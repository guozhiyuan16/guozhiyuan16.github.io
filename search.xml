<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>你不知道的JavaScript</title>
      <link href="/posts/7cda.html"/>
      <url>/posts/7cda.html</url>
      
        <content type="html"><![CDATA[<h1 id="你不知道的JavaScript（上）"><a href="#你不知道的JavaScript（上）" class="headerlink" title="你不知道的JavaScript（上）"></a>你不知道的JavaScript（上）</h1><h2 id="为什么读（解决那些问题）"><a href="#为什么读（解决那些问题）" class="headerlink" title="为什么读（解决那些问题）"></a>为什么读（解决那些问题）</h2><p>JavaScript语言本质上有许多复杂的概念，但是却用一种看起来比较简单的方式体现出来，比如回调函数，因此JavaScript开发者通常只是简单的使用这些特性，并不会关心语言内部的实现原理</p><p>如果每次遇到JavaScript中出乎意料的行为时，你的反应就是把他加入黑名单，那么用不了多久就会把JavaScript语言真正的多样性全部排除</p><h2 id="作用域是什么"><a href="#作用域是什么" class="headerlink" title="作用域是什么"></a>作用域是什么</h2><p>储存和访问变量的值的能力将<code>状态</code>带给了程序，这些变量储存在哪里?程序如何找到它们，这个查找规则被称为<code>作用域</code></p><h3 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h3><p>尽管通常将js归类为动态或解释执行语言，但事实上它是一门编译语言。与传统的编译语言不同，它不是提前编译的，编译结果不能再分布式系统中进行移植</p><p>传统语言的<code>编译</code>原理</p><ul><li><code>分词/词法分析 </code>将由字符组成的字符串分解为<code>有意义的代码块</code>，这些代码块被称为<code>词法单元</code></li><li><code>解析/语法分析</code> 将词法单元转换为<code>AST</code></li><li><code>代码生成</code> 将AST<code>转换</code>为<code>可执行的代码</code></li></ul><p>JavaScript引擎要复杂的多（也会在执行前进行编译），不会有大量的时间来进行优化，因为JS编译过程不是发生在构建之前，而是发生在代码执行之前的几微秒</p><h3 id="理解作用域"><a href="#理解作用域" class="headerlink" title="理解作用域"></a>理解作用域</h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><ul><li><code>引擎</code> 从头到尾负责整个js程序的<code>编译</code>及<code>执行</code>过程</li><li><code>编译器</code> 引擎的好朋友之一，负责<code>语法分析</code>及<code>代码生成</code>等脏活累活</li><li><code>作用域</code> 引擎的另一位好朋友，负责<code>收集</code>并<code>维护</code>由所有声明的标识符（变量）组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限</li></ul><h4 id="var-a-2-解析过程"><a href="#var-a-2-解析过程" class="headerlink" title="var a = 2 解析过程"></a>var a = 2 解析过程</h4><ul><li>编译器分解成词法单元</li><li>词法单元解析成一个树结构</li><li>编译器进行代码生成<ul><li>var a 会询问作用域是否存在a变量，如果存在忽略该声明，继续进行编译，否在会要求作用域声明变量a</li><li>编译器为引擎<code>生成运行时所需代码</code>，这些代码被用来处理 a = 2 这个赋值操作。引擎会问作用域是否存在a变量，存在的话使用，不存在，继续查找</li></ul></li></ul><blockquote><p><code>变量的赋值</code>操作会执行<code>两个动作</code>，首先编译器会在当前作用域中<code>声明一个变量</code>（如果之前没有声明过），然后在运行时引擎会在作用域中<code>查找该变量</code>，如果能够找到就会对它赋值</p></blockquote><h4 id="引擎如何在作用域中查找变量"><a href="#引擎如何在作用域中查找变量" class="headerlink" title="引擎如何在作用域中查找变量"></a>引擎如何在作用域中查找变量</h4><p>当<code>变量</code>出现在<code>赋值操作</code>的<code>左侧</code>时进行 <code>LHS</code>查询，出现在<code>右侧时</code>进行<code>RHS</code>查询</p><p>RHS 查询与简单地查找某个<code>变量的值</code>并无二致，而 LHS 查询则是试图找到变量的<code>容器本身</code>,从而可以对其赋值。从这个角度说，RHS并不是真正意义上的‘赋值操作的左侧’，更准确的说是‘非右侧’</p><blockquote><p>LHS 和 RHS的含义是”赋值操作的左侧或右侧“并不一定意味着就是 ”=赋值操作符的左侧或右侧“。赋值操作还有其他几种形式，因此在概念上最好讲其理解为 <code>赋值操作的目标是谁</code>（LHS）,已经<code>谁是赋值操作的源头</code>（RHS）</p></blockquote><h2 id="补充问题"><a href="#补充问题" class="headerlink" title="补充问题"></a>补充问题</h2><h3 id="什么是js引擎"><a href="#什么是js引擎" class="headerlink" title="什么是js引擎"></a>什么是js引擎</h3><p>JavaScript引擎是一种解释和执行JavaScript代码的软件组件或程序。它是浏览器或其他JavaScript运行环境中的重要组成部分。JavaScript是一种脚本语言，最初设计用于在网页上添加交互性。JavaScript引擎负责解释和执行JavaScript代码，使其能够在用户的浏览器中运行。</p><p>不同的浏览器使用不同的JavaScript引擎。以下是一些主要的JavaScript引擎：</p><ul><li><p>V8引擎： 由Google开发，最初用于Google Chrome浏览器，后来也被用于Node.js等环境。</p></li><li><p>SpiderMonkey： Mozilla Firefox浏览器使用的JavaScript引擎，由Mozilla开发。</p></li><li><p>Chakra引擎： 由Microsoft开发，最初用于Internet Explorer浏览器，后来被Edge浏览器采用。</p></li><li><p>JavaScriptCore（Nitro）： Safari浏览器的JavaScript引擎，由WebKit项目提供。</p></li><li><p>Rhino： 一个由Java编写的JavaScript引擎，通常用于Java应用程序中。</p></li></ul><p>这些引擎<code>负责将JavaScript代码转换为机器代码或解释执行</code>，以便在用户的设备上运行。随着JavaScript的发展，引擎不断优化以提高执行性能和支持新的语言特性。</p><h3 id="什么是js编译器"><a href="#什么是js编译器" class="headerlink" title="什么是js编译器"></a>什么是js编译器</h3><p>JavaScript 是一种解释型语言，通常是通过浏览器中的 JavaScript 引擎逐行解释执行的。然而，随着 JavaScript 的发展，一些工具和技术已经出现，使得 JavaScript 也可以使用编译器进行一些优化。</p><p>在 JavaScript 中，有一种被称为“即时编译”（Just-In-Time Compilation，JIT Compilation）的技术，这是一种在<code>运行时</code>将 JavaScript 代码<code>编译成机器码</code>或其他中间代码的方法。这种技术使得 JavaScript 的执行速度得到提升，因为机器码的执行通常比解释器执行更为高效。</p><p>主要的 JavaScript 引擎，比如 V8（用于 Chrome 和 Node.js）、SpiderMonkey（用于 Firefox）、Chakra（用于 Edge）等，都使用了 JIT 编译技术。以下是 JIT 编译的基本工作原理：</p><ul><li><p>解释执行（Interpretation）： 初始阶段，JavaScript 引擎会解释执行源代码。</p></li><li><p>即时编译（JIT Compilation）： 引擎会监测代码的执行情况，识别经常执行的代码段（热点代码），并将其编译成机器码。</p></li><li><p>优化： JIT 编译器通常会应用一些优化技术，例如内联缓存、去除冗余代码等，以提高执行效率。</p></li><li><p>执行机器码： 一旦代码被成功编译成机器码，后续的执行就会直接使用这些机器码，而不是再次解释源代码。</p></li></ul><p>这种 JIT 编译的方式使得 JavaScript 在运行时能够获得接近原生代码的性能，同时保留了 JavaScript 动态性的特点。这也是为什么现代 JavaScript 引擎能够在性能上取得显著的提升的原因之一。</p><h3 id="其他语言的编译器"><a href="#其他语言的编译器" class="headerlink" title="其他语言的编译器"></a>其他语言的编译器</h3><p>编译器是一种将高级编程语言代码翻译为机器码或其他中间代码的工具。与JavaScript引擎不同，编译器通常在代码执行之前将整个程序编译为机器码，而不是逐行解释执行。这样的编译过程使得执行速度更快，因为代码已经被转换为计算机能够直接理解和执行的形式。</p><p>在不同的编程语言中，有各种不同类型的编译器。以下是一些常见的编译器类型：</p><ul><li><p>前端编译器： 将高级编程语言代码翻译为中间代码，而不生成最终的可执行文件。这些中间代码通常由解释器或后端编译器进一步处理。</p></li><li><p>即时编译器（Just-In-Time Compiler，JIT）： 在程序执行时将字节码或中间代码编译为机器码。JavaScript引擎中的V8就包含了JIT编译器。它在运行时动态地将JavaScript代码编译为机器码，以提高执行性能。</p></li><li><p>静态编译器： 在运行之前将源代码完全编译为机器码。C和C++等语言通常使用静态编译器，生成可执行文件。</p></li><li><p>解释器： 逐行解释执行源代码，而不事先生成机器码。很多脚本语言（如Python、Ruby）使用解释器。</p></li></ul><p>编译器的目标是将源代码转换为能够在计算机上直接执行的形式，以提高程序的性能和效率。与JavaScript引擎不同，编译器通常在程序执行之前完成整个编译过程。</p>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原生JS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读书笔记</title>
      <link href="/posts/ca87.html"/>
      <url>/posts/ca87.html</url>
      
        <content type="html"><![CDATA[<h1 id="唐诗"><a href="#唐诗" class="headerlink" title="唐诗"></a>唐诗</h1><h2 id="诗歌的起源"><a href="#诗歌的起源" class="headerlink" title="诗歌的起源"></a>诗歌的起源</h2><p>诗词，其实就是古代的流行歌曲，它们记录着一个个时代的变迁；如果史书事国家视角，记录的是帝王将相史，那么诗歌就是个人视角，记录的是个人的喜怒哀乐。比起历史的过眼云烟，诗歌包含着诗人丰富的个人情感，这些情感史永恒的，所以诗歌是一种表达情感的高级方式</p><ul><li><p>诗歌的起源于干活时候的口号，中国第一首诗叫做《弹歌》，讲的是原始社会打猎的是，全诗一共八个字  断竹，续竹，飞土，逐肉 （其实这首诗就是个口号，干活的时候一块喊喊，大概类似于做操时候喊的节拍）</p></li><li><p>西周，周公搞了一套礼乐制，把礼节、音乐、舞蹈上升到国家高度。还特意设置了一个采诗官的机构，专门收集各地的民歌，交给朝廷专门的歌舞图谱曲。</p></li><li><p>这些诗歌流传下来，据说孔子把它们又整理了一遍，这就是中国的第一本诗歌总集《诗经》，《诗经》共有诗歌305首，所以后人又称为《诗三百》，</p><ul><li>《诗经》拢共有三种类型<ul><li>风：又称国风，就是各地民歌</li><li>雅 ：大部分是贵族音乐，比如开宴会时的曲子</li><li>颂：特别重大的正式场合演奏的音乐，比如祭祀时用的曲子</li></ul></li><li>里面的诗，基本是四个字一小句，实际上是两组词拼在一块组成的，读起来是‘二/二’的形式，这就是四言诗  例如：（关关/雎鸠，在河/之洲，窈窕/淑女，君子/好逑。）</li></ul></li><li><p>后来有人开辟了全新的玩法，代表人物屈原的《离骚》，《离骚》里面的句子，就不是四个字四个字的了，而是特别喜欢用兮这个语气词 例如：（路漫漫其修远兮，吾将上下而求索。）</p></li><li><p>后来有人继承和模仿屈原的风格写了不少东西，后人将这些作品编辑成集，这就是楚辞</p></li></ul><blockquote><p>《诗经》和《楚辞》，构成了中国诗词的量大起源。诗经里最经典的《国风》和楚辞里面最经典的《离骚》，合称”风骚“，称为中国文学的代称<br>《国风》，代表现实主义，朴实无华 《离骚》，代表浪漫主义，天马行空，这两种类型文学延续至今，涌现出无数的代表人物，后来的诗词，就在这两大起源上继续发展</p></blockquote><ul><li>到了汉代，也有一个机构，跟周朝的采诗官类似，叫乐府，负责采集各地的民歌。这时候的诗已经发展成五言诗，这就是后人口中的汉乐府。最有名的就是《孔雀东南飞》：府吏闻此事，心知长别离。徘徊庭树下，自挂东南枝</li><li>还有一些问人继承《离骚》，于是就有了汉赋 例如：司马相如的《子虚赋》 </li><li>到了魏晋南北朝出现 三曹、竹林七贤、陶渊明（田园诗鼻祖）、谢灵运（山水诗鼻祖），发现五言又不够用了，慢慢发展出七言诗</li></ul><p>可以看到是个发展套路就是：</p><ul><li>节奏越来越丰富；四言到五言到起眼，信息量越来越大，节奏越来越丰富<ul><li>平仄 平仄结合</li><li>押韵 某些句的最后一个字，韵母相同或类似</li><li>对仗 上下两句，平仄相反，句式相同，每个词意思能对上</li></ul></li><li>感情越来越丰富，称为表达喜怒哀乐的重要方式</li></ul><p>催化剂</p><ul><li>科举制 唐代，如果考进士，写诗是基本要求</li><li>国家命运 剧烈变化，给诗人无穷的心理冲击和创作灵感</li></ul><h2 id="初唐领路人"><a href="#初唐领路人" class="headerlink" title="初唐领路人"></a>初唐领路人</h2><p>南北朝的诗歌，开始注重格律（诗的格式和音调，诗开始有节奏感并且读起来朗朗上口），但是缺乏感情，初唐出现几个诗歌改革的先驱，推动诗歌的发展</p><ul><li>王绩 山水田园派，寓言简单朴实 （相顾无相识，长歌怀采薇） </li><li>初唐四杰<ul><li>王勃 《滕王阁序》、《春思赋》、《采莲赋》、五律《送杜少府之任蜀川》、五绝《山中》等</li><li>杨炯 《从军行》</li><li>卢照邻 《长安古意》（得成比目何辞死，愿作鸳鸯不羡仙）</li><li>骆宾王</li></ul></li><li>陈子昂 《登幽州台歌》 前不见古人，后不见来者。年天地之悠悠，独怆然而涕下！他号召向魏晋诗人学习，让诗的风气好起来</li><li>张若虚 《春江花月夜》孤篇盖全唐 （闻一多：诗中的诗，顶峰上的顶峰）</li></ul><p>扭转前朝遗留的弊病，开始注重真情实感</p><h2 id="盛唐老大哥"><a href="#盛唐老大哥" class="headerlink" title="盛唐老大哥"></a>盛唐老大哥</h2><ul><li>贺知章</li></ul><p>37岁高中状元，初唐小跟班（响应陈子昂诗歌改革，是诗歌改革中主要干将），盛唐老大哥（活到86岁，耗死了大神陈子昂，张若虚），人们把他和张若虚，张旭，包融并称吴中（江浙一带）四士</p><p>官场提携了很多人，也和诸多文人雅士为莫逆之交 。看了李白的《蜀道难》后惊为天人，于是大呼，太白是<code>谪仙人</code>(被贬下凡尘的神仙，从此李白也自称谪仙人)，据说诗仙的美号就是这么来的</p><ul><li>张九龄</li></ul><p>号称盛唐最后一位名相，诗人里面官最大的，大官里面诗最棒的</p><p>找举荐人张说（当了三次宰相，号称开元名相，执掌文坛三十年，号称一代文宗），举荐别人孟浩然（望洞庭湖赠张丞相）、王维。 后被李林甫（口蜜腹剑）在玄宗面前说坏话贬职</p><h2 id="边塞诗人"><a href="#边塞诗人" class="headerlink" title="边塞诗人"></a>边塞诗人</h2><p>在唐朝，想要当大官除了科举和被举荐这两条路之外还有一条危险又刺激的道路就是从军。唐朝在各地设立了军区，军区长官被称为节度使。不仅有兵，还能得到中央拨款，节度使不仅需要武将，还需要问人来搞行政，有部分文人投身军旅</p><ul><li>王翰 《凉州词》葡萄美酒夜光杯…</li><li>李颀（qi 身材修长之意）《古意》《古从军行》</li><li>王之涣 《登鹳雀楼》《凉州词》黄河远上白云间</li><li>高适 《燕歌行》边塞诗第一 《别董大》</li><li>王昌龄（七绝圣手）非常注重通过周围的景物描写，来烘托氛围表达情感，情景交融</li><li>岑参 诗歌雄奇瑰丽《白雪歌送武判官归京》</li></ul><h2 id="山水田园诗派"><a href="#山水田园诗派" class="headerlink" title="山水田园诗派"></a>山水田园诗派</h2><ul><li>孟浩然 李白赞美 高山安可仰，徒此辑清芬</li><li>王维 诗佛</li></ul><h2 id="不得不说的李白"><a href="#不得不说的李白" class="headerlink" title="不得不说的李白"></a>不得不说的李白</h2><p>飘逸洒脱独成一派</p>]]></content>
      
      
      <categories>
          
          <category> 唐诗 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 读书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>算法复杂度</title>
      <link href="/posts/7796.html"/>
      <url>/posts/7796.html</url>
      
        <content type="html"><![CDATA[<h1 id="算法复杂度"><a href="#算法复杂度" class="headerlink" title="算法复杂度"></a>算法复杂度</h1><p>怎么理解算法呢？</p><p>简单说就是，同一个功能</p><ul><li>别人写的代码跑起来占内存100M,耗时100毫秒</li><li>你写的代码跑起来占用内存500M,耗时1000毫秒，甚至更多</li></ul><p>所以</p><blockquote><p>衡量代码好坏有两个非常重要的标准: 运行时间(<code>时间复杂度</code>)和占用空间(<code>空间复杂度</code>)</p></blockquote><h2 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h2><p>举个例子</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我又吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"再吃一颗糖"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用这个函数，里面总执行次数就是3次</p><p>下面这个例子</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token string">"一颗糖"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个函数总执行次数会根据我们传进去的值不一样，执行次数也不一样，大概次数如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>     <span class="token operator">:</span> 执行 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1</span><span class="token template-punctuation string">`</span></span> 次i <span class="token operator">&lt;</span> n         <span class="token operator">:</span> 执行 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">n+1</span><span class="token template-punctuation string">`</span></span> 次i<span class="token operator">++</span>           <span class="token operator">:</span> 执行 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">n</span><span class="token template-punctuation string">`</span></span> 次console<span class="token punctuation">.</span>log   <span class="token operator">:</span> 执行 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">n</span><span class="token template-punctuation string">`</span></span> 次<span class="token keyword">return</span>        <span class="token operator">:</span> 执行 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1</span><span class="token template-punctuation string">`</span></span> 次<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个函数的<code>总执行</code>就是 <code>3n + 3</code> 次</p><p>可是我们开发不可能都这样去数，所以根据代码执行时间的推导过程就又一个规律，也就是所有代码执行时间 <code>T(n)</code>和代码的执行次数<code>f(n)</code>是<code>成正比</code>的，而这个规律有一个公式</p><blockquote><p><code>T(n) = O(f(n))</code></p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">n是输入数据的大小或者输入数据的数量<span class="token constant">T</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>表示一段代码的总执行时间<span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>表示一段代码的总执行次数<span class="token constant">O</span> 表示代码的执行时间 <span class="token constant">T</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> 和 执行次数 <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> 成正比<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>算法复杂度的 <code>O()</code> 就是这么来的，我们平时表示算法复杂度主要就是 <code>O()</code>, 读作<code>大欧表示法</code></p><p>上面的两个例子</p><ul><li>第一个函数执行了<code>3</code>次，复杂度就是 <code>O(3)</code></li><li>第二个函数执行了<code>3n+3</code>次，复杂大就是<code>O(3n+3)</code></li></ul><p>这样就会很麻烦，因为如果函数逻辑一样，只是执行次数差了几次，想O(3)和O(4),有什么差别呢？还要写成两种就多此一举了，所以复杂度李有统一的简化表示法，这个执行时间简化的估算值就是我们最终的 <code>时间复杂度</code></p><p>简化过程如下</p><ul><li><code>如果只是常熟直接估算为1</code>， O(3)的时间复杂度就是O(1)，不是说只执行了1次，而是对<code>常量级</code>时间复杂度的一种表示法。<code>一般情况下，只要算法里没有循环和递归，就算有上万行代码，时间复杂度也是O(1)</code></li><li>O(3n+4)里面常数3对于总执行次数几乎没有影响，直接忽略不计，系数3影响也不大,因为3n和n都是一个量级的，所以作为系数的常数3也估算为1或者可以理解为<code>去掉系数</code>，所以O(3n+3)的时间复杂度为 <code>O(n)</code></li><li><code>如果是多项式，只需要保留n的最高次项</code>，O(666n³ + 666n² + n)，这个复杂度里面的最高次项是n得3次方。因为随着n的增大，后面的项的增值远远不及n的最高次项大，所以低于这个次项的直接忽略不计，常数也忽略不计，简化后的 <code>时间复杂度为O(n³)</code></li></ul><h3 id="常用时间复杂度"><a href="#常用时间复杂度" class="headerlink" title="常用时间复杂度"></a>常用时间复杂度</h3><h4 id="O-1"><a href="#O-1" class="headerlink" title="O(1)"></a>O(1)</h4><p>一般情况下，只要算法里没有循环和递归，就算有上万行代码，时间复杂度也是 O(1)，因为它的执行次数不会随着任何一个变量的增大而变长，比如下面这样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">let</span> b <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token number">100</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>b <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始吃糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了1颗糖"</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了2颗糖"</span><span class="token punctuation">)</span>    <span class="token operator">...</span><span class="token operator">...</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了10000颗糖"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="O-n"><a href="#O-n" class="headerlink" title="O(n)"></a>O(n)</h4><p>只有<code>一层循环或者递归</code>，时间复杂度就是<code>O(n)</code>,举个例子</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token operator">--</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">foo3</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token operator">--</span>n <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">foo3</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="O-n²"><a href="#O-n²" class="headerlink" title="O(n²)"></a>O(n²)</h4><p>比如嵌套循环，如下面这样的，里层循环执行n次，外层循环也执行n次，总执行次数就是 n * n , 时间复杂度就是 n的平方，也就是<code>O(n²)</code>。假设n是10，那么里面就会打印10 * 10 = 100 次</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样的总执行次数为 <code>n + n²</code>, 上面说如果是<code>多项式，取最高次项</code>，所以这个时间复杂度也是 <code>O(n²)</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>"我吃了一颗<span class="token constant">O</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//或者下面这样，以运行时间最长的，作为时间复杂度的依据，所以下面的时间复杂度就是 O(n²)</span><span class="token keyword">function</span> <span class="token function">foo3</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> n <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了一颗糖"</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="O-logn"><a href="#O-logn" class="headerlink" title="O(logn)"></a>O(logn)</h4><p>袋子里有16颗糖，每天吃这包糖的一半，多少天吃完</p><p>意思就是16不断除以2，除几次之后等于1？用代码表示</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fool1</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> day <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        n <span class="token operator">=</span> n <span class="token operator">/</span> <span class="token number">2</span>        day <span class="token operator">++</span>     <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> day<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>循环次数的影响主要来源于 n/2 , 这个时间复杂度就是 <code>O(logn)</code>,</p><p>再比如下面这样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"一天"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">foo2</span><span class="token punctuation">(</span> <span class="token number">16</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>里面的打印执行了4次，循环次数主要影响来源于 i * = 2 , 这个时间复杂度也是 <code>O(logn)</code></p><p>这个O(logn)是怎么来的，看下图<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c0e9949416546a7ad430150ec1841bd~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp"></p><p>没有理解的话再看一下，理解一下规律</p><ul><li><code>真数</code>： 这道题的真数是16</li><li><code>底数</code>：就是值的变化规律，比如每次循环都是i*=2，这个乘以2就是规律。比如1,2,3,4,5…这样的值的话，底就是1，每个数变化的规律是+1</li><li><code>对数</code>：在这道题里可以理解成x2乘了多少次，这个次数</li></ul><p>仔细观察就会发现这道题底数是2，而我们要求的天数就是这个对数4，在对数里有一个表达公司</p><blockquote><p>a^b = n  读作以a为底,b的对数=n，在这道题里我们知道a和n的值，也就是  2b = 16 然后求 b</p></blockquote><p>把这个公式转换一下的写法如下</p><blockquote><p>logan = b    在这道题里就是   log216 = ?  答案就是 4</p></blockquote><p>公式是固定的，这个16不是固定的，是我们传进去的 n，所以可以理解为这道题就是求 log2n = ?</p><p>用时间复杂度表示就是 O(log2n)，由于时间复杂度需要去掉常数和系数，而log的底数跟系数是一样的，所以也需要去掉，所以最后这个正确的时间复杂度就是 <code>O(logn)</code></p><p>其他还有一些时间复杂度，我<code>由快到慢</code>排列了一下，如下表顺序</p><table><thead><tr><th>复杂度</th><th>名称</th></tr></thead><tbody><tr><td>O(1)</td><td>常数复杂度</td></tr><tr><td>O(logn)</td><td>对数复杂度</td></tr><tr><td>O(n)</td><td>线性时间复杂度</td></tr><tr><td>O(nlogn)</td><td>线性对数复杂度</td></tr><tr><td>O(n²)</td><td>平方</td></tr><tr><td>O(n³)</td><td>立方</td></tr><tr><td>O(2^n)</td><td>指数，一点数据就卡</td></tr><tr><td>O(n!)</td><td>阶乘，更慢</td></tr></tbody></table><p>这些时间复杂度有什么区别呢，看张图</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bce74e49bf84c44b1ba0f733ac4cc3e~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp"></p><blockquote><p>随着数据流或者n的增大，时间复杂度也随之增加，也就是执行时间的增加，会越来越慢，越来越卡</p></blockquote><h2 id="空间复杂度"><a href="#空间复杂度" class="headerlink" title="空间复杂度"></a>空间复杂度</h2><p>空间复杂度就是算法需要多少内存，占用了多少空间</p><p>常用的空间复杂度有 <code>O(1)</code>,<code>O(n)</code>,<code>O(n^2)</code></p><h4 id="O-1-1"><a href="#O-1-1" class="headerlink" title="O(1)"></a><code>O(1)</code></h4><p>只要不会因为算法里的执行，导致额外的空间增长，就算一万行，空间复杂度也是 <code>O(1)</code>,比如下面这样，时间复杂度也是<code>O(1)</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">let</span> b <span class="token operator">=</span> n <span class="token operator">*</span> <span class="token number">100</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>b <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始吃糖"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了1颗糖"</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了2颗糖"</span><span class="token punctuation">)</span>    <span class="token operator">...</span><span class="token operator">...</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"我吃了10000颗糖"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="O-n-1"><a href="#O-n-1" class="headerlink" title="O(n)"></a><code>O(n)</code></h4><p>下面这种，n的数值越大，算法需要分配的空间就越多，所以他的空间复杂度就是 <code>O(n)</code>,时间复杂度也是<code>O(n)</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="O-n²-1"><a href="#O-n²-1" class="headerlink" title="O(n²)"></a><code>O(n²)</code></h4><p>O(n²) 这种空间复杂度一般出现在比如二维数组，或是矩阵的情况下</p><p>就是遍历生成类似这样格式的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见的Vue知识点</title>
      <link href="/posts/c8d1.html"/>
      <url>/posts/c8d1.html</url>
      
        <content type="html"><![CDATA[<h1 id="总结常见的Vue知识点，看看你在哪个段位-QAQ"><a href="#总结常见的Vue知识点，看看你在哪个段位-QAQ" class="headerlink" title="总结常见的Vue知识点，看看你在哪个段位 QAQ"></a>总结常见的Vue知识点，看看你在哪个段位 QAQ</h1><h2 id="荣耀黄金-⭐️"><a href="#荣耀黄金-⭐️" class="headerlink" title="荣耀黄金 ⭐️"></a>荣耀黄金 ⭐️</h2><h3 id="1-Vue的优缺点"><a href="#1-Vue的优缺点" class="headerlink" title="1.Vue的优缺点?"></a>1.Vue的优缺点?</h3><p><code>优点</code>: 渐进式，组件化，轻量级，虚拟dom,响应式，单页面，数据视图分开<br><code>缺点</code>: 单页面应用不利于SEO,不支持IE8以下，首屏加载时间长</p><h3 id="2-为什么说Vue是一个渐进式框架？"><a href="#2-为什么说Vue是一个渐进式框架？" class="headerlink" title="2.为什么说Vue是一个渐进式框架？"></a>2.为什么说Vue是一个渐进式框架？</h3><p><code>渐进式</code>：通俗点讲就是，你想用啥你就用啥，没有特殊要求，你想用component就用，不用也行，你想用vuex就用，不用也行。</p><h3 id="3-Vue跟React的区别？"><a href="#3-Vue跟React的区别？" class="headerlink" title="3.Vue跟React的区别？"></a>3.Vue跟React的区别？</h3><ul><li><code>相同点</code><ul><li>都使用了<code>虚拟dom</code></li><li><code>组件化</code>开发</li><li>都是<code>单向数据流</code>（父子组件之间，不建议子修改父传下来的数据）</li><li>都支持<code>服务端渲染</code></li></ul></li><li><code>不同点</code><ul><li>React是<code>jsx</code>语法，Vue是<code>template</code></li><li>数据变化React<code>手动</code>（setState）,Vue<code>自动</code>（初始化已把data做响应式处理）</li><li>React单向绑定，Vue双向绑定</li><li>React的<code>Redux</code>,Vue的<code>Vuex</code></li></ul></li></ul><h3 id="4-MVVM是什么？和MVC有何区别呢？"><a href="#4-MVVM是什么？和MVC有何区别呢？" class="headerlink" title="4.MVVM是什么？和MVC有何区别呢？"></a>4.MVVM是什么？和MVC有何区别呢？</h3><p><code>MVC</code>：Controller将Model的数据展示在View上</p><ul><li><code>Model</code>(模型)：负责从数据库取数据</li><li><code>View</code>(视图)：负责展示数据</li><li><code>Controller</code>(控制器)：用户交互的地方，例如点击事件等等</li></ul><p><code>MVVM</code>:实现了 View 和 Model 的自动同步，也就是当 Model 的属性改变时，我们不用再自己手动操作 Dom 元素，来改变 View 的显示，而是改变属性后该属性对应 View 层显示会自动改变（对应Vue<code>数据驱动</code>的思想）</p><ul><li><code>VM</code>(View-Model):做了两件事达到了数据的双向绑定 <ul><li>一是将模型转化成视图，即将后端传递的数据转化成所看到的页面。实现的方式是：<code>数据绑定</code></li><li>二是将视图转化成模型，即将所看到的页面转化成后端的数据。实现的方式是：<code>DOM事件监听</code></li></ul></li></ul><p><code>区别</code><br>整体看来，MVVM 比 MVC 精简很多，不仅简化了业务与界面的依赖，还解决了数据频繁更新的问题，不用再用选择器操作 DOM 元素。因为在 MVVM 中，<code>View 不知道 Model 的存在</code>，<code>Model 和 ViewModel 也观察不到 View</code>，这种低耦合模式提高代码的可重用性</p><p><code>Vue是不是MVVM框架？</code></p><p>Vue是MVVM框架，但是不是严格符合MVVM，因为MVVM规定Model和View不能直接通信，而Vue的ref可以做到这点</p><h2 id="永恒钻石-⭐️⭐️"><a href="#永恒钻石-⭐️⭐️" class="headerlink" title="永恒钻石 ⭐️⭐️"></a>永恒钻石 ⭐️⭐️</h2><h3 id="5-使用过哪些修饰符？"><a href="#5-使用过哪些修饰符？" class="headerlink" title="5.使用过哪些修饰符？"></a>5.使用过哪些修饰符？</h3><p><img src="https://bu.dusays.com/2023/06/24/649700fb94d93.png" alt="Vue常用修饰符"></p><h3 id="6-使用过那些内部指令？"><a href="#6-使用过那些内部指令？" class="headerlink" title="6.使用过那些内部指令？"></a>6.使用过那些内部指令？</h3><p><img src="https://bu.dusays.com/2023/06/24/649700fc64138.png" alt="Vue常用内部指令"></p><h3 id="7-组件通信方式有哪些？"><a href="#7-组件通信方式有哪些？" class="headerlink" title="7.组件通信方式有哪些？"></a>7.组件通信方式有哪些？</h3><ul><li>父组件传值给子组件，子组件使用<code>props</code>进行接受</li><li>子组件传值给父组件，子组件使用<code>$emit+事件</code>对父组件进行传值</li><li>组件中可以使用<code>$parent</code>和<code>$children</code>获取到父组件实例和子组件实例，进而获取数据</li><li>使用<code>$attrs</code>和<code>$listeners</code>，在对一些组件进行二次封装时可以方便传值，例如A-&gt;B-&gt;C</li><li>使用<code>$refs</code>获取组件实例，进而获取数据</li><li>使用<code>Vuex</code>进行状态管理</li><li>使用<code>eventBus</code>进行跨组件触发事件，进而传递数据</li><li>使用<code>provide</code>和<code>inject</code>(没用过)</li><li>使用浏览器缓存，例如<code>localStorage</code></li></ul><h3 id="8-如何设置动态class，动态style？"><a href="#8-如何设置动态class，动态style？" class="headerlink" title="8.如何设置动态class，动态style？"></a>8.如何设置动态class，动态style？</h3><ul><li>动态class对象：<code>&lt;div :class=&quot;&#123; &#39;is-active&#39;: true, &#39;red&#39;: isRed &#125;&quot;&gt;&lt;/div&gt;</code></li><li>动态class数组：<code>&lt;div :class=&quot;[&#39;is-active&#39;, isRed ? &#39;red&#39; : &#39;&#39; ]&quot;&gt;&lt;/div&gt;</code></li><li>动态style对象：<code>&lt;div :style=&quot;&#123; color: textColor, fontSize: &#39;18px&#39; &#125;&quot;&gt;&lt;/div&gt;</code></li><li>动态style数组：<code>&lt;div :style=&quot;[&#123; color: textColor, fontSize: &#39;18px&#39; &#125;, &#123; fontWeight: &#39;300&#39; &#125;]&quot;&gt;&lt;/div&gt;</code></li></ul><h3 id="9-v-if和v-show的区别"><a href="#9-v-if和v-show的区别" class="headerlink" title="9.v-if和v-show的区别"></a>9.v-if和v-show的区别</h3><p><code>v-if</code>是通过控制dom元素的删除和生成来实现显隐，每一次显隐都会使组件重新跑一遍生命周期，因为显隐决定了组件的生成和销毁<br><code>v-show</code>是通过控制dom元素的css样式来实现显隐藏，不会销毁<br><code>频繁或者大数量显隐使用v-show,否则使用v-if</code></p><h3 id="10-计算属性和普通属性的区别"><a href="#10-计算属性和普通属性的区别" class="headerlink" title="10.计算属性和普通属性的区别"></a>10.计算属性和普通属性的区别</h3><p>计算属性是<code>基于</code>他们的<code>依赖进行缓存</code>的，只有相关依赖发生变化时，他们才会重新取值</p><p>计算属性<code>不支持异步</code>，内有异步操作时无效，无法监听数据变化</p><p>声明的<code>计算属性非常大</code>，并且<code>访问量次数很多</code>，<code>改变时间少</code>，就用computed</p><h3 id="11-computed和watch有何区别？"><a href="#11-computed和watch有何区别？" class="headerlink" title="11.computed和watch有何区别？"></a>11.computed和watch有何区别？</h3><ul><li>computed是<code>依赖</code>以有的变量来计算一个目标变量，大多数情况都是<code>多个变量</code>凑在一起计算出<code>一个变量</code>，并且computed具有缓存机制，依赖值不变的情况下会直接读取缓存进行服用，computed<code>不能进行异步操作</code></li><li>watch是监听某一个变量的变化，并执行相对应的回调函数，通常是<code>一个变量</code>的变化决定<code>多个变量</code>的变化，watch可以进行<code>异步操作</code></li><li>简单记就是：一般情况下computed是<code>多对一</code>，watch是<code>一对多</code></li></ul><h3 id="13-Vue的生命周期？"><a href="#13-Vue的生命周期？" class="headerlink" title="13.Vue的生命周期？"></a>13.Vue的生命周期？</h3><p><img src="https://bu.dusays.com/2023/06/24/649700fd23070.png" alt="Vue生命周期"></p><h3 id="14-为什么v-if和v-for不建议用在同一标签？"><a href="#14-为什么v-if和v-for不建议用在同一标签？" class="headerlink" title="14.为什么v-if和v-for不建议用在同一标签？"></a>14.为什么v-if和v-for不建议用在同一标签？</h3><p>在vue2中，<code>v-for优先级</code>是<code>高于v-if</code>的,写在一起会<code>v-for</code>把元素都遍历出来，然后在根据<code>v-if</code>来进行判断，这样<code>会渲染多余的节点</code>，<code>增加无用的dom操作</code>，建议使用computed来解决这个问题</p><h3 id="15-Vuex有哪些属性-用处是什么？"><a href="#15-Vuex有哪些属性-用处是什么？" class="headerlink" title="15.Vuex有哪些属性?用处是什么？"></a>15.Vuex有哪些属性?用处是什么？</h3><p><img src="https://bu.dusays.com/2023/06/24/649700fdca969.png" alt="Vuex"></p><ul><li><code>State</code>: 定义了应用状态的数据结构，可以载这里设置默认的初始状态</li><li><code>Getter</code>: 允许组件从Store中获取数据，mapGetters辅助函数仅仅是将store中的getter映射到局部计算属性</li><li><code>Mutation</code>: 是唯一更改store中状态的方法，且必须是同步函数</li><li><code>Actions</code>: 用于提交mutation,而不是直接变更状态，可以包含任意异步操作</li><li><code>Module</code>: 允许将单一的Store拆分为多个store且同时保存在单一的状态树种</li></ul><h2 id="至尊星耀-⭐️⭐️⭐️"><a href="#至尊星耀-⭐️⭐️⭐️" class="headerlink" title="至尊星耀 ⭐️⭐️⭐️"></a>至尊星耀 ⭐️⭐️⭐️</h2><h3 id="16-不需要响应式的数据应该怎么处理？"><a href="#16-不需要响应式的数据应该怎么处理？" class="headerlink" title="16.不需要响应式的数据应该怎么处理？"></a>16.不需要响应式的数据应该怎么处理？</h3><p>有一些数据，从始至终都<code>未曾改变</code>，这种死数据，既然不改变，那也就<code>不需要</code>对他做<code>响应式处理</code>了，不然只会做一些无用功消耗性能，比如一些写死的下拉框，写死的表格数据，这些数据量大的死数据，如果<code>都进行响应式处</code>理<code>，那会</code>消耗大量性能`</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方法一：将数据定义在data之外</span><span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>list1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="token punctuation">&#125;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>list2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="token punctuation">&#125;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>list3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="token punctuation">&#125;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>list4 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="token punctuation">&#125;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>list5 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>    <span class="token comment">// 方法二：Object.freeze()</span><span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">list1</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>xxxxxxxxxxxxxxxxxxxxxxxx<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">list2</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>xxxxxxxxxxxxxxxxxxxxxxxx<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">list3</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>xxxxxxxxxxxxxxxxxxxxxxxx<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">list4</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>xxxxxxxxxxxxxxxxxxxxxxxx<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">list5</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>xxxxxxxxxxxxxxxxxxxxxxxx<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="17-父子组件的生命周期顺序"><a href="#17-父子组件的生命周期顺序" class="headerlink" title="17.父子组件的生命周期顺序"></a>17.父子组件的生命周期顺序</h3><p><code>父beforeCreate -&gt; 父created -&gt; 父beforeMount -&gt; 子beforeCreate -&gt; 子created -&gt; 子beforeMounted -&gt; 子mounted -&gt; 父mounted</code></p><h3 id="18-对象新属性无法更新视图，删除属性无法更新视图，为什么？怎么办？"><a href="#18-对象新属性无法更新视图，删除属性无法更新视图，为什么？怎么办？" class="headerlink" title="18.对象新属性无法更新视图，删除属性无法更新视图，为什么？怎么办？"></a>18.对象新属性无法更新视图，删除属性无法更新视图，为什么？怎么办？</h3><ul><li>原因：Object.defineProperty没有对对象的新属性进行属性劫持</li><li>对象新属性无法更新视图：使用 <code>Vue.$set(obj,key,value)</code>,组件中<code>this.$set(obj,key,value)</code></li><li>删除属性无法更新视图：使用<code>Vue.$delete(obj,key)</code>,组件中<code>this.$delete(obj,key)</code></li></ul><h3 id="19-自定义指令"><a href="#19-自定义指令" class="headerlink" title="19.自定义指令"></a>19.自定义指令</h3><p><a href="https://www.cnblogs.com/lzq035/p/14183553.html">8个非常实用的Vue自定义指令</a></p><p><a href="https://juejin.cn/post/6844904199289831437">Vue限制input仅能输入正整数或浮点数指令</a></p><h3 id="20-为什么不建议用index做key-为什么不建议用随机数做key"><a href="#20-为什么不建议用index做key-为什么不建议用随机数做key" class="headerlink" title="20.为什么不建议用index做key?为什么不建议用随机数做key?"></a>20.为什么不建议用index做key?为什么不建议用随机数做key?</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"(item, index) in list"</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"index"</span><span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>item<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'123'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'124'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'小花'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'125'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>渲染为<span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"0"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>现在我执行 list<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'小林'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'122'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>渲染为<span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"0"</span><span class="token operator">></span>小林<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"3"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>新旧对比<span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"0"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"0"</span><span class="token operator">></span>小林<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"2"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>                         <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"3"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>可以看出，如果用index做key的话，其实是更新了原有的三项，并新增了小花，虽然达到了渲染目的，但是损耗性能现在我们使用id来做key，渲染为<span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"123"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"124"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"125"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>现在我执行 list<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'小林'</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">'122'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>，渲染为<span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"122"</span><span class="token operator">></span>小林<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"123"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"124"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"125"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>新旧对比                           <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"122"</span><span class="token operator">></span>小林<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"123"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"123"</span><span class="token operator">></span>小明<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"124"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"124"</span><span class="token operator">></span>小红<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"125"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">"125"</span><span class="token operator">></span>小花<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>可以看出，原有的三项都不变，只是新增了小林这个人，这才是最理想的结果<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用<code>index</code>和用<code>随机数</code>都是同理，<code>随机数</code>每次都在<code>变</code>，做不到<code>专一性</code></p><h3 id="21-nextTick的用处"><a href="#21-nextTick的用处" class="headerlink" title="21.nextTick的用处"></a>21.nextTick的用处</h3><p>Vue采用的是<code>异步更新</code>的策略，同一事件循环内<code>多次修改</code>，会统一（<code>批处理</code>）进行一次视图更新，节省性能。所以会出现数据更新，视图还没有更新，这时候拿页面的数据还是<code>上一次的数据</code>，想要拿到<code>最新的数据</code>就需要使用<code>this.$nextTick</code></p><h2 id="最强王者-⭐️⭐️⭐️⭐️"><a href="#最强王者-⭐️⭐️⭐️⭐️" class="headerlink" title="最强王者 ⭐️⭐️⭐️⭐️"></a>最强王者 ⭐️⭐️⭐️⭐️</h2><h3 id="22-Vue响应式是怎么实现的"><a href="#22-Vue响应式是怎么实现的" class="headerlink" title="22.Vue响应式是怎么实现的"></a>22.Vue响应式是怎么实现的</h3><p>整体思路是数据劫持 + 观察者模式</p><p><code>对象</code>内部通过 <code>defineReactive</code> 方法，使用 <code>Object.defineProperty</code> 将属性进行劫持（只会劫持已经存在的属性），数组则是通过<code>重写数组方法</code>来实现。当页面使用对应属性时，每个属性都拥有自己的<code>dep</code>属性，存放他所依赖的 <code>watcher</code>（依赖收集），当属性变化后会通知自己对应的 <code>watcher</code> 去更新(派发更新)。</p><p>可以看我的这篇<a href="https://blog.guozy.online/posts/6.html">Vue响应式原理</a></p><h3 id="23-Vue的模版编译原理"><a href="#23-Vue的模版编译原理" class="headerlink" title="23.Vue的模版编译原理"></a>23.Vue的模版编译原理</h3><p>可以看我的这篇<a href="https://blog.guozy.online/posts/63af.html">Vue模版编译原理</a></p><h3 id="24-watcher和computed的实现"><a href="#24-watcher和computed的实现" class="headerlink" title="24.watcher和computed的实现"></a>24.watcher和computed的实现</h3><p>都是通过watcher来实现的，watcher分为</p><ul><li><code>渲染Watcher</code>：变量修改时，负责通知HTML里的重新渲染</li><li><code>computed Watcher</code>：变量修改时，负责通知computed里依赖此变量的computed属性变量的修改</li><li><code>user Watcher</code>：变量修改时，负责通知watch属性里所对应的变量函数的执行</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// watch时 exprOrFn是一个字符串 cb为watch执行的回调函数 &#123;user:true&#125;</span>watch 是 <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>exprOrFn<span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">user</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>computed 是 <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>getter<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">lazy</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>时间长，忘的有点多，随后补充</p></blockquote><h3 id="25-Vue-set方法的原理？"><a href="#25-Vue-set方法的原理？" class="headerlink" title="25.Vue.set方法的原理？"></a>25.Vue.set方法的原理？</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断是否是数组</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 判断谁大谁小</span>        target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span>        <span class="token comment">// 执行splice</span>        target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>        <span class="token keyword">return</span> val    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__    <span class="token comment">// 如果此对象没有不是响应式对象，直接设置并返回</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val        <span class="token keyword">return</span> val    <span class="token punctuation">&#125;</span>    <span class="token comment">// 否则，新增属性，并响应式处理</span>    <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>    <span class="token keyword">return</span> val<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="26-Vue-delete方法的原理"><a href="#26-Vue-delete方法的原理" class="headerlink" title="26.Vue.delete方法的原理"></a>26.Vue.delete方法的原理</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">del</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断是否为数组</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 执行splice</span>        target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__    <span class="token comment">// 对象本身就没有这个属性，直接返回</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>    <span class="token comment">// 否则，删除这个属性</span>    <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token comment">// 判断是否是响应式对象，不是的话，直接返回</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token keyword">return</span>    <span class="token comment">// 是的话，删除后要通知视图更新</span>    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="27-nextTick的原理？"><a href="#27-nextTick的原理？" class="headerlink" title="27.nextTick的原理？"></a>27.nextTick的原理？</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//回调函数</span><span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">flushCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//把标志还原为false</span>  <span class="token comment">// 依次执行回调</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> callbacks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> timerFunc<span class="token punctuation">;</span> <span class="token comment">//先采用微任务并按照优先级优雅降级的方式实现异步刷新</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 如果支持promise</span>  <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> MutationObserver <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// MutationObserver 主要是监听dom变化 也是一个异步方法</span>  <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> textNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">characterData</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    counter <span class="token operator">=</span> <span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>    textNode<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 如果前面都不支持 判断setImmediate</span>  <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setImmediate</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 最后降级采用setTimeout</span>  <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    pending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token function">timerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="28-key有什么用？说说diff算法吧？"><a href="#28-key有什么用？说说diff算法吧？" class="headerlink" title="28.key有什么用？说说diff算法吧？"></a>28.key有什么用？说说diff算法吧？</h3><p>看大佬写的 <a href="https://juejin.cn/post/6974293549135167495">为什么 Vue 中不要用 index 作为 key？（diff 算法详解）</a></p><h2 id="荣耀王者-⭐️⭐️⭐️⭐️⭐️"><a href="#荣耀王者-⭐️⭐️⭐️⭐️⭐️" class="headerlink" title="荣耀王者 ⭐️⭐️⭐️⭐️⭐️"></a>荣耀王者 ⭐️⭐️⭐️⭐️⭐️</h2><h3 id="29-子组件改变props里的数据会发生什么"><a href="#29-子组件改变props里的数据会发生什么" class="headerlink" title="29.子组件改变props里的数据会发生什么?"></a>29.子组件改变props里的数据会发生什么?</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">item</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 不报错，并且父级数据会跟着变</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>item<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'aaa'</span><span class="token punctuation">;</span>        <span class="token comment">// 会报错，跟基础类型报错一样</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token string">'sss'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="30-watch的immediate属性有什么用？"><a href="#30-watch的immediate属性有什么用？" class="headerlink" title="30.watch的immediate属性有什么用？"></a>30.watch的immediate属性有什么用？</h3><blockquote><p>比如平时created时要请求一次数据，并且当搜索值改变，也要请求数据，我们会这样写</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token function">searchInputValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用<code>immediate</code>完全可以这么写，当它为true时，会初始执行一次</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">searchInputValue</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'getList'</span><span class="token punctuation">,</span>    <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="31-watch监听一个对象时，如何排除某些属性的监听"><a href="#31-watch监听一个对象时，如何排除某些属性的监听" class="headerlink" title="31.watch监听一个对象时，如何排除某些属性的监听"></a>31.watch监听一个对象时，如何排除某些属性的监听</h3><blockquote><p>下面代码是，params发生改变就重新请求数据，无论是a，b，c，d属性改变</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token number">4</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>getList<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>但是如果我只想要a，b改变时重新请求，c，d改变时不重新请求呢？</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 排除对c，d属性的监听</span>      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token operator">=></span> vm<span class="token punctuation">.</span>params<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>          <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token number">4</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>getList<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="32-computed如何实现传参？"><a href="#32-computed如何实现传参？" class="headerlink" title="32.computed如何实现传参？"></a>32.computed如何实现传参？</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// html</span><span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token function">total</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// js</span><span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num        <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="33-vue的hook的使用"><a href="#33-vue的hook的使用" class="headerlink" title="33.vue的hook的使用"></a>33.vue的hook的使用</h3><ul><li><code>同一组件中使用</code></li></ul><blockquote><p>这是我们常用的定时器的方式</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">&#123;</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">timer</span><span class="token operator">:</span><span class="token keyword">null</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>      <span class="token comment">//具体执行内容</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">beforeDestory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>上面做法不好的地方在于：得全局多定义一个timer变量，可以使用hook这么做：</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token comment">//具体执行代码</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span><span class="token string">'hook:beforeDestroy'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>父子组件使用</code></li></ul><blockquote><p>如果子组件需要在mounted时触发父组件的某一个函数，平时都会这么写：</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//父组件</span><span class="token operator">&lt;</span>rl<span class="token operator">-</span>child @childMounted<span class="token operator">=</span><span class="token string">"childMountedHandle"</span><span class="token operator">/</span><span class="token operator">></span><span class="token function">method</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">childMountedHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do something...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">// 子组件</span><span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'childMounted'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>使用hook的话可以更方便</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//父组件</span><span class="token operator">&lt;</span>rl<span class="token operator">-</span>child @hook<span class="token operator">:</span>mounted<span class="token operator">=</span><span class="token string">"childMountedHandle"</span><span class="token operator">/</span><span class="token operator">></span><span class="token function">method</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">childMountedHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do something...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="34-动态指令和参数使用过？"><a href="#34-动态指令和参数使用过？" class="headerlink" title="34.动态指令和参数使用过？"></a>34.动态指令和参数使用过？</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>    <span class="token operator">...</span>    <span class="token operator">&lt;</span>aButton @<span class="token punctuation">[</span>someEvent<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"handleSomeEvent()"</span> <span class="token operator">:</span><span class="token punctuation">[</span>someProps<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"1000"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span>  <span class="token operator">...</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">&#123;</span>      <span class="token operator">...</span>      <span class="token literal-property property">someEvent</span><span class="token operator">:</span> someCondition <span class="token operator">?</span> <span class="token string">"click"</span> <span class="token operator">:</span> <span class="token string">"dbclick"</span><span class="token punctuation">,</span>      <span class="token literal-property property">someProps</span><span class="token operator">:</span> someCondition <span class="token operator">?</span> <span class="token string">"num"</span> <span class="token operator">:</span> <span class="token string">"price"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">handleSomeEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token comment">// handle some event</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="35-相同的路由组件如何重新渲染？"><a href="#35-相同的路由组件如何重新渲染？" class="headerlink" title="35.相同的路由组件如何重新渲染？"></a>35.相同的路由组件如何重新渲染？</h3><blockquote><p>开发人员经常遇到的情况是，多个路由解析为同一个Vue组件。问题是，Vue出于性能原因，默认情况下共享组件将不会重新渲染，如果你尝试在使用相同组件的路由之间进行切换，则不会发生任何变化。</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">&#123;</span>    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">"/a"</span><span class="token punctuation">,</span>    <span class="token literal-property property">component</span><span class="token operator">:</span> MyComponent  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span>    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">"/b"</span><span class="token punctuation">,</span>    <span class="token literal-property property">component</span><span class="token operator">:</span> MyComponent  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>如果依然想重新渲染，怎么办呢？可以使用<code>key</code></p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>    <span class="token operator">&lt;</span>router<span class="token operator">-</span>view <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"$route.path"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="36-自定义v-model"><a href="#36-自定义v-model" class="headerlink" title="36.自定义v-model"></a>36.自定义v-model</h3><blockquote><p>默认情况下，v-model 是 @input 事件侦听器和 :value 属性上的语法糖。但是，你可以在你的Vue组件中指定一个模型属性来定义使用什么事件和value属性——非常棒！</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">event</span><span class="token operator">:</span> <span class="token string">'change'</span><span class="token punctuation">,</span>    <span class="token literal-property property">prop</span><span class="token operator">:</span> <span class="token string">'checked'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="37-如何将获取data中某一个数据的初始状态？"><a href="#37-如何将获取data中某一个数据的初始状态？" class="headerlink" title="37.如何将获取data中某一个数据的初始状态？"></a>37.如何将获取data中某一个数据的初始状态？</h3><blockquote><p>在开发中，有时候需要拿初始状态去计算。例如</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">10</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">howMuch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 计算出num增加了多少，那就是1000 - 初始值</span>        <span class="token comment">// 可以通过this.$options.data().xxx来获取初始值</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>num<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="38-计算变量时，methods和computed哪个好？"><a href="#38-计算变量时，methods和computed哪个好？" class="headerlink" title="38.计算变量时，methods和computed哪个好？"></a>38.计算变量时，methods和computed哪个好？</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token function">howMuch1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>howMuch2<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>index<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>         <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token number">0</span>       <span class="token punctuation">&#125;</span>     <span class="token punctuation">&#125;</span><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">howMuch1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>price    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function">howMuch2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>price    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>computed</code>会好一些，因为computed会有<code>缓存</code>。例如index由0变成1，那么<code>会触发视图更新</code>，这时候<code>methods会重新执行一次</code>，而<code>computed不会</code>，因为computed依赖的两个变量num和price都没变。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3IX-组件渲染</title>
      <link href="/posts/5459.html"/>
      <url>/posts/5459.html</url>
      
        <content type="html"><![CDATA[<h1 id="组件渲染"><a href="#组件渲染" class="headerlink" title="组件渲染"></a>组件渲染</h1><blockquote><p>浏览器（也称为<code>网络浏览器</code>或<code>互联网浏览器</code>）是安装在我们设备商的软件应用程序，使我们能够访问万维网。在阅读这篇文字时，你实际上正在使用一个浏览器</p></blockquote><p>有许多浏览器正在被使用，截止2022年，使用最多的是：<code>谷歌浏览器</code>，苹果的<code>Safari</code>，微软的<code>Edge</code>和<code>火狐</code>。</p><p>但是，它们实际上是如何工作的，从我们在地址栏中<code>键入网络地址开始</code>，到我们试图访问的<code>页面显示在屏幕</code>上，会发生什么？</p><p>这个看似超级简单的过程中涉及更多的内容，在下面我们将<code>导航</code>、<code>获取数据</code>、<code>解析</code> 和 <code>渲染</code>等步骤，来探究浏览器工作原理</p><h2 id="1-导航"><a href="#1-导航" class="headerlink" title="1.导航"></a>1.导航</h2><p>导航是加载网页的第一步。它指的是当用户通过<code>点击一个链接</code>、<code>在浏览器地址栏中写下一个网址</code>、<code>提交一个表格</code>等方式请求一个网页时发生的过程</p><h3 id="DNS查询（解决网址问题）"><a href="#DNS查询（解决网址问题）" class="headerlink" title="DNS查询（解决网址问题）"></a>DNS查询（解决网址问题）</h3><p>导航到一个网页的第一步是找到该网页的<code>静态资源</code>位置（HTML、CSS、Javascript和其他类型的文件）。如果我们导航到 example.com ，HTML 页面位于 IP 地址为 93.184.216.34 的服务器上（对我们来说，网站是域名，但对计算机来说，它们是 <code>IP 地址</code>）。如果我们以前从未访问过这个网站，就必须进行域名系统（DNS）查询。</p><blockquote><p>DNS 服务器是包含<code>公共 IP 地址</code>及其相关<code>主机名</code>数据库的计算机服务器（这通常被比作<code>电话簿</code>，因为人们的名字与一个特定的电话号码相关联）。在大多数情况下，这些服务器按照要求将这些名字解析或翻译成 IP 地址（现在有 600 多个不同的 DNS 根服务器分布在世界各地）。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb726ecac.png"></p><p>因此，当我们请求进行 DNS 查询时，我们<code>实际做的是与这些服务器中的一个进行对话</code>，要求找出与example.com 名称相对应的IP地址。如果<code>找到</code>了一个<code>对应的 IP</code>，就会返回。如果发生了一些情况，查找不成功，我们会在浏览器中看到一些错误信息。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb74815be.png"></p><p>在这个最初的查询之后，IP 地址可能会被<code>缓存一段时间</code>，所以下次访问同一个网站会更快，因为不需要进行 DNS 查询（记住，<code>DNS 查询只发生在我们第一次访问一个网站时</code>）。</p><h3 id="TCP-Transmission-Control-Protocol-握手"><a href="#TCP-Transmission-Control-Protocol-握手" class="headerlink" title="TCP(Transmission Control Protocol)握手"></a>TCP(Transmission Control Protocol)握手</h3><p>一旦浏览器知道了网站的 IP 地址，它将尝试通过 TCP <code>三次握手</code>（也称为 SYN-SYN-ACK，或者更准确的说是 SYN、SYN-ACK、ACK，因为 TCP 有三个消息传输，用于协商和启动两台计算机之间的TCP 会话），与持有资源的服务器建立连接。</p><blockquote><p>TCP 是<code>传输控制协议</code>的缩写，是一种通信标准，使应用程序和计算设备能够在网络上交换信息。它被设计用来在互联网上发送数据包，并确保数据和信息在网络上成功传递。</p></blockquote><p>TCP 握手是一种机制，旨在让<code>两个想要相互传递信息的实体</code>（在我们的例子中是浏览器和服务器）在<code>传输数据之前协商好连接的参数</code>。</p><p>因此，如果浏览器和服务器是两个人，他们之前的对话会是这样的：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ca650a.png"></p><p>浏览器向服务器发送一个 <strong>SYNC</strong>消息，要求进行同步（同步意味着链接）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dc4ac2.png"></p><p>然后，服务器将回复一个 <strong>SYNC-ACK</strong> 消息（SYNChorization 和 ACKnowledgement）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dd211e.png"></p><p>在最后一步，浏览器将回复一个 <strong>ACK</strong> 信息</p><p>现在，TCP链接 （双向链接）已经通过3次握手建立，TLS协商可以开始。</p><h3 id="TLS协商"><a href="#TLS协商" class="headerlink" title="TLS协商"></a>TLS协商</h3><p>对于通过<code>HTTPS</code>建立的安全链接，需要进行另一次握手。这种握手（<code>TLS协商</code>）决定了那个密码将被用于<code>加密通信</code>，验证服务器，并在开始实际的<code>数据传输之前建立一个安全的连接</code></p><blockquote><p><code>传输层安全</code>（TLS）是现已废弃的安全套接字层 （SSL）的继任者，是一种加密协议，<code>旨在通过计算机网络提供通信安全</code>。该协议被广泛用于电子邮件和即时通讯等应用，但它在确保HTTPS安全方面的应用仍然是<code>最公开的</code>。由于应用程序可以使用或不使用TLS(或SSL)进行通信，因此客户（浏览器）有必要要求服务器建立TLS连接。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dd211e.png"></p><p>在这一步骤中，浏览器和服务器之间还交换了一些信息</p><ol><li><strong>客户端hello</strong>。 浏览器向服务器发送一条信息，其中包括它所支持的TLS版本和密码套件，以及一串随机字节，称为<code>客户端随机数</code></li><li> <strong>服务器hello和证书</strong>。服务器发回一条信息，其中包括服务器的SSL证书、服务器选择的密码套件和<code>服务器随机数</code>，这是服务器生成的另一个随机字节串。</li><li> <strong>认证</strong>。 浏览器会向颁发证书的机构核实服务器的SSL证书。这样，浏览器就可以确定服务器就是它所说的那个人。</li><li> <strong>预主密码</strong>。浏览器会再发送一串随机的字节，称为<code>主密钥</code>，用浏览器从服务器的 <code>SSL 证书</code>上获取的 <code>公钥</code> 进行加密。 主密码只能由服务器用 <code>私钥</code> 解密。</li><li> <strong>使用私钥</strong>。 服务器解密<code>预主密码</code>。</li><li> <strong>创建会话秘钥</strong>。 浏览器和服务器从<code>客户端随机数</code>、<code>服务器随机数</code>和<code>预主密码</code>中<code>生成会话密钥</code>。</li><li> <strong>客户端完成</strong>。浏览器向服务器发送一个消息，说它已经完成。</li><li> <strong>服务器完成</strong>。服务器向浏览器发送一个消息，表示它也完成了。</li><li> <strong>安全对称加密实现</strong>。 握手完成，通信可以继续使用会话密钥。</li></ol><p><code>现在可以开始从服务器请求和接受数据了</code></p><h2 id="2-获取数据"><a href="#2-获取数据" class="headerlink" title="2.获取数据"></a>2.获取数据</h2><h3 id="HTTP-请求"><a href="#HTTP-请求" class="headerlink" title="HTTP 请求"></a>HTTP 请求</h3><p>在我们与服务器<code>建立安全连接后</code>，浏览器将<code>发送</code>一个初始的 <code>HTTP GET</code> 请求。首先，浏览器将<code>请求页面的 HTML 文件</code>。它将使用 <code>HTTP 协议</code> 来做这件事。</p><blockquote><p>HTTP (超文本传输协议) 是一个<code>获取资源的协议</code>， 如HTML文件。它是网络上任何<code>数据交换的基础</code>，它是一个<code>客户-服务器协议</code>，这意味着请求是由接受者发起的，通常是网络浏览器。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dc4ea1.png"></p><p><strong>请求方法</strong> HTTP 请求方式一共有 9 种，分别为 POST 、GET 、HEAD、PUT 、PATCH 、 OPTIONS 、DELETE 、CONNECT 、 TRACE 。其中前三种 POST 、GET 、HEAD 是 HTTP 1.0 定义的，后六种 PUT 、PATCH 、 OPTIONS 、DELETE 、CONNECT 、 TRACE 是 HTTP 1.1 定义的。</p><p><strong>URI</strong> 是<code>统一资源识别符</code>的缩写，一个URI最多可以有5个部分</p><ul><li><code>scheme</code> : 用于说明使用的事什么协议</li><li><code>authority</code>: 用于识别域名</li><li><code>path</code>: 用于显示资源的确切路径</li><li><code>query</code>: 用于表示一个请求动作</li><li><code>fragment</code>: 用来指代资源的一部分</li></ul><pre class="line-numbers language-arduino" data-language="arduino"><code class="language-arduino"><span class="token comment">// URI parts</span>scheme <span class="token operator">:</span><span class="token comment">// authority path ? query # fragment</span><span class="token comment">//URI example</span><span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token comment">//example.com/users/user?name=Alice#address></span>https<span class="token operator">:</span> <span class="token comment">// scheme name</span>example<span class="token punctuation">.</span>com <span class="token comment">// authority</span>users<span class="token operator">/</span>user <span class="token comment">// path</span>name<span class="token operator">=</span>Alice <span class="token comment">// query</span>address <span class="token comment">// fragment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>HTTP头字段</strong> 是浏览器和服务器在每个 HTTP 请求和响应中发送和接受的字符串列表（它们通常对终端用户是不可见的）。在请求的情况下，它们包含关于要获取的资源或请求组员的浏览器的更多信息。</p><p>如果你想看看这些请求头字段是什么样子的，请进入 Chrome 浏览器并打开开发者工具（F12）。进入 Network 标签，选择 <code>FETCH/XHR</code>。在下面的屏幕截图中，我刚刚在搜索引擎上搜索了Palm Springs，这就是请求头的样子。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e18a64.png"></p><h3 id="HTTP响应"><a href="#HTTP响应" class="headerlink" title="HTTP响应"></a>HTTP响应</h3><p>一旦服务器收到请求，它将对其进行处理并回复一个 <code>HTTP 响应</code> 。在响应的正文中，我们可以找到所有相关的响应头和我们请求的HTML文档的内容</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e53664.png"></p><p><strong>状态代码</strong> 200、400、401、504网关超时等（我们的目标是 200 状态代码，因为它告诉我们一切正常，请求是成功的）</p><p><strong>响应头字段</strong> 保存关于响应的额外信息，如它的位置或提供它的服务器。</p><p>一个 <strong>HTML</strong> 文档的例子是这样的</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">HTML</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>我的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mainScripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>这个是我的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>一个段落和一个 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;https://example.com/about><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myImage.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image description<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sideEffectsScripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于我前面提到的同一个搜索，响应头是这样的</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e577c7.png"></p><p>如果我们看一下HTML文档，我们会发现它<code>引用了不同的 CSS 和 Javascript </code> 文件。这些文件<code>不会被请求</code>。在这个时候，只有 HTML 被请求并从服务器接收。</p><p>这个初始请求的响应包含收到的第一个字节的数据。第一个字节的时间（TTFB）是指从<code>用户提出请求（在地址栏中输入网站名称）</code>到<code>收到第一个 HTML 数据包</code>（通常为<code>14kb</code>）的时间。</p><h3 id="TCP-慢启动和拥塞算法"><a href="#TCP-慢启动和拥塞算法" class="headerlink" title="TCP 慢启动和拥塞算法"></a>TCP 慢启动和拥塞算法</h3><p><code>TCP 慢启动</code> 是一种<code>平衡网络连接速度</code>的算法。 第一个数据包将是 <code>14kb（或更小）</code>，其工作方式是<code>逐渐增加传输的数据量</code>，直到<code>达到预定的阈值</code>。 从服务器接收到每个数据包后，客户端以 <code>ACK 消息</code>响应。 由于连接容量有限，如果服务器发送太多数据包太快，它们将被丢弃。 客户端不会发送任何 ACK 消息，因此服务器会将此解释为<code>拥塞</code>。 这就是<code>拥塞算法</code>发挥作用的地方。 他们监控发送的数据包和 ACK 消息的流，以确定流量的最佳速率并创建稳定的流量流。</p><h2 id="3-HTML解析"><a href="#3-HTML解析" class="headerlink" title="3.HTML解析"></a>3.HTML解析</h2><p>在向服务器发出初始请求后，浏览器如何收到包含我们尝试访问的网页的 HTML 资源 （第一块数据）的响应。现在浏览器的工作就是开始解析数据。</p><blockquote><p>解析是指将程序<code>分析</code>并<code>转换</code>为运行时环境实际可以运行的内部格式</p></blockquote><p>换句话说，解析意味着将我们编写的代码作为文本（HTML、CSS）并将其<code>转换为浏览器可以使用的内容</code>。解析将由<code>浏览器引擎</code>完成（不要与浏览器的 Javascript 引擎混淆）</p><p>有许多浏览器引擎，但大多数浏览器使用这三个活跃且完整引擎之一：</p><p><strong>Gecko</strong> 它是由 Mozilla 为 Firefox 开发的。 过去，它曾为其他几种浏览器提供支持，但目前，除了 Firefox，Tor 和 Waterfox 是唯一仍在使用 Gecko 的浏览器。 它是用 C++ 和 JavaScript 编写的，自 2016 年起，还用 Rust 编写。</p><p><strong>WebKit</strong> 它主要由 Apple 为 Safari 开发。 它还为 GNOME Web (Epiphany) 和 Otter 提供支持。 （令人惊讶的是，在 iOS 上，包括 Firefox 和 Chrome 在内的所有浏览器也由 WebKit 提供支持）。 它是用 C++ 编写的。</p><p><strong>Blink，Chromium</strong> 的一部分 它最初是 WebKit 的一个分支，主要由 Google 为 Chrome 开发。 它还为 Edge、Brave、Silk、Vivaldi、Opera 和大多数其他浏览器项目（一些通过 QtWebEngine）提供支持。 它是用 C++ 编写的。</p><p>现在我们了解了谁将进行解析，让我们看看在从服务器接收到第一个 HTML 文档后到底发生了什么。 让我们假设文档如下所示：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">HTML</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>This is my page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>This is my page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>This is a H3 header.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is a paragraph.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is another paragraph,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>即使请求页面的 HTML 大于初始的 14KB 数据包， 浏览器也会开始解析并尝试根据其拥有的数据呈现体验。 HTML 解析涉及两个步骤: <code>词法分析</code> 和 <code>树构造</code> （构建称为 DOM 树的东西）。</p><h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><blockquote><p>它将一些输入转换为标签 （源代码的基本组件）。 想象一下，我们将一段英文文本分解成单词，其中单词就是标签。</p></blockquote><p>词法分析过程结束时的结果是一系列 0 个或多个以下标签: DOCTYPE、开始标签（<code>&lt;tag&gt;</code>）、结束标签（<code>&lt;/tag&gt;</code>）、自闭合标签（<code>&lt;tag/&gt;</code>）、<code>属性名称</code>、<code>值</code>、<code>注释</code>、<code>字符</code>、<code>文件结尾</code>或<code>元素中的纯文本内容</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e9aa9c.png"></p><h3 id="构建-DOM"><a href="#构建-DOM" class="headerlink" title="构建 DOM"></a>构建 DOM</h3><p>创建第一个 token 后，<code>树构建</code>开始。这实质上是基于先前解析的标签创建 <code>树状结构</code> （称为文档对象模型）。</p><p>DOM 树描述了 HTML 文档的内容。 <code>&lt;html&gt;</code> 元素时文档树的第一个标签和根节点。树反映了不同标签之间的<code>关系</code>和<code>层次结构</code>。我们有<code>父节点</code>，嵌套在其他标签中的标签是<code>子节点</code>。节点数越多，构建 DOM 树所需的时间就越长。下面是我们从服务器获取的 HTML 文档示例的 DOM 树:</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e9960c.png"></p><p>实际上，DOM 比我们在该模式中看到的更<code>复杂</code>，但我保持简单以便更好地理解（另外，我们将在以后的文章中更详细地讨论 DOM 及其重要性）。</p><p>此构建阶段是 <code>可重入</code> 的，这意味着在处理一个 token 时，分词器可能会恢复，导致在第一个 token 处理完成之前触发并处理更多 token。 从字节到创建 DOM，整个过程如下所示：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ec45eb.png"></p><p>解析器从上到下逐行工作。 当解析器遇到<code>非阻塞资源</code>（例如图像）时，浏览器会向服务器请求这些图像并<code>继续解析</code>。 另一方面，如果它遇到<code>阻塞资源</code>（<strong>CSS 样式表</strong>、在 HTML 的  部分添加的 <strong>Javascrpt 文件</strong>或从 <strong>CDN 添加的字体</strong>），解析器将<code>停止执行</code>，直到所有这些阻塞资源<code>都被下载</code>。 这就是为什么，如果你正在使用 Javascript，建议在 HTML 文件的末尾添加</p><h3 id="预加载器-amp-使页面更快"><a href="#预加载器-amp-使页面更快" class="headerlink" title="预加载器 &amp; 使页面更快"></a>预加载器 &amp; 使页面更快</h3><p>Internet Explorer、WebKit 和 Mozilla 都在 2008 年实现了预加载器，作为处理阻塞资源的一种方式，尤其是脚本（我们之前说过，当遇到脚本标签时，HTML 解析将停止，直到脚本被下载并执行）。<br>使用预加载器，当浏览器卡在脚本上时，第二个较轻的解析器会扫描 HTML 以查找需要检索的资源（样式表、脚本等）。 然后预加载器开始在后台检索这些资源，目的是在主 HTML 解析器到达它们时它们可能已经被下载（如果这些资源已经被缓存，则跳过此步骤）。</p><h2 id="4-解析CSS"><a href="#4-解析CSS" class="headerlink" title="4.解析CSS"></a>4.解析CSS</h2><p>解析完 HTML 之后，就该解析 CSS（在外部 CSS 文件和样式元素中找到）并构建 <code>CSSDOM 树</code>（CSS 对象模型）。</p><p>当浏览器遇到 CSS 样式表时，无论是<code>外部样式</code>表还是<code>嵌入式样式表</code>，它都需要将文本解析为可用于设置布局样式的内容。 浏览器将 <code>CSS 变成的数据结构称为 CSSOM</code>。 DOM 和 CSSOM 遵循相似的概念，因为它们都是树，但它们是<code>不同的数据结构</code>。 就像从我们的 HTML 构建 DOM 一样，从 CSS 构建 CSSOM 被认为是一个<code>「渲染阻塞 」</code>过程。</p><h3 id="词法分析和构建-CSSOM"><a href="#词法分析和构建-CSSOM" class="headerlink" title="词法分析和构建 CSSOM"></a>词法分析和构建 CSSOM</h3><p>与 HTML 解析类似，CSS 解析从词法分析开始。 CSS 解析器<code>获取字节</code>并将它们<code>转换为字符</code>，然后是<code>标签</code>，然后是<code>节点</code>，最后它们被<code>链接到 CSSOM</code> 中。 浏览器会执行一些称为 <code>选择器匹配</code> 的操作，这意味着每组<code>样式都将与页面上的所有节点（元素）匹配</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ec4e0d.png"></p><p>浏览器从适用于节点的最通用规则开始（例如：如果节点是 body 元素的子节点，则所有 body 样式都由该节点继承），然后通过应用更具体的规则<code>递归地优化计算出的样式</code>。 这就是为什么我们说<code>样式规则</code>是<code>级联</code>的。</p><p>假设我们有下面的 HTML 和 CSS：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token selector">h1</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 32px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">section</span> <span class="token punctuation">&#123;</span>  <span class="token property">color</span><span class="token punctuation">:</span> tomato<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">section .mainTitle</span> <span class="token punctuation">&#123;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">&#125;</span><span class="token selector">div</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">div p</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span>  8px<span class="token punctuation">;</span>  <span class="token property">color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码的 CSSOM 看起来像这样：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ecb1e6.png"></p><p>请注意，在上面的模式中，嵌套元素既有<code>继承的样式</code>（来自父级 - 例如：h1 从 body 继承其颜色，section 从 body 继承其字体大小）和它们自己的样式（可以覆盖继承的规则 是否来自父节点 - 例如：p 覆盖了从 div 继承的颜色和字体大小，而 mainTitle 没有从父节点获得其左边距）。</p><p>由于我们的 CSS 可以有多个来源，并且它们可以包含适用于同一节点的规则，因此浏览器必须决定<code>最终应用哪个规则</code>。 这就是 <code>优先级</code> 发挥作用的时候，如果您想了解更多相关信息，可以访问此<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity">页面</a>。</p><p>想象一下，您在机场寻找您的朋友 John。 如果你想通过喊他的名字找到他，你可以喊 “ John ”。 可能不止一个 John 会同时出现在机场，所以他们可能都会做出回应。 更好的方法是用他的全名打电话给你的朋友，这样当你喊“John Doe”时，你就有更好的机会找到他，因为“ John Doe ”比“ John ”更具体。</p><p>同样，假设我们有这个元素：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;https://dev.to/><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>This is just a link!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以及这些CSS样式：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">a</span> <span class="token punctuation">&#123;</span>   <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">p  a</span> <span class="token punctuation">&#123;</span>   <span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>您认为浏览器会应用哪条规则？ 答案是第二条规则，因为 p 标签中的所有 a 标签选择器比所有a 标签选择器都具有<code>更高的优先级</code>。 </p><h3 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h3><p>CSS 规则是<code>从右到左</code>阅读的，这意味着如果我们有这样的代码： <code>section p &#123; color: blue; &#125;</code>, 浏览器将首先查找页面上的所有 <code>p</code> 标签，然后它会查看这些 p 标签中是否有一个 <code>section 标签</code>作为<code>父标</code>签。 如果查找能够命中，它将应用这个 CSS 规则</p><h2 id="5-执行Javascript"><a href="#5-执行Javascript" class="headerlink" title="5.执行Javascript"></a>5.执行Javascript</h2><p>在解析 CSS 并创建 CSSOM 的<code>同时</code>，还会<code>下载其他资产</code>，包括 JavaScript 文件。 这要归功于我们在之前文章中提到的<code>预加载器</code>。</p><blockquote><p><code>预加载器</code>就像一个解析器，它在主解析器处理 HTML 代码时扫描 HTML 文件。 它的作用是<code>查找样式表</code>、<code>脚本</code>或<code>图片</code>（也需要从服务器检索）等资源并<code>请求</code>它们。 希望在解析 HTML 时，这些资源已经<code>下载</code>并准备好进行处理。</p></blockquote><p>所以，当我们从服务器获取 Javascript 文件后，代码被<strong>解释</strong>、<strong>编译</strong>、<strong>解析和执行</strong>。 计算机无法理解 Javascript 代码，只有<code>浏览器可以</code>。 JS 代码需要被<code>翻译成计算机可以使用的东西</code>，这是 Javascript 浏览器引擎的工作（不要与浏览器引擎混淆）。 根据浏览器的不同，JS 引擎可以有不同的名称和不同的工作方式。</p><h3 id="Javascript-引擎"><a href="#Javascript-引擎" class="headerlink" title="Javascript 引擎"></a>Javascript 引擎</h3><p>javascript 引擎（有时也称为 ECMAScript 引擎）是一种在浏览器中执行（运行）Javascript 代码的软件，而不仅仅是零部件（例如，V8 引擎是 Node.js 环境的核心组件）。</p><p>JavaScript 引擎通常由 Web 浏览器供应商开发，每个主要浏览器都有一个。 我们说过，目前使用最多的浏览器是 Chrome、Safari、Edge 和 Firefox。 每个都使用不同的 Javascript 引擎，它们是：</p><p><strong>V8</strong> V8 是 Google 的高性能 JavaScript 引擎。 它是用 C++ 编写的，用于 Chrome 和 Node.js 等。 它实现了 ECMAScript（一种 JavaScript 标准，旨在确保网页在不同 Web 浏览器之间的互操作性）和 WebAssembley。 它实现了 ECMA-262。</p><p><strong>JavaScriptCore</strong> JavaScriptCore 是 WebKit 的内置 JavaScript 引擎，它为 Safari 浏览器、邮件和 macOS 上使用的其他应用程序提供支持。 它目前按照 ECMA-262 规范实现 ECMAScript。 它也被称为 SquirrelFish 或 SquirrelFish Extreme。</p><p><strong>Chakra</strong> Chakra 是微软为其 Microsoft Edge 网络浏览器和其他 Windows 应用程序开发的 Javascript 引擎。 它实现了 ECMAScript 5.1，并且对 ECMAScript 6 有部分（不断增加的）支持。它是用 C++ 编写的。</p><p><strong>SpiderMonkey</strong> SpiderMonkey 是 Mozilla 的 Javascript 和 WebAssembly 引擎。 它是用 C++、Javascript 和 Rust 编写的，用于为 Firefox、Servo 和其他项目提供支持。</p><p>一开始，Javascript 引擎只是简单的解释器。 我们今天使用的现代浏览器能够执行称为即时 (JIT) 编译的功能，这是编译和解释的混合体。</p><p><strong>编译</strong></p><p>在编译过程中，一个称为 <code>编译器</code> 的软件将用高级语言编写的代码一次性转换为机器代码。 创建一个<code>目标文件</code>，该文件可以在任何机器上运行。 采取这些步骤后，就可以执行代码了。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ed7421.png"></p><p><strong>解释</strong></p><p>在解释过程中，解释器逐行检查 Javascript 代码并立即执行。 没有进行编译，因此没有创建目标代码（代码的输出由解释器本身使用其内部机制创建）。 旧版本的 Javascript 使用这种类型的代码执行。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7edf85e.png"></p><p><strong>即时编译( JIT Compilation )</strong></p><p>即时编译是给定语言的解释器的一个特性，它试图<code>同时利用编译和解释</code>。 是在纯编译期间，代码是在执行之前被编译，然而在 JIT 编译中，代码在执行时（在运行时）被编译。 所以我们可以说源代码是动态转换为机器代码的。 较新版本的 Javascript 使用这种类型的代码执行。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f1de8a.png"></p><p>JIT 编译的一个很重要的方面就是将源代码编译成当前正在运行的机器的机器码指令。 这意味着生成的机器代码是针对正在运行的机器的 CPU 架构进行了优化。</p><p>简而言之，这三个过程可以总结为：</p><ul><li>编译器：编译代码</li><li>解释器：运行代码</li><li>JIT 编译器：在运行代码时进行编译</li></ul><p>今天，<code>编译</code>和<code>解释</code>这两个术语之间的界限已经变得非常模糊，因此这个主题可以进行广泛的辩论。</p><p>请注意，我提到了旧版本和新版本的 Javascript。 不支持较新版本语言的浏览器将解释代码，而支持的浏览器将使用某些版本的 JIT 来执行代码（V8、Chakra JavaScriptCore 和 SpiderMonkey 引擎都使用 JIT）。 事实上，尽管 Javascript 是一种解释型语言（它不需要编译），但如今大多数浏览器都会使用 JIT 编译来运行代码，而不是纯粹的解释型语言。</p><h3 id="Javascript-代码是如何处理的"><a href="#Javascript-代码是如何处理的" class="headerlink" title="Javascript 代码是如何处理的"></a>Javascript 代码是如何处理的</h3><p>当 Javascript 代码进入 Javascript 引擎时，它首先被<code>解析</code>。 这意味着代码被读取，并且在这种情况下，代码被转换为称为<code>抽象语法树</code> (<code>AST</code>) 的数据结构。 代码将被拆分成与语言相关的部分（如 <code>function</code> 或 <code>const</code> 关键字），然后所有这些部分将构建抽象语法树。</p><p>假设我们有一个文件，其中包含一个只做一件事的程序，那就是定义一个变量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这就是这行非常简单的代码<code>看起来像抽象语法树</code>的方式（我正在使用@babel/parser-7.16.12）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f2e5b4.png"></p><p>如果你想将一些 Javascript 转换为抽象语法树，你可以使用这个<a href="https://astexplorer.net/">工具</a>。 编写变量后得到的 AST 实际上要大得多，在屏幕截图中隐藏了更多节点。</p><p><code>构建 AST </code>后，它会被翻译成机器代码并<code>立即执行</code>，因为现代 Javascript 使用即时编译。 这段代码的执行将由 Javascript 引擎完成，利用称为<code>“调用堆栈”</code>的东西。</p><blockquote><p>调用堆栈是解释器（如 Web 浏览器中的 JavaScript 解释器）跟踪其在调用多个函数的脚本中的位置的机制——当前正在运行的函数以及从该函数中调用的函数等。</p></blockquote><h2 id="6-创建可访问（无障碍）树"><a href="#6-创建可访问（无障碍）树" class="headerlink" title="6.创建可访问（无障碍）树"></a>6.创建可访问（无障碍）树</h2><p>除了我们一直在讨论的所有这些树（DOM、CSSOM 和 AST）之外，浏览器还构建了一种称为<code>可访问（无障碍）树</code>的东西。</p><blockquote><p>Web 开发中的可访问性（通常缩写为 A11y — 如“a”，然后是 11 个字符，然后是“y”）意味着让尽可能多的人能够使用网站，即使这些人的能力在某种程度上受到限制。 对很多人来说，技术让事情变得更容易。 对于残障人士，技术使事情成为可能。 可访问性意味着开发尽可能易于访问的内容，无论个人的身体和认知能力以及他们如何访问网络 (ACT)。</p></blockquote><p>一般而言，残疾用户可以并且确实在使用具有各种辅助技术的网页。 他们使用屏幕阅读器、放大镜、眼动追踪、语音命令等。 为了让这些技术发挥作用，它们需要能够访问页面的内容。 由于他们无法直接读取 DOM，因此 ACT 开始发挥作用。<br>可访问性树是使用 DOM 构建的，稍后辅助设备将使用它来解析和解释我们正在访问的网页的内容。 ACT 就像 DOM 的语义版本，每次 DOM 更新时它都会更新。 每个需要暴露给辅助技术的 DOM 元素都会在 ACT 中有一个对应节点。 在未构建 ACT 之前，屏幕阅读器无法访问内容。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f4e49e.png"></p><p>要查看可访问性树的实际的样子，您可以通过 Google Chrome 浏览器。 打开调试器 (F12) 并转到“元素”选项卡。 从那里，你可以在右侧选择“辅助功能”窗格。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f6cf4f.png"></p><p>我去 Google 并检查了搜索输入，这是我在“计算”属性下的“辅助功能”窗格中得到的：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f7a09e.png"></p><p>使用语义 HTML 的重要性超出了本文的范围，但作为开发人员，我们都应该记住，我们构建的网站应该可供所有希望使用它们的人使用。 如果您想阅读有关该主题的更多信息，可以在此处找到一篇关于 Web 可访问性的很好的介绍性文章。 据 <code>互联网协会无障碍访问特别兴趣小组</code> 称，目前全世界有超过 13 亿人（约占世界人口的 <code>15%</code>）患有某种形式的残疾。</p><h2 id="7-渲染树"><a href="#7-渲染树" class="headerlink" title="7.渲染树"></a>7.渲染树</h2><p>在解析阶段构建的树（DOM、CSSOM）被组合成一种叫做 <code>渲染树</code> 的东西。 这用于计算最终将绘制到屏幕上的所有可见元素的布局。 渲染树的目的是确保页面内容以正确的顺序绘制元素。 它将作为在屏幕上显示像素的绘画过程的输入。</p><p>DOM 和 CSSOM 是使用 HTML 和 CSS 文件创建的。 这两个文件包含不同类型的信息，树的结构也不同，那么渲染树是如何创建的呢？</p><h3 id="结合-DOM-和-CSSOM"><a href="#结合-DOM-和-CSSOM" class="headerlink" title="结合 DOM 和 CSSOM"></a>结合 DOM 和 CSSOM</h3><ul><li>浏览器将开始在 DOM 树的根部施展魔法并遍历每个可见节点。 一些节点，如脚本或元标记是不可见的，因此它们被忽略。 还有一些节点会被 CSS 隐藏（例如 display: “none” 属性），它们也会被忽略。 我们只对可见节点感兴趣，因为只有它们对屏幕上的输入有影响。</li><li>对于在 DOM 中找到的每个可见节点，将在 CSSOM 中找到相应的规则并应用它们。</li></ul><p>以上步骤的结果将是一个包含所有可见节点、内容和样式的<code>渲染树</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f86fe3.png"></p><h3 id="布局（回流）阶段"><a href="#布局（回流）阶段" class="headerlink" title="布局（回流）阶段"></a>布局（回流）阶段</h3><p>渲染树包含有关显示哪些节点及其计算样式的信息，但不包含每个节点的尺寸或位置。</p><p>接下来需要做的是计算这些节点在设备视口（浏览器窗口内）内的确切位置及其大小。 这个阶段称为布局（在 Chrome、Opera、Safari 和 Internet Explorer 中）或重排（在 Firefox 中），但它们的意思相同。 浏览器在渲染树的根部开始这个过程并遍历它。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7fa93c0.png"></p><p>回流步骤不会只发生一次，而是每次我们<code>更改 DOM</code> 中<code>影响页面布局的</code>某些内容时，即使是<code>部分更改</code>，都会触发回流。 重新计算元素位置的情况示例如下：</p><ul><li>在 DOM 中添加或删除元素</li><li>调整浏览器窗口大小</li><li>更改元素的宽度、位置或使其浮动</li></ul><p>让我们来看一个非常基本的 HTML 示例，其中内嵌了一些 CSS：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Reflow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 50%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 50%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>This is the reflow stage!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码只是说在视口内我们应该有两个 div，其中第二个嵌套在第一个里面。 父 div 占据视口宽度的 100%和高度的 50%。第二个 div 占据父 div 的 50% 这看起来像这样：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb801a105.png"></p><p>这个过程的输出是一个 <code>类似盒子的模型</code> ，它准确地捕获了每个元素需要在屏幕上的位置及其大小。 完成此步骤后，输出就可以传递到下一步，称为<code>绘画阶段</code>。</p><h3 id="绘画（重绘）阶段"><a href="#绘画（重绘）阶段" class="headerlink" title="绘画（重绘）阶段"></a>绘画（重绘）阶段</h3><p>在浏览器决定哪些节点需要可见并计算出它们在视口中的位置后，就可以在屏幕上绘制它们（渲染像素）了。 这个阶段也被称为 <code>光栅化阶段</code> ，浏览器将在布局阶段计算的每个盒子转换为屏幕上的实际像素。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb801c683.png"></p><p>就像布局阶段一样，绘画阶段不会只发生一次，而是每次我们改变屏幕上元素的<code>外观</code>时。 这些情况的例子是：</p><ul><li>改变元素的轮廓</li><li>改变背景颜色</li><li>改变不透明度或可见性</li></ul><p>绘画意味着浏览器需要将元素的每个视觉部分绘制到屏幕上，包括文本、颜色、边框、阴影和替换元素（如按钮和图像），并且需要超快地完成。 为了确保重绘可以比初始绘制更快地完成，屏幕上的绘图通常被<code>分解成几层</code>。 如果发生这种情况，则需要进行<code>合成</code>。</p><h3 id="分层和合成"><a href="#分层和合成" class="headerlink" title="分层和合成"></a>分层和合成</h3><p>传统意义上，网络浏览器完全依赖 CPU 来呈现网页内容。 但现在即使是最小的设备也有高性能的 GPU，所有大部分实现方案都围绕着 GPU 来寻求更好的体验。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb80540cc.png"></p><blockquote><p>合成是一种将页面的各个部分分成层的技术，分别绘制它们并在称为合成器线程的单独线程中合成为页面。 当文档的各个部分绘制在不同的层中并相互重叠时，合成是必要的，以确保它们以正确的顺序绘制到屏幕上并且内容被正确呈现。</p></blockquote><p>通常，只有特定的任务会被重定向到 GPU，而这些任务可以由合成器线程单独处理。<br>为了找出哪些元素需要在哪一层，主线程遍历布局树并创建层树。 默认情况下，只有一层（这些层的实现方式因浏览器而异），但我们可以找到会触发重绘的元素，并为每个元素创建一个单独的层。 这样，重绘不应应用于整个页面，而且此过程将可以使用到 GPU</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb8059efa.png"></p><p>如果我们想向浏览器提示某些元素应该在一个单独的层上，我们可以使用 <code>will-change</code> CSS 属性。 实际上有一些特定的属性和元素表示新层的创建。 其中一些是 <code>&lt;video&gt;</code>、<code>&lt;canvas&gt;</code> 和任何具有 CSS <code>opacity</code> 属性、3D <code>transform</code>、<code>will-change</code> 和其他一些属性的元素。 这些节点连同它们的后代将被绘制到它们自己的图层上。</p><h3 id="谨记"><a href="#谨记" class="headerlink" title="谨记"></a>谨记</h3><p>上面讨论的两种操作，回流和重绘，都是<code>昂贵</code>的，尤其是在像手机这样处理能力低的设备上。 这就是为什么在处理 DOM 更改时我们应该尝试<code>优化</code>它们。 <code>有些动作只会触发重绘，有些动作会同时触发回流和重绘</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常用正则表达式</title>
      <link href="/posts/87a8.html"/>
      <url>/posts/87a8.html</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><h2 id="常用正则表达式"><a href="#常用正则表达式" class="headerlink" title="常用正则表达式"></a>常用正则表达式</h2><h3 id=""><a href="#" class="headerlink" title=""></a><p class='p blue'>有效数字</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/* * 规则分析 * 1.可能出现 + - 号，也可能不出现  [+-]? * 2.一位0-9都可以，多位首位不能是0 (\d|([1-9]\d+)) * 3.小数部分可能有可能没有，一旦有后面必须有小数点+数字 (\.\d+)? */</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[+-]?(\d|([1-9]\d+))(\.\d+)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-1"><a href="#-1" class="headerlink" title=""></a><p class='p blue'>密码</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//=>数字、字母、下划线</span><span class="token comment">//=>6~16位</span><span class="token keyword">let</span> val <span class="token operator">=</span> userPassInp<span class="token punctuation">.</span>value<span class="token punctuation">,</span>    reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\w&#123;6,16&#125;$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span class="token keyword">let</span> flag<span class="token operator">=</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*function checkPass(val)&#123;    if(val.length&lt;6 || val.length>16)&#123;        alert('长度必须介于6-16位之间！');        return;    &#125;    let area=['a','b'....'_']; //=>包含数字、字母、下划线    for(let i=0;i&lt;val.length;i++)&#123;        let char=val[i];        if(!area.includes(char))&#123;            alert('格式不正确！');            return;        &#125;    &#125;&#125;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-2"><a href="#-2" class="headerlink" title=""></a><p class='p blue'>真实姓名</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/* * 1.汉字  /^[\u4E00-\u9FA5]$/ * 2.名字长度 2~10位 * 3.可能有译名 ·汉字  (·[\u4E00-\u9FA5]&#123;2,10&#125;)&#123;0,2&#125; */</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\u4E00-\u9FA5]&#123;2,10&#125;(·[\u4E00-\u9FA5]&#123;2,10&#125;)&#123;0,2&#125;$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-3"><a href="#-3" class="headerlink" title=""></a><p class='p blue'>邮箱</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\w+((-\w+)|(\.\w+))*@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>​<span class="token comment">//=> \w+((-\w+)|(\.\w+))*</span><span class="token comment">//1.开头是数字字母下划线（1到多位）</span><span class="token comment">//2.还可以是 -数字字母下划线 或者 .数字字母下划线,整体零到多次</span><span class="token comment">//=>邮箱的名字由“数字、字母、下划线、-、.”几部分组成，但是-/.不能连续出现也不能作为开始</span>​<span class="token comment">//=> @[A-Za-z0-9]+</span><span class="token comment">//1.@后面紧跟着：数字、字母 （1-多位）</span>​<span class="token comment">//=> ((\.|-)[A-Za-z0-9]+)*</span><span class="token comment">//1.对@后面名字的补充</span><span class="token comment">// 多域名     .com.cn</span><span class="token comment">// 企业邮箱    zxt@zhufeng-peixun-office.com</span>​<span class="token comment">//=> \.[A-Za-z0-9]+</span><span class="token comment">//1. 这个匹配的是最后的域名（.com/.cn/.org/.edu/.net...）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-4"><a href="#-4" class="headerlink" title=""></a><p class='p blue'>身份证号</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/* * 1. 一共18位 * 2. 最后一位可能是X * * 身份证前六位：省市县  130828 * 中间八位：年月日 * 最后四位： *   最后一位 => X或者数字 *   倒数第二位 => 偶数 女  奇数 男 *   其余的是经过算法算出来的 */</span><span class="token comment">//let reg = /^\d&#123;17&#125;(\d|X)$/;</span><span class="token comment">//=>小括号分组的第二个作用：分组捕获，不仅可以把大正则匹配的信息捕获到，还可以单独捕获到每个小分组的内容</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(\d&#123;6&#125;)(\d&#123;4&#125;)(\d&#123;2&#125;)(\d&#123;2&#125;)\d&#123;2&#125;(\d)(\d|X)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"130828199012040617"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=>["130828199012040617", "130828", "1990", "12", "04", "1", "7"...] 捕获结果是数组，包含每一个小分组单独获取的内容</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-5"><a href="#-5" class="headerlink" title=""></a><p class='p blue'>html标签（宽松匹配）</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;(\w+)[^>]*>(.*?&lt;\/\1>)?</span><span class="token regex-delimiter">/</span></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&lt;span>&lt;/span>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reg10<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&lt;span>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reg10<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&lt;spa'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-6"><a href="#-6" class="headerlink" title=""></a><p class='p blue'>手机号（mobile phone）中国（严谨）</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:(?:\+|00)86)?1(?:(?:3[\d])|(?:4[5-79])|(?:5[0-35-9])|(?:6[5-7])|(?:7[0-8])|(?:8[\d])|(?:9[1589]))\d&#123;8&#125;$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-7"><a href="#-7" class="headerlink" title=""></a><p class='p blue'>手机号（mobile phone）中国（宽松）</p></h3><p>只要是13、14、15、16、17、18、19开头即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:(?:\+|00)86)?1[3-9]\d&#123;9&#125;$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-8"><a href="#-8" class="headerlink" title=""></a><p class='p blue'>网址</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(((ht|f)tps?):\/\/)?([^!@#$%^&amp;*?.\s-]([^!@#$%^&amp;*?.\s]&#123;0,63&#125;[^!@#$%^&amp;*?.\s])?\.)+[a-z]&#123;2,6&#125;\/?</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-9"><a href="#-9" class="headerlink" title=""></a><p class='p blue'>座机电话（国内）</p></h3><p>0354-62001234</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:(?:\d&#123;3&#125;-)?\d&#123;8&#125;|^(?:\d&#123;4&#125;-)?\d&#123;7,8&#125;)(?:-\d+)?$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-10"><a href="#-10" class="headerlink" title=""></a><p class='p blue'>统一社会信用代码（宽松匹配）</p></h3><p>15、18、20位数字或字母</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(([0-9A-Za-z]&#123;15&#125;)|([0-9A-Za-z]&#123;18&#125;)|([0-9A-Za-z]&#123;20&#125;))$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-11"><a href="#-11" class="headerlink" title=""></a><p class='p blue'>域名</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([0-9a-zA-Z-]&#123;1,&#125;\.)+([a-zA-Z]&#123;2,&#125;)$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-12"><a href="#-12" class="headerlink" title=""></a><p class='p blue'>A股股票代码</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(s[hz]|S[HZ])(000[\d]&#123;3&#125;|002[\d]&#123;3&#125;|300[\d]&#123;3&#125;|600[\d]&#123;3&#125;|60[\d]&#123;4&#125;)$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-13"><a href="#-13" class="headerlink" title=""></a><p class='p blue'>火车车次</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[GCDZTSPKXLY1-9]\d&#123;1,4&#125;$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-14"><a href="#-14" class="headerlink" title=""></a><p class='p blue'>16进制颜色</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#?([a-fA-F0-9]&#123;6&#125;|[a-fA-F0-9]&#123;3&#125;)$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-15"><a href="#-15" class="headerlink" title=""></a><p class='p blue'>ip-v4</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.)&#123;3&#125;(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])(?::(?:[0-9]|[1-9][0-9]&#123;1,3&#125;|[1-5][0-9]&#123;4&#125;|6[0-4][0-9]&#123;3&#125;|65[0-4][0-9]&#123;2&#125;|655[0-2][0-9]|6553[0-5]))?$</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="-16"><a href="#-16" class="headerlink" title=""></a><p class='p blue'>ip-v6</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(^(?:(?:(?:[0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;:[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)?[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,2&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,3&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,4&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;:((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|(::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|([0-9A-Fa-f]&#123;1,4&#125;::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,6&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1,7&#125;:))$)|(^\[(?:(?:(?:[0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;:[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)?[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,2&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,3&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;:([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,4&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;:((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|(::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;((\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b)\.)&#123;3&#125;(\b((25[0-5])|(1\d&#123;2&#125;)|(2[0-4]\d)|(\d&#123;1,2&#125;))\b))|([0-9A-Fa-f]&#123;1,4&#125;::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,5&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(::([0-9A-Fa-f]&#123;1,4&#125;:)&#123;0,6&#125;[0-9A-Fa-f]&#123;1,4&#125;)|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1,7&#125;:))\](?::(?:[0-9]|[1-9][0-9]&#123;1,3&#125;|[1-5][0-9]&#123;4&#125;|6[0-4][0-9]&#123;3&#125;|65[0-4][0-9]&#123;2&#125;|655[0-2][0-9]|6553[0-5]))?$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><h3 id="-17"><a href="#-17" class="headerlink" title=""></a><p class='p blue'>获取URL地址问好和后面的参数信息（可能也包含HASH值）</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * queryURLParams：获取URL地址问号和面的参数信息（可能也包含HASH值） * @params * @returns [object]把所有问号参数信息以键值对的方式存储起来并且返回 */</span><span class="token keyword">function</span> <span class="token function">queryURLParams</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([^?=&amp;#]+)=([^?=&amp;#]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">,</span> $1<span class="token punctuation">,</span> $2<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> obj<span class="token punctuation">[</span>$1<span class="token punctuation">]</span> <span class="token operator">=</span> $2<span class="token punctuation">)</span><span class="token punctuation">;</span>    url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#([^?=&amp;#]+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">,</span> $1<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> obj<span class="token punctuation">[</span><span class="token string">'HASH'</span><span class="token punctuation">]</span> <span class="token operator">=</span> $1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-18"><a href="#-18" class="headerlink" title=""></a><p class='p blue'>时间字符串的格式化处理</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*  * formatTime：时间字符串的格式化处理  *   @params  *     templete:[string] 我们最后期望获取日期格式的模板  *     模板规则:&#123;0&#125;->年  &#123;1~5&#125;->月日时分秒  *   @return  *     [string]格式化后的时间字符串  */</span><span class="token keyword">function</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>templete <span class="token operator">=</span> <span class="token string">"&#123;0&#125;年&#123;1&#125;月&#123;2&#125;日 &#123;3&#125;时&#123;4&#125;分&#123;5&#125;秒"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> timeAry <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> templete<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\&#123;(\d+)\&#125;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span><span class="token punctuation">[</span><span class="token punctuation">,</span> $1<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">let</span> time <span class="token operator">=</span> timeAry<span class="token punctuation">[</span>$1<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"00"</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> time<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">"0"</span> <span class="token operator">+</span> time <span class="token operator">:</span> time<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-19"><a href="#-19" class="headerlink" title=""></a><p class='p blue'>实现大数字的千分符处理</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*   * millimeter：实现大数字的千分符处理  *   @params  *   @return  *     [string]千分符后的字符串  */</span><span class="token keyword">function</span> <span class="token function">millimeter</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d&#123;1,3&#125;(?=(\d&#123;3&#125;)+$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token parameter">content</span> <span class="token operator">=></span> content <span class="token operator">+</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-20"><a href="#-20" class="headerlink" title=""></a><p class='p blue'>单词首字母大写</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">"good good study，day day up！"</span><span class="token punctuation">;</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\b([a-zA-Z])[a-zA-Z]*\b</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span><span class="token comment">//=>函数被执行了六次，每一次都把正则匹配信息传递给函数</span><span class="token comment">//=>每一次ARG:["good","g"] ["good","g"] ["study","s"]...</span>str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>content<span class="token punctuation">,</span>$1<span class="token punctuation">]</span><span class="token operator">=</span>arg<span class="token punctuation">;</span>    $1<span class="token operator">=</span>$1<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    content<span class="token operator">=</span>content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> $1<span class="token operator">+</span>content<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=>"Good Good Study，Day Day Up！"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 总结 </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式总结</title>
      <link href="/posts/1f2a.html"/>
      <url>/posts/1f2a.html</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式总结"><a href="#正则表达式总结" class="headerlink" title="正则表达式总结"></a>正则表达式总结</h1><h2 id="正则作用"><a href="#正则作用" class="headerlink" title="正则作用"></a>正则作用</h2><ul><li>给定的字符串是否符合正则表达式的过滤逻辑 <span class='p blue'>（匹配）</span>。</li><li>可以通过正则表达式，从字符串中获取我们想要的特定部分 <span class='p blue'>（提取）</span>。</li><li>强大的字符串替换能力<span class='p blue'>（替换）</span>。</li></ul><h2 id="正则概述"><a href="#正则概述" class="headerlink" title="正则概述"></a>正则概述</h2><p>正则表达式（Regular Expression）是用于描述一组字符串特征的模式，用来匹配特定的字符串。通过特殊字符+普通字符来进行模式描述，从而达到文本匹配目的工具。因此正则表达式是用于匹配字符串中字符组合的模式。</p><h2 id="编写正则表达式"><a href="#编写正则表达式" class="headerlink" title="编写正则表达式"></a>编写正则表达式</h2><h3 id=""><a href="#" class="headerlink" title=""></a><p class='p blue'>正则创建方式</p></h3><ul><li><p class='p blue'>字面量创建</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 两个斜杠之间包起来的，都是用来描述规则的元字符（不可添加变量）</span><span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d+</span><span class="token regex-delimiter">/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p class='p blue'>构造函数创建</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 有两个参数：元字符字符串，修饰符字符串，元字符中间可以添加变量</span><span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'\\d+'</span><span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'\\d+'</span> <span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="-1"><a href="#-1" class="headerlink" title=""></a><p class='p blue'>两种创建方式的区别</p></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 构造函数因为传递的是字符串，\需要写两个才代表斜杠</span><span class="token keyword">let</span> reg1 <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token keyword">let</span> reg2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'\\d+'</span><span class="token punctuation">,</span><span class="token string">'g'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>两个 / 中间包起来的都是元字符</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 如果正则中要包含某个变量的值，则不能使用字面量方式创建</span><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'gzy'</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^@"+str+"@$</span><span class="token regex-delimiter">/</span></span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'@gzy@'</span><span class="token punctuation">)</span>  <span class="token comment">// false</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'@""strrr"@'</span><span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>有需要变量的需求只能用构造函数创建</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">'gzy'</span><span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^@"+str+"@$'</span><span class="token punctuation">)</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'@gzy@'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="正则表达式语法"><a href="#正则表达式语法" class="headerlink" title="正则表达式语法"></a>正则表达式语法</h2><ul><li>普通字符 abc 中国 123 等</li><li>特殊字符（元字符、限定符、中括号）：正则表达式中有特殊意义的字符</li></ul><h3 id="-2"><a href="#-2" class="headerlink" title=""></a><p class='p blue'>元字符</p></h3><p>元字符就是在正则表达式中具有<p class='p blue'>特殊含义</p>的字符</p><table><thead><tr><th>元字符</th><th>说明</th></tr></thead><tbody><tr><td>\d</td><td>匹配<code>数字</code></td></tr><tr><td>\D</td><td>匹配<code>非数字</code></td></tr><tr><td>\w</td><td>匹配<code>字母</code>或<code>数字</code>或<code>下划线_</code></td></tr><tr><td>\W</td><td>匹配<code>非字母、数字、下划线_</code></td></tr><tr><td>\s</td><td>匹配<code>空白符</code>（空格）</td></tr><tr><td>\S</td><td>匹配<code>非空白符</code></td></tr><tr><td>.</td><td>匹配任意<code>除了换行符（回车键）之外的单个字符</code></td></tr><tr><td></td><td></td></tr></tbody></table><h3 id="-3"><a href="#-3" class="headerlink" title=""></a><p class='p blue'>限定符</p></h3><p>限定符就是控制字符出现的<span class='p blue'>次数</span>，对字符<span class='p blue'>个数限制</span></p><table><thead><tr><th>限定符</th><th>说明</th></tr></thead><tbody><tr><td>n*</td><td>匹配任何包含<code>零个</code>或者<code>多个</code>n的字符串。n{0,}</td></tr><tr><td>n+</td><td>匹配任何包含<code>至少一个</code>n的字符串。n{1,}</td></tr><tr><td>n?</td><td>匹配任何包含<code>零个</code>或<code>一个</code>n的字符串。{0,1}</td></tr><tr><td>n{x}</td><td>匹配包含<code>x个</code>n的序列的字符串。</td></tr><tr><td>n{x,}</td><td>匹配包含<code>至少x个</code>n的序列的字符串。</td></tr><tr><td>n{x,y}</td><td>匹配包含<code>至少x个至多y个</code>n的序列的字符串。</td></tr><tr><td>n$</td><td>匹配任何<code>结尾</code>为n的字符串。</td></tr><tr><td>^n</td><td>匹配任何<code>开头</code>为n的字符串。</td></tr></tbody></table><ul><li>正则表达式使用时，会对字符串整体校验，完全符合才能够匹配。否则不匹配。</li><li>针对花括号中次数限制，在去匹配字符串时，首先是从前先后匹配，先按照至多次数匹配，若至多不符合要求，则再按照较少的匹配。</li><li>针对花括号中次数限制至少是0时，此时若字符串中没有匹配的项是符合要求的，若字符串中的字符不匹配也是符合要求的。</li></ul><h3 id="-4"><a href="#-4" class="headerlink" title=""></a><p class='p blue'>中括号</p></h3><p>一个中括号就代表一个字符串，中括号的目的解视控制一个字符的范围。</p><table><thead><tr><th>中括号</th><th>说明</th></tr></thead><tbody><tr><td>[abc]</td><td>查找一个括号之间的任何字符。</td></tr><tr><td>[^abc]</td><td>查找一个任何不在方括号之间的字符，^在中括号中有取反的意思。</td></tr><tr><td>[0-9]</td><td>查找一个任何从0至9的数字。</td></tr><tr><td>[a-z]</td><td>查找一个任何从小写a到小写z的字符。</td></tr><tr><td>[A-Z]</td><td>查找一个任何从大写A到大写Z的字符。</td></tr><tr><td>[A-z]</td><td>查找一个字母（包含大小写和下划线）。</td></tr><tr><td>[[\u4e00-\u9fa5]]</td><td>查找一个汉字。</td></tr></tbody></table><h3 id="-5"><a href="#-5" class="headerlink" title=""></a><p class='p blue'>或模式</p></h3><p>特殊符号：正则1|正则2, 或者。 符合或两边其中一个就可以匹配。</p><p>如：google，baidu，bing; // 匹配三种其中一种字符串</p><p>正则：google|baidu|bing</p><h3 id="-6"><a href="#-6" class="headerlink" title=""></a><p class='p blue'>分组模式</p></h3><p>特殊符号： (正则) ;</p><p>组指的是一个小集体，分组就是将一个大集体可以分成几个小集体。</p><p>如：控制你的名字连续出现的次数，最少1次，最多3次</p><p>正则：^(bruce){1,3}$</p><h3 id="-7"><a href="#-7" class="headerlink" title=""></a><p class='p blue'>修饰符</p></h3><table><thead><tr><th>修饰符</th><th>全称</th><th>说明</th></tr></thead><tbody><tr><td>i</td><td>ignoreCase</td><td>忽略单词大小写匹配</td></tr><tr><td>m</td><td>multiline</td><td>可以进行多行匹配</td></tr><tr><td>g</td><td>global</td><td>全局匹配</td></tr></tbody></table><h2 id="相关方法"><a href="#相关方法" class="headerlink" title="相关方法"></a>相关方法</h2><h3 id="-8"><a href="#-8" class="headerlink" title=""></a><p class='p blue'>正则常用方法</p></h3><table><thead><tr><th>方法</th><th>描述</th><th>返回</th></tr></thead><tbody><tr><td><code>test</code></td><td>检查字符串中是否含有检测的字符</td><td>boolean</td></tr><tr><td><code>exec</code></td><td>寻找字符串中是否含有检测的字符</td><td>将找到的字符串按数组返回</td></tr></tbody></table><ul><li><p class='p blue'>test</p> </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">str</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//要求字符串包含string，所以返回false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p class='p blue'>exec</p> </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">ab</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token string">"abababab"</span><span class="token punctuation">;</span>reg<span class="token punctuation">.</span>lastIndex <span class="token comment">//0</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//["ab",index:0,input:"abababab"]</span>reg<span class="token punctuation">.</span>lastIndex<span class="token comment">//2</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//["ab",index:2,input:"abababab"]</span>reg<span class="token punctuation">.</span>lastIndex<span class="token comment">//4</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//["ab",index:4,input:"abababab"]</span>reg<span class="token punctuation">.</span>lastIndex<span class="token comment">//6</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//["ab",index:6,input:"abababab"]</span>reg<span class="token punctuation">.</span>lastIndex<span class="token comment">//8</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//null</span>reg<span class="token punctuation">.</span>lastIndex<span class="token comment">//0</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">//["ab",index:0,input:"abababab"]</span><span class="token comment">//reg.lastIndex是可手动修改的</span>reg<span class="token punctuation">.</span>lastIndex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// reg.lastIndex重置0</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token comment">// ["ab",index:0,input:"abababab"]，与上面结果中的index相同</span><span class="token comment">// 若匹配规则不含有global属性，那在允许exec()方法后lastIndex值始终为0</span><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">ab</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token string">"abababab"</span><span class="token punctuation">;</span>reg<span class="token punctuation">.</span>lastIndex <span class="token comment">// 0</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token comment">// ["ab",index:0,input:"abababab"]</span>reg<span class="token punctuation">.</span>lastIndex <span class="token comment">// 0</span>reg<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token comment">// ["ab",index:0,input:"abababab"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-9"><a href="#-9" class="headerlink" title=""></a><p class='p blue'>字符串常用方法</p></h3><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>search</code></td><td>检索与正则表达式相匹配的值，返回匹配字符串的位置，匹配不到时返回 -1</td></tr><tr><td><code>match</code></td><td>找到一个或多个正则表达式的匹配，在规则中是否含义global属性时返回匹配数组</td></tr><tr><td><code>replace</code></td><td>替换为正则表达式匹配的字符串</td></tr><tr><td><code>split</code></td><td>把字符串按照正则分为字符串数组</td></tr></tbody></table><ul><li><p class='p blue'>search</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">w</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token comment">// 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p class='p blue'>match</p> </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span><span class="token keyword">const</span> reg1 <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">o</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['o', index: 4, input: 'hello world', groups: undefined]</span><span class="token keyword">const</span> reg2 <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">o</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['o', 'o']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p class='p blue'>replace</p> </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"hello world"</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">world</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"baidu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello baidu</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p class='p blue'>split</p> </li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token string">"a1b2c"</span><span class="token punctuation">;</span><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["a","b","c"]，即将分隔符两侧的字符串进行拆分</span><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\d)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// "()"代表记录反向引用,将匹配表达式也返回回来</span>str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["a","1","b","2","c"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="-10"><a href="#-10" class="headerlink" title=""></a><p class='p blue'>捕获组与非捕获组</p></h3><p>正则表达式分组分为<code>捕获组</code>（Capturing Groups）与<code>非捕获组</code>Non-Capturing Groups。正则里面是用成对的小括号来表示分组的，如(\d)表示一个分组，(\d)(\d)表示有两个分组，(\d)(\d)(\d)表示有三个分组，有几对小括号元字符组成，就表示有几个分组。</p><ul><li><p>分组的目的</p><ul><li>作为可选分支</li><li>简写重复模式</li><li>缓存捕获数据及反向引用（只有捕获组才可以被反向引用）</li></ul></li><li><p>捕获组</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\w)+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span> <span class="token comment">//(\w)组成一个捕获组</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>非捕获组</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:\w)+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span> <span class="token comment">//(?:\w)组成一个非捕获组</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><span class='p blue'>不需要用到分组里面的内容的时候</span>，用非捕获组，主要是为了提升效率，因为捕获组多了一步保存数据的步骤，所以一般会多耗费一些时间。<ul><li>命名捕获组</li></ul><p>捕获组其实是分为编号捕获组Numbered Caputuring Groups和命名捕获组Named Capturing Groups的，我们上面说的捕获组，默认指的是编号捕获组。命名捕获组，也是捕获组，只是语法不一样。命名捕获组的语法如下：(?group) 或 (?’name’group)，其中 name 表示捕获组的名称，group 表示捕获组里面的正则。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token string">'2022-12-15'</span><span class="token punctuation">;</span><span class="token keyword">const</span> reg <span class="token operator">=</span>  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token comment">// ['2022-12-15', '2022', '12', '15', index: 0, input: '2022-12-15', groups: undefined]</span><span class="token keyword">const</span> isNotCaputuringReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:\d&#123;4&#125;)-(?:\d&#123;2&#125;)-(?:\d&#123;2&#125;)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>isNotCaputuringReg<span class="token punctuation">)</span><span class="token comment">// ['2022-12-15', index: 0, input: '2022-12-15', groups: undefined]</span><span class="token keyword">const</span> namedCaputuringReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;year>\d&#123;4&#125;)-(?&lt;month>\d&#123;2&#125;)-(?&lt;day>\d&#123;2&#125;)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>namedCaputuringReg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.guozy.online/img/2023/09/ebf88cc9a010d8dc104f1fe3975ab817.png" alt="命名捕获组"></p><h3 id="-11"><a href="#-11" class="headerlink" title=""></a><p class='p blue'>贪婪匹配与非贪婪匹配</p></h3><p>贪婪匹配即照着”量词”规则中要求的<code>更多个</code>的情况去做匹配。</p><p>非贪婪匹配，在”量词”规则后边多加一个问号”?”。</p><p>“量词”包括 ?、*、+、{}、{n,}、{n,m}</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str<span class="token operator">=</span><span class="token string">"aaaaa"</span><span class="token punctuation">;</span><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//["aaaaa"]</span><span class="token keyword">var</span> reg<span class="token operator">=</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a??</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span><span class="token comment">//第一个问号代表0~1个，第二个问号代表能取0就不取1去做匹配</span>str<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//["","","","","",""]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="问号在正则中的五大作用"><a href="#问号在正则中的五大作用" class="headerlink" title="问号在正则中的五大作用"></a>问号在正则中的五大作用</h4><ul><li>问号左边是非量词元字符：本身代表量词元字符，出现零到一次</li><li>问号左边是量词元字符:取消捕获时候的贪婪性</li><li>(?:)只匹配不捕获</li><li>(?=)正向预查</li><li>(?!)负向预查</li></ul><h3 id="-12"><a href="#-12" class="headerlink" title=""></a><p class='p blue'>反向引用</p></h3><p>反向引用就是正则中’ \1 ‘用法，下列代码中(\w)首先匹配a，’\1’引用a，后面量词’+’表示出现一次获多次。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'aaaaabbbbbbcccccccd'</span><span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\w)\1+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span><span class="token string">'$1'</span><span class="token punctuation">)</span> <span class="token comment">// $1是第一个小括号中的内容</span><span class="token comment">// abc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考文章-手册"><a href="#参考文章-手册" class="headerlink" title="参考文章/手册"></a>参考文章/手册</h2><p><a href="https://juejin.cn/post/7021672733213720613?searchId=20230910143127ABD476DA9BBF4333B5D5">就因为这三个知识点，我彻底学废了”正则表达式“</a><br><a href="https://juejin.cn/post/6844903430637486088?searchId=20230910145545404C18A19CDC3E2F33AA">知道这 20 个正则表达式，能让你少写 1,000 行代码</a><br><a href="https://juejin.cn/post/6844903487155732494?searchId=20230910145545404C18A19CDC3E2F33AA">JS正则表达式完整教程（略长）</a><br><a href="https://juejin.cn/post/6993898348168085534?searchId=20230910143127ABD476DA9BBF4333B5D5">聊聊让人头疼的正则表达式</a><br><a href="https://juejin.cn/post/7187580193337245756?searchId=20230910135224A1F52E43E9B03928D5AE">百度工程师带你玩转正则</a></p>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 总结 </tag>
            
            <tag> 正则 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3源码Ⅴ-computed&amp;ref实现</title>
      <link href="/posts/14b0.html"/>
      <url>/posts/14b0.html</url>
      
        <content type="html"><![CDATA[<h1 id="computed-amp-ref的基本用法以及实现"><a href="#computed-amp-ref的基本用法以及实现" class="headerlink" title="computed &amp; ref的基本用法以及实现"></a>computed &amp; ref的基本用法以及实现</h1><h2 id="computed-的使用"><a href="#computed-的使用" class="headerlink" title="computed 的使用"></a>computed 的使用</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> watchEffect<span class="token punctuation">,</span>computed<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">firstname</span><span class="token operator">:</span> <span class="token string">'g'</span> <span class="token punctuation">,</span> <span class="token literal-property property">lastname</span><span class="token operator">:</span> <span class="token string">'zy'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 可以传一个函数</span><span class="token comment">// computed(()=>&#123; &#125;)</span><span class="token comment">// 可以传一个对象</span><span class="token keyword">const</span> fullname <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getter'</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> state<span class="token punctuation">.</span>firstname <span class="token operator">+</span> state<span class="token punctuation">.</span>lastname    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 改计算属性可以导致修改其他属性</span>       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 只打印一次getter ，缓存</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullname<span class="token punctuation">.</span>value<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullname<span class="token punctuation">.</span>value<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullname<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过例子我肯可以看到，computed如下特性</p><ul><li>计算属性主要是根据其他数据进行衍生数据的</li><li>计算属性默认是懒执行的，如果依赖的值不发生变化不会重新执行</li><li>计算属性的值自身无法修改</li><li>依赖的值变化了，后续再取值可以获取到新值</li></ul><h2 id="computed-的实现"><a href="#computed-的实现" class="headerlink" title="computed 的实现"></a>computed 的实现</h2><h3 id="computed可以传递一个函数，也可以传递一个对象"><a href="#computed可以传递一个函数，也可以传递一个对象" class="headerlink" title="computed可以传递一个函数，也可以传递一个对象"></a>computed可以传递一个函数，也可以传递一个对象</h3><p>如果传递的是一个函数，这个函数就是getter</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getterOrOptions</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> getter<span class="token punctuation">;</span>    <span class="token keyword">let</span> setter<span class="token punctuation">;</span>    <span class="token keyword">const</span> isGetter <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>isGetter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        getter <span class="token operator">=</span> getterOrOptions        <span class="token function-variable function">setter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'warn'</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>get        setter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>set    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="computed-返回的事一个普通对象，为了方便依赖收集，应该把普通值包装成一个对象"><a href="#computed-返回的事一个普通对象，为了方便依赖收集，应该把普通值包装成一个对象" class="headerlink" title="computed 返回的事一个普通对象，为了方便依赖收集，应该把普通值包装成一个对象"></a>computed 返回的事一个普通对象，为了方便依赖收集，应该把普通值包装成一个对象</h3><p>类似这样的结构</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> abc <span class="token operator">=</span> <span class="token number">123</span><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">_value</span><span class="token operator">:</span> abc<span class="token punctuation">,</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 依赖收集</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">xxx</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> xxx    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vue中是通过 ComputedRefImpl 类来实现的</p><ul><li>这个类接受getter setter两个函数</li><li>这个类主要是用来收集依赖，离不开 ReactiveEffect</li><li>getter就相当于effect传递的函数，调用run方法内部就会进行依赖收集</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isFunction <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> ReactiveEffect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./effect"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span> effect <span class="token comment">// 放到实例上方便取值</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">getter<span class="token punctuation">,</span>setter</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this._value就是取值后的结果</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value  <span class="token punctuation">&#125;</span>  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getterOrOptions</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">//...</span>  <span class="token comment">// 把普通值包装成一个对象</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedRefImpl</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span>setter<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时候控制台打印 (还没有具备缓存功能)</p><pre class="line-numbers language-none"><code class="language-none">gettergzygettergzygettergzy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="增加缓存功能"><a href="#增加缓存功能" class="headerlink" title="增加缓存功能"></a>增加缓存功能</h3><ul><li>增加一个 _dirty 来标识是否缓存</li><li>在取值前根据 _dirty 判断是否需要重新执行 run 方法</li><li>在每次设置值（值发生了改变）后重置 _dirty 状态</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> effect    <span class="token keyword">public</span> _value    <span class="token keyword">public</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">public</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">getter<span class="token punctuation">,</span>setter</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 依赖的值发生变化了，会将dirty变为true</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this._effect就是取值后的结果</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value    <span class="token punctuation">&#125;</span>    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="计算属性应该也进行依赖收集"><a href="#计算属性应该也进行依赖收集" class="headerlink" title="计算属性应该也进行依赖收集"></a>计算属性应该也进行依赖收集</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> watchEffect <span class="token punctuation">,</span>computed<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">firstname</span><span class="token operator">:</span> <span class="token string">'g'</span> <span class="token punctuation">,</span> <span class="token literal-property property">lastname</span><span class="token operator">:</span> <span class="token string">'zy'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">const</span> fullname <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getter'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> state<span class="token punctuation">.</span>firstname <span class="token operator">+</span> state<span class="token punctuation">.</span>lastname    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 改计算属性可以导致修改其他属性</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> fullname<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>state<span class="token punctuation">.</span>firstname <span class="token operator">=</span> <span class="token string">'hello'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时候firstname发生了变化，但是页面并没有重新渲染</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> effect    <span class="token keyword">public</span> _value    <span class="token keyword">public</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">public</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">getter<span class="token punctuation">,</span> setter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 依赖的值发生变化了，会将dirty变为true</span>                <span class="token comment">// 当依赖的值发生变化了 也应该触发更新</span>                <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 在取值时 要对计算属性也做依赖收集</span>        <span class="token comment">// 如果计算属性是在effect中使用的要做依赖收集</span>        <span class="token comment">// if(activeEffect)&#123;</span>             <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span>        <span class="token comment">// &#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this._effect就是取值后的结果</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value    <span class="token punctuation">&#125;</span>    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以基于以前的 track 和 trigger 进行拆分</p><span class='p green'>effect.ts 中 track 方法拆分</span><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 让这个对象上的属性 记录当前的activeEffect</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token comment">// 说明用户是在effect中使用的这个数据</span>        <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>        <span class="token comment">// 如果没有创建一个映射表</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果有这个映射表来查一下有没有这个属性</span>        <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>        <span class="token comment">// 如果没有set集合创建集合</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果有则看一下set中有没有这个effect（去重）</span>        <span class="token function">trackEffect</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>        <span class="token comment">// name = new Set(effect)</span>        <span class="token comment">// age = new Set(effect)</span>        <span class="token comment">// 我可以通过当前的effect 找到这两个集合中的自己 将其移除掉就可以了</span>        activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><span class='p green'>effect.ts 中 trigger 方法拆分</span><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>newVal<span class="token punctuation">,</span>oldVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 通过对象找到对应的属性 让这个属性对应的effect重新执行</span>    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name 或者 age对应的所有 effect</span>    <span class="token function">triggerEffect</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>dep<span class="token punctuation">]</span>    <span class="token comment">// 运行的是数组 删除的是set</span>    effects <span class="token operator">&amp;&amp;</span>         effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 正在执行的effect , 不要多次执行</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    effect<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 用户传递了对应的更新函数则调用此函数</span>                    <span class="token comment">// 用户如果没有传递则默认就是重新运行effect函数</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="直接访问fallname"><a href="#直接访问fallname" class="headerlink" title="直接访问fallname"></a>直接访问fallname</h3><p>现在访问fallname需要 fallname.value ，修改代码直接fallname取值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fullname <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getter'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> state<span class="token punctuation">.</span>firstname <span class="token operator">+</span> state<span class="token punctuation">.</span>lastname    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 改计算属性可以导致修改其他属性</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">firstname</span><span class="token operator">:</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token literal-property property">lastname</span><span class="token operator">:</span> <span class="token string">'zy'</span><span class="token punctuation">,</span> fullname <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>fullname<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    state<span class="token punctuation">.</span>firstname <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加 public __v_isRef = true</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> effect    <span class="token keyword">public</span> _value    <span class="token keyword">public</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">public</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 表示后续我们可以增加拆包的逻辑</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p class='p green'>handler.ts</p><p>如果存在 __v_isRef 直接返回 value</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// target 指的是原对象 key 指取那个属性 receiver 指的是代理对象(这里的receiver就是proxy)</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 我们在使用proxy的时候要搭配reflect来使用，用来解决this问题</span>        <span class="token comment">// 取值的时候,让这个属性 和 effect产生关系</span>        <span class="token comment">// return target[key]</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果在取值的时候发现取出来的值是对象，那么再次进行代理，返回代理后的结果</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 做依赖收集 记录属性和当前effect的关系</span>        <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 先拿到新值</span>        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">)</span>        <span class="token keyword">return</span> res <span class="token comment">// 取值，并且让target中的this变为代理对象</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__v_isRef<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ref-的使用"><a href="#ref-的使用" class="headerlink" title="ref 的使用"></a>ref 的使用</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> watchEffect<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> ref <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'</span><span class="token comment">// import &#123; reactive, effect, watch, watchEffect, computed, ref &#125; from './reactivity.js'</span><span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 装包，就是将变量在包装一层，里面还有依赖收集功能</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> flag<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    flag<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ref-的实现"><a href="#ref-的实现" class="headerlink" title="ref 的实现"></a>ref 的实现</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./reactivity"</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> trackEffect<span class="token punctuation">,</span> triggerEffect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./effect"</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toReactive</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">:</span> value<span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> _value    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> rawValue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 如果传入的是对象会变为proxy</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value    <span class="token punctuation">&#125;</span>    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> newVal            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>增加依赖收集,标识 ref</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> _value    <span class="token keyword">public</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> rawValue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 如果传入的是对象会变为proxy</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value    <span class="token punctuation">&#125;</span>    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> newVal            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>            <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3源码Ⅳ-watch实现</title>
      <link href="/posts/f3fc.html"/>
      <url>/posts/f3fc.html</url>
      
        <content type="html"><![CDATA[<h1 id="watch-amp-watchEffect-的基本用法及实现"><a href="#watch-amp-watchEffect-的基本用法及实现" class="headerlink" title="watch &amp; watchEffect 的基本用法及实现"></a>watch &amp; watchEffect 的基本用法及实现</h1><h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><h3 id="watch的基本用法"><a href="#watch的基本用法" class="headerlink" title="watch的基本用法"></a>watch的基本用法</h3><p>侦听一个或多个响应式数据源，并在数据源变化时调用所给的回调函数。</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token comment">// vue 依赖于 runtime-dom 依赖于 runtime-core 依赖于 reactivity</span>    <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> watch<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'</span>    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'gzy'</span> <span class="token punctuation">,</span> <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">n</span> <span class="token operator">:</span> <span class="token number">401</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token comment">// 对象是无法监控到前后值的更改</span>    <span class="token comment">// watch 可以监控对象 监控函数</span>    <span class="token comment">// 性能差，会访问对象中的所有属性，进行取值操作</span>    <span class="token function">watch</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据变化了'</span><span class="token punctuation">,</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'sync'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ggggg'</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据变化outer'</span><span class="token punctuation">)</span>        <span class="token comment">// state.name 监控的是一个固定值，不能这样写</span>    <span class="token comment">// ()=> state 不能这样写，没有访问对象中的属性，没有取值操作，没有收集依赖</span>    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> state<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据变化了'</span><span class="token punctuation">,</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'sync'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ggggg'</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据变化outer'</span><span class="token punctuation">)</span>    <span class="token comment">// 发现 先打印的 数据变化outer 然后才打印 数据变化了 -> 默认的watch是异步的</span>    <span class="token comment">// &#123;flush: 'sync'&#125; 表示同步的调用watch</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子中可以看出</p><ul><li>watch 常见用法就是监控一个函数或者响应式对象 根据返回值的变化触发对应的函数<ul><li>监控一个响应式对象，性能会比较差，因为会访问响应式对象中的所有属性，进行取值操作</li><li>监控一个函数，函数执行时去访问响应对象中的某个属性</li></ul></li><li>默认watch函数是异步执行的，传入参数 { flush:’sync’ } 表示同步执行watch</li></ul><h3 id="watch-的实现"><a href="#watch-的实现" class="headerlink" title="watch 的实现"></a>watch 的实现</h3><p>watch 可以看做 effect() + scheduler</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1）source 是一个响应式对象</span>    <span class="token comment">// 2）source 是一个函数</span>    <span class="token comment">// effect() + scheduler</span>    <span class="token comment">// effect 应该传递一个函数</span>    <span class="token keyword">let</span> getter<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 如果是响应式对象就需要包装成一个函数</span>        <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 对于传递的本来就是函数而言不需要变化</span>        getter <span class="token operator">=</span> source    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> oldVal<span class="token punctuation">;</span>    <span class="token comment">// 里面的属性就会收集当前的effect</span>    <span class="token comment">// 如果数据变化后会执行对应的scheduler方法</span>    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>       <span class="token keyword">const</span> newVal <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token function">cb</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span>oldVal<span class="token punctuation">)</span>       oldVal <span class="token operator">=</span> newVal    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    oldVal <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 会让属性和effect关联</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// = 深拷贝 seen防止死循环</span><span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> value    <span class="token punctuation">&#125;</span>    <span class="token comment">// 如果已经循环了这个对象了，那么再循环会导致死循环</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> value    <span class="token punctuation">&#125;</span>    seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>seen<span class="token punctuation">)</span> <span class="token comment">// 触发属性的getter</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> value<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="watchEffect"><a href="#watchEffect" class="headerlink" title="watchEffect"></a>watchEffect</h2><h3 id="watchEffect-基本用法"><a href="#watchEffect-基本用法" class="headerlink" title="watchEffect 基本用法"></a>watchEffect 基本用法</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// vue -> runtime-dom -> runtime-core -> reactivity</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> watchEffect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'</span><span class="token comment">// import &#123; reactive, effect, watch, watchEffect&#125; from './reactivity.js'</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'gzy'</span> <span class="token punctuation">,</span> <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">n</span> <span class="token operator">:</span> <span class="token number">401</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token comment">// 自动收集依赖</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'gggg'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="watchEffect-的实现"><a href="#watchEffect-的实现" class="headerlink" title="watchEffect 的实现"></a>watchEffect 的实现</h3><p>可以发现watchEffect的使用方法和effect一样，而且和watch的区别只是是否传递了 cb ， 所以我们可以对watch进行如下更改来实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>cb<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">dowatch</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span>cb<span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">dowatch</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">dowatch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> getter<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 如果是响应式对象就需要包装成一个函数</span>        <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 对于传递的本来就是函数而言不需要变化</span>        getter <span class="token operator">=</span> source    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> oldVal<span class="token punctuation">;</span>    <span class="token comment">// 里面的属性就会收集当前的effect</span>    <span class="token comment">// 如果数据变化后会执行对应的scheduler方法</span>    <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> newVal <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">cb</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span>oldVal<span class="token punctuation">)</span>            oldVal <span class="token operator">=</span> newVal        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// watchEffect只需要运行自身就可以了</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span>job<span class="token punctuation">)</span>    oldVal <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 会让属性和effect关联</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>把原来的watch修改为dowatch</li><li>新增对应的watch和watchEffect方法，内部调用dowatch并对参数进行区分</li><li>dowatch内部看是否传递了cb， 传递了获取新的值和老的值传递给cb,没有传递说明是watchEffect，只需要运行自身就可以了</li></ul><h2 id="cleanup"><a href="#cleanup" class="headerlink" title="cleanup"></a>cleanup</h2><p>下一次watch函数执行前清理掉上一次的watch</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'gzy'</span> <span class="token punctuation">,</span> <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">n</span> <span class="token operator">:</span> <span class="token number">401</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> state<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> onCleanup</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token function">onCleanup</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        flag <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> r<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'sync'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'11'</span>state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'111'</span>state<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'1111'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">dowatch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token keyword">let</span> clear    <span class="token keyword">let</span> <span class="token function-variable function">onCleanup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        clear <span class="token operator">=</span> fn    <span class="token punctuation">&#125;</span>    <span class="token comment">// 里面的属性就会收集当前的effect</span>    <span class="token comment">// 如果数据变化后会执行对应的scheduler方法</span>    <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> newVal <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">cb</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span>oldVal<span class="token punctuation">,</span>onCleanup<span class="token punctuation">)</span>            oldVal <span class="token operator">=</span> newVal        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// watchEffect只需要运行自身就可以了</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3源码III-effect补充</title>
      <link href="/posts/9c59.html"/>
      <url>/posts/9c59.html</url>
      
        <content type="html"><![CDATA[<h1 id="Vue3源码III-effect补充"><a href="#Vue3源码III-effect补充" class="headerlink" title="Vue3源码III-effect补充"></a>Vue3源码III-effect补充</h1><h2 id="停止effect更新的方法"><a href="#停止effect更新的方法" class="headerlink" title="停止effect更新的方法"></a>停止effect更新的方法</h2><p>先看使用Vue源码中停止effect更新的例子</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/reactivity/dist/reactivity.esm-browser.js'</span>        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span>        <span class="token comment">// 原生effect中调用effect会有一个runner返回值</span>        <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'runner'</span><span class="token punctuation">)</span>            app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> a        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 停止effect的响应式能力， 不再收集相关依赖了</span>        <span class="token comment">// 默认情况下是自动的更新， 数据变化后更新 effect</span>        <span class="token comment">// 数据变化不更新，我可以自己决定更新</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ggggg'</span>            <span class="token comment">// state.name = 'a'</span>            <span class="token comment">// state.name = 'b'</span>            a <span class="token operator">=</span> <span class="token number">100</span>            <span class="token comment">// runner.effect.run() // forceUpdate</span>            <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zzzz'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在原生effect种调用effect会 <span class='p blue'>返回一个runner函数</span></li><li>调用<span class='p blue'>runner.effect.stop()</span> 会停止effect的响应式能力，不再收集相关依赖,不是响应式了</li><li>直接调用 runner 相当于 vue2中的 <span class='p blue'>forceUpdate</span> 方法强制更新视图</li></ul><p>根据这些特性来一步步给我们的effect中增加相关的方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 创建一个响应式effect,并且让effect执行</span>    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 把runner方法直接给用户， 用户可以直接去调用effect中定义的内容</span>    <span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span>    <span class="token comment">// 可以通过runner拿到effect中的所有属性</span>    runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect    <span class="token keyword">return</span> runner<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>runner方法能直接调用，说明调用的是<span class='p blue'>_effect中的run</span>方法</li><li>runner.effect.stop需要我们把 runner.effect指向_effect，并且在 class ReactiveEffect 上<span class='p blue'>扩展 stop方法</span></li><li>并且应该 有一个 <span class='p blue'>active</span> 属性来标识组件是不是正常状态<ul><li>active = true  正常执行</li><li>active = false 清除相关依赖，停止依赖收集</li></ul></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 默认会将fn挂载到类的实例上</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>    parent <span class="token operator">=</span> <span class="token keyword">undefined</span>    active <span class="token operator">=</span> <span class="token boolean">true</span>    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 依赖了那些列表</span>    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 失活态默认调用run的时候 只是重新执行 不会发生依赖收集</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>            <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 清理了上一次的依赖收集</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// fn执行会触发依赖收集</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token comment">// 变为失活态，停止依赖收集</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>            <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数据变了自己来控制渲染"><a href="#数据变了自己来控制渲染" class="headerlink" title="数据变了自己来控制渲染"></a>数据变了自己来控制渲染</h2><blockquote><p>我们希望数据变化了但是5s后再执行页面渲染</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'gzy'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">// 原生effect中调用effect会有一个runner返回值</span><span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> a<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 组件的异步渲染</span>            <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'gggggg'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>effect中会传入一些参数</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 创建一个响应式effect,并且让effect执行</span>    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span>    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 把runner方法直接给用户， 用户可以直接去调用effect中定义的内容</span>    <span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span>    <span class="token comment">// 可以通过runner拿到effect中的所有属性</span>    runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect    <span class="token keyword">return</span> runner<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在 class ReactiveEffect 中接受这个参数</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 默认会将fn挂载到类的实例上</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn<span class="token punctuation">,</span> <span class="token keyword">public</span> scheduler</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>    parent <span class="token operator">=</span> <span class="token keyword">undefined</span>    active <span class="token operator">=</span> <span class="token boolean">true</span>    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 依赖了那些列表</span>    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 失活态默认调用run的时候 只是重新执行 不会发生依赖收集</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>            <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 清理了上一次的依赖收集</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// fn执行会触发依赖收集</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token comment">// 变为失活态，停止依赖收集</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>            <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在渲染时判断有没有传递参数<ul><li>传递了对应的更新函数则<span class='p blue'>调用此函数</span></li><li>没有传递则默认就是<span class='p blue'>重新运行effect函数</span></li></ul></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>newVal<span class="token punctuation">,</span>oldVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 通过对象找到对应的属性 让这个属性对应的effect重新执行</span>    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name 或者 age对应的所有 effect</span>    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>dep<span class="token punctuation">]</span>    <span class="token comment">// 运行的是数组 删除的是set</span>    effects <span class="token operator">&amp;&amp;</span>         effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 正在执行的effect , 不要多次执行</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    effect<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 用户传递了对应的更新函数则调用此函数</span>                    <span class="token comment">// 用户如果没有传递则默认就是重新运行effect函数</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="reactive深度代理"><a href="#reactive深度代理" class="headerlink" title="reactive深度代理"></a>reactive深度代理</h2><p class='p green'>handler.ts</p><p>如果在取值的时候发现取出来的值是对象，那么<span class='p blue'>再次进行代理</span>，返回代理后的结果</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果在取值的时候发现取出来的值是对象，那么再次进行代理，返回代理后的结果</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">)</span>        <span class="token keyword">return</span> res    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3源码II-响应式实现</title>
      <link href="/posts/5899.html"/>
      <url>/posts/5899.html</url>
      
        <content type="html"><![CDATA[<h1 id="Vue3响应式原理"><a href="#Vue3响应式原理" class="headerlink" title="Vue3响应式原理"></a>Vue3响应式原理</h1><h2 id="1-Vue3响应式系统与Vue2响应式系统的区别"><a href="#1-Vue3响应式系统与Vue2响应式系统的区别" class="headerlink" title="1. Vue3响应式系统与Vue2响应式系统的区别"></a>1. Vue3响应式系统与Vue2响应式系统的区别</h2><ul><li><span class='p red'>底层实现</span> Vue 2 使用了 Object.defineProperty 来追踪属性的变化，并触发相应的更新。而 Vue 3 改用了 JavaScript 的 <span class='p red'>Proxy API</span> 来实现响应式系统。Proxy API 提供了更强大和灵活的功能，使得 Vue 3 的响应式系统更高效和可扩展</li><li><span class='p red'>性能优化</span> Vue 3 在响应式系统方面进行了一些优化，提高了性能。Vue 3 使用了基于 Proxy 的跟踪机制，可以更精确地追踪属性的变化，避免了 Vue 2 中的一些性能瓶颈。此外，Vue 3 还引入了<span class='p red'>静态标记（Static Marking）</span>和 <span class='p red'>树摇（Tree Shaking）</span>等优化技术，减少了不必要的更新和渲染操作</li><li><span class='p red'>嵌套响应式</span> Vue 2 的响应式系统在嵌套对象或数组的情况下存在一些限制，需要通过 Vue.set 或 this.$set 进行手动触发更新。而 Vue 3 的响应式系统可以<span class='p red'>自动追踪嵌套对象和数组的变化</span>，无需手动触发更新</li><li><span class='p red'>Composition API</span> Vue 3 引入了 Composition API，这是一个基于函数的 API 风格，可以更好地组织和重用组件逻辑。Composition API 提供了<span class='p red'>更灵活的响应式能力</span>，使得开发者可以更自由地定义响应式数据和副作用</li><li><span class='p red'>TypeScript 支持</span> Vue 3 对 TypeScript 的支持更加完善，提供了<span class='p red'>更准确的类型推断和类型检查</span>。Vue 3 的响应式系统与 TypeScript 的类型系统更好地集成，使得在使用 TypeScript 开发时更加方便和可靠</li></ul><h2 id="2-实现Vue响应式"><a href="#2-实现Vue响应式" class="headerlink" title="2. 实现Vue响应式"></a>2. 实现Vue响应式</h2><h3 id="Vue3中-reactivity-和-effect-基本用法"><a href="#Vue3中-reactivity-和-effect-基本用法" class="headerlink" title="Vue3中 reactivity 和 effect 基本用法"></a>Vue3中 reactivity 和 effect 基本用法</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">          <span class="token comment">// 单独引入响应式模块  </span>          <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../../node_modules/@vue/reactivity/dist/reactivity.esm-browser.js'</span>          <span class="token comment">// 1） 创建一个响应式对象 reactive</span>          <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>          <span class="token comment">// 2) effect 所有的渲染都是基于他来实现的 computed watch 组件渲染</span>          <span class="token comment">// 默认叫响应式effect,数据变化后会重新执行此函数</span>          <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>              app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> state<span class="token punctuation">.</span>age          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">&#123;</span>              state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ggg'</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>          <span class="token comment">// 3) 属性会收集effect (数据的依赖收集) 数据会记录自己在那个effect中使用了，稍后数据变化可以找到对应的effect执行</span>          <span class="token comment">// 输出： 页面初始化会渲染 gzy18  1s后渲染为ggg18</span>      </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以得知Vue3的响应式 离不开 <span class='p red'>reactive</span> 和 <span class='p red'>effect</span> 的互相配合，下面来一步步实现Vue3的响应式</p><h3 id="reactivity源码实现"><a href="#reactivity源码实现" class="headerlink" title="reactivity源码实现"></a><code>reactivity</code>源码实现</h3><h4 id="使用-ES6-的-Proxy-API-来做一层代理"><a href="#使用-ES6-的-Proxy-API-来做一层代理" class="headerlink" title="使用 ES6 的 Proxy API 来做一层代理"></a>使用 ES6 的 Proxy API 来做一层代理</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// reactive 只能处理对象类型的数据，不是对象不处理</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>      <span class="token comment">// target 指的是原对象 </span>      <span class="token comment">// key 指取那个属性 </span>      <span class="token comment">// receiver 指的是代理对象(这里的receiver就是proxy)</span>      <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>          <span class="token comment">// 我们在使用proxy的时候要搭配reflect来使用，用来解决this问题</span>          <span class="token comment">// 取值的时候,让这个属性 和 effect产生关系</span>          <span class="token comment">// return target[key]</span>                    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 取值，并且让target中的this变为代理对象</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>          <span class="token comment">// 更新的数据</span>          <span class="token comment">// 找到这个属性对应的effect让他执行</span>          <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>       <span class="token keyword">return</span> proxy<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里会有一个问题 为什么取值和设置值的时候不直接通过 <code>return target[key]</code>  而是要 <code>Reflect.get(target,key ,receiver)</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'gzy'</span><span class="token punctuation">,</span>  <span class="token keyword">get</span> <span class="token function">aliasName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">**</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">**</span><span class="token template-punctuation string">`</span></span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> proxyPerson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key <span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>proxyPerson<span class="token punctuation">.</span>aliasName<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>proxyPerson.aliasName 来<code>取值</code>的时候，会走 proxyPerson 的 get 方法 ， 其中 target 为 <code>person对象</code>，key为 <code>person.aliasName</code> 方法，这时候的 <code>this是person</code> ,返回的是 <code>person.name</code></p></li><li><p>为了name 的<code>依赖收集</code>，需要再获取aliasName的时候 ，也<code>希望name属性也会触发get</code> , 所以需要调用 <code>Reflect.get(target,key ,receiver)</code></p></li><li><p>而 receiver 指的是<code>代理对象</code>,所以会从代理对象上取name属性 ，这样就达到了我们的需求</p></li></ul><h5 id="为了代码的简介和复用，-新建-handlers-ts-文件并且把-proxy的对象参数提取-成为-mutableHandlers-方法"><a href="#为了代码的简介和复用，-新建-handlers-ts-文件并且把-proxy的对象参数提取-成为-mutableHandlers-方法" class="headerlink" title="为了代码的简介和复用， 新建 handlers.ts 文件并且把 proxy的对象参数提取 成为 mutableHandlers 方法"></a>为了代码的简介和复用， 新建 <code>handlers.ts</code> 文件并且把 <code>proxy的对象参数提取</code> 成为 <code>mutableHandlers</code> 方法</h5><p class='p green'>src/handler.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// target 指的是原对象 key 指取那个属性 receiver 指的是代理对象(这里的receiver就是proxy)</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 我们在使用proxy的时候要搭配reflect来使用，用来解决this问题</span>        <span class="token comment">// 取值的时候,让这个属性 和 effect产生关系</span>        <span class="token comment">// return target[key]</span>        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 取值，并且让target中的this变为代理对象</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 更新的数据</span>        <span class="token comment">// 找到这个属性对应的effect让他执行</span>        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p class='p green'>src/reactivity.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> mutableHandlers <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./handlers"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// reactive 只能处理对象类型的数据，不是对象不处理</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>mutableHandlers<span class="token punctuation">)</span>      <span class="token keyword">return</span> proxy<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="代理对象缓存"><a href="#代理对象缓存" class="headerlink" title="代理对象缓存"></a>代理对象<code>缓存</code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state1 <span class="token operator">===</span> state2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>当对同一个对象创建两次代理对象，应该只需要代理一次就行，使用<code>WeakMap</code>做一下缓存表</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> mutableHandlers <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./handlers"</span><span class="token punctuation">;</span><span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// reactive 只能处理对象类型的数据，不是对象不处理</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target    <span class="token comment">// 缓存可以采用映射表 &#123; &#123;target&#125; -> proxy &#125;</span>    <span class="token keyword">let</span> existingProxy <span class="token operator">=</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token keyword">return</span> existingProxy <span class="token comment">// 代理过直接返回</span>    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>mutableHandlers<span class="token punctuation">)</span>            reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>proxy<span class="token punctuation">)</span>     <span class="token keyword">return</span> proxy<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="处理对象循环代理"><a href="#处理对象循环代理" class="headerlink" title="处理对象循环代理"></a>处理对象<code>循环代理</code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>state1<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state1 <span class="token operator">===</span> state2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>代理过的对象继续代理 （已经被代理过的对象不能再代理了）</p></div><ul><li>在vue3.0的时候 会创建一个反向映射表 { 代理的结果 -&gt; 原内容 }</li><li>目前不用创建反向映射表， 用的方式是，如果这个对象被代理过了说明已经被proxy拦截过了（添加属性）</li></ul><p class='p green'>src/reactivity.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> mutableHandlers <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./handlers"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">&#123;</span>    <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'_v_isReactive'</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target    <span class="token keyword">let</span> existingProxy <span class="token operator">=</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token keyword">return</span> existingProxy    <span class="token comment">// 这里是关键</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> target    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>mutableHandlers<span class="token punctuation">)</span>            reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>proxy<span class="token punctuation">)</span>     <span class="token comment">// 1） 在vue3.0的时候 会创建一个反向映射表 &#123; 代理的结果 -> 原内容 &#125;</span>    <span class="token comment">// 2) 目前不用创建反向映射表， 用的方式是，如果这个对象被代理过了说明已经被proxy拦截过了</span>    <span class="token keyword">return</span> proxy<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p class='p green'>src/handler.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> ReactiveFlags <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./reactivity"</span><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// target 指的是原对象 key 指取那个属性 receiver 指的是代理对象(这里的receiver就是proxy)</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 我们在使用proxy的时候要搭配reflect来使用，用来解决this问题</span>        <span class="token comment">// 取值的时候,让这个属性 和 effect产生关系</span>        <span class="token comment">// 这里是关键</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span>                <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 取值，并且让target中的this变为代理对象</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 更新的数据</span>        <span class="token comment">// 找到这个属性对应的effect让他执行</span>        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="effect源码实现"><a href="#effect源码实现" class="headerlink" title="effect源码实现"></a><code>effect</code>源码实现</h3><h4 id="effect的基础用法"><a href="#effect的基础用法" class="headerlink" title="effect的基础用法"></a>effect的基础用法</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> state<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p class='p green'>effect.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 先把自己放到全局</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 默认会将fn挂载到类的实例上</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>         <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 创建一个响应式effect,并且让effect执行</span>    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>effect默认会执行一次</li><li>执行的时候会先把当前的实例挂载到全局 activeEffect属性</li><li>然后调用effect的函数执行，执行期间会调用响应式对象的get取值，这是在get里就能拿到 activeEffect属性值</li></ul><h4 id="多次调用effect"><a href="#多次调用effect" class="headerlink" title="多次调用effect"></a>多次调用effect</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>state<span class="token punctuation">.</span>age  <span class="token comment">// 不会收集依赖</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>  state<span class="token punctuation">.</span>age<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>需要每次执行完effect的方法后，把activeEffect赋值为null,这样不在effect中进行取值的话就不会收集依赖</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 先把自己放到全局</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>         <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">finally</span><span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">null</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 创建一个响应式effect,并且让effect执行</span>    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="effect嵌套"><a href="#effect嵌套" class="headerlink" title="effect嵌套"></a>effect嵌套</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>  state<span class="token punctuation">.</span>age    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>address<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>effect1执行，activeEffect = effect1, 这时候去取 name 收集 effect1</li><li>effect2执行 会把 activeEffect = effect2 ,这时 age 收集 effect2 ，执行完毕后会把全局的 activeEffect = null</li><li>下一次去 state 取 address 就找activeEffect无法收集</li></ul><div class="tip cogs"><p>原来的是 stack 方法解决，3.2版本后采用的树解决</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 先把自己放到全局</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>    parent <span class="token operator">=</span> <span class="token keyword">undefined</span>    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 创建一个响应式effect,并且让effect执行</span>    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>    _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>effect1执行  parent 为 undefined, activeEffect = effect1， 这时 name 收集 effect1</li><li>effect2执行 因为全局的 activeEffect = effect1，所以先执行 parent = effect1 , 再把全局的 activeEffect = effect2, 这时 age 收集 effect2 ， 最后会把 全局的 activeEffect 设置为 effect1</li><li>下一次去 state 取 address 收集 effect1</li></ul><h4 id="依赖收集（属性和effect关联起来）"><a href="#依赖收集（属性和effect关联起来）" class="headerlink" title="依赖收集（属性和effect关联起来）"></a>依赖收集（属性和effect关联起来）</h4><p class='p green'>src/handler.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> activeEffect<span class="token punctuation">,</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./effect"</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> ReactiveFlags <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./reactivity"</span><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 做依赖收集 记录属性和当前effect的关系</span>        <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key <span class="token punctuation">,</span>receiver<span class="token punctuation">)</span> <span class="token comment">// 先拿到新值</span>        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">)</span>        <span class="token keyword">return</span> res <span class="token comment">// 取值，并且让target中的this变为代理对象</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>        <span class="token keyword">const</span> r <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>receiver<span class="token punctuation">)</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>oldValue<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> r    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="构造依赖关系映射表"><a href="#构造依赖关系映射表" class="headerlink" title="构造依赖关系映射表"></a>构造依赖关系映射表</h4><p class='p green'>src/effect.ts</p><div class="tip cogs"><p>做一个映射表 来收集依赖关系</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 映射表结构应该是这样</span><span class="token comment">// weakmap : map : set</span><span class="token comment">// &#123;name:'gzy',age:18&#125;:'name' -> [effect,effect]</span><span class="token comment">// &#123;name:'gzy',age:18&#125;:'age' -> [effect]</span><span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 让这个对象上的属性 记录当前的activeEffect</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>         <span class="token comment">// 说明用户是在effect中使用的这个数据</span>        <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>        <span class="token comment">// 如果没有创建一个映射表</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果有这个映射表来查一下有没有这个属性</span>        <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>        <span class="token comment">// 如果没有set集合创建集合</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果有则看一下set中有没有这个effect</span>        <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>            activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在浏览器打开应该是这样的</p><p><img src="https://cdn.guozy.online/img/2023/08/bcde599e6d9f24ce3d1f0de641449a1b.png" alt="属性和effect映射表"></p><h4 id="属性改变时执行对应的effect"><a href="#属性改变时执行对应的effect" class="headerlink" title="属性改变时执行对应的effect"></a>属性改变时执行对应的effect</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">          <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span>        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            state<span class="token punctuation">.</span>name <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> state<span class="token punctuation">.</span>name        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ggggg'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p class='p green'>src/effect.ts</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>newVal<span class="token punctuation">,</span>oldVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 通过对象找到对应的属性 让这个属性对应的effect重新执行</span>    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name 或者 age对应的所有 effect</span>    dep <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 正在执行的effect , 不要多次执行</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="cleanupEffect"><a href="#cleanupEffect" class="headerlink" title="cleanupEffect"></a>cleanupEffect</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">          <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span>        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'gzy'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token literal-property property">flag</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token comment">// flag 和 name 属性会触发收集</span>            <span class="token comment">// 下一次应该清理掉flag和name属性，重新收集 flag 和 age 属性会触发收集</span>            app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>flag <span class="token operator">?</span> state<span class="token punctuation">.</span>name <span class="token operator">:</span> state<span class="token punctuation">.</span>age        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>             state<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span>            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                <span class="token comment">// 等会改了name , 还是会触发effect</span>                state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'xxx'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>在 ReactiveEffect 类上新增 deps = [],并且保存 new Set(effect)</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// track</span><span class="token comment">// ...</span><span class="token comment">// 如果有这个映射表来查一下有没有这个属性</span><span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token comment">// 如果没有set集合创建集合</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 如果有则看一下set中有没有这个effect（去重）</span><span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>    <span class="token comment">// name = new Set(effect)</span>    <span class="token comment">// age = new Set(effect)</span>    <span class="token comment">// 我可以通过当前的effect 找到这两个集合中的自己 将其移除掉就可以了</span>    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>在收集依赖之前清理上一次的依赖收集</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 默认会将fn挂载到类的实例上</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>    parent <span class="token operator">=</span> <span class="token keyword">undefined</span>    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 依赖了那些列表</span>    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>            <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 清理了上一次的依赖收集</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// fn执行会触发依赖收集</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 在收集的列表中将自己移除掉</span>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> deps <span class="token punctuation">&#125;</span> <span class="token operator">=</span> effect    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 找到set ，让set移除掉自己</span>        deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    effect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 清空依赖的列表</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip cogs"><p>为了防止删除Set中的effect和往Set种新增effect造成死循环,对trigger方法进行修改</p></div><p class='p green'>trigger</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>newVal<span class="token punctuation">,</span>oldVal</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 通过对象找到对应的属性 让这个属性对应的effect重新执行</span>    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name 或者 age对应的所有 effect</span>    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>dep<span class="token punctuation">]</span>    <span class="token comment">// 运行的是数组 删除的是set</span>    effects <span class="token operator">&amp;&amp;</span>         effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 正在执行的effect , 不要多次执行</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div calss='anzhiyu-tag-link'><a class="tag-Link" target="_blank" href="https://github.com/guozhiyuan16/my-vue3">    <div class="tag-link-tips">引用站外地址</div>    <div class="tag-link-bottom">        <div class="tag-link-left" style="background-image: url(https://api.iowen.cn/favicon/github.com/guozhiyuan16/my-vue3.png);"></div>        <div class="tag-link-right">            <div class="tag-link-title">Vue3响应式原理源码</div>            <div class="tag-link-sitename">guozhiyuan16</div>        </div>        <i class="anzhiyufont anzhiyu-icon-angle-right"></i>    </div>    </a></div>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3源码I-环境搭建</title>
      <link href="/posts/1d18.html"/>
      <url>/posts/1d18.html</url>
      
        <content type="html"><![CDATA[<h1 id="Vue3-I"><a href="#Vue3-I" class="headerlink" title="Vue3 I"></a>Vue3 I</h1><h2 id="Vue3设计思想"><a href="#Vue3设计思想" class="headerlink" title="Vue3设计思想"></a>Vue3设计思想</h2><ul><li><span class='p red'>响应式系统的重写</span> Vue 3 重新设计了响应式系统，采用了 Proxy API 代替了 Vue 2 中的 Object.defineProperty。这样可以提供更好的性能，并且支持更多的响应式特性。</li><li><span class='p red'>更好的性能</span> Vue 3 引入了一些性能优化措施，例如编译器的优化、虚拟 DOM 的改进以及更高效的更新机制。这些改进使得 Vue 3 在性能方面比 Vue 2 更出色。</li><li><span class='p red'>Composition API</span> Vue 3 引入了 Composition API，它是一种基于函数的 API 风格，可以更好地组织和重用组件逻辑。Composition API 提供了更灵活的组合方式，使得代码更具可读性和可维护性。</li><li><span class='p red'>更好的 TypeScript 支持</span> Vue 3 对 TypeScript 的支持更加完善，提供了更准确的类型推断和类型检查。这使得在使用 TypeScript 开发 Vue 应用时更加方便和可靠。</li><li><span class='p red'>更小的包体积</span> Vue 3 在设计时考虑了包体积的问题，并采取了一些措施来减小包的大小。这使得 Vue 3 在加载和运行时更加高效。</li></ul><h3 id="声明式框架"><a href="#声明式框架" class="headerlink" title="声明式框架"></a>声明式框架</h3><div class="tip "><p>Vue3依旧是声明式的框架，用起来简单</p></div><p>命令式和声明式的区别</p><ul><li>jq时代编写的代码都是命令式的，命令式框架重要特点就是关注过程</li><li>声明式框架更加关注结果。命令式的代码封装到了Vuejs中，过程靠vuejs来实现</li></ul><div class="tip "><p>声明式代码更加简单，不需要关注实现，按照要求填代码就可以（给上原材料就出结果）</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 命令式编程</span><span class="token keyword">let</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numbers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  total <span class="token operator">+=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment">// 关注过程</span><span class="token punctuation">&#125;</span><span class="token comment">// 声明式编程</span><span class="token keyword">let</span> total2 <span class="token operator">=</span> number<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span>current</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> memo <span class="token operator">+</span> current<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="采用虚拟DOM"><a href="#采用虚拟DOM" class="headerlink" title="采用虚拟DOM"></a>采用虚拟DOM</h3><p>传统更新页面，拼接一个完整的字符串innerHTML全部重新渲染，添加虚拟DOM后，可以比较新旧虚拟节点，找到变化在进行更新。虚拟DOM就是一个对象，用来描述真实DOM的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">__v_isVNode</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">__v_skip</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    type<span class="token punctuation">,</span>    props<span class="token punctuation">,</span>    <span class="token literal-property property">key</span><span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeKey</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">ref</span><span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>    children<span class="token punctuation">,</span>    <span class="token literal-property property">component</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    patchFlag<span class="token punctuation">,</span>    dynamicProps<span class="token punctuation">,</span>    <span class="token literal-property property">dynamicChildren</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token literal-property property">appContext</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="区分编译时和运行时"><a href="#区分编译时和运行时" class="headerlink" title="区分编译时和运行时"></a>区分编译时和运行时</h3><ul><li>我们需要有一个虚拟DOM，调用渲染方法将虚拟DOM渲染成真实DOM （缺点就是虚拟DOM编写麻烦）</li><li>专门写个编译时可以将模板编译成虚拟DOM （在构建的时候进行编译性能更高，不需要再运行的时候进行编译，而且vue3在编译中做了很多优化）</li></ul><h2 id="Vue3整体架构"><a href="#Vue3整体架构" class="headerlink" title="Vue3整体架构"></a>Vue3整体架构</h2><h3 id="monorepo-管理项目"><a href="#monorepo-管理项目" class="headerlink" title="monorepo-管理项目"></a>monorepo-管理项目</h3><p>Monorepo 是管理项目代码的一个方式，指在一个项目仓库(repo)中管理多个模块/包(package)。 Vue3源码采用 monorepo 方式进行管理，将模块拆分到package目录中。</p><ul><li>一个仓库可维护多个模块，不用到处找仓库</li><li>方便版本管理和依赖管理，模块之间的引用，调用都非常方便</li></ul><h4 id="Vue3项目结构"><a href="#Vue3项目结构" class="headerlink" title="Vue3项目结构"></a>Vue3项目结构</h4><p><img src="https://cdn.guozy.online/img/2023/08/bc2c2816a748e7c06a5297aebdd920bb.png"></p><h4 id="Vue3采用Typescript"><a href="#Vue3采用Typescript" class="headerlink" title="Vue3采用Typescript"></a>Vue3采用Typescript</h4><p>Vue2 采用Flow来进行类型检测 （Vue2中对TS支持并不友好）， Vue3源码采用Typescript来进行重写 , 对Ts的支持更加友好。</p><h2 id="Vue3-开发环境搭建"><a href="#Vue3-开发环境搭建" class="headerlink" title="Vue3 开发环境搭建"></a>Vue3 <code>开发环境搭建</code></h2><h3 id="搭建Monorepo环境"><a href="#搭建Monorepo环境" class="headerlink" title="搭建Monorepo环境"></a>搭建Monorepo环境</h3><p>Vue3中使用pnpm workspace来实现monorepo (<a href="https://www.pnpm.cn/">pnpm</a>是快速、节省磁盘空间的包管理器。主要采用符号链接的方式管理模块)</p><h4 id="全局安装pnpm"><a href="#全局安装pnpm" class="headerlink" title="全局安装pnpm"></a>全局安装pnpm</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token function">pnpm</span> -g<span class="token function">pnpm</span> init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果不做发布可在初始化的package.json中添加 “private” : true</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vue3"</span><span class="token punctuation">,</span><span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 表示是一个基座，不做发布</span><span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span><span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="pnpm搭建monorepo环境"><a href="#pnpm搭建monorepo环境" class="headerlink" title="pnpm搭建monorepo环境"></a>pnpm搭建monorepo环境</h4><h5 id="只需在前项目下创建pnpm-workspace-yaml"><a href="#只需在前项目下创建pnpm-workspace-yaml" class="headerlink" title="只需在前项目下创建pnpm-workspace.yaml"></a>只需在前项目下创建<code>pnpm-workspace.yaml</code></h5><p>将packages下所有的目录都作为包进行管理。这样我们的Monorepo就搭建好了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">packages</span><span class="token operator">:</span>  <span class="token operator">-</span> <span class="token string">"packages/*"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="根目录下创建所有需要管理的包的总目录packages"><a href="#根目录下创建所有需要管理的包的总目录packages" class="headerlink" title="根目录下创建所有需要管理的包的总目录packages"></a><code>根目录下</code>创建所有需要管理的包的总目录<code>packages</code></h5><ul><li>创建响应式包<code>packages/reactivity</code>, pnpm init初始化, 修改package.json中name为<code>@vue/reactivity</code></li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"@vue/reactivity"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>  <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建共享方法包<code>packages/shared</code>, pnpm init初始化, 修改package.json中name为<code>@vue/shared</code></li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"@vue/shared"</span><span class="token punctuation">,</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>    <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="安装共享模块"><a href="#安装共享模块" class="headerlink" title="安装共享模块"></a>安装共享模块</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> <span class="token function">install</span> vue -w<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这时候发现共享的模块不在node_modules根目录下; 添加<span class='p grey'>羞耻的提升</span>可以将Vue3，所依赖的模块提升到node_modules中</p><p><img src="https://cdn.guozy.online/img/2023/08/d279ef0444a06f986b9ff0fe29a83fec.png" alt="羞耻的提升前"></p><ul><li>新建.npmrc</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">shamefully<span class="token operator">-</span>hoist <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>重新执行pnpm install</li></ul><p><img src="https://cdn.guozy.online/img/2023/08/9d09492ed73324d48b707a8621de61fe.png" alt="羞耻的提升后"></p><h3 id="搭建编译环境"><a href="#搭建编译环境" class="headerlink" title="搭建编译环境"></a>搭建编译环境</h3><h4 id="新建文件"><a href="#新建文件" class="headerlink" title="新建文件"></a>新建文件</h4><ul><li>在 reactivity 新建src/index.ts</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span>  <span class="token string">"@vue/shared"</span>  <span class="token comment">// 如何这样引入</span><span class="token keyword">export</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>在 shared 新建src/index.ts</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isObject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> value <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"object"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="在-reactivity-中-如何通过-vue-shared-引入shared包中的方法"><a href="#在-reactivity-中-如何通过-vue-shared-引入shared包中的方法" class="headerlink" title="在 reactivity 中 如何通过 @vue/shared 引入shared包中的方法"></a>在 reactivity 中 如何通过 @vue/shared 引入shared包中的方法</h4><ul><li><p>npm install typescript -g</p></li><li><p>tsc –init 生成 <code>tsconfig.json</code></p></li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"outDir"</span><span class="token operator">:</span> <span class="token string">"dist"</span><span class="token punctuation">,</span> <span class="token comment">// 输出目录</span>    <span class="token property">"sourceMap"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 采用sourcemap</span>    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"es2016"</span><span class="token punctuation">,</span> <span class="token comment">// 目标语法</span>    <span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"ESNext"</span><span class="token punctuation">,</span> <span class="token comment">// 模块格式</span>    <span class="token property">"moduleResolution"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span> <span class="token comment">// 模块解析方式</span>    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 严格模式</span>    <span class="token property">"resolveJsonModule"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 解析json模块</span>    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 允许通过es6语法引入commonjs模块</span>    <span class="token property">"jsx"</span><span class="token operator">:</span><span class="token string">"preserve"</span><span class="token punctuation">,</span> <span class="token comment">// jsx 不转义</span>    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ESNext"</span><span class="token punctuation">,</span><span class="token string">"DOM"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 支持的类库 esnext及dom</span>    <span class="token property">"baseUrl"</span><span class="token operator">:</span> <span class="token string">"./"</span><span class="token punctuation">,</span> <span class="token comment">// 以当前项目为根目录</span>    <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"@vue/*"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"packages/*/src"</span><span class="token punctuation">]</span> <span class="token comment">// 模块之间先找自己定义模块</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>这是就能正确的指向我们自己的包了</p></blockquote><h4 id="配置打包"><a href="#配置打包" class="headerlink" title="配置打包"></a>配置打包</h4><ul><li>根目录新建 scripts/dev.js</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> build <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>resolve<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token string">'reactivity'</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/src/index.ts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>target<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 将依赖的模块全部打包</span>    <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 支持调试</span>    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span> <span class="token comment">// 打包出来的模块是es6模块</span>    <span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">'browser'</span><span class="token punctuation">,</span> <span class="token comment">// 打包的结果给浏览器来使用</span>    <span class="token literal-property property">watch</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token function">onRebuild</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'watch build failed:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>            <span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'watch build succeeded:'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'watching~~~'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="tip fa-atom cogs"><p>开发环境使用 esbuild 版本为 <span class='p red'>0.15.17</span>,新版本 为 <span class='p red'>0.19.2</span> 配置已经发生了变化, 具体可看<a href="https://github.com/evanw/esbuild">esbuild</a>官方文档</p></div><ul><li>根目录package.json配置dev</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"node scripts/dev.js"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>reactivity/dist/index.html 引入打包文件,在浏览器打开看看时候能执行</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./reactivity.js'</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">,</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue3 </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>generator的用法 &amp; async-await</title>
      <link href="/posts/e538.html"/>
      <url>/posts/e538.html</url>
      
        <content type="html"><![CDATA[<h1 id="generator用法实现以及async-await"><a href="#generator用法实现以及async-await" class="headerlink" title="generator用法实现以及async-await"></a>generator用法实现以及async-await</h1><h2 id="什么是generator"><a href="#什么是generator" class="headerlink" title="什么是generator"></a>什么是generator</h2><p>在 JavaScript 中，Generator 是<span class='p red'>一种特殊的函数</span>，它可以产生多个值的序列。Generator 函数使用 <span class='p red'>function*</span> 声明，并通过 <span class='p red'>yield 关键字</span> 来定义每个值的生成步骤。</p><p>Generator 函数可以被看作是一个<span class='p red'>状态机</span>，它可以在每次调用 next() 方法时暂停和恢复执行。每次调用 next() 方法时，Generator 函数会执行到<span class='p red'>下一个 yield 关键字处</span>，并将 <span class='p red'>yield 后面的值作为结果返回</span>。当再次调用 next() 方法时，Generator 函数会从上次暂停的位置继续执行，直到<span class='p red'>遇到下一个 yield 关键字或函数结束</span>。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span> <span class="token comment">// js执行是先走等号右边的，遇到yield就停止了</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span>  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">2</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span>  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">3</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: &#123; value: 1, done: false &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: a abc &#123; value: 2, done: false &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: &#123; value: 3, done: false &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出: &#123; value: undefined, done: true &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.guozy.online/img/2023/08/e04bc03c7b6d3f870f399ced90b73946.png" alt="generator执行"></p><p>通过调用 gen() 创建了一个 Iterator。每次调用 it.next() 方法，Generator 函数会<code>执行到下一个 yield 关键字处</code>，并返回一个<code>包含 value 和 done 属性的对象</code>。value 属性表示<code>生成的值</code>，done 属性表示 Generator 函数<code>是否已经执行完毕</code>。</p><p>通过<code>连续调用 it.next() 方法</code>，我们可以依次获取生成的值。当 Generator 函数执行完毕后，再次调用 next() 方法将<code>返回 undefined</code>。</p><p>js执行是先走等号右边的，遇到yield就停止了,如果想传递参数，<code>下一次调用next传递的参数</code>是<code>上一个yield的值</code></p><blockquote><p>需要注意的是，Generator 函数只是一种语法上的特殊函数，它不会立即执行，而是返回一个可迭代的 Generator 对象。我们需要通过调用 next() 方法来逐步获取生成的值。</p></blockquote><h2 id="generator的异步应用"><a href="#generator的异步应用" class="headerlink" title="generator的异步应用"></a>generator的异步应用</h2><blockquote><p>上面例子中我们可以看到 generator函数可以通过 yield 关键字暂停异步操作，并在操作完成后恢复执行。</p></blockquote><p>假如有两个文件文件名分别为<span class='p blue'>name.txt 、 age.txt</span></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// name.txt</span>age<span class="token punctuation">.</span>txt<span class="token comment">// age.txt</span><span class="token number">18</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有了上面的特性我们希望利用generator来这样写我们的异步代码</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs/promises'</span><span class="token punctuation">)</span> <span class="token comment">// 这里会把方法promise化</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">readResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 依旧是异步，只是看起来像同步的</span>    <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token keyword">yield</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> age<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样写起来有点虽然好，但是调用起来应为是promise，需要我们每次手动去.then (太麻烦了) <img no-lazy class="inline" src="https://bu.dusays.com/2022/05/19/6285328a83ca7.gif" style="height:40px;"/></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">readResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">let</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span>done <span class="token punctuation">&#125;</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span>done <span class="token punctuation">&#125;</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span>done <span class="token punctuation">&#125;</span> <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token comment">// 输出：18</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>终于 TJ 大佬写了个 co库,解决了这个问题,我们只需引入这个 co库 然后 co库 执行传入我们自定义的generator函数即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span> <span class="token comment">// 第三方模块</span><span class="token function">co</span><span class="token punctuation">(</span><span class="token function">readResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 输出：18</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这样是不是就简单多了，我们可以想象这个库是如何实现的:</p><ol><li><p class='p blue'>可以调用.then方法说明返回的是一个promise</p></li><li><p class='p blue'>co库内部会循环迭代promise</p></li></ol><blockquote><p>本质来讲 co 库就是帮我实现了上面的循环迭代 promise</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">co</span><span class="token punctuation">(</span><span class="token parameter">it</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span> <span class="token comment">// 同步迭代for循环，异步迭代用回调</span>        <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> value<span class="token punctuation">,</span>done <span class="token punctuation">&#125;</span> <span class="token operator">=</span>  it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 如果没完成返回的一定是一个promise (自己包的)</span>                Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                    <span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="async-await"><a href="#async-await" class="headerlink" title="async + await"></a>async + await</h2><p>上面的读取方法如果换成async + await 会写成这样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs/promises'</span><span class="token punctuation">)</span> <span class="token comment">// 这里会把方法promise化</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 依旧是异步，只是看起来像同步的</span>    <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> age<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一比较就会发现，<span class='p red'>async</span>函数就是将 Generator 函数的星号（<span class='p red'>*</span>）替换成<span class='p red'>async</span>，将<span class='p red'>yield</span>替换成<span class='p red'>await</span>，仅此而已。</p><p>await就是相当于<span class='p red'>co库</span>的功能，帮我们迭代执行async函数中的方法</p><p><code>async + await 相当于 generator + co库 的语法糖</code> <img no-lazy class="inline" src="https://bu.dusays.com/2022/05/19/6285328a83ca7.gif" style="height:40px;"/></p><blockquote><p>参考文章：<a href="https://es6.ruanyifeng.com/#docs/generator-async">Generator 函数的异步应用</a> 、 <a href="https://es6.ruanyifeng.com/#docs/async">async 函数</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ES6 </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从零开始实现一个符合A+规范的Promise</title>
      <link href="/posts/f09f.html"/>
      <url>/posts/f09f.html</url>
      
        <content type="html"><![CDATA[<h1 id="从零开始实现一个符合A-规范的Promise"><a href="#从零开始实现一个符合A-规范的Promise" class="headerlink" title="从零开始实现一个符合A+规范的Promise"></a>从零开始实现一个符合A+规范的Promise</h1><h2 id="Promise是什么-解决了什么问题？"><a href="#Promise是什么-解决了什么问题？" class="headerlink" title="Promise是什么,解决了什么问题？"></a>Promise是什么,解决了什么问题？</h2><p>Promise是一种用于异步编程的JavaScript对象。主要用于<emp>处理异步操作</emp> 的结果。</p><p>异步导致的<code>问题</code>：<u>回调地狱</u>（让代码难以阅读）、<u>错误处理</u>（无法统一处理错误）、<u>多个异步操作</u>（同步结果困难）</p><ul><li>Promise可以使用<emp>.then()</emp> 方法链式处理异步逻辑</li><li>Promise可以使用<emp>catch()</emp>.方法处理异步操作失败的情况</li><li>Promise提供<emp>.all()</emp>、<emp>.race()</emp>方法支持处理多个Promise对象的结果</li></ul><h2 id="开始实现一个符合A-规范的Promise"><a href="#开始实现一个符合A-规范的Promise" class="headerlink" title="开始实现一个符合A+规范的Promise"></a>开始实现一个符合A+规范的Promise</h2><h3 id="最基础的版本"><a href="#最基础的版本" class="headerlink" title="最基础的版本"></a>最基础的版本</h3><p>我们平常使用Promise时的用法通常是这样的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// todo...</span>  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>  <span class="token comment">// reject('失败')</span>  <span class="token comment">// throw new Error('error')</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'失败'</span><span class="token punctuation">,</span>reason<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从这种使用方法结合平常的使用我们可以知道Promise具有以下<code>特点</code>：</p><ul><li>Promise是<emp>一个类</emp>，使用的时候需要new Promise来产生一个promise实例</li><li>构造函数中需要传递一个参数 <emp>executor</emp>  ， executor是<emp>立即执行的</emp></li><li>executor参数中有两个参数 <emp>resolve(value)</emp> <emp>reject(reason)</emp></li><li>调用<emp>resolve会</emp>让promise <emp>变为成功</emp>，<emp>reject会变成失败</emp></li><li>有三种状态（pending等待态、fulfilled成功态、rejected失败态）,<emp>一旦状态发生改变后不能再修改状态</emp></li><li>每个promise实例都有一个<emp>then方法</emp>，会有两个参数 onfulfilled onrejected</li></ul><p>根据这些特性，我们可以写出基础版本的promise<emp></emp><emp></emp></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token comment">// 是一个类</span><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span>        <span class="token comment">// 实例上也能获取</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 一旦状态发生变化后不能再修改状态</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>            <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果executor执行发生异常 默认等价reject</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">const</span> resolve<span class="token punctuation">,</span><span class="token keyword">const</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="增加异步处理"><a href="#增加异步处理" class="headerlink" title="增加异步处理"></a>增加异步处理</h3><p>上面的版本如果立即修改promise 状态的话能成功，但是promise是用来解决异步问题的，这样就会存在问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token comment">// 异步调用promise会一直处于pending状态，无法正确处理</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>reason<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以我们需要在原型上增加 onFulfilledCbs，onRejectedCbs 两个数组, 当处于pending状态时分别把then中成功的方法和失败的方法放入数组中，当状态改变时循环执行数组中方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span>        <span class="token comment">// 实例上也能获取</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 一旦状态发生变化后不能再修改状态</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 如果executor执行发生异常 默认等价reject</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">const</span> resolve<span class="token punctuation">,</span><span class="token keyword">const</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span>onRejected</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 调用then的时候promise没成功也没失败</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">// this.onFulfilledCbs.push(onFulfilled)</span>            <span class="token comment">// 这样写是为了能拿到返回值并且方便增加一些自己的逻辑</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                <span class="token comment">// todo...</span>                <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h3><p>上面的代码.then链式调用的时候就会存在问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token comment">// 读取本地文件的操作</span><span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 这个返回值是 x -> x 决定promise外层下一个then是成功还是失败  </span>      <span class="token keyword">return</span> <span class="token number">100</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>promise2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2 success'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2 error'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>promise的核心是能进行<code>链式调用</code>,链式调用分为以下几种情况</p><ul><li><emp>返回的是一个普通值（非promise得值）</emp>这个值会被传到外层then的下一个then的成功中</li><li><emp>没有返回值 （抛错了）</emp>，会执行外层then的下一个then的失败</li><li><emp>返回的是promise</emp>，会去解析返回的promise将解析后的值，传递到成功或者失败中（看这个promise是什么）</li></ul><div class="note blue anzhiyufont anzhiyu-icon-fan flat"><p>链式调用一般情况需要返回的是this，promise为了能扭转状态 而且还要保证promise状态变化后不可更改，<code>返回一个全新的promise</code>(promise2)</p></div><p>then 方法可以优化为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ...</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 链式调用会返回一个全新的promise</span>  <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>              <span class="token comment">// 执行当前then拿到返回值</span>              <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>              <span class="token comment">// 把返回值传给下个then的成功</span>              <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>              <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">// 调用then的时候promise没成功也没失败</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>              <span class="token comment">// todo... 能拿到返回值</span>              <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>                  <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>              <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>                  <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>              <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> promise2<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="resolvePromise"><a href="#resolvePromise" class="headerlink" title="resolvePromise"></a>resolvePromise</h3><p>上面的链式调用返回的是一个普通值的话已经可以正常链式调用传递给下一个then了，但是如果返回的也是一个promise就需要进一步处理</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'name.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 这个返回值是 x -> x 决定promise外层下一个then是成功还是失败  </span>      <span class="token comment">// 返回的是一个Promise</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>promise2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2 success'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2 error'</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>就需要我们去解析返回值(A+规范中有具体的要求)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 此函数主要目的是判断x是不是promise</span><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 用x的值来决定promise2 是成功还是失败 （resolve,reject）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// promise实例要么是对象要么是函数</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x<span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 是promise</span>            <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then <span class="token comment">// 看是否有then方法</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>                    called <span class="token operator">=</span> <span class="token boolean">true</span>                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>                    called <span class="token operator">=</span> <span class="token boolean">true</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 是对象 </span>                <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>            called <span class="token operator">=</span> <span class="token boolean">true</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span> <span class="token comment">// 说明x是一个普通值</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 普通值直接向下传递即可        </span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// ...</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// then方法中如果没有传递参数 那么可以透传到下一个then中</span>    onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span><span class="token operator">:</span> <span class="token parameter">data</span> <span class="token operator">=></span> data    onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span> <span class="token function-variable function">onRejected</span><span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> reason<span class="token punctuation">&#125;</span>    <span class="token comment">// 链式调用会返回一个全新的promise</span>    <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token comment">// 这时候promise2是拿不到的，所以用nextTick</span>            process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token comment">// 执行拿到返回值</span>                    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>                    <span class="token comment">// 把返回值传给下个then的成功</span>                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 调用then的时候promise没成功也没失败</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                      <span class="token comment">// todo... 能拿到返回值</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>                        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">try</span>  <span class="token punctuation">&#123;</span>                        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>                        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> promise2<span class="token punctuation">&#125;</span><span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="完整版的promise实现"><a href="#完整版的promise实现" class="headerlink" title="完整版的promise实现"></a><code>完整版的promise实现</code></h3><p>通过以上步骤就实现了完整版的promise</p><div class="note blue anzhiyufont anzhiyu-icon-fan flat"><p>A+规范中是没有 Promise.all(),Promise.race等(),Promise.resolve()等等方法的要求的,现在已经是一个完整的Promise了</p></div><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">===</span> promise2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x<span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>                    called <span class="token operator">=</span> <span class="token boolean">true</span>                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>                    called <span class="token operator">=</span> <span class="token boolean">true</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>              <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>            called <span class="token operator">=</span> <span class="token boolean">true</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'FULFILLED'</span><span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">const</span> resolve<span class="token punctuation">,</span> <span class="token keyword">const</span> reject<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span><span class="token operator">:</span> <span class="token parameter">data</span> <span class="token operator">=></span> data        onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span> <span class="token function-variable function">onRejected</span><span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> reason<span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>                        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>                        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>                            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                        <span class="token keyword">try</span>  <span class="token punctuation">&#123;</span>                            <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>                            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>promise2<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> promise2    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如何确定自己实现的promise是否符合 A+ 规范呢</p><ol><li><p>下载检测工具 yarn global add <code>promise-aplus-tests</code></p></li><li><p>在尾部添加如下代码</p></li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> dfd <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve        dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> dfd<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>运行检测 <code>promises-aplus-tests myPromise.js</code></li></ol><p><img src="https://cdn.guozy.online/img/2023/08/32b0dae2386705c773dc0e1706d41e09.png" alt="promise检测结果"></p><p>哈哈，测试全部通过</p><h2 id="其他常用方法的实现"><a href="#其他常用方法的实现" class="headerlink" title="其他常用方法的实现"></a>其他常用方法的实现</h2><h3 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve"></a><code>Promise.resolve</code></h3><ul><li>Promise.resolve 有一个特点就是会产生一个新的promise</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>      <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Promise.resolve 可以即系传入的promise 具备等待的效果</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//...</span><span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 为了满足ECMAScript</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 一旦状态发生变化后不能再修改状态</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Promise-reject"><a href="#Promise-reject" class="headerlink" title="Promise.reject"></a><code>Promise.reject</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Promise-catch"><a href="#Promise-catch" class="headerlink" title="Promise.catch"></a><code>Promise.catch</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">catch</span><span class="token punctuation">(</span>errFn<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>errFn<span class="token punctuation">)</span> <span class="token comment">// 针对失败做处理</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a><code>Promise.all</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>                result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>idx <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a><code>Promise.race</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Promise-finally"><a href="#Promise-finally" class="headerlink" title="Promise.finally"></a><code>Promise.finally</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token comment">// Promise.resolve 具备一个功能 可以解析传入的promise</span>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> r<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ES6 </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>高阶函数</title>
      <link href="/posts/450.html"/>
      <url>/posts/450.html</url>
      
        <content type="html"><![CDATA[<h1 id="JavaScript中的高阶函数（Higher-Order-Functions）"><a href="#JavaScript中的高阶函数（Higher-Order-Functions）" class="headerlink" title="JavaScript中的高阶函数（Higher-Order Functions）"></a>JavaScript中的高阶函数（Higher-Order Functions）</h1><h2 id="什么是高阶函数"><a href="#什么是高阶函数" class="headerlink" title="什么是高阶函数"></a>什么是高阶函数</h2><p>是指能够<span class='p red'>接受一个或多个函数</span> 作为参数，<span class='p red'>并/或者返回一个新函数</span>的函数。</p><p>具体来说，高阶函数<emp>具备以下两个特点之一或两者兼具</emp>:</p><ol><li><span class='p blue'>接受函数作为参数</span>：高阶函数可以接受一个或多个函数作为参数，这些函数可以在高阶函数内部被调用、处理或者组合，以实现特定的功能。</li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">higherOrderFunction</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// todo...</span>  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">callbackFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是回调函数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">higherOrderFunction</span><span class="token punctuation">(</span>callbackFunction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：这是回调函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li><span class='p blue'>返回一个新函数</span>：高阶函数可以根据内部逻辑动态地生成并返回一个新的函数，该函数可以在其他地方被调用和使用。</li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createGreeter</span><span class="token punctuation">(</span><span class="token parameter">greeting</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// todo...</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>greeting<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> greetHello <span class="token operator">=</span> <span class="token function">createGreeter</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">greetHello</span><span class="token punctuation">(</span><span class="token string">'Alice'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：Hello, Alice!</span><span class="token function">greetHello</span><span class="token punctuation">(</span><span class="token string">'Bob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：Hello, Bob!</span><span class="token keyword">const</span> greetHi <span class="token operator">=</span> <span class="token function">createGreeter</span><span class="token punctuation">(</span><span class="token string">'Hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">greetHi</span><span class="token punctuation">(</span><span class="token string">'Charlie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：Hi, Charlie!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="高阶函数的作用"><a href="#高阶函数的作用" class="headerlink" title="高阶函数的作用"></a>高阶函数的作用</h2><h3 id="1-AOP切片编程"><a href="#1-AOP切片编程" class="headerlink" title="1.  (AOP切片编程)"></a>1. <span class='p blue'>对原有函数进行扩展</span> (AOP切片编程)</h3><p>假如有一个 core 函数，在<code>不修改这个函数</code>的情况下对 core 函数进行封装</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 我们希望对这个core进行封装</span><span class="token keyword">function</span> <span class="token function">core</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'核心逻辑'</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 希望增添一个before函数来扩展</span><span class="token keyword">const</span> newCore <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'增加的额外逻辑'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 能调用，说明返回值还是一个函数</span><span class="token function">newCore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就需要再 core 函数上扩展一个 <span class='p red'>before</span> 方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Function.prototype.before = 可以扩展到函数原型上，所有函数都可调用</span>core<span class="token punctuation">.</span><span class="token function-variable function">before</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 返回的是一个函数</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// todo...</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在核心逻辑之前执行自己的函数（逻辑）</span>    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token comment">// AOP 切片增加额外的逻辑，在原有的逻辑中增添额外的逻辑</span>    <span class="token comment">// todo...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-函数-和"><a href="#2-函数-和" class="headerlink" title="2. 函数  和 "></a>2. 函数 <span class='p blue'>柯里化</span> 和 <span class='p blue'>偏函数</span></h3><p>函数的柯里化（Currying）是一种将<code>接受多个参数的函数转化为一系列接受单个参数的函数的过程</code>。</p><p>具体来说，柯里化将一个接受多个参数的函数转化为一系列只接受一个参数的函数。每个单参数函数都会返回一个新的函数，该新函数接受下一个参数，并继续返回一个新函数，直到所有参数都被处理完毕，最后返回最终的结果。</p><p>而偏函数 <span class='p red'>（参数可以不是一个的柯理化函数）</span> </p><blockquote><p>正常来编写代码 我们把偏函数也称之为柯理化</p></blockquote><p>简单的柯里化示例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token parameter">y</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> add5 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 部分应用，返回一个新函数</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add5</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：8</span><span class="token keyword">const</span> add10 <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add10</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>让我们通过一个例子来说明柯里化的好处</code></p><p>判断某个变量是不是某个类型我们会这样写</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isType</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span>typing</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> typing<span class="token punctuation">&#125;</span><span class="token comment">// 判断某个变量是不是一个字符串 </span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isType</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token string">'String'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isType</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span><span class="token string">'String'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>typing类型每次需要传递，有些多余，我们会想到用高阶函数把它缓存起来，这样更方便</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isType</span><span class="token punctuation">(</span><span class="token parameter">typing</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// typing 保存到这个作用域下 （闭包）</span>    <span class="token keyword">return</span> <span class="token parameter">val</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 定义的作用域</span>        <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> typing    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> isString <span class="token operator">=</span> <span class="token function">isType</span><span class="token punctuation">(</span><span class="token string">'String'</span><span class="token punctuation">)</span> <span class="token comment">// 闭包 定义的函数的作用域和执行函数的作用域不是同一个就是产生闭包</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 执行的作用域</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而有了柯理化函数，我们也可以这样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isType</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span>typing</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> typing<span class="token punctuation">&#125;</span><span class="token comment">// 判断某个变量是不是一个字符串 </span><span class="token keyword">let</span> isString <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span>isType<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'String'</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么关键问题来了，这个<code>柯里化函数curry</code>是怎么实现的，他做了那些事情呢？</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 判断参数个数是否等价</span><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">&#125;</span><span class="token comment">// sum(1,2)(3)</span><span class="token comment">// 柯理化函数一定是高阶函数</span><span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token function-variable function">curried</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用户本次执行的时候传递的参数，本次为 1,2</span>        <span class="token comment">// 这里判断参数的长度是否等于需要柯理化的函数的参数长度 ps: 关键问题的关键QAQ</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> func<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// ps: 函数的长度等于参数的个数</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>others</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">curried</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span><span class="token operator">...</span>others<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> curried<span class="token punctuation">&#125;</span><span class="token keyword">let</span> curriedSum <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 6</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数的柯里化可以带来一些<code>好处</code>，例如：</p><ul><li><span class='p gray'>提供更高的灵活性和复用性</span>：通过柯里化，我们可以轻松地创建一系列根据不同情况预设部分参数的函数，以适应不同的使用场景。</li><li><span class='p gray'>实现函数的延迟执行</span>：柯里化可以将一个多参数函数转化为一系列接受单个参数的函数，这样可以延迟函数的执行，只有当所有参数都准备就绪时才真正执行。</li><li><span class='p gray'>支持函数组合</span>：柯里化可以方便地将多个函数组合在一起，形成一个新的函数管道，使代码更加模块化和可组合。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>高阶函数在JavaScript中具有广泛的应用，可以用于实现函数的组合、函数的延迟执行、函数的柯里化等功能。常见的高阶函数包括map、filter、reduce等数组方法，以及setTimeout、setInterval等定时器函数。</p><p>通过使用高阶函数，我们可以更灵活地处理函数和数据，使代码更加简洁、可复用和可扩展。</p>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 总结 </tag>
            
            <tag> 原生js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生成hexo底部自定义小徽章</title>
      <link href="/posts/d3a9.html"/>
      <url>/posts/d3a9.html</url>
      
        <content type="html"><![CDATA[<h2 id="生成hexo底部自定义小徽章"><a href="#生成hexo底部自定义小徽章" class="headerlink" title="生成hexo底部自定义小徽章"></a>生成hexo底部自定义小徽章</h2><h3 id="1-什么是徽章"><a href="#1-什么是徽章" class="headerlink" title="1.什么是徽章"></a>1.什么是徽章</h3><p>徽章是一种小巧精美的小图标，一般配有相关文字进行辅助说明，富有表现力，本质是一种 <span class='p red'>svg格式的矢量图标</span></p><p><img src="https://cdn.guozy.online/config/%E5%A4%87%E6%A1%88%E5%8F%B7.svg"></p><h3 id="2-如何生成自定义徽章"><a href="#2-如何生成自定义徽章" class="headerlink" title="2.如何生成自定义徽章"></a>2.如何生成自定义徽章</h3><h4 id="标题／内容／颜色／链接"><a href="#标题／内容／颜色／链接" class="headerlink" title="标题／内容／颜色／链接"></a>标题／内容／颜色／链接</h4><p><a href="https://shields.io/badges/static-badge">shields.io</a>提供了添加自定义徽标的功能，通过修改如下URL即可获取自定义徽标图片：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span><span class="token punctuation">&#123;</span>徽标标题<span class="token punctuation">&#125;</span><span class="token operator">-</span><span class="token punctuation">&#123;</span>徽标内容<span class="token punctuation">&#125;</span><span class="token operator">-</span><span class="token punctuation">&#123;</span>徽标颜色<span class="token punctuation">&#125;</span><span class="token punctuation">.</span>svg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><emp>{徽标标题}</emp>：徽标左半部分的文本（短线：--，下划线：__，空格： 或_）；</li><li><emp>{徽标内容}</emp>：徽标右半部分的文本，同上；</li><li><emp>{徽标颜色}</emp>：徽标右半部分背景颜色，可以是 red、green、blue 等颜色英文单词，也可以直接写十六进制的颜色值，如 ff69b4</li></ul><p>将其中的 {徽标标题}、{徽标内容}、{徽标颜色} 分别替换为需要的内容即可：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span>blog<span class="token operator">-</span>@Aurora<span class="token operator">-</span>green<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>做出如下代码和效果如下<img no-lazy class="inline" src="https://bu.dusays.com/2022/05/19/6285328a83ca7.gif" style="height:40px;"/>：</p><p><img src="https://img.shields.io/badge/blog-@Aurora-green"></p><h4 id="附加参数"><a href="#附加参数" class="headerlink" title="附加参数"></a>附加参数</h4><p>可以在徽标图片 URL 后面带上一些参数来控制徽标的样式，这一部分是可选的，不想折腾的话默认的样式就挺好了，可以不看这里的。</p><p>使用方法就是在徽标图片 URL 后面跟上 <span class='p red'>?{参数名}={参数值}</span></p><p>多个参数联用的话就是 <span class='p red'>?{参数名1}={参数值1}&{参数名2}={参数值2}...</span></p><h5 id="style"><a href="#style" class="headerlink" title="style"></a>style</h5><p>style 控制徽标的主体样式，有四种，不设置的话默认是 <span class='p red'>flat</span> 的，示例代码和效果如下：</p><p class='p blue'>plastic</p><p>塑料？大概是指立体效果</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>style<span class="token operator">=</span>plastic<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?style=plastic"></p><p class='p blue'>flat</p><p>正常的样子，扁平化</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>style<span class="token operator">=</span>flat<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?style=flat"></p><p class='p blue'>flat-square</p><p>扁平化 + 去除圆角</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>style<span class="token operator">=</span>flat<span class="token operator">-</span>square<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?style=flat-square"></p><p class='p blue'>social</p><p>扁平化 + 去除圆角</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>style<span class="token operator">=</span>social<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?style=social"></p><ul><li>label</li></ul><p>该参数可以用来强制覆盖原有的徽标标题文字，效果如下，原有的 pod 字样已经被覆盖了：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>label<span class="token operator">=</span>healthinesses<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?label=healthinesses"></p><h5 id="logo"><a href="#logo" class="headerlink" title="logo"></a>logo</h5><p>该参数可以用来为徽标添加 logo，logo 图片会出现在左半部分的徽标标题左边，logo 图片高度必须 ≥ 14px，logo 图片需要先转为 base64 编码然后直接插入到 URL 中（可以用 <a href="https://b64.io/">b64.io</a>将图片转为 base64 编码的字符串），格式如下。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">?</span>logo<span class="token operator">=</span><span class="token punctuation">&#123;</span>base64 编码后的图片数据<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>示例代码和效果如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">BA</span><span class="token operator">%</span><span class="token constant">ACICP</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span><span class="token constant">A4</span><span class="token operator">%</span><span class="token number">87</span><span class="token operator">-</span><span class="token number">2021021028</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span>8F<span class="token operator">%</span><span class="token constant">B7</span><span class="token operator">-</span>red<span class="token operator">?</span>logo<span class="token operator">=</span>data<span class="token operator">%</span>3Aimage<span class="token operator">%</span>2Fpng<span class="token operator">%</span>3Bbase64<span class="token operator">%</span>2CiVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8<span class="token operator">%</span>2BCiA8L3JkZjpSREY<span class="token operator">%</span>2BCjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8<span class="token operator">%</span>2Bnhxg7wAACNlJREFUSInF1mmMVeUdx<span class="token operator">%</span>2FHv2e<span class="token operator">%</span>2B5<span class="token operator">%</span>2B519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf<span class="token operator">%</span>2B7z6J8<span class="token operator">%</span>2BLT37<span class="token operator">%</span>2FZ4VvaQhfFS8<span class="token operator">%</span>2BsBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5<span class="token operator">%</span>2Ftmn20N<span class="token operator">%</span>2FD0wKDRMq9F<span class="token operator">%</span>2Fc3M2U1<span class="token operator">%</span>2FV0vDfWMFh<span class="token operator">%</span>2Btv<span class="token operator">%</span>2FIg1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ<span class="token operator">%</span>2FsDQABRzD22fH7<span class="token operator">%</span>2FYze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH<span class="token operator">%</span>2Boy7n3tbvv<span class="token operator">%</span>2FP2wW<span class="token operator">%</span>2FUQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O<span class="token operator">%</span>2Bh6UVWHnUFbPpU0fEb2A60mMJ7MUi9b<span class="token operator">%</span>2Fb7UgKhiZMaIxm8YLplLMDPz8hl<span class="token operator">%</span>2FEH<span class="token operator">%</span>2Brs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z<span class="token operator">%</span>2BhrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o<span class="token operator">%</span>2F3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy<span class="token operator">%</span>2FFqOC2Y3s3j53HMSi18VRjFPwSwg<span class="token operator">%</span>2B1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO<span class="token operator">%</span>2BXx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK<span class="token operator">%</span>2BSs7Fxz64OTSxSX<span class="token operator">%</span>2BLHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7<span class="token operator">%</span>2Ff8rS<span class="token operator">%</span>2FClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ<span class="token operator">%</span>2BCWGFzcg7e7m6D3<span class="token operator">%</span>2FZuW1Ea5YKdA3EojuONi813TqNi<span class="token operator">%</span>2BYPYOKUhXDtCeGL26<span class="token operator">%</span>2FhakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa<span class="token operator">%</span>2Brw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s<span class="token operator">%</span>2BdHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi<span class="token operator">%</span>2BxUmZ2RiR<span class="token operator">%</span>2FsJ1pbS8NkgZrKAGw0TsgQsQyFaF<span class="token operator">%</span>2FnfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER<span class="token operator">%</span>2BhZW4j63gcJj38V<span class="token operator">%</span>2B<span class="token operator">%</span>2FErSUZXsYBfjIZHIRW0c2Z8BskCAqN<span class="token operator">%</span>2BCbBJBFnyyKjR<span class="token operator">%</span>2BEz57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4<span class="token operator">%</span>2B0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y<span class="token operator">%</span>2FcB75<span class="token operator">%</span>2FX6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP<span class="token operator">%</span>2BNGTFJtDpPYeZKijk<span class="token operator">%</span>2FRn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls<span class="token operator">%</span>2BtX<span class="token operator">%</span>2FUD7GN<span class="token operator">%</span>2FY8Ws05w6rQF<span class="token operator">%</span>2B9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy<span class="token operator">%</span>2BbzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2<span class="token operator">%</span>2BR7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c<span class="token operator">%</span>2B6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM<span class="token operator">%</span>2B<span class="token operator">%</span>2Bzp1bH<span class="token operator">%</span>2F0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve<span class="token operator">%</span>2F18AbT<span class="token operator">%</span>2Bpk8pVY4UacQi9y<span class="token operator">%</span>2BgyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S<span class="token operator">%</span>2Bt5<span class="token operator">%</span>2B2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo<span class="token operator">%</span>2FpumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7<span class="token operator">%</span>2B7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav<span class="token operator">%</span>2FhFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ<span class="token operator">%</span>2FDGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr<span class="token operator">%</span>2B8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO<span class="token operator">%</span>2FHFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK<span class="token operator">%</span>2F<span class="token operator">%</span>2BB85xznnJ3AWzqTzuIX46mr5wLs<span class="token operator">%</span>2BUUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0<span class="token operator">%</span>2BjCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r<span class="token operator">%</span>2BcMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8<span class="token operator">%</span>2B11<span class="token operator">%</span>2Fw<span class="token operator">%</span>2FOOJDEhHPKLCIpOXmi<span class="token operator">%</span>2BM9AgP<span class="token operator">%</span>2BmaiesLifF2T1Rn5ZNj5Lo<span class="token operator">%</span>2FQc<span class="token operator">%</span>2FGcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X<span class="token operator">%</span>2FeryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP<span class="token operator">%</span>2FLh3eHD76MB40swmiDVJyDLYRhpc5<span class="token operator">%</span>2Bub6tse<span class="token operator">%</span>2FwWKbvSQEAw1awAAAABJRU5ErkJggg<span class="token operator">%</span>3D<span class="token operator">%</span>3D<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://img.shields.io/badge/%E4%BA%ACICP%E5%A4%87-2021021028%E5%8F%B7-red?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAACNlJREFUSInF1mmMVeUdx/Hv2e+5+519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf+7z6J8+LT37/Z4VvaQhfFS8+sBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5/tmn20N/D0wKDRMq9F/c3M2U1/V0vDfWMFh+tv/Ig1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ/sDQABRzD22fH7/Yze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH+oy7n3tbvv/P2wW/UQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O+h6UVWHnUFbPpU0fEb2A60mMJ7MUi9b/b7UgKhiZMaIxm8YLplLMDPz8hl/EH+rs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z+hrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o/3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy/FqOC2Y3s3j53HMSi18VRjFPwSwg+1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO+Xx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK+Ss7Fxz64OTSxSX+LHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7/f8rS/ClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ+CWGFzcg7e7m6D3/ZuW1Ea5YKdA3EojuONi813TqNi+YPYOKUhXDtCeGL26/hakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa+rw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s+dHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi+xUmZ2RiR/sJ1pbS8NkgZrKAGw0TsgQsQyFaF/nfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER+hZW4j63gcJj38V+/ErSUZXsYBfjIZHIRW0c2Z8BskCAqN+CbBJBFnyyKjR+Ez57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4+0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y/cB75/X6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP+NGTFJtDpPYeZKijk/Rn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls+tX/UD7GN/Y8Ws05w6rQF+9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy+bzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2+R7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c+6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM++zp1bH/0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve/18AbT+pk8pVY4UacQi9y+gyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S+t5+2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo/pumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7+7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav/hFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ/DGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr+8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO/HFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK/+B85xznnJ3AWzqTzuIX46mr5wLs+UUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0+jCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r+cMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8+11/w/OOJDEhHPKLCIpOXmi+M9AgP+maiesLifF2T1Rn5ZNj5Lo/Qc/GcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X/eryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP/Lh3eHD76MB40swmiDVJyDLYRhpc5+ub6tse/wWKbvSQEAw1awAAAABJRU5ErkJggg=="></p><h5 id="logoWidth"><a href="#logoWidth" class="headerlink" title="logoWidth"></a>logoWidth</h5><p>该参数可以设置在上一个参数 logo 中添加的图标的宽度，设为 0 的话即为忽略该参数，示例代码和效果如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span>gadget<span class="token operator">-</span>Raspberry<span class="token operator">%</span>20Pi<span class="token operator">-</span>pink<span class="token punctuation">.</span>svg<span class="token operator">?</span>logoWidth<span class="token operator">=</span><span class="token number">100</span><span class="token operator">&amp;</span>logo<span class="token operator">=</span>data<span class="token operator">%</span>3Aimage<span class="token operator">%</span>2Fpng<span class="token operator">%</span>3Bbase64<span class="token operator">%</span>2CiVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAACJ0lEQVR4AW2Qy0tUfxjGv3Pm3O<span class="token operator">%</span>2BXGec3jnMZZ9Rxxp<span class="token operator">%</span>2BWkYpJ2QkVIzDpkkoGBSOpBZmWgRIkWSs30SJchC26B9aijKLaFET9Be1q46ayRVDU5uk9Q8seeOG8X573eT<span class="token operator">%</span>2FnZbwQqo5l5Rube52PQdH3BcaY4SbEiy2<span class="token operator">%</span>2B<span class="token operator">%</span>2FWFLv7ueblJv0luJmRHBHzqfwuyDRkzfKqB8pRZeQnwzuZynvgHTtwsYvZRBs2<span class="token operator">%</span>2BVGSU5nfsjX2bocexqDsMLKXgZCQfmkzi6lK0EDJxOfNJdoYORQl5O3OeXY5<span class="token operator">%</span>2BH59PI5XXUMh3RuIQR6v2J2Ld8h3488FXMBWb2TJkNPw9GUzirF3HX2oZFrQUD0Rqc84rfVcaPs0D<span class="token operator">%</span>2FcTK<span class="token operator">%</span>2FQ6y6N6eVsJX3MCglcUzJYVytw6CYxKRSj1Elu0bWCBNCXCnPGz96pTieOTvxyN6OIm<span class="token operator">%</span>2Fhid2Nx1SzWhGxsLwR4aQ9rFOMPl8lwwQlvXZ78NLZhRbBwZrTjReOjzuENKc1YUTOrLJ<span class="token operator">%</span>2BKf7<span class="token operator">%</span>2BsrEJhIL7dhfOaI34n7cxpRWwYnbghFqPMmENyelXzOLE0d1SNbrFGOKcgmDwnduH61Y7zJCAvVINDisZJMPqNEuHVeOQnPr11u3FESWLa2ZbBecp8VNaZXBBb15njHUxmxPC7YK3uGS0YkzNo1VwcZJWtwkeThHKMg33SfEVMqsskBeSjLqwMZYKa18ppXKRwESIv0u8NVPFyRb7hxK0ZYX<span class="token operator">%</span>2BfIPO95D6KBXH<span class="token operator">%</span>2FuoPnu<span class="token operator">%</span>2FBfZ7Zxb0AAAAASUVORK5CYII<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/badge/gadget-Raspberry%20Pi-pink.svg?logoWidth=100&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAACJ0lEQVR4AW2Qy0tUfxjGv3Pm3O+XGec3jnMZZ9Rxxp+WkYpJ2QkVIzDpkkoGBSOpBZmWgRIkWSs30SJchC26B9aijKLaFET9Be1q46ayRVDU5uk9Q8seeOG8X573eT/nZbwQqo5l5Rube52PQdH3BcaY4SbEiy2+/WFLv7ueblJv0luJmRHBHzqfwuyDRkzfKqB8pRZeQnwzuZynvgHTtwsYvZRBs2+VGSU5nfsjX2bocexqDsMLKXgZCQfmkzi6lK0EDJxOfNJdoYORQl5O3OeXY5+H59PI5XXUMh3RuIQR6v2J2Ld8h3488FXMBWb2TJkNPw9GUzirF3HX2oZFrQUD0Rqc84rfVcaPs0D/cTK/Q6y6N6eVsJX3MCglcUzJYVytw6CYxKRSj1Elu0bWCBNCXCnPGz96pTieOTvxyN6OIm/hid2Nx1SzWhGxsLwR4aQ9rFOMPl8lwwQlvXZ78NLZhRbBwZrTjReOjzuENKc1YUTOrLJ+Kf7+srEJhIL7dhfOaI34n7cxpRWwYnbghFqPMmENyelXzOLE0d1SNbrFGOKcgmDwnduH61Y7zJCAvVINDisZJMPqNEuHVeOQnPr11u3FESWLa2ZbBecp8VNaZXBBb15njHUxmxPC7YK3uGS0YkzNo1VwcZJWtwkeThHKMg33SfEVMqsskBeSjLqwMZYKa18ppXKRwESIv0u8NVPFyRb7hxK0ZYX+fIPO95D6KBXH/uoPnu/BfZ7Zxb0AAAAASUVORK5CYII"></p><h5 id="link"><a href="#link" class="headerlink" title="link"></a>link</h5><p>据说该参数是用来设置点击后跳转的 URL 的（嗯，俗称超链接），官方描述如下：</p><p>Specify what clicking on the left/right of a badge should do (esp. for social badge style)</p><p>不过试了一下好像没啥效果（并且实在是没想明白怎么通过返回的图片控制不同点击区域的跳转），如果有大佬知道的求指点，感谢！</p><h5 id="colorA"><a href="#colorA" class="headerlink" title="colorA"></a>colorA</h5><p>该参数用来控制徽标左半部分的背景色，只能用十六进制的颜色作为参数哦，不能直接写 red、green、blue 之类的，这里将左半部分的背景色改为 0xabcdef，代码和效果如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span>twitter<span class="token operator">-</span>@EyreFree777<span class="token operator">-</span>blue<span class="token punctuation">.</span>svg<span class="token operator">?</span>colorA<span class="token operator">=</span>abcdef<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/badge/twitter-@EyreFree777-blue.svg?colorA=abcdef"></p><h5 id="colorB"><a href="#colorB" class="headerlink" title="colorB"></a>colorB</h5><p>该参数用来控制徽标右半部分的背景色，同上，只能用十六进制的颜色作为参数哦，不能直接写 red、green、blue 之类的，这里将右半部分的背景色改为 0xabcdef，代码和效果如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>badge<span class="token operator">/</span>twitter<span class="token operator">-</span>@EyreFree777<span class="token operator">-</span>blue<span class="token punctuation">.</span>svg<span class="token operator">?</span>colorB<span class="token operator">=</span>abcdef<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img.shields.io/badge/twitter-@EyreFree777-blue.svg?colorB=abcdef"></p><h5 id="maxAge"><a href="#maxAge" class="headerlink" title="maxAge"></a>maxAge</h5><p>该参数用来设置 HTTP 缓存时间，以秒为单位，直接在 svg 地址后跟 ?maxAge={缓存秒数} 即可，好像没啥好预览的，不放效果图了。</p><h5 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h5><p>这里需要注意的是，如果你是引用的第三方 svg 然后添加自己的样式，如果该样式之前已经被第三方添加过，是不一定会覆盖第三方的设置的，也就是说自己设置的属性不一定会生效…例如下面的代码设置 colorB 就没生效：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>img<span class="token punctuation">.</span>shields<span class="token punctuation">.</span>io<span class="token operator">/</span>cocoapods<span class="token operator">/</span>v<span class="token operator">/</span>Alamofire<span class="token punctuation">.</span>svg<span class="token operator">?</span>colorB<span class="token operator">=</span><span class="token number">000000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>右半部分应该变成黑色，但是毫无效果的说：</p><p><img src="https://img.shields.io/cocoapods/v/Alamofire.svg?colorB=000000"></p><h3 id="3-如何使用徽章"><a href="#3-如何使用徽章" class="headerlink" title="3.如何使用徽章"></a>3.如何使用徽章</h3><p>大多数徽章都是 <span class='p red'>svg</span> 格式，当然也不排除默写徽章是 <span class='p red'>png</span> 格式，不论怎么说，一律当成图标使用就可以了，如果你和我一样,希望在 <span class='p red'>markdown</span> 文件中使用徽章,那么建议使用在线链接,或者引入本地 <span class='p red'>svg</span> 相关文件.</p><ul><li>在markdown中直接使用</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cdn<span class="token punctuation">.</span>guozy<span class="token punctuation">.</span>online<span class="token operator">/</span>config<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span><span class="token constant">A4</span><span class="token operator">%</span><span class="token number">87</span><span class="token operator">%</span><span class="token constant">E6</span><span class="token operator">%</span><span class="token constant">A1</span><span class="token operator">%</span><span class="token number">88</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span>8F<span class="token operator">%</span><span class="token constant">B7</span><span class="token punctuation">.</span>svg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>想在点击图片后跳转到某个页面，可以这样写</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cdn<span class="token punctuation">.</span>guozy<span class="token punctuation">.</span>online<span class="token operator">/</span>config<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span><span class="token constant">A4</span><span class="token operator">%</span><span class="token number">87</span><span class="token operator">%</span><span class="token constant">E6</span><span class="token operator">%</span><span class="token constant">A1</span><span class="token operator">%</span><span class="token number">88</span><span class="token operator">%</span><span class="token constant">E5</span><span class="token operator">%</span>8F<span class="token operator">%</span><span class="token constant">B7</span><span class="token punctuation">.</span>svg<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">beian.miit.gov.cn</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>如果你是在 html 文件使用徽章,同样先取得在线徽章地址,然后按照 <span class='p red'>html</span> 语法插入图片即可.</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"https://beian.miit.gov.cn/"</span><span class="token operator">></span><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">"https://cdn.guozy.online/config/%E5%A4%87%E6%A1%88%E5%8F%B7.svg"</span> alt<span class="token operator">=</span><span class="token string">"备案号"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>不论是什么语法,最核心最根本的获得到徽章链接,至于不同语言有着各自的语法,按照语言规则手动拼接就好.</p><h3 id="工具网站"><a href="#工具网站" class="headerlink" title="工具网站"></a>工具网站</h3><blockquote><p>生成图标<a href="https://shields.io/badges/static-badge">Shields.io</a><br>图片转base64<a href="https://b64.io/">b64.io</a></p></blockquote><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><blockquote><p><a href="https://juejin.cn/post/6844903872830373895#comment">工具资源系列之 github 上各式各样的小徽章从何而来?</a><br><a href="https://juejin.cn/post/6844903529627254798#heading-10">GitHub 项目徽章的添加和设置</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客优化点</title>
      <link href="/posts/66bc.html"/>
      <url>/posts/66bc.html</url>
      
        <content type="html"><![CDATA[<h2 id="博客更新已经优化清单"><a href="#博客更新已经优化清单" class="headerlink" title="博客更新已经优化清单"></a>博客更新已经优化清单</h2><ul><li><input checked="" disabled="" type="checkbox"> CDN加速  <code>多吉云</code>加速ing</li><li><input checked="" disabled="" type="checkbox"> <a href="https://dashboard.algolia.com/">添加Algolia搜索</a></li><li><input disabled="" type="checkbox"> 文章详情模块随背景图改变颜色</li><li><input disabled="" type="checkbox"> 支持文章隐藏功能</li><li><input checked="" disabled="" type="checkbox"> <a href="https://twikoo.js.org/quick-start.html">接入Twikoo评论模块</a></li><li><input checked="" disabled="" type="checkbox"> 留言板和追番页配置</li><li><input disabled="" type="checkbox"> 底部备案号</li><li><input disabled="" type="checkbox"> 如何引入第三方图标</li><li><input checked="" disabled="" type="checkbox"> Twikoo评论模块私有化部署   已采用 <code>mongoDB cloud + Vercel</code> 部署 </li><li><input checked="" disabled="" type="checkbox"> 部署后使用<code>7bu</code>图床上传评论图片</li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.fomal.cc/posts/2d7ac914.html">引入Vue+Element样式弹窗</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.fomal.cc/posts/d739261b.html">添加昼夜切换效果</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://zfe.space/post/hexo-history-calendar.html">hexo-history-calendar 历史上的今天插件</a></li></ul><blockquote><p>搜索相关文章：<a href="https://blog.ccknbc.cc/posts/hexo-butterfly-algolia/">Hexo Butterfly Algolia 搜索的使用</a></p></blockquote><blockquote><p>评论相关文章：<a href="https://www.jianshu.com/p/c00b8e329f46">Hexo中Twikoo评论系统配置教程</a>  <a href="https://butterfly.js.org/posts/ceeb73f/">Butterfly 安装文档(四) 主题配置-2</a></p></blockquote><h2 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h2><ul><li><input checked="" disabled="" type="checkbox"> 自动化博客部署</li></ul><blockquote><p><a href="https://blog.csdn.net/weixin_58068682/article/details/122770936">部署Twikoo评论系统及其邮件推送(Vercel)</a></p></blockquote><p>全自动部署文章参考</p><blockquote><p><a href="https://akilar.top/posts/f752c86d/">使用Github Action实现全自动部署</a><br><a href="https://blog.anheyu.com/posts/b228.html">hexo博客工作流CI（一键部署的快乐</a><br><a href="https://juejin.cn/post/7088973326055374862">github action 持续集成部署 web 应用</a><br><a href="https://cloud.tencent.com/developer/article/2277577?areaSource=102001.17&traceId=yqggOeDg0-9SNsH8YpfPX">Hexo博客利用GitHub Action自动化部署</a></p></blockquote><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol><li>在hexo generate或hexo deploy之前使用<code>hexo bangumi -u</code>命令更新追番数据，使用<code>hexo cinema -u</code>命令更新追剧数据！</li><li>删除数据命令:hexo bangumi -d/hexo cinema -d</li></ol>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>浏览器工作原理</title>
      <link href="/posts/fbf6.html"/>
      <url>/posts/fbf6.html</url>
      
        <content type="html"><![CDATA[<h1 id="浏览器工作原理"><a href="#浏览器工作原理" class="headerlink" title="浏览器工作原理"></a>浏览器工作原理</h1><blockquote><p>浏览器（也称为<code>网络浏览器</code>或<code>互联网浏览器</code>）是安装在我们设备商的软件应用程序，使我们能够访问万维网。在阅读这篇文字时，你实际上正在使用一个浏览器</p></blockquote><p>有许多浏览器正在被使用，截止2022年，使用最多的是：<code>谷歌浏览器</code>，苹果的<code>Safari</code>，微软的<code>Edge</code>和<code>火狐</code>。</p><p>但是，它们实际上是如何工作的，从我们在地址栏中<code>键入网络地址开始</code>，到我们试图访问的<code>页面显示在屏幕</code>上，会发生什么？</p><p>这个看似超级简单的过程中涉及更多的内容，在下面我们将<code>导航</code>、<code>获取数据</code>、<code>解析</code> 和 <code>渲染</code>等步骤，来探究浏览器工作原理</p><h2 id="1-导航"><a href="#1-导航" class="headerlink" title="1.导航"></a>1.导航</h2><p>导航是加载网页的第一步。它指的是当用户通过<code>点击一个链接</code>、<code>在浏览器地址栏中写下一个网址</code>、<code>提交一个表格</code>等方式请求一个网页时发生的过程</p><h3 id="DNS查询（解决网址问题）"><a href="#DNS查询（解决网址问题）" class="headerlink" title="DNS查询（解决网址问题）"></a>DNS查询（解决网址问题）</h3><p>导航到一个网页的第一步是找到该网页的<code>静态资源</code>位置（HTML、CSS、Javascript和其他类型的文件）。如果我们导航到 example.com ，HTML 页面位于 IP 地址为 93.184.216.34 的服务器上（对我们来说，网站是域名，但对计算机来说，它们是 <code>IP 地址</code>）。如果我们以前从未访问过这个网站，就必须进行域名系统（DNS）查询。</p><blockquote><p>DNS 服务器是包含<code>公共 IP 地址</code>及其相关<code>主机名</code>数据库的计算机服务器（这通常被比作<code>电话簿</code>，因为人们的名字与一个特定的电话号码相关联）。在大多数情况下，这些服务器按照要求将这些名字解析或翻译成 IP 地址（现在有 600 多个不同的 DNS 根服务器分布在世界各地）。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb726ecac.png"></p><p>因此，当我们请求进行 DNS 查询时，我们<code>实际做的是与这些服务器中的一个进行对话</code>，要求找出与example.com 名称相对应的IP地址。如果<code>找到</code>了一个<code>对应的 IP</code>，就会返回。如果发生了一些情况，查找不成功，我们会在浏览器中看到一些错误信息。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb74815be.png"></p><p>在这个最初的查询之后，IP 地址可能会被<code>缓存一段时间</code>，所以下次访问同一个网站会更快，因为不需要进行 DNS 查询（记住，<code>DNS 查询只发生在我们第一次访问一个网站时</code>）。</p><h3 id="TCP-Transmission-Control-Protocol-握手"><a href="#TCP-Transmission-Control-Protocol-握手" class="headerlink" title="TCP(Transmission Control Protocol)握手"></a>TCP(Transmission Control Protocol)握手</h3><p>一旦浏览器知道了网站的 IP 地址，它将尝试通过 TCP <code>三次握手</code>（也称为 SYN-SYN-ACK，或者更准确的说是 SYN、SYN-ACK、ACK，因为 TCP 有三个消息传输，用于协商和启动两台计算机之间的TCP 会话），与持有资源的服务器建立连接。</p><blockquote><p>TCP 是<code>传输控制协议</code>的缩写，是一种通信标准，使应用程序和计算设备能够在网络上交换信息。它被设计用来在互联网上发送数据包，并确保数据和信息在网络上成功传递。</p></blockquote><p>TCP 握手是一种机制，旨在让<code>两个想要相互传递信息的实体</code>（在我们的例子中是浏览器和服务器）在<code>传输数据之前协商好连接的参数</code>。</p><p>因此，如果浏览器和服务器是两个人，他们之前的对话会是这样的：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ca650a.png"></p><p>浏览器向服务器发送一个 <strong>SYNC</strong>消息，要求进行同步（同步意味着链接）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dc4ac2.png"></p><p>然后，服务器将回复一个 <strong>SYNC-ACK</strong> 消息（SYNChorization 和 ACKnowledgement）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dd211e.png"></p><p>在最后一步，浏览器将回复一个 <strong>ACK</strong> 信息</p><p>现在，TCP链接 （双向链接）已经通过3次握手建立，TLS协商可以开始。</p><h3 id="TLS协商"><a href="#TLS协商" class="headerlink" title="TLS协商"></a>TLS协商</h3><p>对于通过<code>HTTPS</code>建立的安全链接，需要进行另一次握手。这种握手（<code>TLS协商</code>）决定了那个密码将被用于<code>加密通信</code>，验证服务器，并在开始实际的<code>数据传输之前建立一个安全的连接</code></p><blockquote><p><code>传输层安全</code>（TLS）是现已废弃的安全套接字层 （SSL）的继任者，是一种加密协议，<code>旨在通过计算机网络提供通信安全</code>。该协议被广泛用于电子邮件和即时通讯等应用，但它在确保HTTPS安全方面的应用仍然是<code>最公开的</code>。由于应用程序可以使用或不使用TLS(或SSL)进行通信，因此客户（浏览器）有必要要求服务器建立TLS连接。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dd211e.png"></p><p>在这一步骤中，浏览器和服务器之间还交换了一些信息</p><ol><li><strong>客户端hello</strong>。 浏览器向服务器发送一条信息，其中包括它所支持的TLS版本和密码套件，以及一串随机字节，称为<code>客户端随机数</code></li><li> <strong>服务器hello和证书</strong>。服务器发回一条信息，其中包括服务器的SSL证书、服务器选择的密码套件和<code>服务器随机数</code>，这是服务器生成的另一个随机字节串。</li><li> <strong>认证</strong>。 浏览器会向颁发证书的机构核实服务器的SSL证书。这样，浏览器就可以确定服务器就是它所说的那个人。</li><li> <strong>预主密码</strong>。浏览器会再发送一串随机的字节，称为<code>主密钥</code>，用浏览器从服务器的 <code>SSL 证书</code>上获取的 <code>公钥</code> 进行加密。 主密码只能由服务器用 <code>私钥</code> 解密。</li><li> <strong>使用私钥</strong>。 服务器解密<code>预主密码</code>。</li><li> <strong>创建会话秘钥</strong>。 浏览器和服务器从<code>客户端随机数</code>、<code>服务器随机数</code>和<code>预主密码</code>中<code>生成会话密钥</code>。</li><li> <strong>客户端完成</strong>。浏览器向服务器发送一个消息，说它已经完成。</li><li> <strong>服务器完成</strong>。服务器向浏览器发送一个消息，表示它也完成了。</li><li> <strong>安全对称加密实现</strong>。 握手完成，通信可以继续使用会话密钥。</li></ol><p><code>现在可以开始从服务器请求和接受数据了</code></p><h2 id="2-获取数据"><a href="#2-获取数据" class="headerlink" title="2.获取数据"></a>2.获取数据</h2><h3 id="HTTP-请求"><a href="#HTTP-请求" class="headerlink" title="HTTP 请求"></a>HTTP 请求</h3><p>在我们与服务器<code>建立安全连接后</code>，浏览器将<code>发送</code>一个初始的 <code>HTTP GET</code> 请求。首先，浏览器将<code>请求页面的 HTML 文件</code>。它将使用 <code>HTTP 协议</code> 来做这件事。</p><blockquote><p>HTTP (超文本传输协议) 是一个<code>获取资源的协议</code>， 如HTML文件。它是网络上任何<code>数据交换的基础</code>，它是一个<code>客户-服务器协议</code>，这意味着请求是由接受者发起的，通常是网络浏览器。</p></blockquote><p><img src="https://bu.dusays.com/2023/06/14/6489cb7dc4ea1.png"></p><p><strong>请求方法</strong> HTTP 请求方式一共有 9 种，分别为 POST 、GET 、HEAD、PUT 、PATCH 、 OPTIONS 、DELETE 、CONNECT 、 TRACE 。其中前三种 POST 、GET 、HEAD 是 HTTP 1.0 定义的，后六种 PUT 、PATCH 、 OPTIONS 、DELETE 、CONNECT 、 TRACE 是 HTTP 1.1 定义的。</p><p><strong>URI</strong> 是<code>统一资源识别符</code>的缩写，一个URI最多可以有5个部分</p><ul><li><code>scheme</code> : 用于说明使用的事什么协议</li><li><code>authority</code>: 用于识别域名</li><li><code>path</code>: 用于显示资源的确切路径</li><li><code>query</code>: 用于表示一个请求动作</li><li><code>fragment</code>: 用来指代资源的一部分</li></ul><pre class="line-numbers language-arduino" data-language="arduino"><code class="language-arduino"><span class="token comment">// URI parts</span>scheme <span class="token operator">:</span><span class="token comment">// authority path ? query # fragment</span><span class="token comment">//URI example</span><span class="token operator">&lt;</span>https<span class="token operator">:</span><span class="token comment">//example.com/users/user?name=Alice#address></span>https<span class="token operator">:</span> <span class="token comment">// scheme name</span>example<span class="token punctuation">.</span>com <span class="token comment">// authority</span>users<span class="token operator">/</span>user <span class="token comment">// path</span>name<span class="token operator">=</span>Alice <span class="token comment">// query</span>address <span class="token comment">// fragment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>HTTP头字段</strong> 是浏览器和服务器在每个 HTTP 请求和响应中发送和接受的字符串列表（它们通常对终端用户是不可见的）。在请求的情况下，它们包含关于要获取的资源或请求组员的浏览器的更多信息。</p><p>如果你想看看这些请求头字段是什么样子的，请进入 Chrome 浏览器并打开开发者工具（F12）。进入 Network 标签，选择 <code>FETCH/XHR</code>。在下面的屏幕截图中，我刚刚在搜索引擎上搜索了Palm Springs，这就是请求头的样子。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e18a64.png"></p><h3 id="HTTP响应"><a href="#HTTP响应" class="headerlink" title="HTTP响应"></a>HTTP响应</h3><p>一旦服务器收到请求，它将对其进行处理并回复一个 <code>HTTP 响应</code> 。在响应的正文中，我们可以找到所有相关的响应头和我们请求的HTML文档的内容</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e53664.png"></p><p><strong>状态代码</strong> 200、400、401、504网关超时等（我们的目标是 200 状态代码，因为它告诉我们一切正常，请求是成功的）</p><p><strong>响应头字段</strong> 保存关于响应的额外信息，如它的位置或提供它的服务器。</p><p>一个 <strong>HTML</strong> 文档的例子是这样的</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">HTML</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>我的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>styles.css<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mainScripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>这个是我的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>一个段落和一个 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;https://example.com/about><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myImage.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image description<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sideEffectsScripts.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于我前面提到的同一个搜索，响应头是这样的</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e577c7.png"></p><p>如果我们看一下HTML文档，我们会发现它<code>引用了不同的 CSS 和 Javascript </code> 文件。这些文件<code>不会被请求</code>。在这个时候，只有 HTML 被请求并从服务器接收。</p><p>这个初始请求的响应包含收到的第一个字节的数据。第一个字节的时间（TTFB）是指从<code>用户提出请求（在地址栏中输入网站名称）</code>到<code>收到第一个 HTML 数据包</code>（通常为<code>14kb</code>）的时间。</p><h3 id="TCP-慢启动和拥塞算法"><a href="#TCP-慢启动和拥塞算法" class="headerlink" title="TCP 慢启动和拥塞算法"></a>TCP 慢启动和拥塞算法</h3><p><code>TCP 慢启动</code> 是一种<code>平衡网络连接速度</code>的算法。 第一个数据包将是 <code>14kb（或更小）</code>，其工作方式是<code>逐渐增加传输的数据量</code>，直到<code>达到预定的阈值</code>。 从服务器接收到每个数据包后，客户端以 <code>ACK 消息</code>响应。 由于连接容量有限，如果服务器发送太多数据包太快，它们将被丢弃。 客户端不会发送任何 ACK 消息，因此服务器会将此解释为<code>拥塞</code>。 这就是<code>拥塞算法</code>发挥作用的地方。 他们监控发送的数据包和 ACK 消息的流，以确定流量的最佳速率并创建稳定的流量流。</p><h2 id="3-HTML解析"><a href="#3-HTML解析" class="headerlink" title="3.HTML解析"></a>3.HTML解析</h2><p>在向服务器发出初始请求后，浏览器如何收到包含我们尝试访问的网页的 HTML 资源 （第一块数据）的响应。现在浏览器的工作就是开始解析数据。</p><blockquote><p>解析是指将程序<code>分析</code>并<code>转换</code>为运行时环境实际可以运行的内部格式</p></blockquote><p>换句话说，解析意味着将我们编写的代码作为文本（HTML、CSS）并将其<code>转换为浏览器可以使用的内容</code>。解析将由<code>浏览器引擎</code>完成（不要与浏览器的 Javascript 引擎混淆）</p><p>有许多浏览器引擎，但大多数浏览器使用这三个活跃且完整引擎之一：</p><p><strong>Gecko</strong> 它是由 Mozilla 为 Firefox 开发的。 过去，它曾为其他几种浏览器提供支持，但目前，除了 Firefox，Tor 和 Waterfox 是唯一仍在使用 Gecko 的浏览器。 它是用 C++ 和 JavaScript 编写的，自 2016 年起，还用 Rust 编写。</p><p><strong>WebKit</strong> 它主要由 Apple 为 Safari 开发。 它还为 GNOME Web (Epiphany) 和 Otter 提供支持。 （令人惊讶的是，在 iOS 上，包括 Firefox 和 Chrome 在内的所有浏览器也由 WebKit 提供支持）。 它是用 C++ 编写的。</p><p><strong>Blink，Chromium</strong> 的一部分 它最初是 WebKit 的一个分支，主要由 Google 为 Chrome 开发。 它还为 Edge、Brave、Silk、Vivaldi、Opera 和大多数其他浏览器项目（一些通过 QtWebEngine）提供支持。 它是用 C++ 编写的。</p><p>现在我们了解了谁将进行解析，让我们看看在从服务器接收到第一个 HTML 文档后到底发生了什么。 让我们假设文档如下所示：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">HTML</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>This is my page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>This is my page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>This is a H3 header.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is a paragraph.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This is another paragraph,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>即使请求页面的 HTML 大于初始的 14KB 数据包， 浏览器也会开始解析并尝试根据其拥有的数据呈现体验。 HTML 解析涉及两个步骤: <code>词法分析</code> 和 <code>树构造</code> （构建称为 DOM 树的东西）。</p><h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><blockquote><p>它将一些输入转换为标签 （源代码的基本组件）。 想象一下，我们将一段英文文本分解成单词，其中单词就是标签。</p></blockquote><p>词法分析过程结束时的结果是一系列 0 个或多个以下标签: DOCTYPE、开始标签（<code>&lt;tag&gt;</code>）、结束标签（<code>&lt;/tag&gt;</code>）、自闭合标签（<code>&lt;tag/&gt;</code>）、<code>属性名称</code>、<code>值</code>、<code>注释</code>、<code>字符</code>、<code>文件结尾</code>或<code>元素中的纯文本内容</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e9aa9c.png"></p><h3 id="构建-DOM"><a href="#构建-DOM" class="headerlink" title="构建 DOM"></a>构建 DOM</h3><p>创建第一个 token 后，<code>树构建</code>开始。这实质上是基于先前解析的标签创建 <code>树状结构</code> （称为文档对象模型）。</p><p>DOM 树描述了 HTML 文档的内容。 <code>&lt;html&gt;</code> 元素时文档树的第一个标签和根节点。树反映了不同标签之间的<code>关系</code>和<code>层次结构</code>。我们有<code>父节点</code>，嵌套在其他标签中的标签是<code>子节点</code>。节点数越多，构建 DOM 树所需的时间就越长。下面是我们从服务器获取的 HTML 文档示例的 DOM 树:</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7e9960c.png"></p><p>实际上，DOM 比我们在该模式中看到的更<code>复杂</code>，但我保持简单以便更好地理解（另外，我们将在以后的文章中更详细地讨论 DOM 及其重要性）。</p><p>此构建阶段是 <code>可重入</code> 的，这意味着在处理一个 token 时，分词器可能会恢复，导致在第一个 token 处理完成之前触发并处理更多 token。 从字节到创建 DOM，整个过程如下所示：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ec45eb.png"></p><p>解析器从上到下逐行工作。 当解析器遇到<code>非阻塞资源</code>（例如图像）时，浏览器会向服务器请求这些图像并<code>继续解析</code>。 另一方面，如果它遇到<code>阻塞资源</code>（<strong>CSS 样式表</strong>、在 HTML 的  部分添加的 <strong>Javascrpt 文件</strong>或从 <strong>CDN 添加的字体</strong>），解析器将<code>停止执行</code>，直到所有这些阻塞资源<code>都被下载</code>。 这就是为什么，如果你正在使用 Javascript，建议在 HTML 文件的末尾添加</p><h3 id="预加载器-amp-使页面更快"><a href="#预加载器-amp-使页面更快" class="headerlink" title="预加载器 &amp; 使页面更快"></a>预加载器 &amp; 使页面更快</h3><p>Internet Explorer、WebKit 和 Mozilla 都在 2008 年实现了预加载器，作为处理阻塞资源的一种方式，尤其是脚本（我们之前说过，当遇到脚本标签时，HTML 解析将停止，直到脚本被下载并执行）。<br>使用预加载器，当浏览器卡在脚本上时，第二个较轻的解析器会扫描 HTML 以查找需要检索的资源（样式表、脚本等）。 然后预加载器开始在后台检索这些资源，目的是在主 HTML 解析器到达它们时它们可能已经被下载（如果这些资源已经被缓存，则跳过此步骤）。</p><h2 id="4-解析CSS"><a href="#4-解析CSS" class="headerlink" title="4.解析CSS"></a>4.解析CSS</h2><p>解析完 HTML 之后，就该解析 CSS（在外部 CSS 文件和样式元素中找到）并构建 <code>CSSDOM 树</code>（CSS 对象模型）。</p><p>当浏览器遇到 CSS 样式表时，无论是<code>外部样式</code>表还是<code>嵌入式样式表</code>，它都需要将文本解析为可用于设置布局样式的内容。 浏览器将 <code>CSS 变成的数据结构称为 CSSOM</code>。 DOM 和 CSSOM 遵循相似的概念，因为它们都是树，但它们是<code>不同的数据结构</code>。 就像从我们的 HTML 构建 DOM 一样，从 CSS 构建 CSSOM 被认为是一个<code>「渲染阻塞 」</code>过程。</p><h3 id="词法分析和构建-CSSOM"><a href="#词法分析和构建-CSSOM" class="headerlink" title="词法分析和构建 CSSOM"></a>词法分析和构建 CSSOM</h3><p>与 HTML 解析类似，CSS 解析从词法分析开始。 CSS 解析器<code>获取字节</code>并将它们<code>转换为字符</code>，然后是<code>标签</code>，然后是<code>节点</code>，最后它们被<code>链接到 CSSOM</code> 中。 浏览器会执行一些称为 <code>选择器匹配</code> 的操作，这意味着每组<code>样式都将与页面上的所有节点（元素）匹配</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ec4e0d.png"></p><p>浏览器从适用于节点的最通用规则开始（例如：如果节点是 body 元素的子节点，则所有 body 样式都由该节点继承），然后通过应用更具体的规则<code>递归地优化计算出的样式</code>。 这就是为什么我们说<code>样式规则</code>是<code>级联</code>的。</p><p>假设我们有下面的 HTML 和 CSS：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token selector">h1</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 32px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">section</span> <span class="token punctuation">&#123;</span>  <span class="token property">color</span><span class="token punctuation">:</span> tomato<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">section .mainTitle</span> <span class="token punctuation">&#123;</span>  <span class="token property">margin-left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">&#125;</span><span class="token selector">div</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">div p</span> <span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span>  8px<span class="token punctuation">;</span>  <span class="token property">color</span><span class="token punctuation">:</span> yellow<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码的 CSSOM 看起来像这样：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ecb1e6.png"></p><p>请注意，在上面的模式中，嵌套元素既有<code>继承的样式</code>（来自父级 - 例如：h1 从 body 继承其颜色，section 从 body 继承其字体大小）和它们自己的样式（可以覆盖继承的规则 是否来自父节点 - 例如：p 覆盖了从 div 继承的颜色和字体大小，而 mainTitle 没有从父节点获得其左边距）。</p><p>由于我们的 CSS 可以有多个来源，并且它们可以包含适用于同一节点的规则，因此浏览器必须决定<code>最终应用哪个规则</code>。 这就是 <code>优先级</code> 发挥作用的时候，如果您想了解更多相关信息，可以访问此<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity">页面</a>。</p><p>想象一下，您在机场寻找您的朋友 John。 如果你想通过喊他的名字找到他，你可以喊 “ John ”。 可能不止一个 John 会同时出现在机场，所以他们可能都会做出回应。 更好的方法是用他的全名打电话给你的朋友，这样当你喊“John Doe”时，你就有更好的机会找到他，因为“ John Doe ”比“ John ”更具体。</p><p>同样，假设我们有这个元素：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;https://dev.to/><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>This is just a link!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以及这些CSS样式：</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">a</span> <span class="token punctuation">&#123;</span>   <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token selector">p  a</span> <span class="token punctuation">&#123;</span>   <span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>您认为浏览器会应用哪条规则？ 答案是第二条规则，因为 p 标签中的所有 a 标签选择器比所有a 标签选择器都具有<code>更高的优先级</code>。 </p><h3 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h3><p>CSS 规则是<code>从右到左</code>阅读的，这意味着如果我们有这样的代码： <code>section p &#123; color: blue; &#125;</code>, 浏览器将首先查找页面上的所有 <code>p</code> 标签，然后它会查看这些 p 标签中是否有一个 <code>section 标签</code>作为<code>父标</code>签。 如果查找能够命中，它将应用这个 CSS 规则</p><h2 id="5-执行Javascript"><a href="#5-执行Javascript" class="headerlink" title="5.执行Javascript"></a>5.执行Javascript</h2><p>在解析 CSS 并创建 CSSOM 的<code>同时</code>，还会<code>下载其他资产</code>，包括 JavaScript 文件。 这要归功于我们在之前文章中提到的<code>预加载器</code>。</p><blockquote><p><code>预加载器</code>就像一个解析器，它在主解析器处理 HTML 代码时扫描 HTML 文件。 它的作用是<code>查找样式表</code>、<code>脚本</code>或<code>图片</code>（也需要从服务器检索）等资源并<code>请求</code>它们。 希望在解析 HTML 时，这些资源已经<code>下载</code>并准备好进行处理。</p></blockquote><p>所以，当我们从服务器获取 Javascript 文件后，代码被<strong>解释</strong>、<strong>编译</strong>、<strong>解析和执行</strong>。 计算机无法理解 Javascript 代码，只有<code>浏览器可以</code>。 JS 代码需要被<code>翻译成计算机可以使用的东西</code>，这是 Javascript 浏览器引擎的工作（不要与浏览器引擎混淆）。 根据浏览器的不同，JS 引擎可以有不同的名称和不同的工作方式。</p><h3 id="Javascript-引擎"><a href="#Javascript-引擎" class="headerlink" title="Javascript 引擎"></a>Javascript 引擎</h3><p>javascript 引擎（有时也称为 ECMAScript 引擎）是一种在浏览器中执行（运行）Javascript 代码的软件，而不仅仅是零部件（例如，V8 引擎是 Node.js 环境的核心组件）。</p><p>JavaScript 引擎通常由 Web 浏览器供应商开发，每个主要浏览器都有一个。 我们说过，目前使用最多的浏览器是 Chrome、Safari、Edge 和 Firefox。 每个都使用不同的 Javascript 引擎，它们是：</p><p><strong>V8</strong> V8 是 Google 的高性能 JavaScript 引擎。 它是用 C++ 编写的，用于 Chrome 和 Node.js 等。 它实现了 ECMAScript（一种 JavaScript 标准，旨在确保网页在不同 Web 浏览器之间的互操作性）和 WebAssembley。 它实现了 ECMA-262。</p><p><strong>JavaScriptCore</strong> JavaScriptCore 是 WebKit 的内置 JavaScript 引擎，它为 Safari 浏览器、邮件和 macOS 上使用的其他应用程序提供支持。 它目前按照 ECMA-262 规范实现 ECMAScript。 它也被称为 SquirrelFish 或 SquirrelFish Extreme。</p><p><strong>Chakra</strong> Chakra 是微软为其 Microsoft Edge 网络浏览器和其他 Windows 应用程序开发的 Javascript 引擎。 它实现了 ECMAScript 5.1，并且对 ECMAScript 6 有部分（不断增加的）支持。它是用 C++ 编写的。</p><p><strong>SpiderMonkey</strong> SpiderMonkey 是 Mozilla 的 Javascript 和 WebAssembly 引擎。 它是用 C++、Javascript 和 Rust 编写的，用于为 Firefox、Servo 和其他项目提供支持。</p><p>一开始，Javascript 引擎只是简单的解释器。 我们今天使用的现代浏览器能够执行称为即时 (JIT) 编译的功能，这是编译和解释的混合体。</p><p><strong>编译</strong></p><p>在编译过程中，一个称为 <code>编译器</code> 的软件将用高级语言编写的代码一次性转换为机器代码。 创建一个<code>目标文件</code>，该文件可以在任何机器上运行。 采取这些步骤后，就可以执行代码了。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7ed7421.png"></p><p><strong>解释</strong></p><p>在解释过程中，解释器逐行检查 Javascript 代码并立即执行。 没有进行编译，因此没有创建目标代码（代码的输出由解释器本身使用其内部机制创建）。 旧版本的 Javascript 使用这种类型的代码执行。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7edf85e.png"></p><p><strong>即时编译( JIT Compilation )</strong></p><p>即时编译是给定语言的解释器的一个特性，它试图<code>同时利用编译和解释</code>。 是在纯编译期间，代码是在执行之前被编译，然而在 JIT 编译中，代码在执行时（在运行时）被编译。 所以我们可以说源代码是动态转换为机器代码的。 较新版本的 Javascript 使用这种类型的代码执行。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f1de8a.png"></p><p>JIT 编译的一个很重要的方面就是将源代码编译成当前正在运行的机器的机器码指令。 这意味着生成的机器代码是针对正在运行的机器的 CPU 架构进行了优化。</p><p>简而言之，这三个过程可以总结为：</p><ul><li>编译器：编译代码</li><li>解释器：运行代码</li><li>JIT 编译器：在运行代码时进行编译</li></ul><p>今天，<code>编译</code>和<code>解释</code>这两个术语之间的界限已经变得非常模糊，因此这个主题可以进行广泛的辩论。</p><p>请注意，我提到了旧版本和新版本的 Javascript。 不支持较新版本语言的浏览器将解释代码，而支持的浏览器将使用某些版本的 JIT 来执行代码（V8、Chakra JavaScriptCore 和 SpiderMonkey 引擎都使用 JIT）。 事实上，尽管 Javascript 是一种解释型语言（它不需要编译），但如今大多数浏览器都会使用 JIT 编译来运行代码，而不是纯粹的解释型语言。</p><h3 id="Javascript-代码是如何处理的"><a href="#Javascript-代码是如何处理的" class="headerlink" title="Javascript 代码是如何处理的"></a>Javascript 代码是如何处理的</h3><p>当 Javascript 代码进入 Javascript 引擎时，它首先被<code>解析</code>。 这意味着代码被读取，并且在这种情况下，代码被转换为称为<code>抽象语法树</code> (<code>AST</code>) 的数据结构。 代码将被拆分成与语言相关的部分（如 <code>function</code> 或 <code>const</code> 关键字），然后所有这些部分将构建抽象语法树。</p><p>假设我们有一个文件，其中包含一个只做一件事的程序，那就是定义一个变量：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这就是这行非常简单的代码<code>看起来像抽象语法树</code>的方式（我正在使用@babel/parser-7.16.12）</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f2e5b4.png"></p><p>如果你想将一些 Javascript 转换为抽象语法树，你可以使用这个<a href="https://astexplorer.net/">工具</a>。 编写变量后得到的 AST 实际上要大得多，在屏幕截图中隐藏了更多节点。</p><p><code>构建 AST </code>后，它会被翻译成机器代码并<code>立即执行</code>，因为现代 Javascript 使用即时编译。 这段代码的执行将由 Javascript 引擎完成，利用称为<code>“调用堆栈”</code>的东西。</p><blockquote><p>调用堆栈是解释器（如 Web 浏览器中的 JavaScript 解释器）跟踪其在调用多个函数的脚本中的位置的机制——当前正在运行的函数以及从该函数中调用的函数等。</p></blockquote><h2 id="6-创建可访问（无障碍）树"><a href="#6-创建可访问（无障碍）树" class="headerlink" title="6.创建可访问（无障碍）树"></a>6.创建可访问（无障碍）树</h2><p>除了我们一直在讨论的所有这些树（DOM、CSSOM 和 AST）之外，浏览器还构建了一种称为<code>可访问（无障碍）树</code>的东西。</p><blockquote><p>Web 开发中的可访问性（通常缩写为 A11y — 如“a”，然后是 11 个字符，然后是“y”）意味着让尽可能多的人能够使用网站，即使这些人的能力在某种程度上受到限制。 对很多人来说，技术让事情变得更容易。 对于残障人士，技术使事情成为可能。 可访问性意味着开发尽可能易于访问的内容，无论个人的身体和认知能力以及他们如何访问网络 (ACT)。</p></blockquote><p>一般而言，残疾用户可以并且确实在使用具有各种辅助技术的网页。 他们使用屏幕阅读器、放大镜、眼动追踪、语音命令等。 为了让这些技术发挥作用，它们需要能够访问页面的内容。 由于他们无法直接读取 DOM，因此 ACT 开始发挥作用。<br>可访问性树是使用 DOM 构建的，稍后辅助设备将使用它来解析和解释我们正在访问的网页的内容。 ACT 就像 DOM 的语义版本，每次 DOM 更新时它都会更新。 每个需要暴露给辅助技术的 DOM 元素都会在 ACT 中有一个对应节点。 在未构建 ACT 之前，屏幕阅读器无法访问内容。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f4e49e.png"></p><p>要查看可访问性树的实际的样子，您可以通过 Google Chrome 浏览器。 打开调试器 (F12) 并转到“元素”选项卡。 从那里，你可以在右侧选择“辅助功能”窗格。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f6cf4f.png"></p><p>我去 Google 并检查了搜索输入，这是我在“计算”属性下的“辅助功能”窗格中得到的：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f7a09e.png"></p><p>使用语义 HTML 的重要性超出了本文的范围，但作为开发人员，我们都应该记住，我们构建的网站应该可供所有希望使用它们的人使用。 如果您想阅读有关该主题的更多信息，可以在此处找到一篇关于 Web 可访问性的很好的介绍性文章。 据 <code>互联网协会无障碍访问特别兴趣小组</code> 称，目前全世界有超过 13 亿人（约占世界人口的 <code>15%</code>）患有某种形式的残疾。</p><h2 id="7-渲染树"><a href="#7-渲染树" class="headerlink" title="7.渲染树"></a>7.渲染树</h2><p>在解析阶段构建的树（DOM、CSSOM）被组合成一种叫做 <code>渲染树</code> 的东西。 这用于计算最终将绘制到屏幕上的所有可见元素的布局。 渲染树的目的是确保页面内容以正确的顺序绘制元素。 它将作为在屏幕上显示像素的绘画过程的输入。</p><p>DOM 和 CSSOM 是使用 HTML 和 CSS 文件创建的。 这两个文件包含不同类型的信息，树的结构也不同，那么渲染树是如何创建的呢？</p><h3 id="结合-DOM-和-CSSOM"><a href="#结合-DOM-和-CSSOM" class="headerlink" title="结合 DOM 和 CSSOM"></a>结合 DOM 和 CSSOM</h3><ul><li>浏览器将开始在 DOM 树的根部施展魔法并遍历每个可见节点。 一些节点，如脚本或元标记是不可见的，因此它们被忽略。 还有一些节点会被 CSS 隐藏（例如 display: “none” 属性），它们也会被忽略。 我们只对可见节点感兴趣，因为只有它们对屏幕上的输入有影响。</li><li>对于在 DOM 中找到的每个可见节点，将在 CSSOM 中找到相应的规则并应用它们。</li></ul><p>以上步骤的结果将是一个包含所有可见节点、内容和样式的<code>渲染树</code>。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7f86fe3.png"></p><h3 id="布局（回流）阶段"><a href="#布局（回流）阶段" class="headerlink" title="布局（回流）阶段"></a>布局（回流）阶段</h3><p>渲染树包含有关显示哪些节点及其计算样式的信息，但不包含每个节点的尺寸或位置。</p><p>接下来需要做的是计算这些节点在设备视口（浏览器窗口内）内的确切位置及其大小。 这个阶段称为布局（在 Chrome、Opera、Safari 和 Internet Explorer 中）或重排（在 Firefox 中），但它们的意思相同。 浏览器在渲染树的根部开始这个过程并遍历它。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb7fa93c0.png"></p><p>回流步骤不会只发生一次，而是每次我们<code>更改 DOM</code> 中<code>影响页面布局的</code>某些内容时，即使是<code>部分更改</code>，都会触发回流。 重新计算元素位置的情况示例如下：</p><ul><li>在 DOM 中添加或删除元素</li><li>调整浏览器窗口大小</li><li>更改元素的宽度、位置或使其浮动</li></ul><p>让我们来看一个非常基本的 HTML 示例，其中内嵌了一些 CSS：</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Reflow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 50%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 50%</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>This is the reflow stage!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码只是说在视口内我们应该有两个 div，其中第二个嵌套在第一个里面。 父 div 占据视口宽度的 100%和高度的 50%。第二个 div 占据父 div 的 50% 这看起来像这样：</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb801a105.png"></p><p>这个过程的输出是一个 <code>类似盒子的模型</code> ，它准确地捕获了每个元素需要在屏幕上的位置及其大小。 完成此步骤后，输出就可以传递到下一步，称为<code>绘画阶段</code>。</p><h3 id="绘画（重绘）阶段"><a href="#绘画（重绘）阶段" class="headerlink" title="绘画（重绘）阶段"></a>绘画（重绘）阶段</h3><p>在浏览器决定哪些节点需要可见并计算出它们在视口中的位置后，就可以在屏幕上绘制它们（渲染像素）了。 这个阶段也被称为 <code>光栅化阶段</code> ，浏览器将在布局阶段计算的每个盒子转换为屏幕上的实际像素。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb801c683.png"></p><p>就像布局阶段一样，绘画阶段不会只发生一次，而是每次我们改变屏幕上元素的<code>外观</code>时。 这些情况的例子是：</p><ul><li>改变元素的轮廓</li><li>改变背景颜色</li><li>改变不透明度或可见性</li></ul><p>绘画意味着浏览器需要将元素的每个视觉部分绘制到屏幕上，包括文本、颜色、边框、阴影和替换元素（如按钮和图像），并且需要超快地完成。 为了确保重绘可以比初始绘制更快地完成，屏幕上的绘图通常被<code>分解成几层</code>。 如果发生这种情况，则需要进行<code>合成</code>。</p><h3 id="分层和合成"><a href="#分层和合成" class="headerlink" title="分层和合成"></a>分层和合成</h3><p>传统意义上，网络浏览器完全依赖 CPU 来呈现网页内容。 但现在即使是最小的设备也有高性能的 GPU，所有大部分实现方案都围绕着 GPU 来寻求更好的体验。</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb80540cc.png"></p><blockquote><p>合成是一种将页面的各个部分分成层的技术，分别绘制它们并在称为合成器线程的单独线程中合成为页面。 当文档的各个部分绘制在不同的层中并相互重叠时，合成是必要的，以确保它们以正确的顺序绘制到屏幕上并且内容被正确呈现。</p></blockquote><p>通常，只有特定的任务会被重定向到 GPU，而这些任务可以由合成器线程单独处理。<br>为了找出哪些元素需要在哪一层，主线程遍历布局树并创建层树。 默认情况下，只有一层（这些层的实现方式因浏览器而异），但我们可以找到会触发重绘的元素，并为每个元素创建一个单独的层。 这样，重绘不应应用于整个页面，而且此过程将可以使用到 GPU</p><p><img src="https://bu.dusays.com/2023/06/14/6489cb8059efa.png"></p><p>如果我们想向浏览器提示某些元素应该在一个单独的层上，我们可以使用 <code>will-change</code> CSS 属性。 实际上有一些特定的属性和元素表示新层的创建。 其中一些是 <code>&lt;video&gt;</code>、<code>&lt;canvas&gt;</code> 和任何具有 CSS <code>opacity</code> 属性、3D <code>transform</code>、<code>will-change</code> 和其他一些属性的元素。 这些节点连同它们的后代将被绘制到它们自己的图层上。</p><h3 id="谨记"><a href="#谨记" class="headerlink" title="谨记"></a>谨记</h3><p>上面讨论的两种操作，回流和重绘，都是<code>昂贵</code>的，尤其是在像手机这样处理能力低的设备上。 这就是为什么在处理 DOM 更改时我们应该尝试<code>优化</code>它们。 <code>有些动作只会触发重绘，有些动作会同时触发回流和重绘</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ES6用法总结</title>
      <link href="/posts/5b5a.html"/>
      <url>/posts/5b5a.html</url>
      
        <content type="html"><![CDATA[<h1 id="对象取值"><a href="#对象取值" class="headerlink" title="对象取值"></a>对象取值</h1><p>取值在程序中非常常见，比如从对象obj中取值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token literal-property property">c</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token literal-property property">d</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span>    <span class="token literal-property property">e</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>es6中可以这样写</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>e<span class="token punctuation">&#125;</span> <span class="token operator">=</span> obj<span class="token keyword">const</span> f <span class="token operator">=</span> a <span class="token operator">+</span> d<span class="token keyword">const</span> g <span class="token operator">=</span> c <span class="token operator">+</span> e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果数据对象中的属性名不是我想要的，可以<code>重命名</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">a</span><span class="token operator">:</span>a1<span class="token punctuation">&#125;</span> <span class="token operator">=</span> obj<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>解构的对象不能为<code>undefined</code>,<code>null</code>。否则会报错，所以要给被解构的对象一个<code>默认值</code></p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>e<span class="token punctuation">&#125;</span> <span class="token operator">=</span> obj <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="合并数据"><a href="#合并数据" class="headerlink" title="合并数据"></a>合并数据</h1><p>合并两个数组，合并两个对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> c <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[1,2,3,1,5,6]</span><span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&#123;a:1,b:1&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>改进</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">,</span><span class="token operator">...</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//[1,2,3,5,6]</span><span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>obj1<span class="token punctuation">,</span><span class="token operator">...</span>obj2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//&#123;a:1,b:1&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="拼接字符串"><a href="#拼接字符串" class="headerlink" title="拼接字符串"></a>拼接字符串</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'小明'</span><span class="token punctuation">;</span><span class="token keyword">const</span> score <span class="token operator">=</span> <span class="token number">59</span><span class="token punctuation">;</span><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>score <span class="token operator">></span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  result <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的考试成绩及格</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>  result <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的考试成绩不及格</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>$&#123;&#125;</code>中可以放入任意的<code>JavaScript表达式</code>，可以<code>进行运算</code>，以及<code>引用对象属性</code>。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'小明'</span><span class="token punctuation">;</span><span class="token keyword">const</span> score <span class="token operator">=</span> <span class="token number">59</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>score <span class="token operator">></span> <span class="token number">60</span><span class="token operator">?</span><span class="token string">'的考试成绩及格'</span><span class="token operator">:</span><span class="token string">'的考试成绩不及格'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="if中判断条件"><a href="#if中判断条件" class="headerlink" title="if中判断条件"></a>if中判断条件</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>    type <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span>    type <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span>    type <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span>    type <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">||</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>改进</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> condition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> condition<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="列表搜索"><a href="#列表搜索" class="headerlink" title="列表搜索"></a>列表搜索</h1><p>在项目中，一些没分页的列表的搜索功能由前端来实现，搜索一般分为精确搜索和模糊搜索。搜索也要叫过滤，一般用<code>filter</code>来实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>   <span class="token parameter">item</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> item <span class="token operator">===</span> <span class="token number">3</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>精确搜索用es6中的<code>find</code>,find方法中找到<code>符合条件的项</code>，就<code>不会继续遍历</code>数组</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> result <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>   <span class="token parameter">item</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> item <span class="token operator">===</span> <span class="token number">3</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="扁平化数组"><a href="#扁平化数组" class="headerlink" title="扁平化数组"></a>扁平化数组</h1><p>一个部门json数组，属性名是部门id,属性值是各个部门成员id数组集合，现在要把有部门的成员id都提取到一个数组集合中</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string-property property">'采购部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">'人事部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">'行政部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">79</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">'运输部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> member <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> deps<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> deps<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        member <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>member<span class="token punctuation">,</span><span class="token operator">...</span>value<span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>member <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>获取对象的全部属性用<code>Object.values()</code>,数组扁平化用<code>flat</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string-property property">'采购部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string-property property">'人事部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string-property property">'行政部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">79</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token string-property property">'运输部'</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> member <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat</span><span class="token punctuation">(</span><span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>其中使用<code>Infinity</code>作为<code>flat</code>的参数，使得<code>无需知道</code>被扁平化的<code>数组的维度</code>。</p></blockquote><h1 id="获取对象属性值"><a href="#获取对象属性值" class="headerlink" title="获取对象属性值"></a>获取对象属性值</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> name <span class="token operator">=</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>es6的可选链操作符</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> name <span class="token operator">=</span> obj<span class="token operator">?.</span>name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="添加对象属性"><a href="#添加对象属性" class="headerlink" title="添加对象属性"></a>添加对象属性</h1><p>当给对象添加属性石，如果属性名是动态变化的，该怎么处理?</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">topic</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>index<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'话题内容'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>不需要额外创建一个变量，es6中的<code>对象属性名</code>可以用<code>表达式</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">topic</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>index<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'话题内容'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="关于输入框非空的判断"><a href="#关于输入框非空的判断" class="headerlink" title="关于输入框非空的判断"></a>关于输入框非空的判断</h1><p>在处理输入框相关业务时，往往会判断输入框未输入值的场景</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>es6的<code>空值合并运算符</code>（是一个逻辑操作符，当左侧的操作数为 null 或者 undefined 时，返回其右侧操作数，否则返回左侧操作数。）</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token operator">??</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">//...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="异步函数"><a href="#异步函数" class="headerlink" title="异步函数"></a>异步函数</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">fn1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>   <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res1</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1</span>      <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res2</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>async + await</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> res1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> res2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>并发请求时，还是要用到<code>Promise.all()</code>,如果并发请求时，只要其中一个异步函数处理完成，就返回结果，要用到<code>Promise.race()</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>   Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [1,2]</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ES6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数组常用方法总结</title>
      <link href="/posts/b528.html"/>
      <url>/posts/b528.html</url>
      
        <content type="html"><![CDATA[<h1 id="数组常用方法及兼容性总结"><a href="#数组常用方法及兼容性总结" class="headerlink" title="数组常用方法及兼容性总结"></a>数组常用方法及兼容性总结</h1><p>数组的的<code>方法</code>名</p><ol><li>方法的作用</li><li>方法的参数（方法运行的时候需要什么值或变量）</li><li>方法的返回值</li><li>是否会改变原有数组</li><li>兼容性</li></ol><h2 id="push"><a href="#push" class="headerlink" title="push"></a><code>push</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["a", "b", "c", "d", "e"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>向数组的末尾添加项</li><li>参数就是要新增的项（如果增加多项就在参数位置逗号隔开）</li><li>返回值是数组的新长度</li><li>原有数组改变</li><li>所有主要浏览器都支持</li></ol><h2 id="unshift"><a href="#unshift" class="headerlink" title="unshift"></a><code>unshift</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ "d", "e","a", "b", "c"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>向数组的开头增加项</li><li>参数就是要新增的项（如果增加多项就在参数位置逗号隔开）</li><li>返回值是数组的新长度</li><li>原有数组改变</li><li>所有主要浏览器都支持</li></ol><h2 id="pop"><a href="#pop" class="headerlink" title="pop"></a><code>pop</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["a","b"];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "c"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>删除数组的末尾项</li><li>不使用参数 （因为删除就是删除最后一个）</li><li>返回值是删除的最后一项</li><li>原有数组改变</li><li>所有主要浏览器都支持</li></ol><h2 id="shift"><a href="#shift" class="headerlink" title="shift"></a><code>shift</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["b","c"];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "a"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>删除数组的开头项</li><li>不使用参数</li><li>返回值是删除的第一项</li><li>原有数组改变</li><li>所有主要浏览器都支持</li></ol><h2 id="splice-可以实现-push-pop-shift-unshift-的功能"><a href="#splice-可以实现-push-pop-shift-unshift-的功能" class="headerlink" title="splice( 可以实现 push,pop,shift,unshift 的功能 )"></a><code>splice</code>( 可以实现 push,pop,shift,unshift 的功能 )</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ary=>['a','b','e']; res=>['c','d']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ary=>['a','b']; res=>['c','d','e']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ary=>[]; res=>['a','b','c','d','e']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ary=>["a", "b", "x", "y", "e"] res=>['c','d']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>ary<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// 从最后一项的索引开始删除一个(模拟pop) ary=>['a','b','c','d'] res=>['e']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>ary<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">)</span> <span class="token comment">// 从数组的最后一项开始删除 0 个增加'f'(模拟push) ary=>['a','b','c','d','e','f'] r</span><span class="token parameter">es</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// 从数组的第一项开始删除一个（模拟shift）ary=>['b','c','d','e'] res=>['a']</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment">// 从数组的第一项开始删除 0 个新增’ 1 ‘(模拟unshift) ary=>['1','a','b','c','d','e'] res=>[]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>删除数组的某些项</li><li>参数为 0 到多个</li></ol><ul><li>splice(n,m) 从索引n开始删除m个（包括n）</li><li>splice(n) 如果第二个参数没有写那么就是从n索引开始删除到末尾</li><li>splice(0) 从第一个开始删除到末尾（可以达到克隆数组的目的，但是靠的是返回值）</li><li>splice(n,m,x,y) 从索引n开始删除m个，然后用x,y顶替删除的位置（从第三个参数开始都是用来顶替的）</li></ul><ol><li>返回值是删除的数组项目组合成的新数组</li><li>原有数组改变</li><li>所有主要浏览器都支持</li></ol><h2 id="slice"><a href="#slice" class="headerlink" title="slice"></a><code>slice</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// var res = ary.slice( 2 , 3 ); // ary=>['a','b','c','d','e'] res=>['c'];</span><span class="token comment">// var res = ary.slice( 2 ); // ary=>['a','b','c','d','e'] res=>['c','d','e'];</span><span class="token comment">// var res = ary.slice( 0 ); // ary=>['a','b','c','d','e'] res=>['a','b','c','d','e'];</span><span class="token comment">// var res = ary.slice(); // ary=>['a','b','c','d','e'] res=>['a','b','c','d','e'];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>用来复制数组的</li><li>0 到 2 个参数</li></ol><ul><li>slice(n,m) 从索引n开始复制到索引m (不包含m，其实也是复制到m-1)</li><li>slice(n) 从索引n开始复制到末尾</li><li>slice(0) 从开头复制到末尾，克隆数组</li><li>slice() 从开头复制到末尾，克隆数组</li></ul><ol start="3"><li>返回值是新复制的数组</li><li>原有数组不变</li><li>所有主要浏览器都支持</li></ol><h2 id="concat"><a href="#concat" class="headerlink" title="concat"></a><code>concat</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> ary2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> ary3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary1<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>ary2<span class="token punctuation">,</span>ary3<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['a','b'];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['c','d'];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["a", "b", "c", "d", "e", "f"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>把两个或两个以上的数组拼接在一起</li><li>你要拼接的数组（多个数组用逗号隔开）</li><li>拼接好的数组</li><li>原有数组不变</li><li>所有主要浏览器都支持</li></ol><h2 id="join"><a href="#join" class="headerlink" title="join"></a><code>join</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// res=>'a-b-c-d'</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// res=>'a,b,c,d'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['a','b','c','d'];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>把数组里的每一项按照指定的分隔符拼接成一项字符串</li><li>参数是指定的分隔符（如果没有指定参数那么默认是逗号）</li><li>返回值是拼接好的字符串</li><li>原有数组不变</li><li>所有主要浏览器都支持</li></ol><h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a><code>reverse</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary1<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['d','c','b','a'];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['d','c','b','a'];</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>倒序数组</li><li>不用参数</li><li>返回值是经过倒序的原有数组</li><li>原有数组顺序改变</li><li>所有主要浏览器都支持</li></ol><h2 id="sort-参数变成了函数"><a href="#sort-参数变成了函数" class="headerlink" title="sort( 参数变成了函数 )"></a><code>sort</code>( 参数变成了函数 )</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">11</span> <span class="token punctuation">,</span> <span class="token number">19</span> <span class="token punctuation">,</span> <span class="token number">13</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> a<span class="token operator">-</span>b<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 升序</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> b<span class="token operator">-</span>a<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 降序</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 1, 2, 2, 3, 3, 4, 6, 11, 13, 19</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 1, 2, 2, 3, 3, 4, 6, 11, 13, 19</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary <span class="token operator">===</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>是把数组按照指定规则去排序（升序或降序）</li><li>参数就是规则，这个规则是一个函数（不加参数只能排序 10 以内的）</li><li>排好序的原有数组</li><li>原有数组顺序改变</li><li>所有主要浏览器都支持</li></ol><blockquote><p><a href="https://www.cnblogs.com/hao-1234-1234/p/11156272.html">sort其他排序用法</a></p></blockquote><h2 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf"></a><code>indexOf</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['b','c','a','d','a'];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>查找某一项在数组是否出现，出现返回索引位置，没有返回-</li><li>参数就是查找的那一项</li><li>元素第一次出现的索引位置</li><li>原有数组不变</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>yes</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="lastIndexOf"><a href="#lastIndexOf" class="headerlink" title="lastIndexOf"></a><code>lastIndexOf</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['b','c','a','d','a'];</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol><li>查找某一项在数组是否出现，出现返回索引位置，没有返回-</li><li>参数就是查找的那一项</li><li>元素最后一次出现的索引位置</li><li>原有数组不变</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>yes</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a><code>forEach</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>item<span class="token punctuation">.</span>b <span class="token operator">=</span> idx<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&#123;a: 1 , b: 0 &#125;, &#123;b: 1 &#125;]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>循环遍历数组的每一项</li></ol><ul><li>是一个函数(必选)函数有三个参数</li><li>item 循环时的每一项</li><li>index 对应每一项的索引</li><li>ary 原有数组</li><li>指定函数的this参数</li></ul><ol start="2"><li>undefined</li><li>对原数组操作有影响</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>1.5</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="map"><a href="#map" class="headerlink" title="map"></a><code>map</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ary<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index<span class="token punctuation">,</span>ary</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> item<span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["b", "c", "a", "d", "a"]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["b1", "c1", "a1", "d1", "a1"]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>循环遍历数组的每一项</li></ol><ul><li>是一个函数(必选)函数有三个参数</li><li>item 循环时的每一项</li><li>index 对应每一项的索引</li><li>ary 原有数组</li><li>指定函数的this参数</li></ul><ol start="2"><li>每次return的值组成的新数组</li><li>原有数组不变</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>1.5</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="filter"><a href="#filter" class="headerlink" title="filter"></a><code>filter</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ages <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">32</span> <span class="token punctuation">,</span> <span class="token number">33</span> <span class="token punctuation">,</span> <span class="token number">16</span> <span class="token punctuation">,</span> <span class="token number">40</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">checkAdult</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> age <span class="token operator">>=</span> <span class="token number">18</span> <span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> res <span class="token operator">=</span> ages<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>checkAdult<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ages<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [32, 33, 16, 40]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [32, 33, 40]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>创建一个新数组, 其包含通过所提供函数实现的测试的所有元素</li></ol><ul><li>callback 用来测试数组的每个元素的函数。</li><li>调用时使用参数 (element, index, array)。返回 true 表示保留该元素（通过测试），false 则不保留。接受三个参数</li><li>element:当前在数组中处理的元素</li><li>index:可选 正在处理元素在数组中的索引</li><li>array:可选 调用了 filter 筛选器的数组</li><li>执行函数时的this指向</li></ul><ol start="2"><li>原有数组不变</li><li>通过测试的元素的集合的数组，如果没有通过测试则返回空数组</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>1.5</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="some"><a href="#some" class="headerlink" title="some"></a><code>some</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> arr1 <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> item <span class="token operator">>=</span> <span class="token number">4</span> <span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2, 3, 4, 5]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>用于检测数组中的元素是否有满足指定的条件</li></ol><ul><li>callback</li><li>item 循环时每一项</li><li>index 对应每一项的索引</li><li>arr 原有数组</li><li>回调函数执行时的this指向</li></ul><ol start="2"><li>原有数组不变</li><li>布尔值（如果数组中有一个元素满足条件返回 true，否则返回 false）</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>1.5</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="every"><a href="#every" class="headerlink" title="every"></a><code>every</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">isBigEnough</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> index<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> element <span class="token operator">>=</span> <span class="token number">10</span> <span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> passed1 <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">,</span> <span class="token number">130</span> <span class="token punctuation">,</span> <span class="token number">44</span> <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isBigEnough<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> passed2 <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">12</span> <span class="token punctuation">,</span> <span class="token number">54</span> <span class="token punctuation">,</span> <span class="token number">18</span> <span class="token punctuation">,</span> <span class="token number">130</span> <span class="token punctuation">,</span> <span class="token number">44</span> <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isBigEnough<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>passed1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>passed2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>用于检测数组所有元素是否都符合指定条件（通过函数提供）</li></ol><ul><li>callback</li><li>item 循环时每一项</li><li>index 对应每一项的索引</li><li>arr 原有数组</li><li>回调函数执行时的this指向</li></ul><ol start="2"><li>原有数组不变</li><li>布尔值（如果所有元素都通过检测返回 true，否则返回 false）</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>1.5</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a><code>reduce</code></h2><ol><li>作用</li></ol><blockquote><p>接收一个函数作为累加器，数组中的每个值（从左到右）开始缩减，最终计算为一个值。</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token keyword">let</span> num <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> prev<span class="token operator">*</span>next<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1,2,3]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>可以作为一个高阶函数，用于函数的compose</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">toUpper</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> str<span class="token operator">+</span><span class="token string">'ab'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 聚合函数es5写法</span><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 聚合函数es6进化版</span><span class="token keyword">let</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span> <span class="token operator">=></span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">let composefn &#x3D; compose(add,toUpper,sum)let res &#x3D; composefn(&#39;a&#39;,&#39;b&#39;);console.log(res); &#x2F;&#x2F; &#39;ABab&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>callback</li><li>prevent</li><li>current</li><li>currentIndex</li><li>arr</li><li>initialValue(可选)</li></ul><ol start="2"><li>返回计算结果</li><li>原有数组不变</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>3.0</td><td>yes</td><td>yes</td></tr></tbody></table><blockquote><p><code>reduce 模拟实现</code></p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">reduce</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span>prev</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>prev<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>prev <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>prev <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> prev<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> <a href="https://juejin.im/post/5e44002c6fb9a07c9f3fd135">25 个数组reduce高级用法</a></p></blockquote><h2 id="reduceRight"><a href="#reduceRight" class="headerlink" title="reduceRight"></a><code>reduceRight</code></h2><ol><li>接收一个函数作为累加器，数组中的每个值（从右到左）开始缩减，最终计算为一个值。<br>可以作为一个高阶函数，用于函数的compose</li></ol><ul><li>callback</li><li>prevent</li><li>current</li><li>currentIndex</li><li>arr</li><li>initialValue(可选)</li></ul><ol start="2"><li>返回计算结果</li><li>原有数组不变</li><li>主流浏览器兼容性（支持该方法的第一个浏览器版本号）</li></ol><table><thead><tr><th>Chrome</th><th>IE</th><th>Firefox</th><th>Safari</th><th>Opera</th></tr></thead><tbody><tr><td>yes</td><td>9</td><td>3.0</td><td>yes</td><td>yes</td></tr></tbody></table><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// reduceRight 实现聚合函数</span><span class="token keyword">let</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token keyword">let</span> fn <span class="token operator">=</span> fns<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token function">next</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原生JS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack常用配置</title>
      <link href="/posts/9046.html"/>
      <url>/posts/9046.html</url>
      
        <content type="html"><![CDATA[<h1 id="webpack常用配置"><a href="#webpack常用配置" class="headerlink" title="webpack常用配置"></a>webpack常用配置</h1><h2 id="什么是webpack"><a href="#什么是webpack" class="headerlink" title="什么是webpack"></a>什么是webpack</h2><p><img src="https://bu.dusays.com/2023/06/24/64970248de944.jpeg" alt="webpack"></p><ul><li><p>webpack可以看做是<code>模块打包机</code>：它做的事情是，分析你的项目结构，找到JavaScript模块以及其它的一些浏览器不能直接运行的拓展语言（Scss，TypeScript等），并将其打包为合适的格式以供浏览器使用。</p></li><li><p>构建就是把源代码转换成发布到线上的可执行 JavaScrip、CSS、HTML 代码，包括如下内容。</p><ul><li><code>代码转换</code>：TypeScript 编译成 JavaScript、SCSS 编译成 CSS 等。</li><li><code>文件优化</code>：压缩 JavaScript、CSS、HTML 代码，压缩合并图片等。</li><li><code>代码分割</code>：提取多个页面的公共代码、提取首屏不需要执行部分的代码让其异步加载。</li><li><code>模块合并</code>：在采用模块化的项目里会有很多个模块和文件，需要构建功能把模块分类合并成一个文件。</li><li><code>自动刷新</code>：监听本地源代码的变化，自动重新构建、刷新浏览器。</li><li><code>代码校验</code>：在代码被提交到仓库前需要校验代码是否符合规范，以及单元测试是否通过。</li><li><code>自动发布</code>：更新完代码后，自动构建出线上发布代码并传输给发布系统。</li></ul></li><li><p>构建其实是工程化、自动化思想在前端开发中的体现，把一系列流程用代码去实现，让代码自动化地执行这一系列复杂的流程。 构建给前端开发注入了更大的活力，解放了我们的生产力。</p></li></ul><h2 id="webpack常用配置-1"><a href="#webpack常用配置-1" class="headerlink" title="webpack常用配置"></a>webpack常用配置</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">yarn init <span class="token operator">-</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="安装-本地安装，不要安装到全局"><a href="#安装-本地安装，不要安装到全局" class="headerlink" title="安装 (本地安装，不要安装到全局)"></a>安装 (本地安装，不要安装到全局)</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">yarn add webpack webpack<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token constant">D</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>   <span class="token comment">// 单入口</span>or<span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>    、、 多入口   <span class="token literal-property property">main</span><span class="token operator">:</span><span class="token string">'./src/index.js'</span>   <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">path</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 绝对路径</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">'bundle.[hash:8].js'</span> <span class="token comment">// 根据摘要算法每次产生不同的hash，防止缓存，当你内容没有变化时，不会发生变化</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h3><p><code>development</code> 调试（不会压缩，不会调试）</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">+</span> mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token operator">-</span> plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span>   <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>NamedModulesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>   <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string-property property">"process.env.NODE_ENV"</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">"development"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span> <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>production</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>—<span class="token operator">+</span>  mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span><span class="token operator">-</span>  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span>    <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string-property property">"process.env.NODE_ENV"</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">"production"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>NoEmitOnErrorsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="loader-转化代码"><a href="#loader-转化代码" class="headerlink" title="loader(转化代码)"></a>loader(转化代码)</h3><blockquote><p>loader<code>特性</code>：简单，单一</p></blockquote><blockquote><p>loader<code>执行顺序</code>: 从下到上，从右到左</p></blockquote><blockquote><p>loader<code>写法</code>:’’,[],{}</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'style-loader!css-loader'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        or        <span class="token punctuation">&#123;</span>            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        or        <span class="token punctuation">&#123;</span>              <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>             <span class="token literal-property property">enforce</span><span class="token operator">:</span><span class="token string">'pre'</span> <span class="token punctuation">,</span> <span class="token comment">// 强制前置执行</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 这种对象的写法的好处就是可以携带参数</span>                <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span>                <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                                    <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span>            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'style-loader'</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>loader<code>分类</code> preLoader(前置) normalLoader(正常) inline(在代码中使用loader  ) postLoader(后置)</p></blockquote><h4 id="loader-解析css"><a href="#loader-解析css" class="headerlink" title="loader 解析css"></a>loader <code>解析css</code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">yarn add css<span class="token operator">-</span>loader style<span class="token operator">-</span>loader <span class="token operator">-</span><span class="token constant">D</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="loader-解析less"><a href="#loader-解析less" class="headerlink" title="loader 解析less"></a>loader <code>解析less</code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">yarn add less less<span class="token operator">-</span>loader <span class="token operator">-</span><span class="token constant">D</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">,</span><span class="token string">'less-loader'</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="loader-解析js"><a href="#loader-解析js" class="headerlink" title="loader 解析js"></a>loader <code>解析js</code></h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> babel-loader @babel/core @babel/preset-env<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">rules</span> <span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>          <span class="token literal-property property">exclude</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 排除  </span>          <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>              <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span>              <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token comment">// 这块配置可以单独放到 babel.config.js</span>                  <span class="token string-property property">"presets"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                  <span class="token string-property property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                      <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-decorators"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"legacy"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 转化装饰器</span>                      <span class="token punctuation">[</span><span class="token string">"@babel/plugin-proposal-class-properties"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"loose"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>  <span class="token comment">// 转化类属性</span>                                        <span class="token punctuation">]</span>              <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">//  babel.config.js || .babelrc</span><span class="token punctuation">&#123;</span>  <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span>      <span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span>      <span class="token string-property property">"useBuiltIns"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// useBuiltIns 提供 false, entry, usage 三种方式</span>      <span class="token punctuation">&#123;</span>        <span class="token string-property property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 浏览器需要兼容的版本，也可以单独放置到 .browserslistrc</span>          <span class="token string-property property">"ie"</span><span class="token operator">:</span> <span class="token number">10</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Browserslist 的配置有几种方式，并按下面的<code>优先级</code>使用：</p><ul><li>@babel/preset-env 里的 targets</li><li>package.json 里的 browserslist 字段</li><li>.browserslistrc 配置文件</li></ul><ul><li><p>yarn add @babel/plugin-proposal-decorators     // 转化装饰器</p></li><li><p>yarn add @babel/plugin-proposal-class-properties  // 转化类属性</p></li><li><p>yarn add @babel/plugin-transform-runtime  // 转化js运行时的api 方法并且可以优化js抽离公共部分(promise,yeld…)</p><ul><li>yarn add @babel/runtime -S  (注意不是-D,生产依赖,不用在plugins中配置)</li></ul></li></ul><blockquote><p>@babel/runtime, @babel/plugin-transform-runtime 把 helpers 和 polyfill 功能拆分了。默认只提供 helpers。</p></blockquote><blockquote><p>Babel 转换了浏览器不支持的箭头函数和 Class，但是 Promise 并没有变化。这是因为 Babel 只转换不兼容的新语法，而对新的 API，如 Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise、Object.assign() 等，是不会转换的。这时候就需要 polyfill 了。</p></blockquote><ul><li><p>yarn add @babel/polyfill   </p><p>  import ‘@babel/polyfill’  // 写了一整套的api 实例身上也可以调用 eg ‘aaa’.include(‘a)</p><p>  useBuiltIns 提供 false, entry, usage 三种方式   </p><ul><li>“useBuiltIns”: “false”   此时不对 polyfill 做操作。如果引入 @babel/polyfill，则无视配置的浏览器兼容，引入所有的 polyfill。</li><li>“useBuiltIns”: “entry”,”corejs”: 2,   根据配置的浏览器兼容，引入浏览器不兼容的 polyfill。需要在入口文件手动添加 import ‘@babel/polyfill’，会自动根据 browserslist 替换成浏览器不兼容的所有 polyfill</li><li>“useBuiltIns”: “usage”,”corejs”: 2,   usage 会根据配置的浏览器兼容，以及你代码中用到的 API 来进行 polyfill，实现了按需添加。</li></ul></li></ul><blockquote><p>ps babel-polyfill 包含所有补丁，不管浏览器是否支持，也不管你的项目是否有用到，都全量引了，所以如果你的用户全都不差流量和带宽（比如内部应用），尽可以用这种方式。</p></blockquote><blockquote><p><a href="https://github.com/sorrycc/blog/issues/80">Polyfill 方案的过去、现在和未来</a></p></blockquote><blockquote><p><a href="https://blog.hhking.cn/2019/04/02/babel-v7-update/">Babel 7 升级实践</a></p></blockquote><h4 id="loader-解析img"><a href="#loader-解析img" class="headerlink" title="loader 解析img"></a>loader <code>解析img</code></h4><ul><li>js中的引入</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'./logo.png'</span><span class="token punctuation">;</span> <span class="token comment">// 不能放字符串，不会被打包  </span><span class="token keyword">import</span> logo <span class="token keyword">from</span> <span class="token string">'./logo.png'</span><span class="token punctuation">;</span> <span class="token comment">// 这样才会产生依赖关系，才会打包</span><span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>img<span class="token punctuation">.</span>src <span class="token operator">=</span> logo<span class="token punctuation">;</span><span class="token comment">// 会把logo进行生成一张新的图片放到dist目录下，会返回一个新的图片地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>css背景图(css-loader 会把他变成require的形式 eg: background:url(require(‘./logo.png’)))</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token comment">// 对模块来进行配置</span>      <span class="token literal-property property">rules</span> <span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// 匹配的规则</span>          <span class="token punctuation">&#123;</span>              <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>              <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                  <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'url-loader'</span><span class="token punctuation">,</span>                   <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                      <span class="token literal-property property">limit</span><span class="token operator">:</span><span class="token number">200</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">,</span>                      <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'images/[hash:8].[name].[ext]'</span>   <span class="token comment">//  图片放到./dist/images 常和output.publicPath配合使用确保图片地址引用正确</span>                      <span class="token literal-property property">publicPath</span><span class="token operator">:</span><span class="token string">"/url-loader-test/dist/"</span>      <span class="token comment">//该地址不是唯一的，根据你的代码实际路由地址进行修改</span>                  <span class="token punctuation">&#125;</span>                     <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token comment">// 两者的主要差异在于。url-loader可以设置图片大小限制，当图片超过限制时，其表现行为等同于file-loader，而当图片不超过限制时，则会将图片以base64的形式打包进css文件，以减少请求次数。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="" >   (打包后文件夹结构可能会变化，就会找不到)</p><p>html-withimg-loader (打包后也会变成base64)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span> <span class="token operator">:</span><span class="token punctuation">[</span>                 <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                    <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'html-withimg-loader'</span>                <span class="token punctuation">&#125;</span>           <span class="token punctuation">]</span>     <span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="devServer"><a href="#devServer" class="headerlink" title="devServer"></a>devServer</h3><ul><li><p>默认打包是在<strong>内存中</strong>打包的</p><p>  contentBase:’dist’ （不配置也能成功是应为运行了html-webpack-plugin）</p></li><li><p>默认启动的服务是在根目录下</p></li><li><p>creatGzip<br>  compress:true</p></li><li><p>热更新<br>  hot:true</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span><span class="token punctuation">&#123;</span>   <span class="token operator">...</span>   <span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>           <span class="token literal-property property">hot</span><span class="token operator">:</span><span class="token boolean">true</span>  <span class="token comment">// 表示启动热更新</span>       <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>           <span class="token comment">// 使用热替换插件</span>           <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="proxy-依靠http-proxy-middleware-webpack内置"><a href="#proxy-依靠http-proxy-middleware-webpack内置" class="headerlink" title="proxy (依靠http-proxy-middleware(webpack内置))"></a>proxy (依靠http-proxy-middleware(webpack内置))</h4><ul><li><p>后台配置跨域头</p></li><li><p>设置webpack-dev-server proxy</p></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  <span class="token comment">// mock 自己的数据</span>  <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 默认webpack-dev-server 启动的时候 会调用这样的before 钩子， app参数是express()执行的结果</span>      app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>          res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'world!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">proxy</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token comment">// 只对开发的时候有效，上线代码一般会布置到一起,就不存在跨域了</span>      <span class="token comment">//'/api':'http://localhost:3000',</span>        <span class="token comment">// 前端发 /api/user   后台实际接口 /user</span>      <span class="token string-property property">'/api'</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">target</span><span class="token operator">:</span><span class="token string">'http://127.0.0.1:3000'</span><span class="token punctuation">,</span>            <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                      <span class="token string-property property">'/api'</span><span class="token operator">:</span><span class="token string">''</span>                  <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>把webpack在后台启动 （一般不会用） </li></ul><h3 id="resolve-第三方模块的解析规则"><a href="#resolve-第三方模块的解析规则" class="headerlink" title="resolve 第三方模块的解析规则"></a>resolve 第三方模块的解析规则</h3><p><a href="https://segmentfault.com/a/1190000013176083?utm_source=tag-newest">深入浅出webpack学习(5)–Resolve</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 第三方模块的解析规则</span>        <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"node_modules"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token literal-property property">mainFiles</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">,</span><span class="token string">'index.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 入口文件的配置</span>        <span class="token literal-property property">mainFields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">,</span><span class="token string">'main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 入口字段的配置 webpack会按照数组里的顺序去package.json文件里面找，只会使用找到的第一个。</span>        <span class="token literal-property property">extensions</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//也就是说当遇到require('./data')这样的导入语句时，webpack会先去寻找./data.js文件，如果找不到则去找./data.json文件，如果还是找不到则会报错。</span>        <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token string-property property">'bootstrap'</span><span class="token operator">:</span><span class="token string">'bootstrap/dist/css/bootstrap.css'</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h3><h4 id="html-webpack-plugin"><a href="#html-webpack-plugin" class="headerlink" title="html-webpack-plugin"></a><code>html-webpack-plugin</code></h4><p><a href="https://www.npmjs.com/package/html-webpack-plugin">html-webpack-plugin API</a></p><blockquote><p>简化HTML文件的创建，为您的webpack捆绑服务提供服务。这对于webpack包含文件名中包含哈希值的bundle 来说尤其有用，它会更改每个编译。您可以让插件为您生成HTML文件(打包html并且把打包后的文件引入)</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'./public/index.html'</span><span class="token punctuation">,</span>  <span class="token comment">// 模版名称,此处html统一存放在public下</span>            <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'main.html'</span>   <span class="token comment">// 生成html的名称，默认为index.html</span>            <span class="token literal-property property">chunks</span><span class="token operator">:</span><span class="token punctuation">[</span>chunk<span class="token punctuation">]</span>  <span class="token comment">// 配合多入口进行使用时new 多个插件并分别配置代码块</span>            <span class="token literal-property property">minify</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                        <span class="token literal-property property">removeAttributeQuotes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         <span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                    <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>           <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="DefinePlugin"><a href="#DefinePlugin" class="headerlink" title="DefinePlugin"></a><code>DefinePlugin</code></h4><p>DefinePlugin 允许创建一个在编译时可以配置的全局常量。这可能会对开发模式和发布模式的构建允许不同的行为非常有用。如果在开发构建中，而不在发布构建中执行日志记录，则可以使用全局常量来决定是否记录日志。这就是 DefinePlugin 的用处，设置它，就可以忘记开发和发布构建的规则。</p><p><a href="https://www.webpackjs.com/plugins/define-plugin/">DefinePlugin 用法</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 定义的变量 需要json.stringify 包裹</span>            <span class="token constant">DEV</span><span class="token operator">:</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// or '"development"'</span>            <span class="token constant">EXPRESSION</span><span class="token operator">:</span><span class="token string">'1+1'</span><span class="token punctuation">,</span>            <span class="token constant">FLAG</span><span class="token operator">:</span><span class="token string">'true'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NameModulesPlugin"><a href="#NameModulesPlugin" class="headerlink" title="NameModulesPlugin"></a><code>NameModulesPlugin</code></h4><p>当开启 HMR 的时候使用该插件会显示模块的相对路径，建议用于开发环境。</p><h3 id="mini-css-extract-plugin-（抽离css样式-变成link-href-的形式）"><a href="#mini-css-extract-plugin-（抽离css样式-变成link-href-的形式）" class="headerlink" title="mini-css-extract-plugin （抽离css样式 变成link href 的形式）"></a><code>mini-css-extract-plugin</code> （抽离css样式 变成link href 的形式）</h3><ul><li>yarn add mini-css-extract-plugin optimize-css-assets-webpack-plugin uglifyjs-webpack-plugin -D</li></ul><p><a href="https://www.npmjs.com/package/mini-css-extract-plugin">mini-css-extract-plugin API</a></p><p>经过style-loader处理后会把样式以style标签的形式嵌入html ,如果css样式多的时候不适用，这个模块<strong>内置style-loader</strong>。</p><blockquote><p>用这个plugin当环境变为生产环境需要手动压缩</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">let</span> OptimizeCss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> UglifyJSPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglifyjs-webpack-plugin'</span><span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 生产环境需要手动压缩</span>    <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'production'</span><span class="token punctuation">,</span>    <span class="token comment">// 手动压缩配置</span>    <span class="token literal-property property">optimization</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>  <span class="token comment">//这里可以放一下优化配置,只有模式是**生产环境才会调用**, 用了这个后会自己的配置覆盖掉原来的配置，导致只有css进行了压缩,js没有压缩，所以需要手动调用</span>        <span class="token literal-property property">minimizer</span><span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// 压缩配置</span>            <span class="token keyword">new</span> <span class="token class-name">uglifyJSPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">cache</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token literal-property property">parallel</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 并行打包</span>                <span class="token literal-property property">sourceMap</span><span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">// 调试使用的</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token keyword">new</span> <span class="token class-name">OptimizeCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'css-loader'</span>            <span class="token punctuation">&#125;</span>，            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>                <span class="token literal-property property">enforce</span><span class="token operator">:</span><span class="token string">'post'</span>   <span class="token comment">// 强制最后执行</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">plugin</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">'[name].css'</span><span class="token punctuation">,</span>            <span class="token literal-property property">chunkFilename</span><span class="token operator">:</span><span class="token string">"[id].css"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="optimize-css-assets-webpack-plugin-生产环境压缩-css"><a href="#optimize-css-assets-webpack-plugin-生产环境压缩-css" class="headerlink" title="optimize-css-assets-webpack-plugin (生产环境压缩 css)"></a><code>optimize-css-assets-webpack-plugin</code> (生产环境压缩 css)</h4><ul><li>yarn add optimize-css-assets-webpack-plugin -D</li></ul><blockquote><p>用法在上面</p></blockquote><h4 id="uglifyjs-webpack-plugin-压缩js"><a href="#uglifyjs-webpack-plugin-压缩js" class="headerlink" title="uglifyjs-webpack-plugin (压缩js)"></a><code>uglifyjs-webpack-plugin</code> (压缩js)</h4><ul><li>yarn add UglifyJSPlugin -D</li></ul><p>当调用optimization后，会覆盖掉原来的配置，导致只有css进行了压缩,js没有压缩，所以需要手动调用</p><blockquote><p>用法在上面</p></blockquote><h4 id="postcss-loader-autoprefixer-css3加前缀-在css-loader之前使用"><a href="#postcss-loader-autoprefixer-css3加前缀-在css-loader之前使用" class="headerlink" title="postcss-loader autoprefixer (css3加前缀,在css-loader之前使用)"></a><code>postcss-loader autoprefixer</code> (css3加前缀,在css-loader之前使用)</h4><p><a href="https://www.npmjs.com/package/postcss-loader">postcss-loader API</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jsmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'css-loader'</span>            <span class="token punctuation">&#125;</span>，            <span class="token punctuation">&#123;</span> <span class="token comment">// 1</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>                <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                        <span class="token literal-property property">ident</span><span class="token operator">:</span> <span class="token string">'postcss'</span><span class="token punctuation">,</span>                        <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>                          <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token operator">...</span>options<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token operator">...</span><span class="token punctuation">,</span>                        <span class="token punctuation">]</span>                      <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">use</span><span class="token operator">:</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>                <span class="token literal-property property">enforce</span><span class="token operator">:</span><span class="token string">'post'</span>   <span class="token comment">// 强制最后执行</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token comment">// 2</span>postcss<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jsmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">pulgins</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a><code>ESLint</code></h4><ul><li>yarn add eslint eslint-loader -D</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">module</span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">"pre"</span><span class="token punctuation">,</span> <span class="token comment">// 必须在前面执行，先校验代码</span>                <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'eslint-loader'</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="clean-webpack-plugin-清空目录，一般在开发环境使用，常配合出口hash"><a href="#clean-webpack-plugin-清空目录，一般在开发环境使用，常配合出口hash" class="headerlink" title="clean-webpack-plugin (清空目录，一般在开发环境使用，常配合出口hash)"></a><code>clean-webpack-plugin</code> (清空目录，一般在开发环境使用，常配合出口hash)</h4><ul><li>yarn add clean-webpack-plugin@4 -D    webpack只能用上一个版本的</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> CleanWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'clean-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>         <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不需要传参，默认就会去找output.path</span>    <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="copy-webpack-plugin-拷贝静态资源插件"><a href="#copy-webpack-plugin-拷贝静态资源插件" class="headerlink" title="copy-webpack-plugin (拷贝静态资源插件)"></a><code>copy-webpack-plugin</code> (拷贝静态资源插件)</h4><ul><li>yarn add copy-webpack-plugin -D</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> CopyWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'copy-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">from</span><span class="token operator">:</span><span class="token string">'./assets'</span><span class="token punctuation">,</span>            <span class="token literal-property property">to</span><span class="token operator">:</span><span class="token string">'./'</span>   <span class="token comment">// 默认会拷贝到dist</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="webpack-DefinePlugin-设置环境变量"><a href="#webpack-DefinePlugin-设置环境变量" class="headerlink" title="webpack.DefinePlugin ( 设置环境变量 )"></a><code>webpack.DefinePlugin</code> ( 设置环境变量 )</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token comment">// 定义的变量 需要json.stringify 包裹</span>                <span class="token constant">DEV</span><span class="token operator">:</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// or '"development"'</span>                <span class="token constant">EXPRESSION</span><span class="token operator">:</span><span class="token string">'1+1'</span><span class="token punctuation">,</span>                <span class="token constant">FLAG</span><span class="token operator">:</span><span class="token string">'true'</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="webpack-merge-区分环境变量，进行不同配置"><a href="#webpack-merge-区分环境变量，进行不同配置" class="headerlink" title="webpack-merge (区分环境变量，进行不同配置)"></a><code>webpack-merge</code> (区分环境变量，进行不同配置)</h4><ul><li>yarn add webpack-merge -D</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 导入公共配置，loader entry  output 等</span><span class="token keyword">let</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 区分环境变量</span><span class="token keyword">let</span> prod <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'production'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span>prod<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="devtool-socurc-map"><a href="#devtool-socurc-map" class="headerlink" title="devtool:socurc-map "></a><code>devtool:socurc-map </code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'production'</span>      <span class="token operator">...</span>      <span class="token literal-property property">devtool</span><span class="token operator">:</span>  source<span class="token operator">-</span>map'<span class="token punctuation">,</span> <span class="token comment">// 会单独生成一个sourcemap文件 ，出错会标识当前报错的列和行  大而全</span>                <span class="token comment">// eval-source-map // 不会产生单独的文件，但是可以显示行和列</span>                <span class="token comment">// cheap-module-source-map // 不会产生列。但是是一个单独的映射文件</span>                <span class="token comment">// cheap-module-eval-source-map  // 不会产生文件，集成在打包后的文件中，不会产生列</span><span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p> 带cheap-module没有列，带eval在文件中<br> 如果使用 mini-css-extract-plugin 优化配置优化js时也需要配置那里的sourceMap。当然默认情况就会产生source-map</p></blockquote><h3 id="watch-监听打包"><a href="#watch-监听打包" class="headerlink" title="watch ( 监听打包 )"></a>watch ( 监听打包 )</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>     <span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token string">'production'</span>     <span class="token operator">...</span>     <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token literal-property property">watchOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 监控的选项</span>            <span class="token literal-property property">poll</span><span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 以秒为单位 轮询</span>            <span class="token literal-property property">aggregateTimeout</span><span class="token operator">:</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token comment">// 防抖 只要不停地触发事件只执行最后一次   节流 每隔多少秒触发一次</span>            <span class="token literal-property property">ignored</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="others-config"><a href="#others-config" class="headerlink" title="others config"></a>others config</h2><h3 id="webpack的配置文件是否只能为webpack-config-js"><a href="#webpack的配置文件是否只能为webpack-config-js" class="headerlink" title="webpack的配置文件是否只能为webpack.config.js?"></a>webpack的配置文件是否只能为webpack.config.js?</h3><ul><li>你可以在scripts的命令中配置 – config 名字 来实现重命名</li><li>或者在script配置后 npm run build – –config webpack.config1.js</li><li>webpack-cli/bin/config-yargs.js 中 defaultDescription: “webpack.config.js or webpackfile.js”,</li></ul><h3 id="jq在webpack中的使用-把-挂在window的方式"><a href="#jq在webpack中的使用-把-挂在window的方式" class="headerlink" title="jq在webpack中的使用(把$挂在window的方式?)"></a>jq在webpack中的使用(把$挂在window的方式?)</h3><p>import $ from ‘jquery’;  // 个文件打包后就会成为(function(arg){eval(…)})(); 这种window.$为undefined</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1.通过expose-loader 暴露的loader</span><span class="token keyword">import</span>  <span class="token string">'expose-loader?$！jquery'</span>  <span class="token punctuation">(</span><span class="token operator">!</span> 属于loader的另一种类型 inline<span class="token punctuation">)</span>or<span class="token keyword">import</span>  <span class="token string">'jquery'</span><span class="token literal-property property">rules</span> <span class="token operator">:</span><span class="token punctuation">[</span>   <span class="token punctuation">&#123;</span>      <span class="token literal-property property">test</span><span class="token operator">:</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>jquery<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 只要引用jquery 就能匹配到</span>      <span class="token literal-property property">use</span><span class="token operator">:</span><span class="token string">'expose-loader?$'</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">     </span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>js<span class="token comment">// 2. 用webpack插件每个模块都提供一个$</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>Providelugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>         <span class="token string-property property">'$'</span><span class="token operator">:</span><span class="token string">'jquery'</span>   <span class="token comment">// 这个$并不是全局的</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">    </span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>js<span class="token comment">// 3. 在html引用</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token operator">...</span>    externals<span class="token punctuation">&#123;</span>  <span class="token comment">// 打包的时候需要排除掉</span>        <span class="token string-property property">'jquery'</span><span class="token operator">:</span><span class="token string">'$'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">    ### npx 运行机制 (可以实现零配置打包)</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>js@<span class="token constant">IF</span> <span class="token constant">EXIST</span> <span class="token string">"%~dp0\node.exe"</span> <span class="token punctuation">(</span> <span class="token comment">// 如果当前bin文件夹下存在node.exe 执行</span>  <span class="token string">"%~dp0\node.exe"</span>  <span class="token string">"%~dp0\..\webpack\bin\webpack.js"</span> <span class="token operator">%</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token constant">ELSE</span> <span class="token punctuation">(</span>  @<span class="token constant">SETLOCAL</span>  @<span class="token constant">SET</span> <span class="token constant">PATHEXT</span><span class="token operator">=</span><span class="token operator">%</span><span class="token constant">PATHEXT</span><span class="token operator">:</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token constant">JS</span><span class="token punctuation">;</span><span class="token operator">=</span><span class="token punctuation">;</span><span class="token operator">%</span>  node  <span class="token string">"%~dp0\..\webpack\bin\webpack.js"</span> <span class="token operator">%</span><span class="token operator">*</span>  <span class="token comment">// 不存在执行 node ../webpack/bin/webpack.js</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="多入口配置"><a href="#多入口配置" class="headerlink" title="多入口配置"></a>多入口配置</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token comment">// 入口文件数量</span>        <span class="token literal-property property">index</span><span class="token operator">:</span><span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>        <span class="token literal-property property">main</span><span class="token operator">:</span><span class="token string">'./src/main.js'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">path</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token string">'[name].[hash:8].js'</span>  <span class="token comment">// 根据入口名定义打包后的文件名</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>         <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>             <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'public/index.html'</span><span class="token punctuation">,</span>             <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>             <span class="token literal-property property">minify</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                 <span class="token literal-property property">removeAttributeQuotes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                 <span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>             <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"index"</span><span class="token punctuation">]</span>   <span class="token comment">// 代码块名称</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>             <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">"public/index.html"</span><span class="token punctuation">,</span>             <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">"main.html"</span><span class="token punctuation">,</span>             <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span>   <span class="token comment">// 代码块名称</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>     <span class="token punctuation">]</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="调试es6代码-需要一个sourceMap-源码映射"><a href="#调试es6代码-需要一个sourceMap-源码映射" class="headerlink" title="调试es6代码 需要一个sourceMap 源码映射"></a>调试es6代码 需要一个sourceMap 源码映射</h3><h3 id="多页面应用抽离公共代码以及第三方模块"><a href="#多页面应用抽离公共代码以及第三方模块" class="headerlink" title="多页面应用抽离公共代码以及第三方模块"></a>多页面应用抽离公共代码以及第三方模块</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 分离代码块</span>            <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 缓存组</span>                <span class="token literal-property property">common</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token comment">// common~index~login</span>                    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>                    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>  <span class="token comment">// 从入口处抽离</span>                    <span class="token literal-property property">minSize</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">,</span>   <span class="token comment">// 只要共用的部分超过0个字节 我就抽离</span>                    <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 至少两次才抽离出来</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">vendor</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>                    <span class="token literal-property property">priority</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token comment">// 权重，先走这里，默认为0</span>                    <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>  <span class="token comment">// 标识第三方模块，node_modules下的</span>                    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>                    <span class="token literal-property property">minSize</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token literal-property property">minChunks</span><span class="token operator">:</span><span class="token number">2</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置中出现的问题"><a href="#配置中出现的问题" class="headerlink" title="配置中出现的问题"></a>配置中出现的问题</h2><h3 id="read-only-property-‘exports’-of-object"><a href="#read-only-property-‘exports’-of-object" class="headerlink" title="read only property ‘exports’ of object"></a>read only property ‘exports’ of object</h3><blockquote><p><a href="https://stackoverflow.com/questions/42449999/webpack-import-module-exports-in-the-same-module-caused-error">Uncaught TypeError: Cannot assign to read only property ‘exports’ of object </a></p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 原因：</span><span class="token comment">// This happens if other modules down stream have an unexpected require tree. Babel changes require to import where it isn't supposed to which causes the aforementioned issue @Matthew Herbst. To solve this add "sourceType": "unambiguous" to your babelrc file or babel.config.js so that @babel/plugin-transform-runtime won't do this change of require expression to import in your commonjs files.</span><span class="token comment">// babel.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">'@quasar/babel-preset-app'</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string-property property">"sourceType"</span><span class="token operator">:</span> <span class="token string">"unambiguous"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="this-getOptions-is-not-a-function"><a href="#this-getOptions-is-not-a-function" class="headerlink" title="this.getOptions is not a function"></a>this.getOptions is not a function</h3><p>TypeError: this.getOptions is not a function 一般都是插件为了适配webpack5 做了升级，降低插件版本即可</p><h3 id="图片打包到公共img文件夹下，页面取不到图片问题"><a href="#图片打包到公共img文件夹下，页面取不到图片问题" class="headerlink" title="图片打包到公共img文件夹下，页面取不到图片问题"></a>图片打包到公共img文件夹下，页面取不到图片问题</h3><p><a href="https://segmentfault.com/q/1010000014640043">图片打包到公共img文件夹下，页面取不到图片问题（图片查找路径被添加了css/img/xxx）</a></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">loader</span><span class="token operator">:</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span><span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token comment">/*  * 复写css文件中资源路径  * webpack3.x配置在extract-text-webpack-plugin插件中  * 因为css文件中的外链是相对与css的，  * 我们抽离的css文件在可能会单独放在css文件夹内  * 引用其他如img/a.png会寻址错误  * 这种情况下所以单独需要配置../../，复写其中资源的路径  */</span>  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'../../'</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="html-withimg-loader-引用图片地址改变"><a href="#html-withimg-loader-引用图片地址改变" class="headerlink" title="html-withimg-loader 引用图片地址改变"></a>html-withimg-loader 引用图片地址改变</h3><p>使用html-withimg-loader 引用图片地址变为  &lt;img src={“default”:”389a66a25c539a9fd3524d58c43e2560.png”}&gt;</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>    <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'url-loader'</span><span class="token punctuation">,</span>    <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">esModule</span><span class="token operator">:</span><span class="token boolean">false</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>webpack4 使用最新 copy-webpack-plugin 打包报错 “compilation.getCache is not a function“<br>yarn add copy-webpack-plugin@6 -D  // 降低版本  npm</p></blockquote><blockquote><p>通过默认的devServer配置启动的服务，打包的动态链接库找不到，需要配置contentBase</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue2初渲染流程</title>
      <link href="/posts/63af.html"/>
      <url>/posts/63af.html</url>
      
        <content type="html"><![CDATA[<h1 id="Vue2初渲染流程"><a href="#Vue2初渲染流程" class="headerlink" title="Vue2初渲染流程"></a>Vue2<code>初渲染</code>流程</h1><ul><li><code>template模板</code> =&gt; <code>ast 语法树</code>（描述语法的）=&gt; <code>render函数</code> =&gt; <code>虚拟dom</code></li><li>new Vue时会产生一个watcher(渲染watcher) <code>vm._update(vm._render()) 创建真实节点</code></li></ul><h2 id="获取template模版"><a href="#获取template模版" class="headerlink" title="获取template模版"></a>获取<code>template</code>模版</h2><ul><li><code>render</code> 有render直接使用</li><li><code>template</code> 没有render看template</li><li>最后是<code>el找html找外部模板</code></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// init.js</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token operator">...</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">...</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">...</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="模版编译成render函数"><a href="#模版编译成render函数" class="headerlink" title="模版编译成render函数"></a>模版编译成<code>render函数</code></h2><h3 id="生成compileToFunctions函数主要流程"><a href="#生成compileToFunctions函数主要流程" class="headerlink" title="生成compileToFunctions函数主要流程"></a>生成<code>compileToFunctions</code>函数<code>主要流程</code></h3><ul><li>模板编译成render函数<ul><li><code>parseHtml</code> 生成ast语法树</li><li><code>generate</code> 变为一个_c(“div”,{a:1},_c())</li><li>使用with包裹生成的字符串 let str = <code>with(this)&#123;return $&#123;code&#125;&#125;</code> (渲染的时候去实例取值)</li><li><code>return new Function(str)</code></li></ul></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// compiler/index.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> parseHtml <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./parse'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> generate <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./generate'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span><span class="token parameter">template</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 生成 ast 语法树</span>    <span class="token keyword">let</span> ast <span class="token operator">=</span> <span class="token function">parseHtml</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ast 生成 虚拟dom</span>    <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 生成render函数</span>    <span class="token keyword">let</span> render <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this)&#123; return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;</span><span class="token template-punctuation string">`</span></span>    <span class="token comment">// 把字符串变成一个函数</span>    <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 返回render函数</span>    <span class="token keyword">return</span> fn<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="render函数挂在到-vm-options上"><a href="#render函数挂在到-vm-options上" class="headerlink" title="render函数挂在到 vm.options上"></a><code>render</code>函数挂在到 vm.options上</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// init.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> mountComponent <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./lifecycle'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token operator">...</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>                vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// template => render方法</span>            <span class="token comment">// 1.处理模板变为ast树 2.标记静态节点 3.codegen=>return 字符串 4.new Function + with (render函数)</span>            <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>            options<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span> <span class="token comment">// 保证render一定有</span>        <span class="token punctuation">&#125;</span>        <span class="token function">mountComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 组件挂载</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="render函数生成虚拟dom"><a href="#render函数生成虚拟dom" class="headerlink" title="render函数生成虚拟dom"></a>render函数生成<code>虚拟dom</code></h2><ul><li>Vue 是通过<code>Watcher渲染</code>页面</li><li>Watcher 第二个参数是 <code>updateComponent</code> =&gt; vm._update(vm_render());</li><li><code>vm._render 产生虚拟节点</code></li><li><code>vm._update 把虚拟节点渲染为真实节点</code></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// lifecycle.js</span><span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'./observer/watcher'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// Watcher中会执行此方法</span>    <span class="token keyword">let</span> <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>updateComponent<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// render.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createElement<span class="token punctuation">,</span> createTextVnode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./vdom/index.js"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_c</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 创建元素的虚拟节点</span>        <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_v</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 创建文本虚拟节点</span>        <span class="token keyword">return</span> <span class="token function">createTextVnode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_s</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 转化成字符串</span>        <span class="token keyword">return</span> val <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span><span class="token string">''</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token operator">:</span> val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> render <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">;</span> <span class="token comment">// 获取编译后的render方法</span>        <span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用render方法产生虚拟节点 （会自动将值进行渲染）</span>        render vnode<span class="token punctuation">;</span> <span class="token comment">// 返回虚拟节点</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// vdom/index.js</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>tag<span class="token punctuation">,</span>data<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token operator">...</span>children</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>tag<span class="token punctuation">,</span>data<span class="token punctuation">,</span>data<span class="token punctuation">.</span>key<span class="token punctuation">,</span>children<span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTextVnode</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>text</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>tag<span class="token punctuation">,</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>children<span class="token punctuation">,</span>text<span class="token punctuation">,</span>componentOptions</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 可以根据需求任意添加</span>        vm<span class="token punctuation">,</span>        tag<span class="token punctuation">,</span>        data<span class="token punctuation">,</span>        key<span class="token punctuation">,</span>        children<span class="token punctuation">,</span>        text<span class="token punctuation">,</span>        componentOptions    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="虚拟dompatch渲染到页面"><a href="#虚拟dompatch渲染到页面" class="headerlink" title="虚拟dompatch渲染到页面"></a>虚拟dom<code>patch</code>渲染到页面</h2><p>patch 分为<code>初渲染</code>和后续的<code>dom-diff</code>;</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// lifecycle.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> patch <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./vdom/patch'</span><span class="token punctuation">;</span><span class="token keyword">import</span> Watcher <span class="token keyword">from</span> <span class="token string">'./observer/watcher'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lifecycle</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token comment">// 通过patch吧虚拟节点转为真实节点</span>        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//组件渲染用patch方法后会产生$el属性</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// Watcher中会执行此方法</span>    <span class="token keyword">let</span> <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>updateComponent<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// vdom/patch.js</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>vnode</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// oldVnode 是一个真实元素</span>    <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">;</span> <span class="token comment">// id="app"</span>        <span class="token keyword">const</span> parentElm <span class="token operator">=</span> oldElm<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span><span class="token comment">// body</span>        <span class="token keyword">let</span> el <span class="token operator">=</span> <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据虚拟节点创建真实的节点</span>        parentElm<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>oldElm<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将创建的节点插到原有的节点的下一个</span>        parentElm<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除原有的节点</span>        <span class="token keyword">return</span> el <span class="token comment">// vm.$el</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token comment">// dom-diff</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">updateProperties</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span>oldProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> newProps <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 属性</span>    <span class="token keyword">let</span> el <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">;</span> <span class="token comment">// 当前的真实元素</span>    <span class="token comment">// 1.老的属性 新的没有 删除属性</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> newStyle <span class="token operator">=</span> newProps<span class="token punctuation">.</span>style <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> oldStyle <span class="token operator">=</span> oldProps<span class="token punctuation">.</span>style <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldStyle<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 判断样式新老先比对</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newStyle<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            el<span class="token punctuation">.</span>style<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 2. 新的属性老的没有,直接用新的覆盖，不考虑有没有</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> newProps<span class="token punctuation">.</span>style<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                el<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> newProps<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            el<span class="token punctuation">.</span>className <span class="token operator">=</span> newProps<span class="token punctuation">.</span>class<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> tag<span class="token punctuation">,</span>children<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> text<span class="token punctuation">,</span> vm <span class="token punctuation">&#125;</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">updateProperties</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新属性</span>        children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            vnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElm</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span>； <span class="token comment">// 递归创建子元素</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="初渲染完成，撒花-QAQ"><a href="#初渲染完成，撒花-QAQ" class="headerlink" title="初渲染完成，撒花 QAQ"></a><code>初渲染完成，撒花 QAQ</code></h2>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue2数据劫持原理</title>
      <link href="/posts/6.html"/>
      <url>/posts/6.html</url>
      
        <content type="html"><![CDATA[<h1 id="Vue2数据劫持原理"><a href="#Vue2数据劫持原理" class="headerlink" title="Vue2数据劫持原理"></a>Vue2<code>数据劫持</code>原理</h1><h2 id="rollup打包Vue源码配置"><a href="#rollup打包Vue源码配置" class="headerlink" title="rollup打包Vue源码配置"></a><code>rollup</code>打包Vue<code>源码</code>配置</h2><p><code>类库，工具库</code>一般使用<code>rollup</code>打包，打包出的文件比较<code>干净</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#                rollup和babel桥梁    babel核心模块   es6=>es5       启动webpack服务</span><span class="token function">yarn</span> <span class="token function">add</span> rollup rollup-plugin-babel @babel/core @babel/preset-ent rollup-plugin-serve -D<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>rollup简单配置</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// rollup.config.js</span><span class="token keyword">import</span> babel <span class="token keyword">from</span> <span class="token string">'rollup-plugin-babel'</span><span class="token keyword">import</span> serve <span class="token keyword">from</span> <span class="token string">'rollup-plugin-server'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">input</span><span class="token operator">:</span><span class="token string">"./src/index.js"</span><span class="token punctuation">,</span> <span class="token comment">// 入口</span>    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">format</span><span class="token operator">:</span><span class="token string">'umd'</span><span class="token punctuation">,</span> <span class="token comment">// 支持amd commonjs window.Vue</span>        <span class="token literal-property property">file</span><span class="token operator">:</span><span class="token string">"./dist/vue.js"</span><span class="token punctuation">,</span> <span class="token comment">// 打包后的文件存放地址</span>        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"Vue"</span><span class="token punctuation">,</span> <span class="token comment">// 全局的名字就是vue</span>        <span class="token literal-property property">sourcemap</span><span class="token operator">:</span><span class="token boolean">true</span> <span class="token comment">// es6->es5源码映射模块</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">exclude</span><span class="token operator">:</span><span class="token string">'node_modules/**'</span> <span class="token comment">// 此目录不需要babel转化</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">open</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">,</span>            <span class="token literal-property property">contentBase</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>            <span class="token literal-property property">openPage</span><span class="token operator">:</span><span class="token string">'/public/index.html'</span> <span class="token comment">// 默认打开目录</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token comment">// .babelrc</span><span class="token punctuation">&#123;</span>    <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"@babel/preset-env"</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="如何在原型上扩展方法"><a href="#如何在原型上扩展方法" class="headerlink" title="如何在原型上扩展方法"></a>如何在<code>原型上扩展方法</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> initMixin <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./init'</span><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// options 为用户传入的参数</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入口方法，初始化操作</span><span class="token punctuation">&#125;</span><span class="token comment">// 写成一个个插件对原型进行扩展</span><span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// init.js</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// ...</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// ...</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="对象的数据劫持"><a href="#对象的数据劫持" class="headerlink" title="对象的数据劫持"></a>对象的<code>数据劫持</code></h2><p>初始化时调用<code>initState(vm)</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// init.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> initState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./state'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// vm 是 Vue的实例</span>        vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> options<span class="token punctuation">;</span> <span class="token comment">// 把用户传入的参数挂载到vm上</span>        <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// options 已经挂载在 vm上</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// state.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> observe <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./observer/index'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span> <span class="token comment">// 上面挂载了这里可以取</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 有传递data 就需要对数据进行劫持</span>        <span class="token function">initDate</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">initDate</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data    <span class="token comment">// 把数据代理到 vm._data上方便拿取</span>    vm<span class="token punctuation">.</span>_data <span class="token operator">=</span>  data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">==</span> <span class="token string">'function'</span><span class="token operator">?</span><span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token operator">:</span>data<span class="token punctuation">;</span> <span class="token comment">// 如果是函数取返回值，不是的话就是对象</span>    <span class="token comment">// 当去vm取值时，将属性取值代理到vm._data上</span>    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">'_data'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>data<span class="token punctuation">,</span>key</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> vm<span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            vm<span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// observer/index.js</span><span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data中某个值还为对象需要监控</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">&#123;</span>        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> value        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token operator">!=</span>newValue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data中某个值修改为对象需要监控新赋的值</span>                value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对象才监测</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">||</span> data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 如果是普通值直接返回（不能返回data）</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 开始数据劫持</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="数组的数据劫持"><a href="#数组的数据劫持" class="headerlink" title="数组的数据劫持"></a>数组的<code>数据劫持</code></h2><ul><li>核心思想是把<code>数组的原有方法重写</code>，在<code>执行之前先执行自己写的方法</code> (<code>AOP切片编程</code>)</li><li>只有<code>data中的数组</code>才会先执行自己定义的，在<code>外部不受影响</code> （所有不能直接修改数组原型）</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// observer/array.js</span><span class="token keyword">let</span> oldArrayMethods <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment">// 保存数组原有方法</span><span class="token keyword">export</span> <span class="token keyword">let</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过Array.__proto__ 还能找到数组原有方法</span><span class="token comment">// 只有这7中方法是因为这几个方法才会改变原有数组，vue是数据改变刷新视图的</span><span class="token keyword">let</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'pop'</span><span class="token punctuation">,</span>    <span class="token string">'push'</span><span class="token punctuation">,</span>    <span class="token string">'shift'</span><span class="token punctuation">,</span>    <span class="token string">'unshift'</span><span class="token punctuation">,</span>    <span class="token string">'splice'</span><span class="token punctuation">,</span>    <span class="token string">'revert'</span><span class="token punctuation">,</span>    <span class="token string">'sort'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    arrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> result <span class="token operator">=</span> oldArrayMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数组老的方法</span>        <span class="token comment">// 新插入数组中的值也需要变成响应式 => 调用Observer中的observeArray</span>        <span class="token keyword">let</span> insert<span class="token punctuation">;</span>        <span class="token keyword">let</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> <span class="token string">"push"</span><span class="token operator">:</span>            <span class="token keyword">case</span> <span class="token string">"unshift"</span><span class="token operator">:</span>                insert <span class="token operator">=</span> args<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"splice"</span><span class="token operator">:</span>                insert <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第三个以后是新增的</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>insert<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>insert<span class="token punctuation">)</span> <span class="token comment">// 数组新增的值有可能是对象 也需要深层监控 （调用 Observe中的 arrayObserve 监控）</span>        <span class="token keyword">return</span> result    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// observer/index.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> arrayMethods <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./array.js'</span><span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">&#123;</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 给每个值增加__ob__指向Observer这个类（方便value通过__ob__调用observeArray方法）</span>        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token string">'__ob__'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">value</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">,</span>            <span class="token literal-property property">enumerable</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不可枚举，防止被循环出来</span>            <span class="token literal-property property">configurable</span><span class="token operator">:</span><span class="token boolean">false</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token comment">// 如果是数组的话如果数组长度很长每个都监控很费时间</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        value<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayMethods<span class="token punctuation">;</span> <span class="token comment">// 数组的原型指向修改后的那些方法</span>            <span class="token comment">// Object.setPrototypeOf(value,arrayMethods);</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数组中的对象变化了也需要监控</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">observeArray</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 数组的每一项都 observer 所以效率低</span>        value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://www.zhihu.com/tardis/zm/art/585838362?source_id=1003">Object.create()与new Object()的区别</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>收集一些常见的手写题（上）</title>
      <link href="/posts/c05a.html"/>
      <url>/posts/c05a.html</url>
      
        <content type="html"><![CDATA[<h1 id="防抖"><a href="#防抖" class="headerlink" title="防抖"></a>防抖</h1><p>触发<code>高频</code>事件<code>n秒</code>内函数<code>只执行一次</code>，如果n秒内<code>高频</code>事件再次被<code>触发</code>，则<code>重新计算时间</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * @desc 函数防抖 * @param &#123;Function&#125; func 函数 * @param &#123;Number&#125; wait 延迟执行毫秒数 * @param &#123;Boolean&#125; immediate true 表示立即执行，false 表示非立即执行 */</span><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> daley<span class="token punctuation">,</span> immediate</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> timer  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> run <span class="token operator">=</span> <span class="token operator">!</span>timer          timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>              timer <span class="token operator">=</span> <span class="token keyword">null</span>              <span class="token comment">// fn.apply(this, arguments) 立即执行完输入完再执行一次</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> daley<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>              <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hi debounce'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token function">debounce</span><span class="token punctuation">(</span>say<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="节流"><a href="#节流" class="headerlink" title="节流"></a>节流</h1><p><code>高频事件</code>触发，但在<code>n秒</code>内<code>只会执行一次</code>，节流会<code>稀释</code>函数的<code>执行频率</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span>daley</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> canRun <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>canRun<span class="token punctuation">)</span> <span class="token keyword">return</span>      canRun <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>          <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span>          canRun <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>daley<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'box'</span><span class="token punctuation">)</span><span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hi throttle'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span>say<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h1><ul><li><p><code>深拷贝</code>：修改新变量的值不会影响原有变量的值。默认情况下基本数据类型（number，string，null，undefined，boolean）都是深拷贝。</p></li><li><p><code>浅拷贝</code>：修改新变量的值会影响原有的变量的值。默认情况下引用类型（object）都是浅拷贝。</p></li></ul><blockquote><p>ES6中的<code>结构赋值</code>和<code>Object.assign</code>都是浅拷贝（一层的话看不出来）</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>  <span class="token comment">// == 有个默认的进制转化 null == undefined -> true</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj <span class="token operator">!=</span><span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>  <span class="token comment">// 字符串</span>  <span class="token keyword">let</span> newObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">obj<span class="token punctuation">.</span>constructor</span><span class="token punctuation">;</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> newObj<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>不能解析new Date(), reg: /reg/, fn: function () {} 需要<code>单独处理</code></p></blockquote><h1 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> event <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span>            fns <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fns <span class="token operator">||</span> fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 这回我们加入了取消订阅的方法</span>        <span class="token keyword">let</span> fns <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 如果缓存列表中没有函数，返回false</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fns<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment">// 如果没有传对应函数的话</span>        <span class="token comment">// 就会将key值对应缓存列表中的函数都清空掉</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            fns <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 遍历缓存列表，看看传入的fn与哪个函数相同</span>            <span class="token comment">// 如果相同就直接从缓存列表中删掉即可</span>            fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span>fn<span class="token punctuation">,</span>cb <span class="token operator">===</span> fn<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">===</span> fn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    fns<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'一起喵喵喵'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'一起旺旺旺'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>event<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'pet'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>event<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'pet'</span><span class="token punctuation">,</span> cat<span class="token punctuation">)</span><span class="token punctuation">;</span>event<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'pet'</span><span class="token punctuation">,</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取消dog方法的订阅</span>event<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'pet'</span><span class="token punctuation">,</span> dog<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发布</span>event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'pet'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'二哈'</span><span class="token punctuation">,</span> <span class="token string">'波斯猫'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*    接收数据    [ '二哈', '波斯猫' ]    一起喵喵喵*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>new、call、apply、bind内部进行了什么操作？</title>
      <link href="/posts/c6aa.html"/>
      <url>/posts/c6aa.html</url>
      
        <content type="html"><![CDATA[<h1 id="new"><a href="#new" class="headerlink" title="new"></a><code>new</code></h1><p><code>思路</code>：</p><ol><li>创建一个对象<code>__proto__</code>指向这个类的<code>原型对象</code>(可以<code>使用prototype上的方法</code>了)</li><li>调用类<code>执行</code>并且<code>修改this指向</code>为新创建的obj,并且<code>传入剩余参数</code></li><li>判断如果构造函数<code>返回的是引用类型</code>则<code>返回这个值</code>，否则<code>返回obj</code></li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Animal</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token operator">=</span>type<span class="token punctuation">;</span>    <span class="token comment">// 如果当前构造函数返回的是一个引用类型 需要把这个返回</span>    <span class="token comment">//return &#123;name:'a'&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">Animal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">mockNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// Constructor => Animal</span>    <span class="token keyword">let</span> Constructor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 返回的结果</span>    obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment">// 原型上的方法</span>    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">Constructor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> r <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token operator">?</span>r<span class="token operator">:</span>obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> animal <span class="token operator">=</span> <span class="token function">mockNew</span><span class="token punctuation">(</span>Animal<span class="token punctuation">,</span><span class="token string">'爬行类'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 爬行类</span>animal<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// say</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="call"><a href="#call" class="headerlink" title="call"></a><code>call</code></h1><p><code>思路</code>：</p><ol><li>先找到call方法 =&gt; 只有<code>函数</code>才能找到call方法 =&gt; 找到call</li><li>并且把调用call这个函数中的<code>this修改成call的第一个参数</code> =&gt; 改this</li><li>调用<code>call方法的那个函数执行</code> =&gt; 这个函数中的this已经被修改过了</li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">call</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    context <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">||</span> window    context<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span>        <span class="token comment">// fn1.this = fn2（这样是不可行的,js中不能直接改变this指向）  ==> &#123;&#125;.fn1() fn1 中的this 就指向fn2了 也就相当于this();</span>    <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'arguments['</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'context.fn('</span><span class="token operator">+</span>args<span class="token operator">+</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// fn1 的this指向fn2 并且让fn1执行</span><span class="token function">fn1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 无论写多少个都会找到最终的一个call方法，并且把这个call中的this 变成 fn2,并且让这个call执行,call执行内部就会让fn2执行</span>fn1<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fn2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//--> (fn1.call.call).call(fn2) --> call.call(fn2)</span><span class="token comment">// 改变当前函数的this指向   并且让当前函数执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="apply"><a href="#apply" class="headerlink" title="apply"></a><code>apply</code></h1><p><code>思路</code>：和call一样，只不过<code>第二个参数是数组</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span>args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    context <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">||</span> window<span class="token punctuation">;</span>    context<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">return</span>  context<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 利用数组的toString的特性</span>    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'context.fn('</span><span class="token operator">+</span> args <span class="token operator">+</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">delete</span> context<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>    <span class="token keyword">return</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">fn1</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>fn2<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="bind"><a href="#bind" class="headerlink" title="bind"></a><code>bind</code></h1><p><code>思路</code>：</p><ol><li>bind方法可以绑定this指向 绑定参数</li><li>bind方法返回一个绑定后的函数<code>（高阶函数）</code></li><li>如果绑定的函数<code>被new</code>了 当前函数的<code>this就是当前的实例</code></li><li><code>new 出来的结果可以找到原有类的原型</code></li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'aa'</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'养了一只'</span> <span class="token operator">+</span> name <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">'岁'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 保存原来的方法</span>    <span class="token keyword">let</span> bindArgs <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">function</span> <span class="token function">fBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//this</span>        <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">that</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">fBound</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> context<span class="token punctuation">,</span> bindArgs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// fBound.prototype = this.prototype   //这样两个类的原型指向同一个地址，不太好</span>    <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>  <span class="token comment">// 中间件函数实现关联，</span>    fBound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> fBound<span class="token punctuation">&#125;</span>fn<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token string">'哺乳类'</span><span class="token punctuation">;</span><span class="token keyword">let</span> bindFn <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'猫'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//bindFn(9);</span><span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bindFn</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 原生JS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>收集一些常见的烧脑题（上）</title>
      <link href="/posts/187b.html"/>
      <url>/posts/187b.html</url>
      
        <content type="html"><![CDATA[<p>虽然一般用不到，但是能<code>加深对js运行机制的理解</code></p><h1 id="第1题"><a href="#第1题" class="headerlink" title="第1题"></a>第1题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">a</span> <span class="token punctuation">(</span><span class="token parameter">b <span class="token operator">=</span> c<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>: Cannot access ‘c’ before initialization</p><p><code>解析</code>: 给函数多个参数设置默认值实际上跟<code>按顺序定义变量一样</code>，所以<code>会存在暂时性死区</code>，即<code>前面定义的变量不能引用后面还未定义的变量</code>，二后面的可以访问前面的</p><h1 id="第2题"><a href="#第2题" class="headerlink" title="第2题"></a>第2题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> a <span class="token operator">=</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token keyword">let</span> a <span class="token operator">=</span> b <span class="token operator">=</span> <span class="token number">20</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>: 10 、 20</p><p><code>解析</code>:  连等操作是<code>从右向左</code>执行,相当于 <code>b = 10 , let a = b</code>, 很明显<code>b没有声明就直接赋值</code>了，所以会<code>隐式创建为一个全局变量</code>，函数内的也是一样，并没有声明b，直接就对b赋值了，因为<code>作用域链</code>，会一层一层向上查找，找了到<code>全局的b</code>，所以全局的b就被修改为20了，而函数内的a因为重新声明了，所以只是局部变量，不影响全局的a，所以a还是10。</p><h1 id="第3题"><a href="#第3题" class="headerlink" title="第3题"></a>第3题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">n</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> b <span class="token operator">=</span> aa<span class="token punctuation">.</span>x <span class="token operator">=</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">n</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：undefined、{n: 2}</p><p><code>解析</code>：<code>运算符优先级最高</code>，所以会先执行a.x,此时a、b共同指向的{n: 1}变成了{n: 1, x: undefined}，然后按照连等操作<code>从右到左执行代码</code>，a = {n: 2}，显然，a现在指向了一个新对象，然后a.x = a，因为a.x最开始就执行过了，所以这里其实<code>等价于</code>：({n: 1, x: undefined}).x = b.x = a = {n: 2}。</p><h1 id="第4题"><a href="#第4题" class="headerlink" title="第4题"></a>第4题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>arr<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> x <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：[]</p><p><code>解析</code>：arr[10]=10，那么<code>索引3到9位置上都是undefined</code>，arr[3]等打印出来也确实是undefined，但是，这里其实涉及到ECMAScript版本不同对应方法行为不同的问题，ES6之前的遍历方法都<code>会跳过数组未赋值过的位置</code>，也就是空位，但是ES6新增的<code>for of</code>方法就不会跳过</p><h1 id="第5题"><a href="#第5题" class="headerlink" title="第5题"></a>第5题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>答案</code>：[4,5,3]</p><p><code>解析</code>：assign方法可以用于处理数组，不过会把数组视为对象，比如这里会把目标<code>数组视为是属性为0、1、2的对象</code>，所以源数组的0、1属性的值覆盖了目标对象的值。</p><h1 id="第6题"><a href="#第6题" class="headerlink" title="第6题"></a>第6题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">switch</span><span class="token punctuation">(</span>x<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token operator">++</span>x  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token operator">++</span>x  <span class="token keyword">break</span>  <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token operator">++</span>x  <span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：4</p><p><code>解析</code>： <code>后缀版的自增运算符会在语句被求值后才发生</code>，所以x会仍以1的值去匹配case分支，那么显然匹配到为1的分支，此时，<code>x++生效</code>，x变成2，再执行++x，变成3，因为<code>没有break语句</code>，所以会进入<code>当前case后面的分支</code>，所以再次++x，最终变成4。</p><h1 id="第7题"><a href="#第7题" class="headerlink" title="第7题"></a>第7题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> out <span class="token operator">=</span> <span class="token number">25</span><span class="token keyword">var</span> inner <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">out</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  <span class="token function-variable function">func</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> out <span class="token operator">=</span> <span class="token number">30</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>out  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inner<span class="token punctuation">.</span>func<span class="token punctuation">,</span> inner<span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>inner<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inner<span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inner<span class="token punctuation">.</span>func <span class="token operator">=</span> inner<span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：25, 20, 20,25</p><p><code>解析</code>：这道题考察<code>this指向</code>问题</p><ol><li>逗号操作符会返回<code>表达式中的最后一个值</code>，这里是inner.func对应的函数，<code>ƒ () &#123; var out = 3 return this.out &#125;</code>(函数本身)，然后执行此函数，此函数并不是通过对象的方法调用，而是在<code>全局环境下调用</code>，所以<code>this指向window</code>, 打印出来的当然是window下的out</li><li>这个显然是以对象的方法调用，那么<code>this指向该对象</code></li><li>加了个括号，看起来有点迷惑人，但实际上<code>(inner.func)和inner.func</code>是<code>完全相等</code>的，所以还是作为对象的方法调用</li><li>赋值表达式和逗号表达式相似，都是<code>返回的值本身</code>，所以也相对于在<code>全局环境下调用函数</code></li></ol><h1 id="第8题"><a href="#第8题" class="headerlink" title="第8题"></a>第8题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'bcd'</span>obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：undefined</p><p><code>解析</code>：这道题考察的是this的指向问题，箭头函数执行的时候上下文是不会绑定this的，所以它里面的this取决于外层的this，这里函数执行的时候外层是全局作用域，所以this指向window，window对象下没有name属性，所以是undefined。</p><h1 id="第9题"><a href="#第9题" class="headerlink" title="第9题"></a>第9题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">var</span> <span class="token function-variable function">getNum</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：undefined</p><p><code>解析</code>：</p><ul><li><p>首先因为var声明的<code>变量提升</code>作用，所以a变量被提升到顶部，未赋值，所以第一个打印出来的是undefined。</p></li><li><p>接下来是函数声明和函数表达式的区别，<code>函数声明会有提升</code>作用，在<code>代码执行前就把函数提升到顶部</code>，在执行上下文上中生成函数定义，所以<code>第二个getNum会被最先提升到顶部</code>，然后是var声明getNum的提升，但是因为getNum函数已经被声明了，所以就不需要再声明一个同名变量，接下来开始执行代码，执行到var getNum = fun…时，虽然声明被提前了，但是赋值操作还是留在这里，所以getNum被赋值为了一个函数，<code>下面的函数声明直接跳过</code>，最后，getNum函数执行前a打印出来还是1，执行后，a被修改成了2，所以最后打印出来的2。</p></li></ul><h1 id="第10题"><a href="#第10题" class="headerlink" title="第10题"></a>第10题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>fn<span class="token punctuation">]</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：打印出arr数组本身</p><p><code>解析</code>：函数作为某个对象的方法调用，this指向该对象，<code>数组显然也是对象</code>,只不过我们都习惯了对象引用属性的方法：<code>obj.fn</code> ，但是实际上<code>obj[&#39;fn&#39;]</code>引用也是可以的。</p><h1 id="第11题"><a href="#第11题" class="headerlink" title="第11题"></a>第11题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">var</span> b<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> bconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：1、b函数本身、b函数本身</p><p><code>解析</code>：这三小题都涉及到函数声明和var声明，<code>两者都会发生提升</code>，但是<code>函数会优先提升</code>,所以如果<code>变量和函数同名</code>的话，变量的提升就<code>忽略</code>了</p><ul><li><p>提升完后，执行到<code>赋值代码</code>，a被赋值成了1，函数因为已经声明提升了，所以<code>跳过</code>，最后打印a就是1。</p></li><li><p>和第一题类似，只是b没有赋值操作，那么执行到这两行相当于都没有操作，b当然是函数。</p></li><li><p>和第二题类似，只是先后顺序换了一下，但是并不影响两者的提升顺序，仍是函数优先，同名的var声明提升忽略，所以打印出b还是函数。</p></li></ul><blockquote><p><a href="https://www.cnblogs.com/zhulongxu/p/16533629.html">函数和变量提升的区别</a></p></blockquote><h1 id="第12题"><a href="#第12题" class="headerlink" title="第12题"></a>第12题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">&#125;</span>Foo<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token keyword">var</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token comment">//请写出以下输出结果：</span>Foo<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Foo<span class="token punctuation">.</span>getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">new</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code></p><p>2、4、1、1、2、3、3</p><p><code>解析</code></p><p>这是一道综合性题目，首先<code>getName函数声明会先提升</code>，然后getName函数表达式提升，但是因为函数声明提升在前，所以 <code>忽略函数表达式</code>的<code>提升</code>，然后<code>开始执行</code>代码，执行到var getName= …时，<code>修改</code>了getName的值，<code>赋值成了打印4的新函数</code>。</p><ol><li><p>执行Foo函数的静态方法，打印出2。</p></li><li><p>执行getName，当前getName是打印出4的那个函数。</p></li><li><p>执行Foo函数，(<code>函数内没有声明getName</code>)修改了<code>全局变量getName</code>，赋值成了打印1的函数，然后<code>返回this</code>，因为是在全局环境下执行，所以this指向<code>window</code>，因为<code>getName已经被修改</code>了，所以打印出1。</p></li><li><p>因为getName没有被重新赋值，所以再执行仍然打印出1。</p></li><li><p>new操作符是用来调用函数的，所以new Foo.getName()相当于<code>new (Foo.getName)()</code>，所以new的是<code>Foo的静态方法getName</code>，打印出2。</p></li><li><p>因为点运算符（.）的优先级和new是一样高的，所以从左往右执行，相当于(new Foo()).getName()，对Foo使用new调用会返回一个<code>新创建的对象</code>(实例)，然后执行该对象的getName方法，该对象本身并<code>没有该方法</code>，所以会从<code>Foo的原型对象</code>上查找，找到了，所以打印出3。</p></li><li><p>和上题一样，点运算符<code>（.）的优先级和new一样高</code>，另外new是用来<code>调用函数</code>的，所以new new Foo().getName()相当于<code>new ((new Foo()).getName)()</code>，括号里面的就是上一题，所以最后找到的是<code>Foo原型上的方法</code>，无论是直接调用，还是通过new调用，都会执行该方法，所以打印出3。</p></li></ol><h1 id="第13题"><a href="#第13题" class="headerlink" title="第13题"></a>第13题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">i</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> a<span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// true</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span>join <span class="token operator">=</span> a<span class="token punctuation">.</span>shift<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：true</p><p><code>解析</code>：</p><ol><li>两个类型不同时进行==比较时，会将<code>一个类型转为另一个类型</code>，然后再进行比较。比如Object类型与Number类型进行比较时，Object类型会转换为Number类型。 Object转换为Number时，会尝试调用<code>Object.valueOf()</code>和<code>Object.toString()</code>来获取对应的数字基本类型。</li><li>数组调用toString()会<code>隐含调用Array.join()</code>方法 而数组shift方法的用法：shift() 方法用于把数组的第一个元素从其中删除，并返回第一个元素的值。如果数组是空的，那么 shift() 方法将不进行任何操作，返回 undefined 值。请注意，该方法不创建新数组，而是直接修改原有的 数组。 所以我们可以看到 a == 1时会调用toString(),toString()调用join()，join()等于shift，则转换为Number类型后为1.</li></ol><h1 id="第14题"><a href="#第14题" class="headerlink" title="第14题"></a>第14题</h1><blockquote><p><a href="https://blog.guozy.online/posts/6271.html">0.1 + 0.2 != 0.3</a></p></blockquote><h1 id="第15题"><a href="#第15题" class="headerlink" title="第15题"></a>第15题</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function-variable function">y</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">2</span>  <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>答案</code>：undefined、3、2、1</p><p><code>解析</code>：</p><ul><li>函数<code>参数也是一个单独的作用域</code>，所以相当于<code>参数作用域</code>定义了一个x , y (并且<code>参数作用域</code>是在函数执行产生的作用域<code>之上</code>)</li><li>第一个x访问<code>参数作用域</code>的x,undefined</li><li>var x = 2 ,在函数作用域定义了一个x</li><li>执行y()函数，访问的<code>默认值是参数作用域的x</code>，它被修改成了3，打印的也是3</li><li>f函数内部访问x,访问的<code>最近作用域</code>，也就是内层函数作用域，访问到的一定是2</li></ul><p><a href="https://juejin.cn/post/7030425359392882695">看似简单的题，席卷几十个前端群，王红元老师都亲自出面解答</a></p>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 知其所以然 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>清除浮动 + BFC</title>
      <link href="/posts/d37c.html"/>
      <url>/posts/d37c.html</url>
      
        <content type="html"><![CDATA[<h1 id="浮动"><a href="#浮动" class="headerlink" title="浮动"></a>浮动</h1><h2 id="1-场景"><a href="#1-场景" class="headerlink" title="1.场景"></a>1.场景</h2><p>我们想实现如下效果，肯定会想到<code>float</code>或者<code>flex</code>,flex先不做讨论</p><p><img src="https://bu.dusays.com/2023/06/24/6496ff28618b0.png" alt="你想象的浮动"></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"right"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">.</span>box <span class="token punctuation">&#123;</span>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid black<span class="token punctuation">;</span>  <span class="token literal-property property">padding</span><span class="token operator">:</span> 5px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 450px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span>  <span class="token literal-property property">float</span><span class="token operator">:</span> left<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span>  <span class="token literal-property property">float</span><span class="token operator">:</span> right<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496ff2953f0a.png" alt="实际上的浮动"></p><h2 id="2-寻找原因"><a href="#2-寻找原因" class="headerlink" title="2.寻找原因"></a>2.寻找原因</h2><p>原因是，浮动的元素会<code>脱离文档流</code>,父元素就无法管到他，布局也会往前推进，就会出现<code>父元素高度坍塌</code>的现象</p><h1 id="这时候就需要清除浮动"><a href="#这时候就需要清除浮动" class="headerlink" title="这时候就需要清除浮动"></a>这时候就需要<code>清除浮动</code></h1><h2 id="1-将父级也设置成浮动"><a href="#1-将父级也设置成浮动" class="headerlink" title="1. 将父级也设置成浮动"></a>1. <code>将父级也设置成浮动</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">&#123;</span>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">000</span><span class="token punctuation">;</span>  <span class="token literal-property property">padding</span><span class="token operator">:</span> 5px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 450px<span class="token punctuation">;</span>  <span class="token literal-property property">float</span><span class="token operator">:</span> left<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>缺点</code>： 这种方法肯定是<code>弊大于利</code>，想想父级设置成浮动了，爷爷级又管不到父级了，又得解决爷爷级的高度坍塌，这不是无限套娃？</p><h2 id="2-给父级增加定位absolute"><a href="#2-给父级增加定位absolute" class="headerlink" title="2.给父级增加定位absolute"></a>2.<code>给父级增加定位absolute</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">&#123;</span>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">000</span><span class="token punctuation">;</span>  <span class="token literal-property property">padding</span><span class="token operator">:</span> 5px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 450px<span class="token punctuation">;</span>  <span class="token literal-property property">position</span><span class="token operator">:</span> absolute<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>缺点</code>: <code>position:absolute</code>也会<code>脱离文档流</code>，影响了整体布局</p><h2 id="3-给父级设置-overflow-hidden"><a href="#3-给父级设置-overflow-hidden" class="headerlink" title="3.给父级设置 overflow:hidden"></a>3.给父级设置 <code>overflow:hidden</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token punctuation">&#123;</span>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #<span class="token number">000</span><span class="token punctuation">;</span>  <span class="token literal-property property">padding</span><span class="token operator">:</span> 5px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 450px<span class="token punctuation">;</span>  <span class="token literal-property property">overflow</span><span class="token operator">:</span>hidden<span class="token punctuation">;</span>  letter<span class="token operator">-</span>spacing<span class="token operator">:</span> 10px<span class="token punctuation">;</span>  <span class="token comment">/* word-break: break-all; */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>缺点</code>：当文本过长,且包含过长英文时，会出现英文文本被隐藏的情况</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"right"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div<span class="token operator">></span>张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三ahdhjfsahdhjfagahdhjfagghadsfghhgafghjafjgfdgasjgfsahdhjfagghadsfghhgafghjafjgfdgasjgfsghadsfghhgafghjafjgfdgasjgfs张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三张三<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496ff2a485e3.png" alt="文字被隐藏"></p><h2 id="4-给父级设置对应的高度"><a href="#4-给父级设置对应的高度" class="headerlink" title="4.给父级设置对应的高度"></a>4.给父级<code>设置对应的高度</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box <span class="token punctuation">&#123;</span>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid black<span class="token punctuation">;</span>  <span class="token literal-property property">padding</span><span class="token operator">:</span> 5px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 450px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>缺点</code>：如果浮动元素是<code>定高</code>的，那还好，如果是不定高的，那这种方式就很不灵活了，有可能今天是100px，明天是200px，后天是300px，那你不是得累死？</p><h2 id="5-末尾增加空元素进行clear"><a href="#5-末尾增加空元素进行clear" class="headerlink" title="5.末尾增加空元素进行clear"></a>5.<code>末尾增加空元素进行clear</code></h2><p>关于<code>clear</code>:</p><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td>left</td><td>在左侧不允许浮动</td></tr><tr><td>right</td><td>在右侧不允许浮动</td></tr><tr><td>both</td><td>在左右两侧均不允许浮动</td></tr><tr><td>none</td><td>默认值。允许浮动元素出现在两侧</td></tr><tr><td>inherit</td><td>规定应该从父元素继承 clear 属性的值</td></tr></tbody></table><p>所以这里<code>bottomDiv</code>设置成<code>clear:both</code>，代表了它<code>左右都不能有浮动元素</code>，这迫使了他往下移动，进而撑开了父级盒子的高度。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"right"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"bottomDiv"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">.</span>bottomDiv <span class="token punctuation">&#123;</span>  <span class="token literal-property property">clear</span><span class="token operator">:</span> both<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>缺点</code>：增加了一个<code>div</code>标签，增加了页面的<code>渲染负担</code></p><h2 id="6-给父级添加微元素进行clear"><a href="#6-给父级添加微元素进行clear" class="headerlink" title="6.给父级添加微元素进行clear"></a>6.给<code>父级添加微元素进行clear</code></h2><p>这种方法就是用<code>伪元素</code>代替了上面的div标签，大家都知道，<code>伪元素是不会被渲染出来的</code>，所以也很好的弥补了上一种方法的缺点。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box<span class="token operator">:</span><span class="token operator">:</span>after <span class="token punctuation">&#123;</span>  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token literal-property property">display</span><span class="token operator">:</span> block<span class="token punctuation">;</span>  <span class="token literal-property property">clear</span><span class="token operator">:</span> both<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h1><h2 id="1-官网解释"><a href="#1-官网解释" class="headerlink" title="1.官网解释"></a>1.官网解释</h2><p><code>块格式化上下文</code>（Block Formatting Context,BFC）是web页面可视化css渲染的一部分，是块盒子的布局过程发生的区域，也是浮动元素与其他元素交互的区域。浏览器对<code>BFC的</code>限制规则是：</p><ol><li>生成BFC元素的子元素会一个接一个的放置</li><li>垂直方向上他们的起点是一个包含块的顶部，两个相邻元素之间的垂直距离取决于元素的margin特性。在BFC中相邻的<code>块级元素的外边距会折叠</code>（Mastering margin collapsing）</li><li>生成BFC元素的子元素中，每一个子元素左外边距与包含块的左边界相接触（对于从右到左的格式化，右外边距接触右边界），即使浮动元素也是如此（尽管子元素的内容区域会由于浮动而压缩），除非这个子元素也创建了一个新的BFC(如它自身也是一个浮动元素)</li></ol><h2 id="2-触发条件"><a href="#2-触发条件" class="headerlink" title="2.触发条件"></a>2.触发条件</h2><ul><li>根元素，即<code>HTML</code>标签</li><li>浮动元素：<code>float</code>值为<code>left、right</code></li><li><code>overflow</code>值不为visible,为<code>auto、scroll、hidden</code></li><li><code>display</code>值为<code>inline-block、table-cell、table-caption、table、inline-table、flex、inline-flex、--grid、inline-grid</code></li><li>定位元素：<code>position</code>值为<code>absolute、fixed</code></li></ul><h2 id="3-个人理解"><a href="#3-个人理解" class="headerlink" title="3.个人理解"></a>3.个人理解</h2><ol><li>内部的Box会在垂直方向上一个接一个的放置</li><li>内部的Box垂直方向上的距离由margin决定（属于同一个BFC的两个相邻Box的margin会发生折叠，不同BFC不会发生折叠）</li><li>每个元素的左外边距与包含块的左边界相接触（从左向右），即使浮动元素也是如此（BFC中子元素不会超出他的包含块，而position为absolute的元素可以超出他的包含块边界）</li><li>BFC的区域不会与float的元素区域重叠</li><li>计算BFC的高度时，浮动子元素也参与计算</li></ol><p>第<code>1</code>点和第<code>3</code>点就不用说了，大家都懂，下面就来着重说说第<code>2，4，5</code>点吧！</p><h2 id="解决margin重叠问题"><a href="#解决margin重叠问题" class="headerlink" title="解决margin重叠问题"></a><code>解决margin重叠问题</code></h2><p>假如我想要两个盒子间距20px,我这么写</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box2"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box3"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">.</span>box2 <span class="token punctuation">&#123;</span>  margin<span class="token operator">-</span>bottom<span class="token operator">:</span> 10px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>box3 <span class="token punctuation">&#123;</span>  margin<span class="token operator">-</span>top<span class="token operator">:</span> 10px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果发现，并没有达到预期，两个盒子的margin重叠了：</p><p><img src="https://bu.dusays.com/2023/06/24/6496ff2cb8561.png" alt="margin重叠"></p><p>怎么解决呢？根据个人理解里的<code>第2点</code>可知：<code>两个不同BFC环境的盒子</code>，他们两的<code>margin才不会重叠</code>，那么我们只需触发<code>box3的BFC</code>就行</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box3 <span class="token punctuation">&#123;</span>  margin<span class="token operator">-</span>bottom<span class="token operator">:</span> 10px<span class="token punctuation">;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  background<span class="token operator">-</span>color<span class="token operator">:</span> red<span class="token punctuation">;</span>  <span class="token literal-property property">float</span><span class="token operator">:</span> left<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就实现了两个盒子中键间隔20px了</p><p><img src="https://bu.dusays.com/2023/06/24/6496ff2b2994f.png" alt="触发box3的BFC"></p><h2 id="浮动元素与BFC盒子不重叠"><a href="#浮动元素与BFC盒子不重叠" class="headerlink" title="浮动元素与BFC盒子不重叠"></a><code>浮动元素与BFC盒子不重叠</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box2 w"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"box3 w"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">.</span>w <span class="token punctuation">&#123;</span>  <span class="token literal-property property">width</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span>  <span class="token literal-property property">height</span><span class="token operator">:</span> 100px<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>box2 <span class="token punctuation">&#123;</span>  <span class="token literal-property property">float</span><span class="token operator">:</span> left<span class="token punctuation">;</span> <span class="token comment">// 触发BFC</span>  <span class="token literal-property property">background</span><span class="token operator">:</span> red<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>box3 <span class="token punctuation">&#123;</span>  <span class="token literal-property property">background</span><span class="token operator">:</span> green<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果是，因为红色盒子浮动脱离文档流，导致绿色盒子向前推进，导致红色盒子盖住了绿色盒子</p><p><img src="https://bu.dusays.com/2023/06/24/6496ff2bda549.png" alt="box2触发了BFC"></p><p>怎么解决呢？根据个人理解里的<code>第4点</code>可知：<code>float盒子与BFC盒子不重叠</code>，所以我们只需要把绿色盒子<code>设置为BFC盒子</code>就行</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>box3 <span class="token punctuation">&#123;</span>  <span class="token literal-property property">background</span><span class="token operator">:</span> green<span class="token punctuation">;</span>  <span class="token literal-property property">overflow</span><span class="token operator">:</span>hidden <span class="token comment">// 触发BFC</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496ff2d73626.png" alt="box3也触发BFC"></p><h2 id="利用BFC清除浮动"><a href="#利用BFC清除浮动" class="headerlink" title="利用BFC清除浮动"></a><code>利用BFC清除浮动</code></h2><p>根据个人理解里的<code>第5点</code>可知：BFC盒子会把内部的<code>float盒子算进高度中</code>，这也是为什么前面可以通过给父级盒子设置<code>float: left position: absolute overflow: hidden</code>来解决浮动的高度塌陷问题，<code>因为这些做法都使父级盒子变成一个BFC盒子</code>，而BFC盒子会把内部的<code>float盒子算进高度</code>，顺势解决了高度塌陷问题</p>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
            <tag> CSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0.1 + 0.2 != 0.3</title>
      <link href="/posts/6271.html"/>
      <url>/posts/6271.html</url>
      
        <content type="html"><![CDATA[<h1 id="深入分析0-1-0-2-0-3"><a href="#深入分析0-1-0-2-0-3" class="headerlink" title="深入分析0.1 + 0.2 != 0.3"></a>深入分析0.1 + 0.2 != 0.3</h1><p>计算机在存储数字是通过<code>二进制</code>来存储的,呈现的时候是通过<code>十进制</code>来呈现的,所以会有误差</p><p>那<code>为什么</code>计算机的<code>二进制存储会造成误差</code>呢？下面来一步步深究</p><h2 id="十进制转二进制的转换规则"><a href="#十进制转二进制的转换规则" class="headerlink" title="十进制转二进制的转换规则"></a>十进制转二进制的转换规则</h2><h3 id="整数"><a href="#整数" class="headerlink" title="整数"></a><code>整数</code></h3><ul><li>转换规则 <ul><li><code>除二取余，然后倒序排列，高位补零</code></li></ul></li></ul><p><img src="https://bu.dusays.com/2023/06/24/64970020f3d2d.png" alt="整数10进制转2进制"></p><p>可以得出<code>1010001</code>,可以看出有7位，但是计算机内部标识数是定长的，例如<code>8位</code>、<code>16位</code>、<code>32位</code>，所以7位是不够的，需要<code>高位补0</code>，也就是<code>01010001</code>,规范写法<code>(81)10 = (01010001)</code></p><p><img src="https://bu.dusays.com/2023/06/24/64970021b9756.png" alt="不够位数高位补0"></p><h3 id="负整数"><a href="#负整数" class="headerlink" title="负整数"></a><code>负整数</code></h3><ul><li>转换规则<ul><li>把<code>正整数转成二进制</code></li><li>对二进制<code>取反</code></li><li>对取反后的二进制进行<code>加1</code></li></ul></li></ul><p><img src="https://bu.dusays.com/2023/06/24/64970022739a0.png" alt="-81转为二进制"></p><h3 id="小数"><a href="#小数" class="headerlink" title="小数"></a><code>小数</code></h3><ul><li>转换规则<ul><li>对<code>小数点以后得数乘以2</code>，得出结果，取结果的<code>整数部分</code>（不是0就是1）,然后再对结果的<code>小数点以后的数乘以2</code>，得出结果，再取结果整数部分，再然后然后再对结果的小数点以后的数乘以2。。。。以此类推。。直到小数部分为0或者位数已经到达位数。再把这个过程中取的整数按先后顺序排好就行了。</li></ul></li></ul><p><img src="https://bu.dusays.com/2023/06/24/649700232d6ce.png" alt="0.125转为二进制"></p><p><img src="https://bu.dusays.com/2023/06/24/64970023d869b.png" alt="121.6转为二进制"></p><h2 id="0-1-0-2"><a href="#0-1-0-2" class="headerlink" title="0.1 + 0.2"></a>0.1 + 0.2</h2><p>再回到 <code>0.1 + 0.2</code> 这个问题</p><p><img src="https://bu.dusays.com/2023/06/24/64970024b7074.png"></p><p>可以看到，0.1和0.2转为二进制都是<code>无限循环</code>的，超过了最大位数, 所以存储时<code>只能通过近似值取存储他们</code>，那自然的，当0.1 + 0.2 时，<code>近似值转十进制可定也是近似值</code>，所以会有误差。</p><p><img src="https://bu.dusays.com/2023/06/24/6497002569530.png"></p>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 知其所以然 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>原型链</title>
      <link href="/posts/8b9.html"/>
      <url>/posts/8b9.html</url>
      
        <content type="html"><![CDATA[<h1 id="原型链知识点总结"><a href="#原型链知识点总结" class="headerlink" title="原型链知识点总结"></a><code>原型链</code>知识点总结</h1><h2 id="prototype（显式原型）-和-proto-（隐式原型）的关系"><a href="#prototype（显式原型）-和-proto-（隐式原型）的关系" class="headerlink" title="prototype（显式原型） 和 __proto__（隐式原型）的关系"></a><code>prototype</code>（显式原型） 和 <code>__proto__</code>（隐式原型）的关系</h2><h3 id="构造函数的prototype和其实例的-proto-是指向同一个地方的，这个地方就叫做原型对象"><a href="#构造函数的prototype和其实例的-proto-是指向同一个地方的，这个地方就叫做原型对象" class="headerlink" title="构造函数的prototype和其实例的__proto__是指向同一个地方的，这个地方就叫做原型对象"></a><code>构造函数</code>的prototype和其<code>实例</code>的__proto__是指向同一个地方的，这个地方就叫做<code>原型对象</code></h3><p>构造函数就是可以用了来<code>new</code>的函数，箭头函数不可用来做构造函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>age</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">&#125;</span><span class="token comment">// 这是实例</span><span class="token keyword">const</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>构造函数</code>的prototype和其<code>实例</code>的__proto__指向同一地方，验证如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">&#125;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// &#123; sayName: [Function] &#125;</span><span class="token keyword">const</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person1<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// &#123; sayName: [Function] &#125;</span><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'小红'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// &#123; sayName: [Function] &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> person1<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> person2<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97b4d228.png" alt="构造函数的prototype和其实例的__proto__指向同一地方"></p><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a><code>函数</code></h3><p>上面提到了<code>构造函数</code>，说到底也是个函数，平时定义函数，无非有一下几种方式</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">arrowFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实这几种的<code>本质</code>是一样的（只考虑函数的声明），都可以用 <code>new Function</code> 来声明， 所以 <code>Function</code> 也是一个构造函数，上面的写法等同于</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fn1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'console.log(`我是$&#123;name&#125;, 我今年$&#123;age&#125;岁`)'</span><span class="token punctuation">)</span><span class="token keyword">const</span> fn2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'console.log(`我是$&#123;name&#125;, 我今年$&#123;age&#125;岁`)'</span><span class="token punctuation">)</span><span class="token keyword">const</span> arrowFn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'console.log(`我是$&#123;name&#125;, 我今年$&#123;age&#125;岁`)'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造函数的prototype 和其实例的 __proto__是指向同一个地方的，这里的<code>fn1,fn2,arrowFn</code>其实就是<code>Function构造函数的实例</code> ,验证如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">arrowFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, 我今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">岁</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> fn1<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> fn2<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> arrowFn<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97c0bcbf.png" alt="构造函数其实也是Function类的实例"></p><blockquote><p>Person函数也可以看成 <code>const Person = new Function()</code> 这样生成的，所以<code>Person</code>也就是<code>Function构造函数的实例</code>，所以Person就会有<code>__proto__</code>指向<code>Function.prototype</code></p></blockquote><h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a><code>对象</code></h3><p>平常开发中，创建一个对象，通常会有一下几种方式</p><ul><li><code>构造函数创建对象</code>，他创建出来的对象都是此<code>Function构造函数</code>的实例，所以这里先不讨论</li><li><code>字面量创建</code></li><li><code>new Object()</code></li><li><code>Object.create()</code>创建对象，创建出来的是一个空原型的对象，这里先不讨论</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 第一种：构造函数创建对象</span><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">&#125;</span><span class="token keyword">const</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span> <span class="token comment">// Person &#123; name: '张三', age: 10 &#125;</span><span class="token comment">// 第二种：字面量创建对象</span><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// &#123; name: '张三', age: 10 &#125;</span><span class="token comment">// 第三种：new Object创建对象</span><span class="token keyword">const</span> person3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>person3<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三'</span>person3<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person3<span class="token punctuation">)</span> <span class="token comment">// &#123; name: '张三', age: 10 &#125;</span><span class="token comment">// 第四种：Object.create创建对象</span><span class="token keyword">const</span> person4 <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>person4<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三'</span>person4<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person4<span class="token punctuation">)</span> <span class="token comment">// &#123; name: '张三', age: 10 &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>字面量创建对象</code>的<code>本质</code>就是<code>new Object创建对象</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 字面量创建对象</span><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// &#123; name: '张三', age: 10 &#125;</span>本质是<span class="token comment">// new Object创建对象</span><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>person2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三'</span>person2<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// &#123; name: '张三', age: 10 &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们之前说过，<code>构造函数的prototype</code>和其<code>实例的__proto__</code>是指向同一个地方的，这里的person2,person3其实也都是<code>Object构造函数的实例</code>。验证如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> person3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>person3<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'张三'</span>person3<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">10</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> person2<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> person3<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97ce2221.png" alt="对象是Object类的实例"></p><h3 id="Function和Object"><a href="#Function和Object" class="headerlink" title="Function和Object"></a><code>Function和Object</code></h3><p>上面证明</p><ul><li><code>函数</code>是<code>Function构造函数</code>的实例</li><li><code>对象</code>是<code>Object构造函数</code>的实例</li></ul><p>那<code>Function构造函数</code>和<code>Object构造函数</code>他们两个又是谁的实例?</p><ul><li><code>function Object()</code>其实也是个函数，所以他是<code>Function构造函数</code>的实例</li><li><code>function Function()</code>其实也是个函数，所以他也是<code>Function构造函数</code>的实例,没错,他是他自己本身的实例</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> Object<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> Function<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97db074c.png" alt="Object类和Function类也是Function构造函数的实例"></p><h3 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a><code>constructor</code></h3><p>constructor和prototype是成对的，你指向我，我指向你。举个例子，如果你是我老婆，那我肯定是你的老公。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// &#123;constructor: fn&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">===</span> fn<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97e7cf7a.png" alt="constructor和prototype是成对的，你指向我，我指向你"></p><h2 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h2><h3 id="person-prototype-和-Function-prototype"><a href="#person-prototype-和-Function-prototype" class="headerlink" title="person.prototype 和 Function.prototype"></a><code>person.prototype 和 Function.prototype</code></h3><ul><li><code>Person.prototype</code>, 他是构造函数Person的<code>原型对象</code></li><li><code>Function.prototype</code>,他是构造函数Function的<code>原型对象</code></li></ul><p>可知其本质都是<code>对象</code></p><p>所以肯定是通过<code>new Object()</code>来创建的。既然是通过<code>new Object()</code>创建的，那就说明Person.prototype和Function.prototype<code>都是构造函数Object的实例</code> 。 也就说明了<code>Person.prototype</code>和<code>Function.prototype</code>他们两的<code>__proto__</code>都指向<code>Object.prototype</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f97f39c8d.png" alt="原型对象其实都是Object类的实例"></p><h3 id="什么是原型链"><a href="#什么是原型链" class="headerlink" title="什么是原型链?"></a><code>什么是原型链?</code></h3><p><code>__proto__的路径就叫原型链</code></p><p><img src="https://bu.dusays.com/2023/06/24/6496f97fdb382.png" alt="__proto__的查找路径就叫原型链"></p><h3 id="原型链终点"><a href="#原型链终点" class="headerlink" title="原型链终点"></a><code>原型链终点</code></h3><p>上面咱们看到，<code>三条原型链结尾都是Object.prototype</code>，那是不是说明了Object.prototype就是原型链的终点呢？其实不是的，<code>Object.prototype其实也有__proto__</code>，指向<code>null，那才是原型链的终点</code><br>至此，整个原型示意图就画完啦！！！</p><p><img src="https://bu.dusays.com/2023/06/24/6496f980e6e16.png" alt="null是原型链终点"></p><h2 id="原型继承"><a href="#原型继承" class="headerlink" title="原型继承"></a><code>原型继承</code></h2><p>说到原型，就不得不说补充一下<code>原型继承</code>这个知识点了，<code>原型继承</code>就是，<code>实例</code>可以使用<code>构造函数上的prototype</code>中的方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 构造函数</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">&#125;</span><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 往原型对象添加方法</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span> <span class="token comment">// 实例</span><span class="token comment">// 使用构造函数的prototype中的方法</span>person<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 张三</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://bu.dusays.com/2023/06/24/6496f981ac9bc.png" alt="原型继承就是实例可以使用构造函数上的方法"></p><h2 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a><code>instanceof</code></h2><p>使用方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">A</span> instance <span class="token constant">B</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>作用：<code>判断B的prototype是否在A的原型链上</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 构造函数</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">&#125;</span><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">)</span> <span class="token comment">// 实例</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Person <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 知其所以然 </tag>
            
            <tag> 原生JS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数组转为树</title>
      <link href="/posts/5fcd.html"/>
      <url>/posts/5fcd.html</url>
      
        <content type="html"><![CDATA[<h1 id="数组转化为树得常用方法总结"><a href="#数组转化为树得常用方法总结" class="headerlink" title="数组转化为树得常用方法总结"></a><code>数组转化为树</code>得常用方法总结</h1><h2 id="使用递归来遍历"><a href="#使用递归来遍历" class="headerlink" title="使用递归来遍历"></a>使用<code>递归</code>来遍历</h2><p>提供一个<code>genChildren</code>方法，该方法<code>递归</code>去查找子集</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"> <span class="token keyword">const</span> arrayData <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'广东省'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">2</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'广州市'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">3</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'中国'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'天河区'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">4</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'湖南省'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">2</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'俄罗斯'</span><span class="token punctuation">,</span>        <span class="token literal-property property">parent_id</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token keyword">function</span> <span class="token function">genChildren</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>result<span class="token punctuation">,</span>rootId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>parent_id <span class="token operator">===</span> rootId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> newItem <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>item<span class="token punctuation">,</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>            <span class="token function">genChildren</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>newItem<span class="token punctuation">.</span>children<span class="token punctuation">,</span>item<span class="token punctuation">.</span>id<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">arrayToTree</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token function">genChildren</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span>result<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">arrayToTree</span><span class="token punctuation">(</span>arrayData<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>时间复杂度 <code>O(2^n)</code></p></blockquote><h2 id="不用递归，使用map来存储"><a href="#不用递归，使用map来存储" class="headerlink" title="不用递归，使用map来存储"></a>不用递归，使用<code>map</code>来存储</h2><p>先把数据转成<code>Map</code>去存储，之后遍历的同时借助<code>对象的引用</code>，直接从Map找对应的数据做存储</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">arrayToTree2</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> rootId</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> arrMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      arrMap<span class="token punctuation">[</span>item<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span>item<span class="token punctuation">,</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> id <span class="token operator">=</span> item<span class="token punctuation">.</span>id      <span class="token keyword">const</span> pid <span class="token operator">=</span> item<span class="token punctuation">.</span>parent_id      <span class="token keyword">const</span> newItem <span class="token operator">=</span> arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">===</span> rootId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> parent <span class="token operator">=</span> arrMap<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">.</span>children          parent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arrayToTree2'</span><span class="token punctuation">,</span> <span class="token function">arrayToTree2</span><span class="token punctuation">(</span>arrayData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>有两次循环，该实现的时间复杂度为<code>O(2n)</code>，需要一个Map把数据存储起来，空间复杂度<code>O(n)</code></p></blockquote><h2 id="把两次遍历缩减为一次"><a href="#把两次遍历缩减为一次" class="headerlink" title="把两次遍历缩减为一次"></a>把两次遍历缩减为一次</h2><p>主要思路也是先把数据转成<code>Map</code>去存储，之后遍历的同时借助对象的引用，<code>直接从Map找对应的数据做存储</code>。不同点在遍历的时候即做Map存储,有找对应关系。性能会更好。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">arrayToTree3</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span>rootId</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> arrMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> id <span class="token operator">=</span> item<span class="token punctuation">.</span>id        <span class="token keyword">const</span> pid <span class="token operator">=</span> item<span class="token punctuation">.</span>parent_id        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>            <span class="token operator">...</span>item<span class="token punctuation">,</span>            <span class="token literal-property property">children</span><span class="token operator">:</span>arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>                <span class="token keyword">const</span> newItem <span class="token operator">=</span> arrMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">===</span> rootId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>arrMap<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                arrMap<span class="token punctuation">[</span>pid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            arrMap<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arrayToTree3'</span><span class="token punctuation">,</span> <span class="token function">arrayToTree3</span><span class="token punctuation">(</span>arrayData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>一次循环就搞定了，该实现的时间复杂度为<code>O(n)</code>，需要一个Map把数据存储起来，空间复杂度<code>O(n)</code></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>数组去重</title>
      <link href="/posts/bb28.html"/>
      <url>/posts/bb28.html</url>
      
        <content type="html"><![CDATA[<h1 id="数组去重常用方法"><a href="#数组去重常用方法" class="headerlink" title="数组去重常用方法"></a><code>数组去重</code>常用方法</h1><h2 id="1-ES6的new-Set-去重"><a href="#1-ES6的new-Set-去重" class="headerlink" title="1.ES6的new Set()去重"></a>1.<code>ES6的new Set()去重</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">// [1, 2, 3, 4, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>Set无法去重引用类型的数据（对象数组），如果数组中的值都是简单的string或者number,可以使用Set去重</p></blockquote><h2 id="2-使用new-Map-去重"><a href="#2-使用new-Map-去重" class="headerlink" title="2.使用new Map()去重"></a>2.<code>使用new Map()去重</code></h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">unique</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">const</span> arrMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>arrMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            arrMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">unique</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [1, 2, 3, 4, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>如果是数组对象的话也可以在map中存放主键，来达到对象去重</p></blockquote><p>基本的Map()方法<br>| Method | Description |<br>| — | — |<br>| new Map() | 创建新的 Map 对象。 |<br>| set() | 为 Map 对象中的键设置值。 |<br>| get() | 获取 Map 对象中键的值。 |<br>| entries() | 返回 Map 对象中键/值对的数组。 |<br>| keys() | 返回 Map 对象中键的数组。 |<br>| values() | 返回 Map 对象中值的数组。 |<br>| clear() | 删除 Map 中的所有元素。 |<br>| delete() | 删除由键指定的元素。 |<br>| has() | 如果键存在，则返回 true。 |</p><h2 id="3-使用includes去重"><a href="#3-使用includes去重" class="headerlink" title="3.使用includes去重"></a>3.使用<code>includes</code>去重</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">unique</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">unique</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [1, 2, 3, 4, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-最古老的方法，双循环去重"><a href="#4-最古老的方法，双循环去重" class="headerlink" title="4.最古老的方法，双循环去重"></a>4.最古老的方法，<code>双循环</code>去重</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">unique</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                j<span class="token operator">--</span><span class="token punctuation">;</span>                len<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">&#125;</span><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">unique</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [1, 2, 3, 4, 6]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-最有趣的去重方法，filter去重"><a href="#5-最有趣的去重方法，filter去重" class="headerlink" title="5.最有趣的去重方法，filter去重"></a>5.最有趣的去重方法，<code>filter</code>去重</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">unique5</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=></span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">===</span> index<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">unique5</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>快速排序</title>
      <link href="/posts/ae6.html"/>
      <url>/posts/ae6.html</url>
      
        <content type="html"><![CDATA[<h1 id="快速排序（Quick-Sort）"><a href="#快速排序（Quick-Sort）" class="headerlink" title="快速排序（Quick Sort）"></a><code>快速排序（Quick Sort）</code></h1><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2016/11/29/dd9dc195a7331351671fe9ac4f7d5aa4~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="快速排序原理示意图"></p><blockquote><p><code>快速排序(Quick Sort)</code>使用得最广泛，速度也较快，是图灵奖得主C.A.R.Hoare(1934-) 于1960事提出的</p></blockquote><h2 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h2><blockquote><p>快速排序的基本思想：通过一趟排序将待排记录分隔成独立的两部分，其中一部分记录的关键字均比另一部分的关键字小，则可分别对这两部分记录继续进行排序，以达到整个序列有序</p></blockquote><h2 id="算法描述和实现"><a href="#算法描述和实现" class="headerlink" title="算法描述和实现"></a>算法描述和实现</h2><p>快速排序使用分治法来吧一个串（list）分成两个子串（sub-lists）。具体算法描述如下：</p><ul><li>从数列中挑出一个元素，称为”基准“（pivot）</li><li>重新排序数列，所有元素比基准值小的摆放在基准前面，所有元素比基准值大的摆在基准值的后面（相同的数可以到任一边）。在这个分区退出之后，该基准就处于数列的中间位置。这个称为（partition）操作</li><li>递归的（recursive）把小于基准值元素的子数列和大于基准值元素的子数列排序</li></ul><h2 id="js代码实现"><a href="#js代码实现" class="headerlink" title="js代码实现"></a>js代码实现</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> left <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> right <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">var</span> x <span class="token operator">=</span> arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">,</span>                i <span class="token operator">=</span> left <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>                temp            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> left <span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> right <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    i<span class="token operator">++</span>                    temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>                    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>                    arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> left<span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> arr    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">quickSort2</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> arr    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> middleIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 取基准点</span>    <span class="token keyword">const</span> valueArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>middleIndex<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 取基准点的值，splice(index,1) 则返回的是含有被删除的元素的数组</span>    <span class="token keyword">const</span> middleVal <span class="token operator">=</span> valueArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span>middleVal<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            left<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            right<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token function">quickSort2</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>valueArr<span class="token punctuation">,</span><span class="token function">quickSort2</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'quickSort2'</span><span class="token punctuation">,</span><span class="token function">quickSort2</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>归并排序</title>
      <link href="/posts/f8df.html"/>
      <url>/posts/f8df.html</url>
      
        <content type="html"><![CDATA[<h1 id="归并排序（Merge-Sort）"><a href="#归并排序（Merge-Sort）" class="headerlink" title="归并排序（Merge Sort）"></a><code>归并排序（Merge Sort）</code></h1><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2016/11/29/33d105e7e7e9c60221c445f5684ccfb6~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="归并排序原理示意图"></p><blockquote><p>和选择排序一样，归并排序的性能不受输入数据的影响，但表现比选择排序好的多，因为始终都是O(n log n)的时间复杂度。代价是需要额外的内存空间</p></blockquote><h2 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h2><blockquote><p>归并排序是建立在归并操作上的一种有效的排序算法。该算法是采用分治法（Divide and Conquer）的一个非常典型的应用。归并排序是一种稳定的排序方法。将已有序的子序列合并，得到完全有序地序列；即先使每个子序列有序，再使子序列段间有序。若将两个有序表合并成一个有序表，称为2-璐归并</p></blockquote><h2 id="算法描述和实现"><a href="#算法描述和实现" class="headerlink" title="算法描述和实现"></a>算法描述和实现</h2><ul><li>把长度为n的输入序列分成两个长度为n/2的子序列</li><li>对这两个子序列分别采用归并排序</li><li>将两个排序好的子序列合并成一个最终的排序序列</li></ul><h2 id="js代码实现"><a href="#js代码实现" class="headerlink" title="js代码实现"></a>js代码实现</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">mergeSort</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> arr    <span class="token punctuation">&#125;</span>    <span class="token keyword">var</span> middle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>len<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    left <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>middle<span class="token punctuation">)</span><span class="token punctuation">,</span>    right <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>middle<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token function">mergeSort</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">mergeSort</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span>right</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> right<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> right<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result<span class="token punctuation">&#125;</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h2><ul><li>最佳情况：<code>T(n) = O(n)</code></li><li>最差情况：<code>T(n) = O(nlogn)</code></li><li>平均情况：<code>T(n) = O(nlogn)</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>插入排序</title>
      <link href="/posts/1941.html"/>
      <url>/posts/1941.html</url>
      
        <content type="html"><![CDATA[<h1 id="插入排序（Insertion-Sort）"><a href="#插入排序（Insertion-Sort）" class="headerlink" title="插入排序（Insertion Sort）"></a><code>插入排序（Insertion Sort）</code></h1><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2016/11/29/f0e1e3b7f95c3888ab2791b6abbfae41~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="插入排序原理示意图"></p><h2 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h2><p>插入排序（Insertion-Sort）的算法描述是一种简单直观的排序算法。它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到响应位置并插入。插入排序早实现上，通常采用in-place排序（即只需用到O(1)的额外空间的排序），因而在从后向前扫描过程中，<code>需要反复把已排序元素逐步向后挪位</code>，为最新元素提供插入空间。</p><blockquote><p><code>in-place</code> 解决问题过程中，只开辟了常数量的空间，与n无关，这是原址操作，就是In-place。</p></blockquote><blockquote><p><code>out-place</code> 如果开辟的辅助空间与问题规模有关，则是out-place。</p></blockquote><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cucnVub29iLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAxOS8wMy9zb3J0LnBuZw?x-oss-process=image/format,png" alt="排序算法"></p><h2 id="算法描述和实现"><a href="#算法描述和实现" class="headerlink" title="算法描述和实现"></a>算法描述和实现</h2><p>一般来说，插入排序都采用in-place在数组上实现。具体算法描述如下：</p><ul><li>从第一个元素开始，该元素可以认为已经被排序</li><li>取出下一个元素，在已经排序的元素序列中从后向前扫描</li><li>如果该元素（已排序）大于新元素，将该元素移到下一位置</li><li>重复步骤3，直到找到已排序的元素小于或者等于新元素的位置</li><li>将新元素插入到该位置后</li><li>重复步骤2~5</li></ul><h3 id="js代码实现"><a href="#js代码实现" class="headerlink" title="js代码实现"></a>js代码实现</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token keyword">function</span> <span class="token function">insertionSort</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> current <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">></span> current<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            j<span class="token operator">--</span>        <span class="token punctuation">&#125;</span>        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> current    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssl过期更换</title>
      <link href="/posts/5fb7.html"/>
      <url>/posts/5fb7.html</url>
      
        <content type="html"><![CDATA[<h1 id="SSL证书过期更换"><a href="#SSL证书过期更换" class="headerlink" title="SSL证书过期更换"></a>SSL证书过期更换</h1><p>ssl证书过期半年了，一直懒（麻烦）的更换，更换完成觉得</p><blockquote><p>不是因为某件事很难，你才不想做，而是因为你不想做，才让这件事变得很难</p></blockquote><h2 id="1-获取新的SSL证书"><a href="#1-获取新的SSL证书" class="headerlink" title="1.获取新的SSL证书"></a>1.获取新的SSL证书</h2><p><a href="https://cloud.tencent.com/">腾讯云</a>搜索<code>SSL证书</code></p><ul><li><p>过期后需要立即选购</p></li><li><p>已拥有进入<code>产品控制台</code>，点击下载<code>nginx</code>版本证书</p></li></ul><h2 id="2-服务器更新SSL证书"><a href="#2-服务器更新SSL证书" class="headerlink" title="2.服务器更新SSL证书"></a>2.服务器更新SSL证书</h2><ul><li>通过<code>nginx.conf</code>找到ssl证书存放地址</li></ul><p>我的nginx.conf在/101.34.xx.xx/etc/nginx/nginx.conf</p><p><img src="https://bu.dusays.com/2023/06/24/6496f982ae43c.png" alt="nginx.conf"></p><ul><li>进入<code>101.34.xx.xx/etc/ssl</code>把第一步下载的nginx证书替换掉原有的</li></ul><h2 id="3-重启nginx"><a href="#3-重启nginx" class="headerlink" title="3.重启nginx"></a>3.重启nginx</h2><ul><li>登录nginx服务器</li><li>进入<code>usr/sbin/</code></li><li>执行 <code>./nginx -s reload</code></li></ul><blockquote><p>查看nginx端口命令<code>ps -ef | grep nginx</code></p></blockquote><blockquote><p><a href="https://cloud.tencent.com/document/product/400/35244">Nginx 服务器 SSL 证书安装部署</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 生活多美好 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 服务器 </tag>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>选择排序</title>
      <link href="/posts/c803.html"/>
      <url>/posts/c803.html</url>
      
        <content type="html"><![CDATA[<h1 id="选择排序（Selection-Sort）"><a href="#选择排序（Selection-Sort）" class="headerlink" title="选择排序（Selection Sort）"></a><code>选择排序（Selection Sort）</code></h1><blockquote><p>表现最稳定的排序算法之一，因为无论什么数据进去都是O(n²)的时间复杂度，所以用到它的时候，数据规模越小越好。唯一好就是不占用额外的内存空间。</p></blockquote><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2016/11/29/138a44298f3693e3fdd1722235e72f0f~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="选择排序原理示意图"></p><h2 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h2><p>选择排序（Selection-Sort）是一种简单直观的排序算法。他的工作原理：首先在未排序序列中找到最小（大）元素，存放到排序序列的起始位置，然后再从剩余未排序元素中继续寻找最小（大）元素，然后放到以排序序列的末尾。以此类推，直到所有元素均排序完毕</p><h2 id="算法描述和实现"><a href="#算法描述和实现" class="headerlink" title="算法描述和实现"></a>算法描述和实现</h2><h3 id="具体算法描述"><a href="#具体算法描述" class="headerlink" title="具体算法描述"></a>具体算法描述</h3><p>n个记录的直接选择排序可经过n-1趟直接选择排序得到有序结果。具体算法描述如下：</p><ul><li>初始状态：无序区为R[1..n]，有序区为空；</li><li>第i趟排序(i=1,2,3…n-1)开始时，当前有序区和无序区分别为R[1..i-1]和R(i..n）。该趟排序从当前无序区中-选出关键字最小的记录 R[k]，将它与无序区的第1个记录R交换，使R[1..i]和R[i+1..n)分别变为记录个数增加1个的新有序区和记录个数减少1个的新无序区；</li><li>n-1趟结束，数组有序化了。</li></ul><h3 id="js代码实现"><a href="#js代码实现" class="headerlink" title="js代码实现"></a>js代码实现</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">selectionSort</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> minIndex<span class="token punctuation">,</span> temp    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 不用比较最后一个</span>        minIndex <span class="token operator">=</span> i <span class="token comment">// 默认为当前值</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 每次从下一个数开始循环</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 寻找最小数</span>                minIndex <span class="token operator">=</span> j <span class="token comment">// 将最小数的索引保存</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    <span class="token comment">// 保存当前项</span>        arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token comment">// 当前项替换为最小值</span>        arr<span class="token punctuation">[</span>minIndex<span class="token punctuation">]</span> <span class="token operator">=</span> temp <span class="token comment">// 最小索引替换为当前项</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">&#125;</span><span class="token comment">// var arr = [3,44,38,5,47,15,36,26,27,2,46,4,19,50,48]</span><span class="token comment">//  var arr = [3,1,2,4,5]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">selectionSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[2, 3, 4, 5, 15, 19, 26, 27, 36, 38, 44, 46, 47, 48, 50]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>冒泡排序</title>
      <link href="/posts/52f6.html"/>
      <url>/posts/52f6.html</url>
      
        <content type="html"><![CDATA[<h1 id="冒泡排序-Bubble-Sort"><a href="#冒泡排序-Bubble-Sort" class="headerlink" title="冒泡排序(Bubble Sort)"></a><code>冒泡排序(Bubble Sort)</code></h1><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2016/11/30/f427727489dff5fcb0debdd69b478ecf~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="冒泡原理示意图"><br><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/1/173091f3c487e684~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp"></p><h2 id="算法描述"><a href="#算法描述" class="headerlink" title="算法描述"></a>算法描述</h2><p>冒泡排序是一种简单的排序算法。它重复的走访过要排序的数列，一次比较两个元素，如果它们顺序错我就把它们交换过来。走访数列的工作是重复的进行直到没有再需要交换。也就是说该数列已经排序完成。<code>这个算法的名字由来是因为越小的元素会经由交换慢慢“浮”到数列的顶端</code></p><h2 id="算法描述和实现"><a href="#算法描述和实现" class="headerlink" title="算法描述和实现"></a>算法描述和实现</h2><h3 id="具体算法描述"><a href="#具体算法描述" class="headerlink" title="具体算法描述"></a>具体算法描述</h3><ul><li>比较相邻的元素，如果第一个比第二个大，就交换他们两个</li><li>对每一对相邻元素做同样的工作，从开始第一对到结尾的最后一对，这样在最后的元素应该会是最大的数</li><li>针对所有的元素重复以上的步骤，除了最后一个</li><li>重复以上步骤，直到排序完成</li></ul><h3 id="js代码实现"><a href="#js代码实现" class="headerlink" title="js代码实现"></a>js代码实现</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token keyword">function</span> <span class="token function">bubbleSort</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 外层循环控制比较轮数</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 里层循环控制每一轮比较的次数， arr[i] 只用跟其余的len - i个元素比较</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> prev <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            <span class="token keyword">let</span> next <span class="token operator">=</span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>            <span class="token comment">// 前一个大于后一个，两者交换位置</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>prev <span class="token operator">></span> next<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> next                arr<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> prev            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> arr<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 时刻准备着 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见请求头以及作用</title>
      <link href="/posts/31861.html"/>
      <url>/posts/31861.html</url>
      
        <content type="html"><![CDATA[<h1 id="requestHeader"><a href="#requestHeader" class="headerlink" title="requestHeader"></a>requestHeader</h1><blockquote><p>请求头中的常见属性说明以及作用</p></blockquote><h2 id="实现功能"><a href="#实现功能" class="headerlink" title="实现功能"></a>实现功能</h2><ul><li><input checked="" disabled="" type="checkbox"> <code>Accept-Language</code> 实现<strong>多语言</strong> </li><li><input checked="" disabled="" type="checkbox"> <code>Referer</code> 实现<strong>防盗链</strong></li><li><input checked="" disabled="" type="checkbox"> <code>Range</code> 实现文件<strong>断点续传</strong>（206）</li><li><input checked="" disabled="" type="checkbox"> <code>Cache-Control &amp; Last-Modified &amp; ETag</code> 实现<strong>缓存</strong></li><li><input checked="" disabled="" type="checkbox"> <code>Accept-Encoding</code> 实现<strong>文件压缩</strong></li><li><input checked="" disabled="" type="checkbox"> <code>Cookie</code>  cookie使用已经<code>封装setCookie</code></li><li><input checked="" disabled="" type="checkbox"> <code>session</code> 基于cookie实现<code>session使用</code></li><li><input checked="" disabled="" type="checkbox"> <code>JWT</code> jwt使用</li></ul><h2 id="启动这个项目"><a href="#启动这个项目" class="headerlink" title="启动这个项目"></a>启动这个项目</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/guozhiyuan16/share.git<span class="token comment">## 安装依赖</span><span class="token builtin class-name">cd</span> share<span class="token function">yarn</span> <span class="token function">install</span><span class="token comment">## 推荐使用nodemon启动服务</span><span class="token function">yarn</span> global <span class="token function">add</span> nodemonnodemon app.js<span class="token comment">## 默认打开localhost:3000/index.html 即可看到演示项目</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="目录结构说明"><a href="#目录结构说明" class="headerlink" title="目录结构说明"></a>目录结构说明</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">.</span>│└─share                 <span class="token comment">// 后端文件夹</span>    ├─config            <span class="token comment">// 项目配置 port、token-secret 等等</span>    ├─controllers       <span class="token comment">// 业务控制层</span>    ├─download          <span class="token comment">// 下载文件地址</span>    ├─middlewares       <span class="token comment">// 中间件</span>    ├─page              <span class="token comment">// 静态文件</span>    ├─router            <span class="token comment">// 路由</span>    ├─utils             <span class="token comment">// 工具包</span>    └─  app<span class="token punctuation">.</span>js          <span class="token comment">// 后端主入口文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="多语言"><a href="#多语言" class="headerlink" title="多语言"></a><code>多语言</code></h2><blockquote><p>多语言就是一个网站可以实现多种语言的切换，这里不讨论建N个网站，一个语言对应一个网站。这里讨论如何智能返回用户所需的语言。</p></blockquote><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>向server扔过去了<code>Accept-Language</code></td><td></td></tr><tr><td></td><td>接收对方的<code>Accept-Language</code></td></tr><tr><td></td><td>字段大概这样子<code>zh,en-US;q=0.9,en;q=0.8 </code>（q没有传值<code>默认为1</code>）</td></tr><tr><td></td><td>开始处理，将字段变成带权重<code>q</code>的数组</td></tr><tr><td></td><td>排序好大概长这样[{“name”:”zh”,”q”:1},{“name”:”en-US”,”q”:0.9},{“name”:”en”,”q”:0.8}]</td></tr><tr><td></td><td><code>根据权重</code>返回拥有的语言</td></tr><tr><td></td><td>没有匹配到返回<code>默认</code>的语言</td></tr><tr><td>渲染不同的语言页面</td><td>http请求完成</td></tr></tbody></table><h2 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a><code>防盗链</code></h2><blockquote><p>这个技术用的最多的应该就是对于图片的限制，只有在<code>白名单中的域名可以获取到</code>，其他域名返回一个提示图片。（减轻自己服务器压力）<br>ps : 微博图片有防盗链</p></blockquote><h3 id="如何本地模拟防盗链效果？"><a href="#如何本地模拟防盗链效果？" class="headerlink" title="如何本地模拟防盗链效果？"></a>如何本地模拟防盗链效果？</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## 打开微博，随意找到一张图片 </span>https://wx2.sinaimg.cn/large/0024cZx9ly8grtevkbgodj60f408in3t02.jpg<span class="token comment">## 新建index.html，引入图片</span><span class="token operator">&lt;</span>img <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">"https://wx2.sinaimg.cn/large/0024cZx9ly8grtevkbgodj60f408in3t02.jpg"</span> /<span class="token operator">></span><span class="token comment">## 用户http-server 或者 vscode内置的插件启动服务</span>打开启动静态服务的页面，发现图片无法展示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>html中请求一张图片</td><td></td></tr><tr><td></td><td>接收对方的<code>Referer</code>(<code>浏览器的地址栏地址</code>)</td></tr><tr><td></td><td>获取 <code>host</code>(图片请求的地址)</td></tr><tr><td></td><td>如果<code>域名相同</code>或者在<code>白名单</code>内</td></tr><tr><td></td><td>返回图片</td></tr><tr><td></td><td>返回一张万能图</td></tr><tr><td>渲染不同的图片</td><td>http请求完成</td></tr></tbody></table><h2 id="206"><a href="#206" class="headerlink" title="206"></a><code>206</code></h2><blockquote><p>支持获取页面的某一部分<br>ps:百度的网站支持206</p></blockquote><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>发起请求</td><td></td></tr><tr><td></td><td>接收对方的<code>Range</code>(<code>bytes=$&#123;start&#125;-$&#123;end&#125;</code>)</td></tr><tr><td></td><td>正则<code>匹配到开始和结束</code>位置</td></tr><tr><td></td><td>读取静态文件<code>获取文件大小</code></td></tr><tr><td></td><td>设置状态码<code>206</code></td></tr><tr><td></td><td>设置响应 <code>Content-Range</code>:<code>bytes $&#123;start&#125;-$&#123;end&#125;/$&#123;statObj.size&#125;</code></td></tr><tr><td></td><td>设置响应 <code>Content-Length</code>:<code>end-start+1</code></td></tr><tr><td></td><td>http请求完成</td></tr></tbody></table><blockquote><p><a href="https://juejin.cn/post/6844903668458717192">如何手写一款KOA的中间件来实现断点续传</a></p></blockquote><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a><code>缓存</code></h2><blockquote><p>优势</p></blockquote><ul><li>减少了冗余的数据传输，节省了网费。</li><li>减少了服务器的负担， 大大提高了网站的性能</li><li>加快了客户端加载网页的速度</li></ul><h3 id="缓存分类"><a href="#缓存分类" class="headerlink" title="缓存分类"></a>缓存分类</h3><ul><li><p><code>强制缓存如果生效，不需要再和服务器发生交互</code>，而对比缓存<code>不管是否生效，都需要与服务端发生交互</code></p></li><li><p>两类缓存规则可以同时存在，强制缓存优先级高于对比缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则</p></li></ul><h4 id="A-强制缓存"><a href="#A-强制缓存" class="headerlink" title="A.强制缓存"></a>A.强制缓存</h4><ul><li>强制缓存，在缓存数据未失效的情况下，可以直接使用缓存数据，那么浏览器是如何判断缓存数据是否失效呢？ 我们知道，在没有缓存数据的时候，浏览器向服务器请求数据时，服务器会将数据和缓存规则一并返回，缓存规则信息包含在响应header中。</li><li>Cache-Control 配置<ul><li>private 客户端可以缓存</li><li>public 客户端和代理服务器都可以缓存</li><li>max-age=60 缓存内容将在60秒后失效</li><li>no-cache 需要使用对比缓存验证数据,强制向源服务器再次验证</li><li>no-store 所有内容都不会缓存，强制缓存和对比缓存都不会触发</li></ul></li></ul><p><img src="https://bu.dusays.com/2023/06/24/6496f978745da.png" alt="强制缓存"></p><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>发起请求</td><td></td></tr><tr><td></td><td>收到请求</td></tr><tr><td></td><td>响应设置<code>Cache-Control:max-age=10</code></td></tr><tr><td></td><td>10秒内不要找我</td></tr><tr><td>发起请求，超出<code>过期时间</code>重新请求，否则直接拿缓存</td><td></td></tr></tbody></table><h4 id="B-对比缓存"><a href="#B-对比缓存" class="headerlink" title="B.对比缓存"></a>B.对比缓存</h4><blockquote><p>ps: 服务端返回304状态码浏览器就会去缓存中取对应缓存文件<br>ps: 两种是可以同时存在的</p></blockquote><ul><li>对比缓存，顾名思义，需要进行比较判断是否可以使用缓存。</li><li>浏览器第一次请求数据时，服务器会将缓存标识与数据一起返回给客户端，客户端将二者<code>备份至缓存数据库中</code>。</li><li>再次请求数据时，客户端将备份的<code>缓存标识</code>发送给服务器，服务器根据缓存标识进行判断，判断成功后，<code>返回304状态码</code>，通知客户端比较成功，可以<code>使用缓存数据</code>。</li></ul><p><img src="https://bu.dusays.com/2023/06/24/6496f97961a75.png" alt="对比缓存"></p><h5 id="Last-Modify-amp-If-Modified-Since"><a href="#Last-Modify-amp-If-Modified-Since" class="headerlink" title="Last-Modify &amp; If-Modified-Since"></a>Last-Modify &amp; If-Modified-Since</h5><ul><li>Last-Modified：响应时告诉客户端此资源的<code>最后修改时间</code></li><li><code>If-Modified-Since</code>：当资源过期时（使用Cache-Control标识的max-age），发现资源具有Last-Modified声明，则再次向服务器请求时带上头If-Modified-Since。</li><li>服务器收到请求后发现有头If-Modified-Since则与被请求资源的最后修改时间进行比对。若最后修改时间较新，说明资源又被改动过，则<code>响应最新的资源</code>内容并返回200状态码；</li><li>若最后修改时间和If-Modified-Since一样，说明资源没有修改，则响应304表示<code>未更新</code>，告知浏览器继续使用所保存的缓存文件。</li></ul><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>发起请求</td><td></td></tr><tr><td></td><td>响应中设置 <code>Last-Modify</code></td></tr><tr><td>浏览器接收<code>Last-Modify</code></td><td></td></tr><tr><td>下次请求</td><td></td></tr><tr><td>请求头中添加<code>If-Modified-Since</code></td><td></td></tr><tr><td></td><td>后端接收<code>If-Modified-Since</code></td></tr><tr><td></td><td><code>文件修改时间</code> 与 <code>If-Modified-Since</code>比较</td></tr><tr><td></td><td>相等返回<code>304</code>不相等返回最新文件</td></tr></tbody></table><h6 id="最后修改时间存在问题"><a href="#最后修改时间存在问题" class="headerlink" title="最后修改时间存在问题"></a>最后修改时间存在问题</h6><ul><li>某些服务器不能精确得到文件的最后修改时间， 这样就无法通过最后修改时间来判断文件是否更新了。</li><li>某些文件的修改非常频繁，在秒以下的时间内进行修改. Last-Modified只能精确到秒。</li><li>一些文件的最后修改时间改变了，但是内容并未改变。 我们不希望客户端认为这个文件修改了。</li><li>如果同样的一个文件位于多个CDN服务器上的时候内容虽然一样，修改时间不一样。</li></ul><h5 id="ETag-amp-If-None-Match"><a href="#ETag-amp-If-None-Match" class="headerlink" title="ETag &amp; If-None-Match"></a>ETag &amp; If-None-Match</h5><blockquote><p>ETag是实体标签的缩写，根据实体内容生成的一段hash字符串,可以标识资源的状态。当资源发生改变时，ETag也随之发生变化。 ETag是Web服务端产生的，然后发给浏览器客户端。</p></blockquote><ul><li>客户端想判断缓存是否可用可以先获取缓存中文档的ETag，然后通过If-None-Match发送请求给Web服务器询问此缓存是否可用。</li><li>服务器收到请求，将服务器的中此文件的ETag,跟请求头中的If-None-Match相比较,如果值是一样的,说明缓存还是最新的,Web服务器将发送304 Not Modified响应码给客户端表示缓存未修改过，可以使用。</li><li>如果不一样则Web服务器将发送该文档的最新版本给浏览器客户端</li></ul><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>发起请求</td><td></td></tr><tr><td></td><td>响应中设置 <code>E-Tag</code></td></tr><tr><td>浏览器接收<code>E-Tag</code></td><td></td></tr><tr><td>下次请求</td><td></td></tr><tr><td>请求头中添加<code>If-None-Match</code></td><td></td></tr><tr><td></td><td>后端接收<code>If-Modified-Since</code></td></tr><tr><td></td><td><code>文件签名</code> 与 <code>E-Tag</code>比较</td></tr><tr><td></td><td>相等返回<code>304</code>不相等返回最新文件</td></tr></tbody></table><blockquote><p><a href="https://juejin.cn/post/6844904018012012552">你知道 http 响应头中的 ETag 是如何生成的吗</a></p></blockquote><h3 id="crypto加密模块"><a href="#crypto加密模块" class="headerlink" title="crypto加密模块"></a>crypto加密模块</h3><ul><li>摘要算法 （md5）<ul><li><code>不能反解</code>（网上的md5解码其实就是<code>撞库</code>）</li><li><code>摘要</code> 不能根据摘要的结果 反推摘要的过程 如果内容有一点变化，摘要的结果完全不同</li><li><code>相同值摘要的结果相同</code></li></ul></li><li>加盐算法 （sha1/sha256）<ul><li>如果内容是一致的，但是<code>加的盐不同结果也不同</code></li></ul></li></ul><h3 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h3><ul><li>第一次请求</li></ul><p><img src="https://bu.dusays.com/2023/06/24/6496f97a54d06.png" alt="第一次请求"></p><ul><li>第二次请求</li></ul><p><img src="https://bu.dusays.com/2023/06/24/6496f983d1575.png" alt="第二次请求"></p><blockquote><p><a href="https://juejin.cn/post/6844903662934818824">HTTP 缓存的那些事儿</a></p></blockquote><h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><table><thead><tr><th>client</th><th>server</th></tr></thead><tbody><tr><td>html中请求一张图片</td><td></td></tr><tr><td></td><td>接收对方的<code>Accept-Encoding</code>(<code>gzip, deflate, br</code>)</td></tr><tr><td></td><td>根据顺序判断支不支持这些压缩方式</td></tr><tr><td></td><td>如果有配置就返回压缩后的文件</td></tr><tr><td>渲染不同的图片</td><td>http请求完成</td></tr></tbody></table><h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># host</span><span class="token number">127.0</span>.0.1a.test.com<span class="token number">127.0</span>.0.1b.test.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>HTTP1.0中协议是<code>无状态</code>的，但在WEB应用中，在多个请求之间共享会话是非常必要的，所以出现了Cookie</li><li>cookie是为了<code>辩别用户身份</code>，进行会话跟踪而<code>存储在客户端</code>上的数据</li></ul><h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ul><li>服务器发送cookie </li></ul><p>客户端第一次访问服务器的时候服务器通过响应头向客户端发送Cookie,属性之间用分号空格分隔</p><pre class="line-numbers language-none"><code class="language-none">Set-Cookie:name&#x3D;xxx; Path&#x3D;&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>客户端接收保存cookie</li></ul><p>客户端接收到Cookie之后保存在本地</p><ul><li>客户端发送cookie</li></ul><p>以后客户端再请求服务器的时候会把此Cookie发送到服务器端</p><pre class="line-numbers language-none"><code class="language-none">Cookie:name&#x3D;zfpx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="cookie重要属性"><a href="#cookie重要属性" class="headerlink" title="cookie重要属性"></a>cookie重要属性</h3><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>name=value</code></td><td>键值对，可以<code>设置要保存的 Key/Value</code></td></tr><tr><td><code>Domain</code></td><td>域名，<code>默认是当前域名</code>(cookie<code>能跨域获取</code>)</td></tr><tr><td><code>maxAge</code></td><td>最大失效时间(毫秒),设置在多少后失效</td></tr><tr><td>Expires</td><td>过期时间(秒)，在设置的某个时间点后该 Cookie 就会失效，如 expires=Money, 05-Dec-11 11:11:11 GMT</td></tr><tr><td>secure</td><td>当 secure 值为 true 时，cookie 在 HTTP 中是无效，在 HTTPS 中才有效</td></tr><tr><td><code>Path</code></td><td>表示 cookie 影响到的路径，如 path=/。如果<code>路径不能匹配时，浏览器则不发送这个Cookie</code></td></tr><tr><td><code>httpOnly</code></td><td>如果在COOKIE中设置了httpOnly属性，则通过程序<code>(JS脚本)将无法读取到COOKIE</code>信息，防止XSS攻击产生</td></tr></tbody></table><h3 id="cookie-注意事项"><a href="#cookie-注意事项" class="headerlink" title="cookie 注意事项"></a>cookie 注意事项</h3><ul><li>可能被客户端篡改，<code>使用前验证合法性</code></li><li><code>不要存储敏感数据</code>，比如用户密码，账户余额</li><li><code>使用httpOnly</code>保证安全</li><li>每次<code>请求都会携带cookie</code>,尽量<code>减少cookie的体积</code></li><li><code>设置正确的domain和path</code>，减少数据传输</li></ul><h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><ul><li>session是基于cookie的</li><li>session是另一种记录客户状态的机制，不同的是<code>Cookie保存在客户端</code>浏览器中，而<code>session保存在服务器</code>上</li><li>客户端浏览器访问服务器的时候，服务器把客户端信息以某种形式记录在服务器上，这就是session。客户端浏览器再次访问时只需要从该Session中查找该客户的状态就可以了</li></ul><h3 id="cookie和session区别"><a href="#cookie和session区别" class="headerlink" title="cookie和session区别"></a>cookie和session区别</h3><ol><li>cookie数据存<code>放在客户的浏览器</code>上，<code>session数据放在服务器</code>上。</li><li>cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗 <code>考虑到安全应当使用session</code></li><li>session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能 考虑到减轻服务器性能方面,应当使用COOKIE</li><li>单个cookie保存的数据<code>不能超过4K</code>，很多浏览器都限制一个站点<code>最多保存20个</code>cookie</li></ol><blockquote><p>将登陆信息等重要信息存放为session、其他信息如果需要保留，可以放在cookie中</p></blockquote><h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><ul><li><p>JSON Web Token（jwt） 是目前最流行的<code>跨域</code>身份验证解决方案</p></li><li><p>解决问题： session不支持分布式架构，无法支持横向扩展，只能通过数据库来保存会话数据实现共享。如果持久层失败会出现认证失败</p></li><li><p>优点：服务器<code>不保存任何会话数据</code>，即服务器变为<code>无状态</code>，使其更容易扩展</p></li></ul><h3 id="jwt-包含了使用-分隔的三部分"><a href="#jwt-包含了使用-分隔的三部分" class="headerlink" title="jwt 包含了使用 . 分隔的三部分"></a>jwt 包含了<code>使用 . 分隔</code>的三部分</h3><ul><li>Header 头部</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"alg"</span><span class="token builtin class-name">:</span><span class="token string">"HS256"</span>,<span class="token string">"typ"</span><span class="token builtin class-name">:</span><span class="token string">"JWT"</span><span class="token punctuation">&#125;</span>// algorithm <span class="token operator">=</span><span class="token operator">></span> HMAC SHA256// <span class="token builtin class-name">type</span> <span class="token operator">=</span><span class="token operator">></span> JWT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>Payload 负载，载荷</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># JWT 规定了7个官方字段</span>iss <span class="token punctuation">(</span>issuer<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>签发人<span class="token variable">`</span></span>exp <span class="token punctuation">(</span>expiration <span class="token function">time</span><span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>过期时间<span class="token variable">`</span></span>sub <span class="token punctuation">(</span>subject<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>主题<span class="token variable">`</span></span>aud <span class="token punctuation">(</span>audience<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>受众<span class="token variable">`</span></span>nbf <span class="token punctuation">(</span>Not Before<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>生效时间<span class="token variable">`</span></span>iat <span class="token punctuation">(</span>Issued At<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>签发时间<span class="token variable">`</span></span>jti <span class="token punctuation">(</span>JWT ID<span class="token punctuation">)</span>: <span class="token variable"><span class="token variable">`</span>编号<span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Signature 签名</li></ul><p>对前两部分的签名，防止数据篡改</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">HMACSHA256(    base64UrlEncode(header) + "." +    base64UrlEncode(payload),    secret)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>jwt作为一个令牌 （token）, 有些场合可能会放到URL (比如 api.example.com/?token = xxx). Base64有三个字符 <code>+</code> 、<code>/</code> 、<code>=</code> 在URL里面有特殊含义，所有要被替换掉： <code>=</code>被<code>省略</code>、<code>+</code> 替换成 <code>-</code> 、 <code>/</code> 替换成<code>_</code> 。这就是Base64URL算法</p></blockquote><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>HTTP <code>请求头 Authorization</code> 字段里面</p><pre class="line-numbers language-none"><code class="language-none">Authorization: Bearer &lt;token&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>通过<code>url传输</code></p><pre class="line-numbers language-none"><code class="language-none">api.example.com&#x2F;?token &#x3D; xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果是post请求也可以<code>放在请求体中</code></p><blockquote><p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JSON Web Token 入门教程</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
            <tag> Koa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大文件切片上传</title>
      <link href="/posts/f188.html"/>
      <url>/posts/f188.html</url>
      
        <content type="html"><![CDATA[<h1 id="大文件上传功能"><a href="#大文件上传功能" class="headerlink" title="大文件上传功能"></a>大文件上传功能</h1><h2 id="实现功能"><a href="#实现功能" class="headerlink" title="实现功能"></a><code>实现功能</code></h2><ul><li><input checked="" disabled="" type="checkbox"> 大文件切片</li><li><input checked="" disabled="" type="checkbox"> 断点续传</li><li><input checked="" disabled="" type="checkbox"> 秒传</li><li><input checked="" disabled="" type="checkbox"> 暂停上传</li><li><input checked="" disabled="" type="checkbox"> 恢复上传</li><li><input checked="" disabled="" type="checkbox"> 切片进度条</li><li><input checked="" disabled="" type="checkbox"> 文件进度条 </li></ul><h2 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a><code>整体思路</code></h2><h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a><code>前端</code></h3><ul><li>核心是利用 <code>Blob.prototype.slice</code> 方法，和数组的 slice 方法相似，调用的 slice 方法可以返回<code>原文件的某个切片</code></li><li>根据预先设置好的切片最大数量将文件切分为一个个切片，然后借助 http 的可并发性，同时上传多个切片，这样从原本传一个大文件，变成了<code>同时传多个小的文件切片</code>，可以大大减少上传时间</li><li>由于是并发，传输到服务端的顺序可能会发生变化，所以我们还需要给每个<code>切片记录顺序</code></li></ul><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a><code>服务端</code></h3><ul><li>服务端需要负责接受这些切片，并在接收到所有切片后<code>合并</code>切片<ul><li><code>何时合并</code>切片 前端在每个切片中都携带切片最大数量的信息，当服务端接受到这个数量的切片时自动合并，也可以额外发一个请求主动通知服务端进行切片的合并</li><li><code>如何合并</code>切片 使用 nodejs 的 读写流（readStream/writeStream），将所有切片的流传输到最终文件的流里</li></ul></li></ul><h2 id="前端部分"><a href="#前端部分" class="headerlink" title="前端部分"></a><code>前端部分</code></h2><h3 id="上传基本步骤"><a href="#上传基本步骤" class="headerlink" title="上传基本步骤"></a>上传基本步骤</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 校验文件是否选择</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'你尚未选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 校验文件类型和文件大小是否符合上传标准</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">allowUpload</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">setUploadStatus</span><span class="token punctuation">(</span>UploadStatus<span class="token punctuation">.</span><span class="token constant">UPLOADING</span><span class="token punctuation">)</span>        <span class="token comment">// 切片</span>        <span class="token keyword">let</span> <span class="token literal-property property">partList</span><span class="token operator">:</span> Part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createChunks</span><span class="token punctuation">(</span>currentFile<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计算哈希值 秒传的功能 通过webworker子进程来计算hash</span>        <span class="token keyword">let</span> fileHash <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span>partList<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 根据计算后的hash值生成文件名</span>        <span class="token keyword">let</span> lastDotIndex <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dog.jpg</span>        <span class="token keyword">let</span> extName <span class="token operator">=</span> currentFile<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastDotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .jpg</span>        <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>fileHash<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>extName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// hash.jpg</span>        <span class="token comment">// 设置hash名 （hash为32为字符串）</span>        <span class="token function">setFilename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 每个切片增加一些属性 </span>        partList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> Part<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            item<span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>   <span class="token comment">// hash文件名</span>            item<span class="token punctuation">.</span>chunk_name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filename<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>index<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  <span class="token comment">//hash切片索引名</span>            item<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            item<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token comment">// 设置partList</span>        <span class="token function">setPartList</span><span class="token punctuation">(</span>partList<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 开始上传 </span>        <span class="token keyword">await</span> <span class="token function">uploadParts</span><span class="token punctuation">(</span>partList<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="文件切片"><a href="#文件切片" class="headerlink" title="文件切片"></a><code>文件切片</code></h4><blockquote><p>文件切片并且返回切片列表，列表中每一项增加<code>size</code>属性</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">interface</span> <span class="token class-name">Part</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">chunk</span><span class="token operator">:</span> Blob    <span class="token literal-property property">size</span><span class="token operator">:</span> number    filename<span class="token operator">?</span><span class="token operator">:</span> string    chunk_name<span class="token operator">?</span><span class="token operator">:</span> string    loaded<span class="token operator">?</span><span class="token operator">:</span> number    percent<span class="token operator">?</span><span class="token operator">:</span> number    xhr<span class="token operator">?</span><span class="token operator">:</span> XMLHttpRequest<span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token constant">DEFAULT_SIZE</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 默认切片大小100M分段</span><span class="token comment">// 文件切片</span><span class="token keyword">function</span> <span class="token function">createChunks</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">file</span><span class="token operator">:</span>File</span><span class="token punctuation">)</span><span class="token operator">:</span> Part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> partList <span class="token operator">=</span> Part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>current <span class="token operator">>=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> chunk <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>current <span class="token operator">*</span> <span class="token constant">DEFAULT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        partList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>chunk<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span>chunk<span class="token punctuation">.</span>size<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        current <span class="token operator">+=</span> <span class="token constant">DEFAULT_SIZE</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> partList<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="计算文件hash值"><a href="#计算文件hash值" class="headerlink" title="计算文件hash值"></a><code>计算文件hash值</code></h4><blockquote><p><code>秒传的功能</code> （通过webworker子进程来计算哈希）</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">calculateHash</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">partList</span><span class="token operator">:</span>Part<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./hash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建webworker</span>        worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> partList <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> percent<span class="token punctuation">,</span> hash <span class="token punctuation">&#125;</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>                        <span class="token function">setHashPercent</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置hash值</span>            <span class="token comment">// 最后一次有hash值了</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">resolve</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// public/hash.js</span>self<span class="token punctuation">.</span><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://cdn.bootcss.com/spark-md5/3.0.0/spark-md5.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载远程脚本</span><span class="token comment">// File => 多个 Blob => 读取Blob读取成ArrayBuffer => spark 计算哈希值</span>self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>     <span class="token keyword">let</span> partList <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">// event.data拿到值</span>    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">self<span class="token punctuation">.</span>SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 引入远程脚本会全局注入这个类</span>    <span class="token keyword">let</span> percent <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> <span class="token comment">// 百分比</span>    <span class="token keyword">let</span> perSize <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">/</span> partList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 每个切片所占百分比</span>    <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>partList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>        chunk<span class="token punctuation">,</span>        size    <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// h5读取文件api</span>        reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>        reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            percent <span class="token operator">+=</span> perSize<span class="token punctuation">;</span>            self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">percent</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>percent<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    buffers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">buffer</span> <span class="token operator">=></span> spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 通知主进程，当前的哈希计算已经全部完成,并且把最终的hash值给主进程发过去</span>    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">percent</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>        <span class="token literal-property property">hash</span><span class="token operator">:</span> spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    self<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="上传切片"><a href="#上传切片" class="headerlink" title="上传切片"></a><code>上传切片</code></h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 上传切片</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadParts</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">partList</span><span class="token operator">:</span> Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 验证后台是否已经上传过</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> needUpload<span class="token punctuation">,</span> uploadList <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">verify</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needUpload<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'秒传成功'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 通过切片列表生成上传的请求数组</span>        <span class="token keyword">let</span> requests <span class="token operator">=</span> <span class="token function">createRequests</span><span class="token punctuation">(</span>partList<span class="token punctuation">,</span> uploadList<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 上传切片</span>        <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 告诉后台合并切片</span>        <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/merge/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filename<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span>        <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'上传失败或暂停'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="验证是否上传过（可实现秒传）"><a href="#验证是否上传过（可实现秒传）" class="headerlink" title="验证是否上传过（可实现秒传）"></a>验证是否上传过（可实现秒传）</h5><ul><li>参数说明<ul><li><code>needUpload</code> 判断是否上传过，可以实现秒传（其实是后台有文件，根本没传）</li><li><code>uploadList</code> 后端对应filename的所有切片列表(有可能有些切片不完整或者没有,用于断点续传)</li></ul></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filename</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/verify/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filename<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="通过切片列表生成上传的请求数组"><a href="#通过切片列表生成上传的请求数组" class="headerlink" title="通过切片列表生成上传的请求数组"></a>通过切片列表生成上传的请求数组</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createRequests</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">partList</span><span class="token operator">:</span> Part<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">uploadList</span><span class="token operator">:</span> Uploaded<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> partList            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">part</span><span class="token operator">:</span> Part</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 找到了说明上传过</span>                <span class="token keyword">let</span> uploadFile <span class="token operator">=</span> uploadList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>filename <span class="token operator">===</span> part<span class="token punctuation">.</span>chunk_name<span class="token punctuation">)</span>                <span class="token comment">// 没有上传过</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uploadFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    part<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已经上传的字节数0</span>                    part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已经上传的百分比就是0 分片上传过的百分比</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 上传过但不完整需要重新传</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadFile<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    part<span class="token punctuation">.</span>loaded <span class="token operator">=</span> uploadFile<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token comment">// 已经上传的字节数</span>                    part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uploadFile<span class="token punctuation">.</span>size <span class="token operator">/</span> part<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 已经上传的百分比</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">part</span><span class="token operator">:</span> Part</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/upload/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filename<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>part<span class="token punctuation">.</span>chunk_name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>part<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>                <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/octet-stream'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 指定请求体的格式</span>                <span class="token function-variable function">setXHR</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">xhr</span><span class="token operator">:</span> XMLHttpRequest</span><span class="token punctuation">)</span> <span class="token operator">=></span> part<span class="token punctuation">.</span>xhr <span class="token operator">=</span> xhr<span class="token punctuation">,</span> <span class="token comment">// 暂停需要xhr.abort()</span>                <span class="token function-variable function">onProgress</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> ProgressEvent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                    part<span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>loaded<span class="token operator">!</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token operator">/</span> part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token function">setPartList</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>partList<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token literal-property property">data</span><span class="token operator">:</span> part<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token comment">// 请求体</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a><code>后端</code></h2><h3 id="后端接收切片"><a href="#后端接收切片" class="headerlink" title="后端接收切片"></a>后端<code>接收切片</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> <span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span> mergeChunks<span class="token punctuation">,</span> <span class="token constant">PUBLIC_DIR</span> <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload/:filename/:chunk_name/:start'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">req</span><span class="token operator">:</span> Request<span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> Response<span class="token punctuation">,</span> <span class="token literal-property property">_next</span><span class="token operator">:</span> NextFunction</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> filename<span class="token punctuation">,</span> chunk_name <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span> <span class="token comment">// 获取文件名和切片名</span>    <span class="token keyword">let</span> <span class="token literal-property property">start</span> <span class="token operator">:</span>number <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上传加参数实现断点续传</span>    <span class="token keyword">let</span> chunk_dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> exist <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断文件夹在不在</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> chunkFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>chunk_dir<span class="token punctuation">,</span> chunk_name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建分片路径</span>    <span class="token comment">// flags a:append</span>    <span class="token keyword">let</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> start<span class="token punctuation">,</span> <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">'a'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 可读流读完了</span>    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>        ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    req<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="合并切片"><a href="#合并切片" class="headerlink" title="合并切片"></a><code>合并切片</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> <span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span> mergeChunks<span class="token punctuation">,</span> <span class="token constant">PUBLIC_DIR</span> <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/merge/:filename'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">req</span><span class="token operator">:</span> Request<span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> Response<span class="token punctuation">,</span> <span class="token literal-property property">_next</span><span class="token operator">:</span> NextFunction</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> filename <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token function">mergeChunks</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// utils.js</span><span class="token keyword">const</span> <span class="token function-variable function">pipeStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filePath</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">ws</span><span class="token operator">:</span> WriteStream</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">resolve</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 合并切片</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">mergeChunks</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filename</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">size</span><span class="token operator">:</span> number <span class="token operator">=</span> <span class="token constant">DEFAULT_SIZE</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合并切片后文件存放路径</span>    <span class="token keyword">let</span> chunkDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取切片文件路径</span>    <span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>chunkDir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取切片文件路径下所有切片</span>    chunks<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">Number</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">Number</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 按文件名后索引升序排列</span>    <span class="token comment">// 切片都封装成promise,并且并发读取</span>    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>        chunks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunkFile<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">pipeStream</span><span class="token punctuation">(</span>            path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>chunkDir<span class="token punctuation">,</span> chunkFile<span class="token punctuation">)</span><span class="token punctuation">,</span>            fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>                filePath<span class="token punctuation">,</span>                <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">start</span><span class="token operator">:</span> index <span class="token operator">*</span> size <span class="token comment">// 从那个位置开始写</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>chunkDir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="验证接口"><a href="#验证接口" class="headerlink" title="验证接口"></a><code>验证接口</code></h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// // 每次先计算hash值</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/verify/:filename'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">req</span><span class="token operator">:</span> Request<span class="token punctuation">,</span> <span class="token literal-property property">res</span><span class="token operator">:</span> Response<span class="token punctuation">,</span> <span class="token literal-property property">_next</span><span class="token operator">:</span> NextFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">&#123;</span> filename <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>    <span class="token comment">// public下有完整文件，不需要上传了</span>    <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_DIR</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> existFile <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断目录是否存在</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>existFile<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">needUpload</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">//因为已经上传过了，所以不需要上传了，可以实现秒传</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> tempDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">TEMP_DIR</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取temp下对应文件夹里所有的文件</span>    <span class="token keyword">let</span> exist <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">pathExists</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token literal-property property">uploadList</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>exist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        uploadList <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">)</span><span class="token punctuation">;</span>        uploadList <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>uploadList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filename</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> stat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>tempDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拿到文件详情</span>            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>                filename<span class="token punctuation">,</span> <span class="token comment">// 文件名</span>                <span class="token literal-property property">size</span><span class="token operator">:</span> stat<span class="token punctuation">.</span>size <span class="token comment">// 现在的文件大小（有可能没传完）</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token literal-property property">success</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token literal-property property">needUpload</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 需要上传</span>        uploadList <span class="token comment">// 已经上传的文件列表，方便前端过滤</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 人类补完计划 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Node </tag>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
